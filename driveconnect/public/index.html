<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveConnect NC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=EH6_wDSUHjZ155FCNOGogvRtTF11vlyr-I42_7VsyiHE9dDdc8slqZZ43aMXXYk1onXf77XgmWnThZqp&currency=USD&components=buttons,hosted-fields"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .gradient-text { background: linear-gradient(to right, #ea580c, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #map { height: 420px; width: 100%; border-radius: 16px; }
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { color: #f97316; border-bottom: 3px solid #f97316; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease forwards; }
    </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>
<script>
// ========== SUPABASE ==========
const SUPABASE_URL = 'https://nnmdvepfyccnehzbvpfn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ubWR2ZXBmeWNjbmVoemJ2cGZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTE4NjMsImV4cCI6MjA4NjkyNzg2M30.fCvcy_YdRs_Sn0AZobiq0OfGGm9mYJPKwEo9VPte1fY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const COMMISSION = 0.02;
const NOUMEA = { lat: -22.2758, lng: 166.4580 };

let currentUser = null;
let currentView = 'home';
let currentTab  = 'slots';
let map = null, userMarker = null, iMarkers = [], watchId = null;

// Cache local pour Ã©viter trop de requÃªtes
let DB = { instructors: [], slots: [], bookings: [] };

// ========== HELPERS ==========
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

function notif(title, msg, color='orange') {
    const n = document.createElement('div');
    n.className = `fixed top-4 right-4 bg-white p-4 rounded-2xl shadow-2xl z-[9999] border-l-4 border-${color}-500 max-w-sm fade-in`;
    n.innerHTML = `<p class="font-bold text-gray-800">${title}</p>${msg?`<p class="text-sm text-gray-500 mt-1">${msg}</p>`:''}`;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 5000);
}

function calcPrices(amount) {
    const commission = Math.round(amount * COMMISSION);
    return { total: amount, commission, net: amount - commission };
}

function cancellationPolicy(date, time) {
    const diff = (new Date(date+'T'+time) - new Date()) / 3600000;
    if (diff >= 48) return { pct:100, label:'âœ… Remboursement intÃ©gral (48h+)',  color:'green'  };
    if (diff >= 24) return { pct:50,  label:'âš ï¸ Remboursement 50% (24hâ€“48h)',   color:'yellow' };
    return              { pct:0,   label:'âŒ Aucun remboursement (< 24h)',      color:'red'    };
}

function sortedInstructors() {
    const now = new Date();
    return [...DB.instructors].sort((a,b) => {
        const sA = (a.rating||0)*100 - (a.penalty_until && new Date(a.penalty_until)>now ? (a.visibility_penalty||0) : 0);
        const sB = (b.rating||0)*100 - (b.penalty_until && new Date(b.penalty_until)>now ? (b.visibility_penalty||0) : 0);
        return sB - sA;
    });
}

// ========== CHARGEMENT DONNÃ‰ES SUPABASE ==========
async function loadData() {
    const [instRes, slotsRes] = await Promise.all([
        sb.from('instructors').select('*'),
        sb.from('slots').select('*').eq('available', true).gte('date', new Date().toISOString().split('T')[0])
    ]);
    DB.instructors = instRes.data || [];
    DB.slots = slotsRes.data || [];

    if (currentUser) {
        const field = currentUser.user_type === 'student' ? 'student_id' : 'instructor_id';
        const { data } = await sb.from('bookings').select('*').eq(field, currentUser.id).order('created_at', { ascending: false });
        DB.bookings = data || [];
    }
}

// ========== AUTH ==========
async function login(email, password, userType) {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) { notif('âŒ Email ou mot de passe incorrect', '', 'red'); return; }

    const { data: profile } = await sb.from('users').select('*').eq('id', data.user.id).single();
    if (!profile || profile.user_type !== userType) {
        notif('âŒ Ce compte n\'est pas un ' + (userType==='student'?'Ã©lÃ¨ve':'moniteur'), '', 'red');
        await sb.auth.signOut();
        return;
    }
    currentUser = { ...profile, ...data.user };
    currentView = userType === 'student' ? 'student-dashboard' : 'instructor-dashboard';
    await loadData();
    render();
}

async function signup(email, password, name, userType) {
    const { data, error } = await sb.auth.signUp({
        email, password,
        options: { data: { name, user_type: userType } }
    });
    if (error) { notif('âŒ ' + error.message, '', 'red'); return; }

    // Attendre que le trigger crÃ©e le profil
    await new Promise(r => setTimeout(r, 1000));

    // Mettre Ã  jour le profil avec le nom si pas encore fait
    await sb.from('users').upsert({
        id: data.user.id,
        email, name,
        user_type: userType
    }, { onConflict: 'id' });

    // Si moniteur, crÃ©er le profil instructeur
    if (userType === 'instructor') {
        await sb.from('instructors').upsert({
            id: data.user.id,
            user_id: data.user.id,
            name, email,
            rating: 0, total_reviews: 0, experience: 0,
            location: 'NoumÃ©a', hourly_rate: 4500,
            verified: false, is_online: false,
            lat: NOUMEA.lat, lng: NOUMEA.lng,
            visibility_penalty: 0
        }, { onConflict: 'id' });
    }

    const { data: profile } = await sb.from('users').select('*').eq('id', data.user.id).single();
    currentUser = { ...profile, ...data.user };
    currentView = userType === 'student' ? 'student-dashboard' : 'instructor-dashboard';
    await loadData();
    render();
    notif('âœ… Compte crÃ©Ã© !', 'Bienvenue sur DriveConnect NC', 'green');
}

// ========== HOME ====================
function HomePage() {
    return `<div class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-orange-50 flex items-center justify-center">
        <div class="text-center max-w-3xl px-4">
            <h1 class="text-6xl font-extrabold mb-4 gradient-text">DriveConnect NC</h1>
            <p class="text-xl text-gray-400 mb-16">La plateforme de cours de conduite Ã  NoumÃ©a</p>
            <div class="grid md:grid-cols-2 gap-8 max-w-2xl mx-auto">
                <button onclick="showView('student-login')" class="bg-white p-10 rounded-3xl shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1 border-2 border-orange-100">
                    <div class="text-5xl mb-4">ğŸ‘¨â€ğŸ“</div><h3 class="text-2xl font-bold mb-2">Je suis Ã©lÃ¨ve</h3>
                    <p class="text-gray-400 text-sm">RÃ©servez un cours en quelques clics</p>
                </button>
                <button onclick="showView('instructor-login')" class="bg-white p-10 rounded-3xl shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1 border-2 border-orange-100">
                    <div class="text-5xl mb-4">ğŸš—</div><h3 class="text-2xl font-bold mb-2">Je suis moniteur</h3>
                    <p class="text-gray-400 text-sm">GÃ©rez vos crÃ©neaux et revenus</p>
                </button>
            </div>
            <div class="flex justify-center gap-4 mt-10">
                <a href="/legal.html" class="bg-white border border-gray-200 px-5 py-2 rounded-xl text-sm font-medium text-gray-500 hover:text-orange-500 transition shadow-sm">ğŸ”’ ConfidentialitÃ©</a>
                <a href="/legal.html" class="bg-white border border-gray-200 px-5 py-2 rounded-xl text-sm font-medium text-gray-500 hover:text-orange-500 transition shadow-sm">ğŸ“‹ CGU</a>
            </div>
        </div>
    </div>`;
}

// ========== LOGIN ====================
function LoginPage(type) {
    return `<div class="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <button onclick="showView('home')" class="mb-6 text-orange-500">â† Retour</button>
            <div class="bg-white rounded-3xl shadow-2xl p-8 border border-orange-100">
                <h2 class="text-3xl font-bold mb-1" id="form-title">Se connecter</h2>
                <p class="text-gray-400 mb-8 text-sm">${type==='student'?'ğŸ‘¨â€ğŸ“ Espace Ã‰lÃ¨ve':'ğŸš— Espace Moniteur'}</p>
                <form id="login-form" class="space-y-4">
                    <div id="name-field" style="display:none">
                        <input type="text" id="name" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-400 outline-none" placeholder="Nom complet">
                    </div>
                    <input type="email" id="email" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-400 outline-none" placeholder="Email">
                    <input type="password" id="password" required minlength="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-400 outline-none" placeholder="Mot de passe">
                    <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-xl font-bold shadow-lg">
                        <span id="submit-text">Se connecter</span>
                    </button>
                </form>
                <div class="mt-6 text-center">
                    <button onclick="toggleSignup('${type}')" class="text-orange-500 text-sm font-medium"><span id="toggle-text">Pas de compte ? S'inscrire</span></button>
                </div>
            </div>
        </div>
    </div>`;
}

// ========== STUDENT DASHBOARD ====================
function StudentDashboard() {
    const myBookings = DB.bookings;
    const instructors = sortedInstructors();
    return `<div class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-extrabold gradient-text">DriveConnect NC</h1>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-500">ğŸ‘‹ ${currentUser.name}</span>
                    <button onclick="logout()" class="px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-xl">DÃ©connexion</button>
                </div>
            </div>
        </header>
        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-3xl shadow-xl p-6 mb-8 border border-orange-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">ğŸ—ºï¸ Moniteurs en temps rÃ©el</h2>
                    <button onclick="centerOnMe()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-orange-600">ğŸ“ Me localiser</button>
                </div>
                <div class="flex gap-4 text-xs text-gray-400 mb-3">
                    <span><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span>Disponible</span>
                    <span><span class="inline-block w-3 h-3 rounded-full bg-gray-400 mr-1"></span>Hors ligne</span>
                    <span><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span>Ma position</span>
                    <span><span class="inline-block w-3 h-3 rounded-full bg-red-400 mr-1"></span>PÃ©nalisÃ©</span>
                </div>
                <div id="map"></div>
            </div>
            ${myBookings.length>0?`
            <div class="bg-white rounded-3xl shadow-xl p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">ğŸ“… Mes rÃ©servations</h2>
                ${myBookings.map(b=>{
                    const pol = cancellationPolicy(b.date,b.time);
                    const canCancel = b.status!=='cancelled' && b.status!=='completed';
                    return `<div class="border border-gray-100 rounded-2xl p-4 mb-3 fade-in">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${b.instructor_name||'Moniteur'}</p>
                                <p class="text-sm text-gray-400">ğŸ“… ${b.date} Ã  ${b.time} Â· â±ï¸ ${b.duration}h</p>
                                <p class="text-sm font-semibold text-orange-600 mt-1">${b.amount} XPF</p>
                                ${b.payment_status==='paid'?'<p class="text-xs text-green-600">âœ… PayÃ©</p>':''}
                                ${b.status==='cancelled'?`<p class="text-xs text-red-500">âŒ AnnulÃ© Â· RemboursÃ©: ${b.refund_amount||0} XPF</p>`:''}
                            </div>
                            <div class="text-right">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${b.status==='confirmed'?'bg-green-100 text-green-700':b.status==='cancelled'?'bg-red-100 text-red-600':'bg-yellow-100 text-yellow-700'}">${b.status==='confirmed'?'âœ… ConfirmÃ©':b.status==='cancelled'?'âŒ AnnulÃ©':'â³ En attente'}</span>
                                ${canCancel?`<button onclick="cancelStudent('${b.id}')" class="mt-2 block text-xs text-red-500 hover:underline">Annuler</button><p class="text-xs text-gray-400 mt-1">${pol.label}</p>`:''}
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>`:''}
            <h2 class="text-xl font-bold mb-4">ğŸš— Choisir un moniteur</h2>
            <div class="grid md:grid-cols-3 gap-6">
                ${instructors.map((i,idx)=>{
                    const now=new Date();
                    const hasPenalty=i.penalty_until&&new Date(i.penalty_until)>now;
                    const availableSlots=DB.slots.filter(s=>s.instructor_id===i.id).length;
                    return `<div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-3xl p-6 text-white shadow-xl cursor-pointer hover:shadow-2xl transition-all hover:-translate-y-1 fade-in" onclick="focusInstructor('${i.id}')">
                        ${idx===0?'<div class="text-xs font-bold mb-2 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full inline-block">â­ Meilleure note</div>':''}
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${i.is_online?'bg-green-500':'bg-gray-600'}">${i.is_online?'ğŸŸ¢ En ligne':'âš« Hors ligne'}</span>
                            <span class="font-bold">â­ ${i.rating||'N/A'}</span>
                        </div>
                        <div class="text-4xl mb-3 text-center">ğŸ‘¨â€ğŸ«</div>
                        <h3 class="font-extrabold text-lg text-center mb-1">${i.name}</h3>
                        <p class="text-orange-200 text-sm text-center mb-4">ğŸ“ ${i.location||'NoumÃ©a'}</p>
                        ${hasPenalty?'<p class="text-xs text-red-200 text-center mb-2">âš ï¸ VisibilitÃ© rÃ©duite</p>':''}
                        <div class="bg-white/20 rounded-2xl p-3 mb-4">
                            <p class="text-sm text-orange-100">Ã€ partir de</p>
                            <p class="text-2xl font-extrabold">${i.hourly_rate||0} XPF/h</p>
                            <p class="text-xs text-orange-200 mt-1">ğŸ“† ${availableSlots} crÃ©neaux disponibles</p>
                        </div>
                        <button onclick="event.stopPropagation();showSlots('${i.id}')" class="w-full bg-white text-orange-600 py-3 rounded-xl font-bold hover:bg-orange-50 transition">ğŸ“… Voir les crÃ©neaux</button>
                    </div>`;
                }).join('')}
                ${instructors.length===0?'<div class="col-span-3 text-center py-12 text-gray-400"><p class="text-4xl mb-3">ğŸš—</p><p>Aucun moniteur disponible pour le moment</p></div>':''}
            </div>
        </div>
    </div>`;
}

// ========== INSTRUCTOR DASHBOARD ====================
function InstructorDashboard() {
    const myBookings = DB.bookings;
    const profile = DB.instructors.find(x=>x.id===currentUser.id) || {};
    const mySlots = DB.slots.filter(s=>s.instructor_id===currentUser.id);
    const totalNet = myBookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid').reduce((s,b)=>s+(b.net||0),0);
    const tabs = [{id:'slots',label:'ğŸ“… CrÃ©neaux'},{id:'bookings',label:'ğŸ“‹ RÃ©servations'},{id:'earnings',label:'ğŸ’° Revenus'},{id:'settings',label:'âš™ï¸ ParamÃ¨tres'}];
    return `<div class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-extrabold gradient-text">DriveConnect NC</h1>
                <div class="flex items-center gap-3">
                    <button onclick="toggleOnline()" class="px-3 py-2 text-sm rounded-xl font-semibold ${profile.is_online?'bg-green-100 text-green-700':'bg-gray-100 text-gray-500'}">${profile.is_online?'ğŸŸ¢ En ligne':'âš« Hors ligne'}</button>
                    <span class="text-sm text-gray-500">ğŸ‘‹ ${currentUser.name}</span>
                    <button onclick="logout()" class="px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-xl">DÃ©connexion</button>
                </div>
            </div>
        </header>
        <div class="container mx-auto px-4 py-8">
            <div class="grid md:grid-cols-3 gap-4 mb-8">
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-5 text-white">
                    <p class="text-orange-200 text-sm">Revenus nets</p>
                    <p class="text-3xl font-extrabold">${totalNet.toLocaleString()} XPF</p>
                </div>
                <div class="bg-white rounded-2xl p-5 shadow border">
                    <p class="text-gray-400 text-sm">RÃ©servations</p>
                    <p class="text-3xl font-extrabold">${myBookings.filter(b=>b.status==='confirmed').length}</p>
                </div>
                <div class="bg-white rounded-2xl p-5 shadow border">
                    <p class="text-gray-400 text-sm">CrÃ©neaux dispo</p>
                    <p class="text-3xl font-extrabold">${mySlots.length}</p>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl p-6 mb-8 border border-orange-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">ğŸ—ºï¸ Ma position</h2>
                    <button onclick="startTracking()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-orange-600">ğŸ“ Partager GPS</button>
                </div>
                <p id="gps-status" class="text-xs text-gray-400 mb-3">GPS non actif</p>
                <div id="map"></div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border">
                <div class="flex border-b overflow-x-auto">
                    ${tabs.map(t=>`<button onclick="switchTab('${t.id}')" class="tab-btn px-6 py-4 font-semibold whitespace-nowrap ${currentTab===t.id?'active':''}">${t.label}</button>`).join('')}
                </div>
                <div class="p-6">${getTabContent(profile, myBookings, mySlots)}</div>
            </div>
        </div>
    </div>`;
}

function getTabContent(profile, myBookings, mySlots) {
    if (currentTab==='slots') return SlotsTab(mySlots);
    if (currentTab==='bookings') return BookingsTab(myBookings);
    if (currentTab==='earnings') return EarningsTab(myBookings);
    if (currentTab==='settings') return SettingsTab(profile);
    return '';
}

function SlotsTab(mySlots) {
    return `<div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">Mes crÃ©neaux</h3>
        <button onclick="showAddSlot()" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-semibold text-sm">+ Ajouter</button>
    </div>
    <div class="space-y-3">
        ${mySlots.length===0?'<div class="text-center py-12 text-gray-400"><p class="text-4xl mb-3">ğŸ“…</p><p>Aucun crÃ©neau Â· Ajoutez-en un !</p></div>':mySlots.map(s=>{
            const booking=DB.bookings.find(b=>b.slot_id===s.id&&b.status!=='cancelled');
            return `<div class="border ${booking?'border-blue-200 bg-blue-50':'border-gray-100'} rounded-2xl p-4 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold">${s.date} Ã  ${s.time}</p>
                        <p class="text-sm text-gray-400">â±ï¸ ${s.duration}h Â· ğŸ’° ${s.price} XPF</p>
                        ${booking?`<p class="text-xs text-blue-600 mt-1">ğŸ‘¨â€ğŸ“ ${booking.student_name}</p>`:''}
                    </div>
                    <div>
                        ${booking?`<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">ğŸ”’ RÃ©servÃ©</span>
                        <button onclick="cancelInstructor('${booking.id}')" class="block mt-2 text-xs text-red-500 hover:underline">Annuler</button>`:
                        `<button onclick="deleteSlot('${s.id}')" class="text-xs text-red-400 hover:underline">ğŸ—‘ï¸ Supprimer</button>`}
                    </div>
                </div>
            </div>`;
        }).join('')}
    </div>`;
}

function BookingsTab(myBookings) {
    const sorted = [...myBookings].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    return `<div class="space-y-3">
        ${sorted.length===0?`<div class="text-center py-12 text-gray-400"><p class="text-4xl mb-3">ğŸ“‹</p><p>Aucune rÃ©servation</p></div>`:sorted.map(b=>`
        <div class="border border-gray-100 rounded-2xl p-4 fade-in">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold">ğŸ‘¨â€ğŸ“ ${b.student_name||'Ã‰lÃ¨ve'}</p>
                    <p class="text-sm text-gray-400">ğŸ“… ${b.date} Ã  ${b.time} Â· ${b.duration}h</p>
                    <p class="text-sm font-semibold text-orange-600">${b.net||0} XPF nets</p>
                    ${b.payment_status==='paid'?'<p class="text-xs text-green-600">âœ… PayÃ©</p>':''}
                </div>
                <div class="text-right">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${b.status==='confirmed'?'bg-green-100 text-green-700':b.status==='cancelled'?'bg-red-100 text-red-600':'bg-yellow-100 text-yellow-700'}">${b.status==='confirmed'?'âœ… ConfirmÃ©':b.status==='cancelled'?'âŒ AnnulÃ©':'â³ En attente'}</span>
                    ${b.status==='pending'?`<div class="mt-2 flex gap-2">
                        <button onclick="confirmB('${b.id}')" class="text-xs bg-green-500 text-white px-2 py-1 rounded-lg">âœ…</button>
                        <button onclick="rejectB('${b.id}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded-lg">âŒ</button>
                    </div>`:''}
                </div>
            </div>
        </div>`).join('')}
    </div>`;
}

function EarningsTab(myBookings) {
    const paid = myBookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid');
    const total = paid.reduce((s,b)=>s+(b.net||0),0);
    const months = {};
    paid.forEach(b=>{const m=b.date.substr(0,7);months[m]=(months[m]||0)+(b.net||0);});
    return `<div>
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white mb-6">
            <p class="text-orange-200">Total revenus nets</p>
            <p class="text-4xl font-extrabold">${total.toLocaleString()} XPF</p>
            <p class="text-orange-200 text-sm mt-1">Commission plateforme : ${Math.round(total*COMMISSION/(1-COMMISSION)).toLocaleString()} XPF</p>
        </div>
        <div class="space-y-3">
            ${Object.entries(months).sort((a,b)=>b[0].localeCompare(a[0])).map(([m,v])=>`
            <div class="flex justify-between items-center border border-gray-100 rounded-xl p-4">
                <p class="font-semibold">${m}</p>
                <p class="font-bold text-orange-600">${v.toLocaleString()} XPF</p>
            </div>`).join('')}
        </div>
    </div>`;
}

function SettingsTab(profile) {
    return `<form id="settings-form" class="space-y-4">
        <div><label class="block text-sm font-medium mb-2">Localisation</label><input type="text" id="s-loc" value="${profile.location||''}" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400" placeholder="Quartier / Ville"></div>
        <div><label class="block text-sm font-medium mb-2">TÃ©lÃ©phone</label><input type="tel" id="s-phone" value="${profile.phone_number||''}" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400" placeholder="+687 XX XX XX"></div>
        <div><label class="block text-sm font-medium mb-2">Tarif horaire (XPF)</label><input type="number" id="s-rate" value="${profile.hourly_rate||4500}" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400"></div>
        <div><label class="block text-sm font-medium mb-2">AnnÃ©es d'expÃ©rience</label><input type="number" id="s-exp" value="${profile.experience||0}" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400"></div>
        <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-xl font-bold">ğŸ’¾ Sauvegarder</button>
    </form>`;
}

// ========== ACTIONS CRÃ‰NEAUX ==========
window.showAddSlot = function() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
    const today = new Date().toISOString().split('T')[0];
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl">
        <h3 class="text-xl font-bold mb-4">â• Nouveau crÃ©neau</h3>
        <form id="slot-form" class="space-y-4">
            <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="sl-date" min="${today}" required class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400"></div>
            <div><label class="block text-sm font-medium mb-1">Heure</label><select id="sl-time" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400">
                ${['07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30','11:00','11:30','12:00','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00'].map(t=>`<option>${t}</option>`).join('')}
            </select></div>
            <div><label class="block text-sm font-medium mb-1">DurÃ©e (heures)</label><select id="sl-dur" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400"><option value="1">1h</option><option value="1.5">1h30</option><option value="2">2h</option></select></div>
            <div id="sl-preview" class="bg-orange-50 rounded-xl p-3 text-sm text-orange-700"></div>
            <div class="flex gap-3">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 border border-gray-200 py-3 rounded-xl font-semibold">Annuler</button>
                <button type="submit" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">CrÃ©er</button>
            </div>
        </form>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });

    modal.querySelector('#slot-form').onsubmit = async function(e) {
        e.preventDefault();
        const instructor = DB.instructors.find(x=>x.id===currentUser.id);
        const price = instructor ? instructor.hourly_rate : 4500;
        const { data, error } = await sb.from('slots').insert({
            instructor_id: currentUser.id,
            date: document.getElementById('sl-date').value,
            time: document.getElementById('sl-time').value,
            duration: parseFloat(document.getElementById('sl-dur').value),
            price, available: true
        }).select().single();
        if (error) { notif('âŒ Erreur', error.message, 'red'); return; }
        DB.slots.push(data);
        modal.remove();
        notif('âœ… CrÃ©neau ajoutÃ©', '', 'green');
        render();
    };
};

window.showSlots = function(instructorId) {
    const instructor = DB.instructors.find(x=>x.id===instructorId);
    if (!instructor) return;
    const slots = DB.slots.filter(s=>s.instructor_id===instructorId&&s.available);
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4';
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <div><h3 class="text-xl font-bold">${instructor.name}</h3><p class="text-gray-400 text-sm">ğŸ“ ${instructor.location} Â· â­ ${instructor.rating||'N/A'}</p></div>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 text-2xl">âœ•</button>
        </div>
        <div class="space-y-3">
            ${slots.length===0?'<p class="text-center text-gray-400 py-8">Aucun crÃ©neau disponible</p>':slots.map(s=>`
            <div class="border border-gray-100 rounded-2xl p-4 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold">ğŸ“… ${s.date}</p>
                        <p class="text-sm text-gray-400">ğŸ• ${s.time} Â· â±ï¸ ${s.duration}h</p>
                        <p class="font-semibold text-orange-600 mt-1">${s.price} XPF</p>
                    </div>
                    <button onclick="bookSlot('${s.id}','${instructorId}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:bg-orange-600">RÃ©server</button>
                </div>
            </div>`).join('')}
        </div>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
};

window.bookSlot = function(slotId, instructorId) {
    if (!currentUser) { notif('âŒ Connectez-vous d\'abord', '', 'red'); return; }
    const slot = DB.slots.find(s=>s.id===slotId);
    const instructor = DB.instructors.find(i=>i.id===instructorId);
    if (!slot || !instructor) return;
    const prices = calcPrices(slot.price);
    document.querySelectorAll('.fixed').forEach(m=>m.remove());
    showPaymentModal(slot, instructor, prices);
};

function showPaymentModal(slot, instructor, prices) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4';
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">ğŸ’³ Paiement</h3>
            <button onclick="this.closest('.fixed').remove();document.body.style.overflow=''" class="text-gray-400 text-2xl">âœ•</button>
        </div>
        <div class="bg-orange-50 rounded-2xl p-4 mb-4">
            <p class="font-bold">${instructor.name}</p>
            <p class="text-sm text-gray-500">ğŸ“… ${slot.date} Ã  ${slot.time} Â· â±ï¸ ${slot.duration}h</p>
            <p class="text-2xl font-extrabold text-orange-600 mt-2">${prices.total} XPF</p>
        </div>
        <div id="paypal-btns" class="mb-4"></div>
        <button id="pay-btn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition">ğŸ’³ PAYER ${slot.price} XPF</button>
        <p class="text-xs text-gray-400 text-center mt-2">ğŸ”’ Paiement sÃ©curisÃ©</p>
    </div>`;
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    modal.addEventListener('click', e => { if(e.target===modal){modal.remove();document.body.style.overflow='';}});

    async function completeBooking(paymentStatus, orderId) {
        const { error } = await sb.from('slots').update({ available: false }).eq('id', slot.id);
        if (error) { notif('âŒ Erreur slot', error.message, 'red'); return; }

        const { data: booking, error: bError } = await sb.from('bookings').insert({
            slot_id: slot.id,
            student_id: currentUser.id,
            student_name: currentUser.name,
            instructor_id: instructor.id,
            instructor_name: instructor.name,
            date: slot.date, time: slot.time, duration: slot.duration,
            amount: slot.price, commission: prices.commission, net: prices.net,
            status: 'confirmed', payment_status: paymentStatus,
            paypal_order_id: orderId
        }).select().single();

        if (bError) { notif('âŒ Erreur rÃ©servation', bError.message, 'red'); return; }

        DB.slots = DB.slots.filter(s=>s.id!==slot.id);
        DB.bookings.push(booking);
        modal.remove(); document.body.style.overflow='';
        notif('âœ… RÃ©servation confirmÃ©e !', `Cours avec ${instructor.name} le ${slot.date}`, 'green');
        render();
    }

    if (typeof paypal !== 'undefined') {
        try {
            paypal.Buttons({
                style:{layout:'vertical',color:'gold',label:'pay',height:48},
                createOrder:(d,a)=>a.order.create({purchase_units:[{amount:{value:(slot.price/100).toFixed(2),currency_code:'USD'}}]}),
                onApprove:(d,a)=>a.order.capture().then(()=>completeBooking('paid',d.orderID)),
                onError:()=>notif('âŒ Erreur PayPal','','red')
            }).render('#paypal-btns');
        } catch(e) {}
    }

    document.getElementById('pay-btn').onclick = function() {
        if(confirm(`Confirmer le paiement de ${slot.price} XPF ?`)) completeBooking('paid','DIRECT_'+generateId());
    };
}

// ========== ANNULATIONS ==========
window.cancelStudent = async function(bookingId) {
    const b = DB.bookings.find(x=>x.id===bookingId);
    if (!b) return;
    const pol = cancellationPolicy(b.date,b.time);
    const refund = Math.round(b.amount*pol.pct/100);
    if (!confirm(`Annuler ce cours ?\n\n${pol.label}\nRemboursement : ${refund} XPF`)) return;

    await sb.from('bookings').update({ status:'cancelled', cancelled_by:'student', refund_amount:refund, cancelled_at:new Date().toISOString() }).eq('id', bookingId);
    if (pol.pct>=50) await sb.from('slots').update({ available:true }).eq('id', b.slot_id);

    await loadData();
    notif('RÃ©servation annulÃ©e',`Remboursement de ${refund} XPF (${pol.pct}%)`,pol.pct===100?'green':pol.pct===50?'yellow':'red');
    render();
};

window.cancelInstructor = async function(bookingId) {
    const b = DB.bookings.find(x=>x.id===bookingId);
    if (!b) return;
    const diffH = (new Date(b.date+'T'+b.time)-new Date())/3600000;
    const isLate = diffH<24;
    if (!confirm(isLate?`âš ï¸ Annulation < 24h !\n\nPÃ©nalitÃ© visibilitÃ© -10% pendant 7 jours\nConfirmer ?`:`Annuler ce cours ? L'Ã©lÃ¨ve sera remboursÃ©.`)) return;

    await sb.from('bookings').update({ status:'cancelled', cancelled_by:'instructor', refund_amount:b.amount, cancelled_at:new Date().toISOString() }).eq('id', bookingId);
    await sb.from('slots').update({ available:true }).eq('id', b.slot_id);

    if (isLate) {
        const end = new Date(); end.setDate(end.getDate()+7);
        await sb.from('instructors').update({ penalty_until:end.toISOString(), visibility_penalty:10 }).eq('id', currentUser.id);
    }

    await loadData();
    notif(isLate?'âš ï¸ PÃ©nalitÃ© appliquÃ©e':'âœ… Cours annulÃ©',isLate?'VisibilitÃ© -10% pendant 7 jours':'Ã‰lÃ¨ve remboursÃ©',isLate?'red':'orange');
    render();
};

window.confirmB = async (id) => {
    await sb.from('bookings').update({ status:'confirmed' }).eq('id', id);
    await loadData(); notif('âœ… Cours acceptÃ©','','green'); render();
};

window.rejectB = async (id) => {
    const b = DB.bookings.find(x=>x.id===id);
    await sb.from('bookings').update({ status:'rejected' }).eq('id', id);
    if (b) await sb.from('slots').update({ available:true }).eq('id', b.slot_id);
    await loadData(); notif('Cours refusÃ©','','red'); render();
};

window.deleteSlot = async (id) => {
    if (!confirm('Supprimer ce crÃ©neau ?')) return;
    await sb.from('slots').delete().eq('id', id);
    DB.slots = DB.slots.filter(s=>s.id!==id);
    notif('CrÃ©neau supprimÃ©','','orange'); render();
};

// ========== GPS & CARTE ==========
function initMap() {
    if (map){map.remove();map=null;iMarkers=[];}
    map=L.map('map').setView([NOUMEA.lat,NOUMEA.lng],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
    const now=new Date();
    sortedInstructors().forEach(i=>{
        if(!i.lat) return;
        const hasPenalty=i.penalty_until&&new Date(i.penalty_until)>now;
        const color=hasPenalty?'#f87171':i.is_online?'#22c55e':'#9ca3af';
        const icon=L.divIcon({html:`<div style="background:${color};width:44px;height:44px;border-radius:50%;border:3px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸš—</div>`,className:'',iconSize:[44,44],iconAnchor:[22,22]});
        const slots=DB.slots.filter(s=>s.instructor_id===i.id).length;
        const marker=L.marker([i.lat,i.lng],{icon}).addTo(map).bindPopup(`<div style="text-align:center;padding:10px;min-width:180px"><p style="font-weight:800;font-size:15px">${i.name}</p><p style="color:#f97316;margin:4px 0">â­ ${i.rating||'N/A'}</p><p style="color:#6b7280;font-size:13px">ğŸ“ ${i.location}</p><p style="font-weight:700;color:#f97316;font-size:17px;margin:6px 0">${i.hourly_rate} XPF/h</p><p style="font-size:12px;color:#6b7280;margin-bottom:8px">ğŸ“† ${slots} crÃ©neaux</p><span style="background:${i.is_online?'#dcfce7':'#f3f4f6'};color:${i.is_online?'#16a34a':'#6b7280'};padding:3px 10px;border-radius:20px;font-size:12px;display:block;margin-bottom:10px">${i.is_online?'ğŸŸ¢ Disponible':'âš« Hors ligne'}</span><button onclick="showSlots('${i.id}')" style="background:#f97316;color:white;border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;width:100%">ğŸ“… Voir crÃ©neaux</button></div>`,{maxWidth:220});
        iMarkers.push({id:i.id,marker});
    });
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{const ic=L.divIcon({html:`<div style="background:#3b82f6;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(59,130,246,0.5)"></div>`,className:'',iconSize:[16,16],iconAnchor:[8,8]});if(userMarker)map.removeLayer(userMarker);userMarker=L.marker([pos.coords.latitude,pos.coords.longitude],{icon:ic}).addTo(map).bindPopup('ğŸ“ Ma position');map.setView([pos.coords.latitude,pos.coords.longitude],14);},()=>{});}
}

window.centerOnMe=()=>{if(!navigator.geolocation)return;navigator.geolocation.getCurrentPosition(pos=>{map.setView([pos.coords.latitude,pos.coords.longitude],15);notif('ğŸ“ LocalisÃ© !','','blue');},()=>{});};
window.focusInstructor=(id)=>{const i=DB.instructors.find(x=>x.id===id);if(i&&map){map.setView([i.lat,i.lng],15);iMarkers.find(m=>m.id===id)?.marker.openPopup();}};

window.startTracking=()=>{
    if(!navigator.geolocation){notif('âŒ GPS indisponible','','red');return;}
    if(watchId)navigator.geolocation.clearWatch(watchId);
    watchId=navigator.geolocation.watchPosition(async pos=>{
        await sb.from('instructors').update({lat:pos.coords.latitude,lng:pos.coords.longitude,is_online:true}).eq('id',currentUser.id);
        const ic=L.divIcon({html:`<div style="background:#f97316;width:48px;height:48px;border-radius:50%;border:3px solid white;box-shadow:0 4px 15px rgba(249,115,22,0.5);display:flex;align-items:center;justify-content:center;font-size:22px;">ğŸš—</div>`,className:'',iconSize:[48,48],iconAnchor:[24,24]});
        if(userMarker)map.removeLayer(userMarker);
        userMarker=L.marker([pos.coords.latitude,pos.coords.longitude],{icon:ic}).addTo(map);
        map.setView([pos.coords.latitude,pos.coords.longitude],15);
        const el=document.getElementById('gps-status');
        if(el)el.textContent='ğŸŸ¢ GPS actif â€” Position partagÃ©e avec les Ã©lÃ¨ves';
    },err=>notif('âŒ GPS',err.message,'red'),{enableHighAccuracy:true});
};

window.toggleOnline=async ()=>{
    const i=DB.instructors.find(x=>x.id===currentUser.id);
    if(i){
        const newStatus=!i.is_online;
        await sb.from('instructors').update({is_online:newStatus}).eq('id',currentUser.id);
        i.is_online=newStatus;
        notif(newStatus?'ğŸŸ¢ En ligne':'âš« Hors ligne','','green');
        render();
    }
};

// ========== NAVIGATION ==========
window.showView=async (v)=>{currentView=v;render();};
window.switchTab=(t)=>{currentTab=t;render();};

window.logout=async ()=>{
    if(watchId)navigator.geolocation.clearWatch(watchId);
    if(currentUser && currentUser.user_type==='instructor'){
        await sb.from('instructors').update({is_online:false}).eq('id',currentUser.id);
    }
    await sb.auth.signOut();
    currentUser=null; currentView='home'; render();
};

window.toggleSignup=(type)=>{
    const s=document.getElementById('name-field').style.display==='none';
    document.getElementById('name-field').style.display=s?'block':'none';
    document.getElementById('name').required=s;
    document.getElementById('form-title').textContent=s?'CrÃ©er un compte':'Se connecter';
    document.getElementById('submit-text').textContent=s?"S'inscrire":'Se connecter';
    document.getElementById('toggle-text').textContent=s?'DÃ©jÃ  un compte ?':"Pas de compte ?";
};

function setupLoginForm(type) {
    document.getElementById('login-form').onsubmit=async function(e){
        e.preventDefault();
        const email=document.getElementById('email').value;
        const password=document.getElementById('password').value;
        const isSignup=document.getElementById('name-field').style.display!=='none';
        const btn = document.getElementById('submit-text');
        btn.textContent='â³ Chargement...';
        if(isSignup){
            await signup(email, password, document.getElementById('name').value, type);
        } else {
            await login(email, password, type);
        }
        if(document.getElementById('submit-text')) btn.textContent=isSignup?"S'inscrire":'Se connecter';
    };
}

document.addEventListener('submit', async function(e){
    if(e.target.id==='settings-form'){
        e.preventDefault();
        await sb.from('instructors').update({
            location: document.getElementById('s-loc').value,
            phone_number: document.getElementById('s-phone').value,
            hourly_rate: parseInt(document.getElementById('s-rate').value),
            experience: parseInt(document.getElementById('s-exp').value)
        }).eq('id', currentUser.id);
        await loadData();
        notif('âœ… Profil sauvegardÃ©','','green');
    }
});


// ========== ADMIN DASHBOARD ==========
let adminData = { users: [], instructors: [], bookings: [], slots: [] };
let adminTab = 'overview';

async function loadAdminData() {
    const [u, i, b, s] = await Promise.all([
        sb.from('users').select('*').order('created_at', { ascending: false }),
        sb.from('instructors').select('*'),
        sb.from('bookings').select('*').order('created_at', { ascending: false }),
        sb.from('slots').select('*')
    ]);
    adminData.users = u.data || [];
    adminData.instructors = i.data || [];
    adminData.bookings = b.data || [];
    adminData.slots = s.data || [];
    document.getElementById('app').innerHTML = AdminDashboard();
}

function AdminDashboard() {
    const totalRevenue = adminData.bookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid').reduce((s,b)=>s+(b.amount||0),0);
    const totalCommission = Math.round(totalRevenue * COMMISSION);
    const tabs = [{id:'overview',label:'ğŸ“Š Vue globale'},{id:'users',label:'ğŸ‘¥ Utilisateurs'},{id:'instructors',label:'ğŸš— Moniteurs'},{id:'bookings',label:'ğŸ“‹ RÃ©servations'},{id:'danger',label:'âš ï¸ Danger Zone'}];
    return `<div class="min-h-screen bg-gray-900 text-white">
        <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ›¡ï¸</span>
                    <div><h1 class="text-xl font-extrabold text-orange-400">Admin Panel</h1><p class="text-xs text-gray-400">DriveConnect NC</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-400">ğŸ‘‹ ${currentUser.name}</span>
                    <button onclick="showView('student-dashboard')" class="px-3 py-2 text-sm bg-orange-500 hover:bg-orange-600 rounded-xl">ğŸš— App</button>
                    <button onclick="logout()" class="px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 rounded-xl">DÃ©connexion</button>
                </div>
            </div>
        </header>
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700"><p class="text-gray-400 text-sm">Utilisateurs</p><p class="text-3xl font-extrabold">${adminData.users.length}</p></div>
                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700"><p class="text-gray-400 text-sm">Moniteurs</p><p class="text-3xl font-extrabold text-orange-400">${adminData.instructors.length}</p></div>
                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700"><p class="text-gray-400 text-sm">RÃ©servations</p><p class="text-3xl font-extrabold text-green-400">${adminData.bookings.length}</p></div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-5"><p class="text-orange-200 text-sm">Commission totale</p><p class="text-3xl font-extrabold">${totalCommission.toLocaleString()} XPF</p></div>
            </div>
            <div class="bg-gray-800 rounded-3xl overflow-hidden border border-gray-700">
                <div class="flex border-b border-gray-700 overflow-x-auto">
                    ${tabs.map(t=>`<button onclick="switchAdminTab('${t.id}')" class="px-6 py-4 font-semibold whitespace-nowrap text-sm transition ${adminTab===t.id?'text-orange-400 border-b-2 border-orange-400 bg-gray-700':'text-gray-400 hover:text-white'}">${t.label}</button>`).join('')}
                </div>
                <div class="p-6">${getAdminTabContent()}</div>
            </div>
        </div>
    </div>`;
}

function getAdminTabContent() {
    if (adminTab==='overview') return `<h3 class="font-bold text-lg mb-4">ğŸ“‹ DerniÃ¨res rÃ©servations</h3><div class="space-y-3">${adminData.bookings.slice(0,10).map(b=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${b.student_name||'?'} â†’ ${b.instructor_name||'?'}</p><p class="text-sm text-gray-400">ğŸ“… ${b.date} Ã  ${b.time} Â· ${b.amount||0} XPF</p></div><span class="px-3 py-1 rounded-full text-xs font-bold ${b.status==='confirmed'?'bg-green-900 text-green-400':b.status==='cancelled'?'bg-red-900 text-red-400':'bg-yellow-900 text-yellow-400'}">${b.status}</span></div>`).join('')||'<p class="text-gray-400">Aucune rÃ©servation</p>'}</div>`;
    if (adminTab==='users') return `<h3 class="font-bold text-lg mb-4">ğŸ‘¥ Utilisateurs (${adminData.users.length})</h3><div class="space-y-2">${adminData.users.map(u=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${u.name||'?'} ${u.is_admin?'ğŸ›¡ï¸':''}</p><p class="text-sm text-gray-400">${u.email}</p></div><div class="flex gap-2"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.user_type==='student'?'bg-blue-900 text-blue-400':'bg-orange-900 text-orange-400'}">${u.user_type||'?'}</span>${!u.is_admin?`<button onclick="adminDeleteUser('${u.id}')" class="text-red-400 text-xs">ğŸ—‘ï¸</button>`:''}</div></div>`).join('')||'<p class="text-gray-400">Aucun</p>'}</div>`;
    if (adminTab==='instructors') return `<h3 class="font-bold text-lg mb-4">ğŸš— Moniteurs (${adminData.instructors.length})</h3><div class="space-y-2">${adminData.instructors.map(i=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${i.name||'?'}</p><p class="text-sm text-gray-400">ğŸ“ ${i.location||'?'} Â· â­ ${i.rating||0} Â· ${i.hourly_rate||0} XPF/h</p>${i.penalty_until&&new Date(i.penalty_until)>new Date()?'<p class="text-xs text-red-400">âš ï¸ PÃ©nalisÃ©</p>':''}</div><div class="flex gap-2"><span class="px-2 py-1 rounded-full text-xs ${i.is_online?'bg-green-900 text-green-400':'bg-gray-600 text-gray-400'}">${i.is_online?'ğŸŸ¢':'âš«'}</span><button onclick="adminVerifyInstructor('${i.id}',${!i.verified})" class="text-xs px-2 py-1 rounded-lg ${i.verified?'bg-green-800 text-green-400':'bg-gray-600 text-gray-300'}">${i.verified?'âœ…':'VÃ©rifier'}</button>${i.penalty_until?`<button onclick="adminRemovePenalty('${i.id}')" class="text-xs px-2 py-1 bg-red-900 text-red-400 rounded-lg">Lever</button>`:''}</div></div>`).join('')||'<p class="text-gray-400">Aucun</p>'}</div>`;
    if (adminTab==='bookings') return `<h3 class="font-bold text-lg mb-4">ğŸ“‹ RÃ©servations (${adminData.bookings.length})</h3><div class="space-y-2">${adminData.bookings.map(b=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${b.student_name||'?'} â†’ ${b.instructor_name||'?'}</p><p class="text-sm text-gray-400">ğŸ“… ${b.date} Â· ${b.amount||0} XPF Â· Net: ${b.net||0} XPF</p></div><span class="px-3 py-1 rounded-full text-xs font-bold ${b.status==='confirmed'?'bg-green-900 text-green-400':b.status==='cancelled'?'bg-red-900 text-red-400':'bg-yellow-900 text-yellow-400'}">${b.status}</span></div>`).join('')||'<p class="text-gray-400">Aucune</p>'}</div>`;
    if (adminTab==='danger') return `<h3 class="font-bold text-lg mb-4 text-red-400">âš ï¸ Zone Danger</h3><div class="space-y-4"><div class="bg-red-900/30 border border-red-700 rounded-xl p-4"><p class="font-bold text-red-400 mb-1">Nettoyer les crÃ©neaux passÃ©s</p><p class="text-sm text-gray-400 mb-3">Supprime tous les crÃ©neaux dont la date est dÃ©passÃ©e.</p><button onclick="adminCleanSlots()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl text-sm font-bold">ğŸ—‘ï¸ Nettoyer</button></div><div class="bg-gray-700 rounded-xl p-4"><p class="text-sm text-gray-400">ğŸ‘¥ ${adminData.users.length} users Â· ğŸš— ${adminData.instructors.length} moniteurs Â· ğŸ“‹ ${adminData.bookings.length} rÃ©servations Â· ğŸ“… ${adminData.slots.length} crÃ©neaux</p></div></div>`;
    return '';
}

window.switchAdminTab = (t) => { adminTab = t; document.getElementById('app').innerHTML = AdminDashboard(); };
window.adminVerifyInstructor = async (id, v) => { await sb.from('instructors').update({verified:v}).eq('id',id); notif(v?'âœ… VÃ©rifiÃ©':'RetirÃ©','','green'); await loadAdminData(); };
window.adminRemovePenalty = async (id) => { await sb.from('instructors').update({penalty_until:null,visibility_penalty:0}).eq('id',id); notif('âœ… PÃ©nalitÃ© levÃ©e','','green'); await loadAdminData(); };
window.adminDeleteUser = async (id) => { if(!confirm('Supprimer ?')) return; await sb.from('users').delete().eq('id',id); notif('SupprimÃ©','','red'); await loadAdminData(); };
window.adminCleanSlots = async () => { if(!confirm('Supprimer crÃ©neaux passÃ©s ?')) return; const t=new Date().toISOString().split('T')[0]; await sb.from('slots').delete().lt('date',t); notif('âœ… NettoyÃ©','','green'); await loadAdminData(); };


function render() {
    if(map){map.remove();map=null;iMarkers=[];}
    const app=document.getElementById('app');
    switch(currentView){
        case 'home':                app.innerHTML=HomePage(); break;
        case 'student-login':       app.innerHTML=LoginPage('student');    setupLoginForm('student');    break;
        case 'instructor-login':    app.innerHTML=LoginPage('instructor'); setupLoginForm('instructor'); break;
        case 'student-dashboard':   app.innerHTML=StudentDashboard();      setTimeout(()=>initMap(),100); break;
        case 'instructor-dashboard':app.innerHTML=InstructorDashboard();   setTimeout(()=>initMap(),100); break;
        case 'admin':               loadAdminData(); break;
    }
}

// ========== DÃ‰MARRAGE ==========
async function boot() {
    document.getElementById('app').innerHTML = '<div class="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center"><div class="text-center"><div class="text-5xl mb-4">ğŸš—</div><p class="text-xl font-bold text-orange-600">DriveConnect NC</p><p class="text-gray-400 mt-2">Connexion Ã  la base de donnÃ©es...</p><div class="mt-4 w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div></div>';

    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        const { data: profile } = await sb.from('users').select('*').eq('id', session.user.id).single();
        if (profile) {
            currentUser = { ...profile, ...session.user };
            if (profile.is_admin) {
                currentView = 'admin';
            } else {
                currentView = profile.user_type === 'student' ? 'student-dashboard' : 'instructor-dashboard';
            }
        }
    }

    await loadData();
    render();

    setInterval(async () => {
        if (!document.hidden && currentView !== 'admin') {
            await loadData();
            if (currentUser) render();
        }
    }, 15000);
}

boot();
</script>
</body>
</html>
