<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>DriveConnect NC ‚Äî Cours de conduite √† Noum√©a</title>
    <meta name="description" content="Trouvez un moniteur de conduite qualifi√© √† Noum√©a en quelques clics. R√©servez, payez, roulez.">
    <meta property="og:title" content="DriveConnect NC">
    <meta property="og:description" content="La plateforme de cours de conduite en Nouvelle-Cal√©donie">
    <meta name="theme-color" content="#FF5A1F">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DriveConnect">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cabinet+Grotesk:wght@400;500;700;800;900&family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=EH6_wDSUHjZ155FCNOGogvRtTF11v1yr-I42_7VsyiHE9dDdc8slqZZ43aMXXJr0WS_LW4JXKU36H0VC&currency=USD&locale=fr_FR"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- STYLES LANDING -->
    <style id="landing-styles">

        #landing-page {
            --orange: #FF5A1F;
            --orange-light: #FF8C42;
            --dark: #0D0D0D;
            --dark-2: #1A1A1A;
            --dark-3: #252525;
            --text: #F5F0EB;
            --text-muted: rgba(245,240,235,0.45);
            --border: rgba(245,240,235,0.08);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html { scroll-behavior: smooth; }

        #landing-page {
            background: var(--dark);
            color: var(--text);
            font-family: 'Cabinet Grotesk', sans-serif;
            overflow-x: hidden;
            }


        /* GRAIN OVERLAY */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1;
            opacity: 0.4;
        }

        /* NAV */
        nav {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            padding: 24px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(13,13,13,0.9), transparent);
        }
        .nav-logo {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        .nav-logo span { color: var(--orange); }
        .nav-cta {
            background: var(--orange);
            color: white;
            padding: 10px 22px;
            border-radius: 100px;
            font-weight: 700;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s;
            display: inline-block;
        }
        .nav-cta:hover { background: var(--orange-light); transform: translateY(-1px); }

        /* HERO */
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 120px 48px 80px;
            position: relative;
            overflow: hidden;
        }

        /* Cercle d√©coratif */
        .hero::after {
            content: '';
            position: absolute;
            right: -200px;
            top: 50%;
            transform: translateY(-50%);
            width: 700px;
            height: 700px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,90,31,0.12) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,90,31,0.12);
            border: 1px solid rgba(255,90,31,0.25);
            color: var(--orange-light);
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 32px;
            width: fit-content;
        }
        .hero-tag::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--orange);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .hero h1 {
            font-family: 'DM Serif Display', serif;
            font-size: clamp(52px, 8vw, 96px);
            line-height: 1.0;
            letter-spacing: -2px;
            margin-bottom: 28px;
            max-width: 780px;
        }
        .hero h1 em {
            font-style: italic;
            color: var(--orange);
        }
        .hero h1 .line-2 {
            display: block;
            color: var(--text-muted);
        }

        .hero-sub {
            font-size: 18px;
            color: var(--text-muted);
            max-width: 440px;
            line-height: 1.6;
            margin-bottom: 48px;
            font-weight: 400;
        }

        .hero-btns {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn-hero-primary {
            background: var(--orange);
            color: white;
            padding: 16px 32px;
            border-radius: 100px;
            font-weight: 800;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.25s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-hero-primary:hover { background: var(--orange-light); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(255,90,31,0.35); }
        .btn-hero-secondary {
            background: transparent;
            color: var(--text);
            padding: 16px 32px;
            border-radius: 100px;
            font-weight: 700;
            font-size: 16px;
            text-decoration: none;
            border: 1.5px solid var(--border);
            transition: all 0.25s;
        }
        .btn-hero-secondary:hover { border-color: rgba(245,240,235,0.3); background: rgba(245,240,235,0.05); }

        /* SCROLL INDICATOR */
        .scroll-hint {
            position: absolute;
            bottom: 40px;
            left: 48px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
        }
        .scroll-line {
            width: 40px;
            height: 1px;
            background: var(--text-muted);
            animation: scrollLine 2s ease-in-out infinite;
        }
        @keyframes scrollLine {
            0% { transform: scaleX(0); transform-origin: left; }
            50% { transform: scaleX(1); transform-origin: left; }
            51% { transform: scaleX(1); transform-origin: right; }
            100% { transform: scaleX(0); transform-origin: right; }
        }

        /* STATS MARQUEE */
        .stats-band {
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            overflow: hidden;
            position: relative;
        }
        .marquee-track {
            display: flex;
            gap: 0;
            animation: marquee 20s linear infinite;
            width: max-content;
        }
        .marquee-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 0 48px;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }
        .marquee-item strong { color: var(--text); font-size: 15px; }
        .marquee-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--orange); }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* FEATURES */
        .section { padding: 120px 48px; max-width: 1200px; margin: 0 auto; }

        .section-label {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--orange);
            margin-bottom: 20px;
        }
        .section-title {
            font-family: 'DM Serif Display', serif;
            font-size: clamp(36px, 5vw, 56px);
            line-height: 1.1;
            letter-spacing: -1px;
            margin-bottom: 16px;
        }
        .section-sub {
            color: var(--text-muted);
            font-size: 17px;
            max-width: 480px;
            line-height: 1.6;
            margin-bottom: 64px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            background: var(--border);
            border-radius: 24px;
            overflow: hidden;
        }
        .feature-card {
            background: var(--dark-2);
            padding: 40px 36px;
            transition: background 0.3s;
        }
        .feature-card:hover { background: var(--dark-3); }
        .feature-icon {
            width: 48px; height: 48px;
            border-radius: 14px;
            background: rgba(255,90,31,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 24px;
            border: 1px solid rgba(255,90,31,0.2);
        }
        .feature-card h3 {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }
        .feature-card p {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* SPLIT SECTION */
        .split-section {
            padding: 120px 48px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 80px;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        .split-visual {
            border-radius: 28px;
            overflow: hidden;
            background: var(--dark-2);
            border: 1px solid var(--border);
            padding: 40px;
            position: relative;
        }
        .split-visual::before {
            content: '';
            position: absolute;
            top: -1px; left: 24px; right: 24px;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--orange), transparent);
        }

        /* MOCK CARD */
        .mock-card {
            background: var(--dark-3);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 12px;
        }
        .mock-card-header {
            background: linear-gradient(135deg, #1A1A1A, #2D2D2D);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .mock-avatar {
            width: 48px; height: 48px;
            border-radius: 14px;
            background: var(--orange);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
        }
        .mock-name { font-weight: 700; font-size: 15px; }
        .mock-loc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .mock-badge {
            margin-left: auto;
            background: #DCFCE7;
            color: #16A34A;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 100px;
        }
        .mock-body { padding: 16px 20px; }
        .mock-price { font-size: 22px; font-weight: 800; }
        .mock-price span { font-size: 13px; font-weight: 400; color: var(--text-muted); }
        .mock-stars { color: #F59E0B; font-size: 13px; margin-top: 4px; }
        .mock-btn {
            display: block;
            width: 100%;
            background: var(--orange);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            margin-top: 14px;
            cursor: pointer;
            font-family: 'Cabinet Grotesk', sans-serif;
        }

        /* PRICING */
        .pricing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 48px;
        }
        .pricing-card {
            background: var(--dark-2);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }
        .pricing-card:hover { transform: translateY(-4px); border-color: rgba(255,90,31,0.3); }
        .pricing-card.featured {
            border-color: rgba(255,90,31,0.4);
            background: linear-gradient(135deg, rgba(255,90,31,0.08), var(--dark-2));
        }
        .pricing-card.featured::before {
            content: 'Moniteurs';
            position: absolute;
            top: 20px; right: 20px;
            background: var(--orange);
            color: white;
            font-size: 11px;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 100px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .pricing-who { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .pricing-amount { font-size: 48px; font-weight: 900; letter-spacing: -2px; }
        .pricing-amount sup { font-size: 22px; font-weight: 700; vertical-align: super; }
        .pricing-amount sub { font-size: 14px; font-weight: 500; color: var(--text-muted); }
        .pricing-desc { color: var(--text-muted); font-size: 14px; line-height: 1.5; margin: 16px 0 28px; }
        .pricing-features { list-style: none; space-y: 12px; }
        .pricing-features li {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .pricing-features li::before {
            content: '‚úì';
            color: var(--orange);
            font-weight: 800;
            flex-shrink: 0;
        }

        /* CTA FINAL */
        .cta-section {
            margin: 0 48px 120px;
            background: var(--orange);
            border-radius: 32px;
            padding: 80px 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 40px;
            position: relative;
            overflow: hidden;
        }
        .cta-section::before {
            content: '';
            position: absolute;
            right: -100px; top: -100px;
            width: 400px; height: 400px;
            border-radius: 50%;
            background: rgba(255,255,255,0.08);
        }
        .cta-section::after {
            content: '';
            position: absolute;
            right: 80px; bottom: -60px;
            width: 250px; height: 250px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
        }
        .cta-title {
            font-family: 'DM Serif Display', serif;
            font-size: clamp(32px, 4vw, 48px);
            line-height: 1.1;
            letter-spacing: -1px;
            color: white;
        }
        .cta-sub { color: rgba(255,255,255,0.7); font-size: 16px; margin-top: 12px; }
        .cta-btn {
            background: white;
            color: var(--orange);
            padding: 18px 40px;
            border-radius: 100px;
            font-weight: 800;
            font-size: 16px;
            text-decoration: none;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        .cta-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.2); }

        /* FOOTER */
        footer {
            border-top: 1px solid var(--border);
            padding: 40px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 13px;
        }
        footer a { color: var(--text-muted); text-decoration: none; margin-left: 24px; }
        footer a:hover { color: var(--text); }

        /* ANIMATIONS SCROLL */
        .reveal {
            opacity: 0;
            transform: translateY(32px);
            transition: opacity 0.7s ease, transform 0.7s ease;
        }
        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .reveal-delay-1 { transition-delay: 0.1s; }
        .reveal-delay-2 { transition-delay: 0.2s; }
        .reveal-delay-3 { transition-delay: 0.3s; }

        /* MOBILE */
        @media (max-width: 768px) {
            nav { padding: 20px 24px; }
            .hero { padding: 100px 24px 80px; }
            .hero::after { display: none; }
            .section { padding: 80px 24px; }
            .features-grid { grid-template-columns: 1fr; }
            .split-section { grid-template-columns: 1fr; padding: 80px 24px; gap: 48px; }
            .pricing-grid { grid-template-columns: 1fr; }
            .cta-section { flex-direction: column; text-align: center; margin: 0 24px 80px; padding: 56px 32px; }
            footer { flex-direction: column; gap: 16px; text-align: center; padding: 32px 24px; }
            footer a { margin: 0 12px; }

        }
    
    </style>

    <!-- STYLES APP -->
<style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap');
        :root {
            --primary: #FF5A1F;
            --primary-dark: #e04a12;
            --surface: #FFFFFF;
            --bg: #F7F7F7;
            --text: #1A1A1A;
            --text-muted: #717171;
            --border: #EBEBEB;
            --shadow: 0 2px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.12);
            --radius: 16px;
            --radius-lg: 24px;
        }
        * { font-family: 'DM Sans', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); overscroll-behavior-y: contain; }
        input, textarea, select { font-size: 16px !important; font-family: 'DM Sans', sans-serif; }

        /* TYPOGRAPHIE */
        .display-font { font-family: 'DM Serif Display', serif; }
        .gradient-text { background: linear-gradient(135deg, #FF5A1F, #FF8C42); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        /* COMPOSANTS */
        .card { background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border); }
        .btn-primary { background: var(--primary); color: white; border-radius: 12px; font-weight: 600; padding: 14px 24px; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(255,90,31,0.3); }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1.5px solid var(--border); border-radius: 12px; font-weight: 600; padding: 13px 24px; transition: all 0.2s; cursor: pointer; }
        .btn-secondary:hover { border-color: var(--text); background: var(--bg); }
        .input-field { width: 100%; padding: 14px 16px; border: 1.5px solid var(--border); border-radius: 12px; outline: none; background: var(--surface); color: var(--text); transition: border-color 0.2s; }
        .input-field:focus { border-color: var(--primary); }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 100px; font-size: 12px; font-weight: 600; }
        .badge-green { background: #ECFDF5; color: #059669; }
        .badge-red { background: #FEF2F2; color: #DC2626; }
        .badge-yellow { background: #FFFBEB; color: #D97706; }
        .badge-orange { background: #FFF7ED; color: #EA580C; }
        .badge-gray { background: #F3F4F6; color: #6B7280; }
        .badge-online { background: #DCFCE7; color: #16A34A; }

        /* MAP */
        #map { height: 380px; width: 100%; border-radius: var(--radius); overflow: hidden; }
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }

        /* TABS */
        .tab-btn { transition: all 0.2s; color: var(--text-muted); font-weight: 500; padding: 14px 20px; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
        .tab-btn:hover { color: var(--text); }

        /* ANIMATIONS */
        @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideIn { from { opacity:0; transform:translateX(-8px); } to { opacity:1; transform:translateX(0); } }
        .fade-in { animation: fadeUp 0.35s ease forwards; }
        .slide-in { animation: slideIn 0.25s ease forwards; }

        /* HEADER */
        .app-header { background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 40; }

        /* INSTRUCTOR CARD */
        .instructor-card { background: var(--surface); border-radius: var(--radius-lg); border: 1.5px solid var(--border); overflow: hidden; transition: all 0.25s; cursor: pointer; }
        .instructor-card:hover { border-color: var(--primary); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        .instructor-card-header { background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%); padding: 24px; }

        /* MODE SOMBRE */
        .dark { --surface: #1C1C1E; --bg: #000000; --text: #F5F5F5; --text-muted: #8E8E93; --border: #2C2C2E; --shadow: 0 2px 16px rgba(0,0,0,0.4); }
        .dark .app-header { background: rgba(28,28,30,0.92); }
        .dark .input-field { background: #2C2C2E; color: #F5F5F5; }
        .dark .badge-gray { background: #3A3A3C; color: #AEAEB2; }

        /* MOBILE */
        @media (max-width: 640px) {
            .grid-cols-mobile-1 { grid-template-columns: 1fr !important; }
            .hide-mobile { display: none !important; }
        }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* MODE SOMBRE */
        .dark body { background: #0f172a !important; color: #e2e8f0 !important; }
        .dark .bg-white { background: #1e293b !important; }
        .dark .bg-gray-50 { background: #0f172a !important; }
        .dark .bg-gray-100 { background: #1e293b !important; }
        .dark .border-gray-100, .dark .border-gray-200 { border-color: #334155 !important; }
        .dark .text-gray-400 { color: #94a3b8 !important; }
        .dark .text-gray-500 { color: #94a3b8 !important; }
        .dark .text-gray-600 { color: #cbd5e1 !important; }
        .dark .text-gray-800 { color: #e2e8f0 !important; }
        .dark .shadow-xl { box-shadow: 0 20px 60px rgba(0,0,0,0.4) !important; }
        .dark .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; }
        .dark input { background: #0f172a !important; color: #e2e8f0 !important; border-color: #334155 !important; }
        .dark .bg-orange-50 { background: #1c1108 !important; }
        .dark header { background: #1e293b !important; border-color: #334155 !important; }
        .dark .tab-btn { color: #94a3b8; }
        .dark .tab-btn.active { color: #f97316; }
        /* √âTOILES */
        .stars { display:flex; gap:4px; }
        .star { font-size:1.5rem; cursor:pointer; transition: transform 0.1s; }
        .star:hover { transform: scale(1.2); }

        /* ===== INSTRUCTOR DASHBOARD REDESIGN ===== */
        .dash-header {
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-bottom: 1px solid #F0F0F0;
            position: sticky; top: 0; z-index: 50;
            padding: 0 24px;
        }
        .dark .dash-header {
            background: rgba(18,18,18,0.96);
            border-bottom-color: #2A2A2A;
        }
        .dash-header-inner {
            max-width: 1100px; margin: 0 auto;
            height: 60px; display: flex; align-items: center;
            justify-content: space-between; gap: 16px;
        }
        .dash-logo {
            font-size: 17px; font-weight: 800; letter-spacing: -0.4px;
            color: var(--text);
        }
        .dash-logo span { color: var(--primary); }
        .status-pill {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 7px 14px; border-radius: 100px;
            font-size: 12px; font-weight: 700; letter-spacing: 0.2px;
            border: 1.5px solid; cursor: pointer; transition: all 0.2s;
        }
        .status-pill.online {
            color: #16A34A; border-color: #86EFAC;
            background: #F0FDF4;
        }
        .status-pill.offline {
            color: #6B7280; border-color: #E5E7EB;
            background: #F9FAFB;
        }
        .dark .status-pill.offline {
            color: #9CA3AF; border-color: #3A3A3A; background: #1E1E1E;
        }
        .status-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: currentColor;
        }
        .status-pill.online .status-dot {
            animation: blink 2s ease-in-out infinite;
        }
        @keyframes blink {
            0%,100%{opacity:1} 50%{opacity:0.4}
        }
        .dash-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; border: none;
            background: var(--bg); transition: all 0.2s;
            color: var(--text-muted);
        }
        .icon-btn:hover { background: var(--border); }
        .logout-btn {
            font-size: 13px; font-weight: 600; padding: 7px 14px;
            border-radius: 100px; border: 1.5px solid var(--border);
            background: transparent; cursor: pointer; color: var(--text-muted);
            transition: all 0.2s;
        }
        .logout-btn:hover { border-color: var(--text-muted); color: var(--text); }

        /* MAIN LAYOUT */
        .dash-body {
            max-width: 1100px; margin: 0 auto;
            padding: 28px 20px 60px;
        }
        @media(min-width:768px){ .dash-body { padding: 36px 24px 80px; } }

        /* REVENUE HERO CARD */
        .revenue-hero {
            border-radius: 24px; padding: 28px;
            background: linear-gradient(135deg, #111 0%, #222 100%);
            position: relative; overflow: hidden; margin-bottom: 16px;
        }
        .revenue-hero::before {
            content:'';
            position:absolute; top:-80px; right:-80px;
            width:220px;height:220px;border-radius:50%;
            background: radial-gradient(circle, rgba(255,90,31,0.18) 0%, transparent 70%);
        }
        .revenue-hero::after {
            content:'';
            position:absolute; bottom:-40px; left:30%;
            width:160px;height:160px;border-radius:50%;
            background: radial-gradient(circle, rgba(255,90,31,0.1) 0%, transparent 70%);
        }
        .revenue-label {
            font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
            text-transform: uppercase; color: rgba(255,255,255,0.4);
            margin-bottom: 10px;
        }
        .revenue-amount {
            font-size: 42px; font-weight: 900; color: white;
            letter-spacing: -2px; line-height: 1; margin-bottom: 8px;
        }
        .revenue-amount span {
            font-size: 18px; font-weight: 400;
            color: rgba(255,255,255,0.35); letter-spacing: 0;
        }
        .revenue-sub { font-size: 13px; color: rgba(255,255,255,0.35); }
        .revenue-badge {
            position: absolute; top: 24px; right: 24px;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.6); font-size: 11px; font-weight: 700;
            padding: 5px 12px; border-radius: 100px; letter-spacing: 0.5px;
        }

        /* STAT CARDS ROW */
        .stats-row {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 12px; margin-bottom: 20px;
        }
        .stat-card {
            background: white; border-radius: 18px;
            border: 1px solid #F0F0F0; padding: 18px 16px;
            transition: all 0.2s; cursor: default;
        }
        .dark .stat-card { background: #1C1C1E; border-color: #2C2C2E; }
        .stat-card.clickable { cursor: pointer; }
        .stat-card.clickable:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
        .stat-card-icon {
            width: 34px; height: 34px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; margin-bottom: 12px;
        }
        .stat-icon-blue { background: #EFF6FF; }
        .stat-icon-purple { background: #F5F3FF; }
        .stat-icon-orange { background: #FFF7ED; }
        .stat-card-value {
            font-size: 26px; font-weight: 800; color: var(--text);
            letter-spacing: -1px; line-height: 1;
        }
        .stat-card-value.accent { color: var(--primary); }
        .stat-card-label {
            font-size: 11px; color: var(--text-muted); margin-top: 4px;
            font-weight: 500;
        }
        .stat-card-sub {
            font-size: 10px; color: var(--text-muted); margin-top: 2px;
        }

        /* MAP CARD */
        .map-card {
            background: white; border-radius: 20px;
            border: 1px solid #F0F0F0;
            overflow: hidden; margin-bottom: 20px;
        }
        .dark .map-card { background: #1C1C1E; border-color: #2C2C2E; }
        .map-card-header {
            padding: 18px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #F5F5F5;
        }
        .dark .map-card-header { border-bottom-color: #2C2C2E; }
        .map-card-title {
            font-size: 15px; font-weight: 700; color: var(--text);
        }
        .map-card-sub {
            font-size: 11px; color: var(--text-muted); margin-top: 2px;
        }
        .gps-btn {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--primary); color: white;
            padding: 9px 16px; border-radius: 12px; border: none;
            font-size: 12px; font-weight: 700; cursor: pointer;
            transition: all 0.2s; font-family: 'DM Sans', sans-serif;
        }
        .gps-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }

        /* TABS REDESIGN */
        .tabs-card {
            background: white; border-radius: 20px;
            border: 1px solid #F0F0F0; overflow: hidden;
        }
        .dark .tabs-card { background: #1C1C1E; border-color: #2C2C2E; }
        .tabs-nav {
            display: flex; overflow-x: auto;
            border-bottom: 1px solid #F0F0F0;
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
            padding: 0 8px;
        }
        .tabs-nav::-webkit-scrollbar { display: none; }
        .dark .tabs-nav { border-bottom-color: #2C2C2E; }
        .tab-pill {
            flex-shrink: 0; padding: 0 16px; height: 52px;
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            border: none; background: transparent; border-bottom: 2px solid transparent;
            color: var(--text-muted); transition: all 0.2s;
            white-space: nowrap; font-family: 'DM Sans', sans-serif;
            margin-bottom: -1px;
        }
        .tab-pill.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-pill:hover:not(.active) { color: var(--text); }
        .tab-pill-icon { font-size: 15px; }
        .tab-body { padding: 24px 20px; }
        @media(min-width:640px){ .tab-body { padding: 28px; } }

        /* SLOT ITEMS */
        .slot-item {
            border: 1.5px solid #F0F0F0; border-radius: 16px;
            padding: 16px; transition: all 0.2s;
        }
        .dark .slot-item { border-color: #2C2C2E; }
        .slot-item.booked { border-color: #BFDBFE; background: #EFF6FF; }
        .dark .slot-item.booked { border-color: #1D4ED8; background: rgba(29,78,216,0.12); }
        .slot-date { font-size: 14px; font-weight: 700; color: var(--text); }
        .slot-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .slot-student { font-size: 12px; color: #2563EB; margin-top: 4px; font-weight: 600; }
        .slot-status-badge {
            font-size: 11px; font-weight: 700;
            padding: 4px 10px; border-radius: 100px;
        }
        .add-slot-btn {
            width: 100%; padding: 14px;
            border: 2px dashed #E5E7EB; border-radius: 16px;
            background: transparent; cursor: pointer;
            font-size: 13px; font-weight: 600; color: var(--text-muted);
            transition: all 0.2s; font-family: 'DM Sans', sans-serif;
            margin-top: 8px;
        }
        .add-slot-btn:hover { border-color: var(--primary); color: var(--primary); background: #FFF7ED; }

        /* BOOKING ITEMS */
        .booking-item {
            border: 1.5px solid #F0F0F0; border-radius: 16px;
            padding: 16px; transition: background 0.2s;
        }
        .dark .booking-item { border-color: #2C2C2E; }
        .booking-student { font-size: 14px; font-weight: 700; color: var(--text); }
        .booking-info { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
        .booking-amount { font-size: 14px; font-weight: 700; color: var(--primary); }

        /* EARNINGS */
        .earnings-hero {
            background: linear-gradient(135deg, #FF5A1F, #FF8C42);
            border-radius: 18px; padding: 22px;
            color: white; margin-bottom: 16px;
        }
        .earnings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .earnings-mini {
            background: white; border: 1px solid #F0F0F0;
            border-radius: 16px; padding: 16px;
        }
        .dark .earnings-mini { background: #1C1C1E; border-color: #2C2C2E; }
        .month-bar {
            background: #F5F5F5; border-radius: 12px; padding: 14px 16px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .dark .month-bar { background: #252525; }
        .month-bar-track {
            height: 3px; background: #E5E7EB; border-radius: 2px;
            margin-top: 6px; overflow: hidden;
        }
        .dark .month-bar-track { background: #3A3A3A; }
        .month-bar-fill { height: 100%; background: var(--primary); border-radius: 2px; }

        /* SETTINGS */
        .settings-section { margin-bottom: 24px; }
        .settings-label {
            font-size: 11px; font-weight: 700; letter-spacing: 1px;
            text-transform: uppercase; color: var(--text-muted);
            margin-bottom: 12px; display: block;
        }
        .avatar-upload-zone {
            border-radius: 18px; padding: 24px;
            border: 2px dashed #E5E7EB; background: #FAFAFA;
            display: flex; flex-direction: column; align-items: center;
            gap: 12px; text-align: center;
        }
        .dark .avatar-upload-zone { border-color: #3A3A3A; background: #1A1A1A; }

        /* SECTION HEADER */
        .section-hdr {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .section-hdr h3 {
            font-size: 16px; font-weight: 700; color: var(--text);
        }

        /* ACTION BTNS IN SLOTS */
        .danger-link {
            font-size: 11px; color: #EF4444; font-weight: 600;
            background: none; border: none; cursor: pointer;
            padding: 4px 0; font-family: 'DM Sans', sans-serif;
        }
        .danger-link:hover { text-decoration: underline; }

        /* EMPTY STATES */
        .empty-state {
            text-align: center; padding: 48px 24px;
            color: var(--text-muted);
        }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state-text { font-size: 14px; font-weight: 500; }

    </style>
</head>
<body style="background:#0D0D0D;margin:0;padding:0">

<!-- ========== LANDING PAGE ========== -->
<div id="landing-page">


<!-- NAV -->
<nav>
    <div class="nav-logo">Drive<span>Connect</span> NC</div>
    <a href="/app.html" class="nav-cta">Commencer ‚Üí</a>
</nav>

<!-- HERO -->
<section class="hero">
    <div class="hero-tag">Disponible √† Noum√©a ¬∑ Nouvelle-Cal√©donie</div>
    <h1>
        R√©servez votre <em>moniteur</em>
        <span class="line-2">en 2 minutes.</span>
    </h1>
    <p class="hero-sub">Trouvez un moniteur de conduite qualifi√© pr√®s de chez vous, payez en ligne, et prenez la route.</p>
    <div class="hero-btns">
        <a href="/app.html" class="btn-hero-primary">
            Trouver un moniteur
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </a>
        <a href="/app.html" class="btn-hero-secondary">Je suis moniteur</a>
    </div>
    <div class="scroll-hint">
        <div class="scroll-line"></div>
        D√©couvrir
    </div>
</section>

<!-- STATS MARQUEE -->
<div class="stats-band">
    <div class="marquee-track" id="marquee">
        <div class="marquee-item"><strong>100%</strong> Moniteurs v√©rifi√©s <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>2%</strong> Commission seulement <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Noum√©a</strong> & Grande Terre <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Paiement</strong> s√©curis√© en ligne <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Chat</strong> direct avec le moniteur <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Temps r√©el</strong> sur la carte <div class="marquee-dot"></div></div>
        <!-- Dupliquer pour loop infinie -->
        <div class="marquee-item"><strong>100%</strong> Moniteurs v√©rifi√©s <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>2%</strong> Commission seulement <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Noum√©a</strong> & Grande Terre <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Paiement</strong> s√©curis√© en ligne <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Chat</strong> direct avec le moniteur <div class="marquee-dot"></div></div>
        <div class="marquee-item"><strong>Temps r√©el</strong> sur la carte <div class="marquee-dot"></div></div>
    </div>
</div>

<!-- FEATURES -->
<div class="section">
    <p class="section-label reveal">Pourquoi DriveConnect</p>
    <h2 class="section-title reveal reveal-delay-1">Tout ce qu'il faut<br>pour apprendre √† conduire</h2>
    <p class="section-sub reveal reveal-delay-2">Une plateforme pens√©e pour la Nouvelle-Cal√©donie, simple et transparente.</p>

    <div class="features-grid">
        <div class="feature-card reveal">
            <div class="feature-icon">üó∫Ô∏è</div>
            <h3>Carte en temps r√©el</h3>
            <p>Visualisez les moniteurs disponibles pr√®s de vous sur une carte interactive. Voyez leur position et disponibilit√© en direct.</p>
        </div>
        <div class="feature-card reveal reveal-delay-1">
            <div class="feature-icon">üí≥</div>
            <h3>Paiement s√©curis√©</h3>
            <p>R√©glez vos cours directement en ligne via PayPal. Remboursement automatique en cas d'annulation selon nos conditions.</p>
        </div>
        <div class="feature-card reveal reveal-delay-2">
            <div class="feature-icon">üí¨</div>
            <h3>Chat instantan√©</h3>
            <p>Communiquez directement avec votre moniteur avant et apr√®s le cours. Messages en temps r√©el, sans d√©lai.</p>
        </div>
        <div class="feature-card reveal">
            <div class="feature-icon">‚≠ê</div>
            <h3>Avis v√©rifi√©s</h3>
            <p>Seuls les √©l√®ves ayant effectu√© un cours peuvent laisser une note. Des avis authentiques pour choisir en confiance.</p>
        </div>
        <div class="feature-card reveal reveal-delay-1">
            <div class="feature-icon">üìÖ</div>
            <h3>R√©servation simple</h3>
            <p>Choisissez un cr√©neau, payez, c'est r√©serv√©. Le moniteur confirme et vous recevez un email de confirmation.</p>
        </div>
        <div class="feature-card reveal reveal-delay-2">
            <div class="feature-icon">‚úÖ</div>
            <h3>Moniteurs v√©rifi√©s</h3>
            <p>Chaque moniteur est v√©rifi√© par notre √©quipe avant d'appara√Ætre sur la plateforme. Votre s√©curit√© est notre priorit√©.</p>
        </div>
    </div>
</div>

<!-- SPLIT - Pour les √©l√®ves -->
<div class="split-section">
    <div>
        <p class="section-label reveal">Pour les √©l√®ves</p>
        <h2 class="section-title reveal reveal-delay-1">Trouvez, r√©servez,<br>conduisez.</h2>
        <p class="section-sub reveal reveal-delay-2">En quelques clics, choisissez le moniteur qui vous convient selon sa note, son tarif et sa localisation.</p>
        <a href="/app.html" class="btn-hero-primary reveal reveal-delay-3" style="display:inline-flex">
            Cr√©er un compte √©l√®ve ‚Üí
        </a>
    </div>
    <div class="split-visual reveal">
        <div class="mock-card">
            <div class="mock-card-header">
                <div class="mock-avatar">JM</div>
                <div>
                    <div class="mock-name">Jean-Marie Kalepo</div>
                    <div class="mock-loc">üìç Dumb√©a ¬∑ 8 ans d'exp.</div>
                </div>
                <div class="mock-badge">‚óè En ligne</div>
            </div>
            <div class="mock-body">
                <div class="mock-price">4 500 <span>XPF/h</span></div>
                <div class="mock-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ <span style="color:var(--text-muted);font-size:12px">4.9 (23 avis)</span></div>
                <button class="mock-btn">Voir les cr√©neaux</button>
            </div>
        </div>
        <div class="mock-card" style="opacity:0.6">
            <div class="mock-card-header">
                <div class="mock-avatar" style="background:#6B7280">SP</div>
                <div>
                    <div class="mock-name">Sophie Paita</div>
                    <div class="mock-loc">üìç Noum√©a ¬∑ 5 ans d'exp.</div>
                </div>
                <div class="mock-badge" style="background:#F3F4F6;color:#6B7280">‚óã Hors ligne</div>
            </div>
            <div class="mock-body">
                <div class="mock-price">5 000 <span>XPF/h</span></div>
                <div class="mock-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ <span style="color:var(--text-muted);font-size:12px">4.2 (11 avis)</span></div>
            </div>
        </div>
        <div style="text-align:center;padding:12px 0;font-size:13px;color:var(--text-muted)">+ plusieurs moniteurs disponibles</div>
    </div>
</div>

<!-- SPLIT - Pour les moniteurs -->
<div class="split-section" style="direction:rtl">
    <div style="direction:ltr">
        <p class="section-label reveal">Pour les moniteurs</p>
        <h2 class="section-title reveal reveal-delay-1">G√©rez votre activit√©<br>sans effort.</h2>
        <p class="section-sub reveal reveal-delay-2">Cr√©ez votre profil, publiez vos cr√©neaux, recevez les paiements. On s'occupe du reste avec seulement 2% de commission.</p>
        <a href="/app.html" class="btn-hero-primary reveal reveal-delay-3" style="display:inline-flex">
            Devenir moniteur ‚Üí
        </a>
    </div>
    <div class="split-visual reveal" style="direction:ltr">
        <!-- Dashboard mockup -->
        <div style="background:linear-gradient(135deg,#1A1A1A,#2D2D2D);border-radius:16px;padding:20px;margin-bottom:12px">
            <p style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:4px">Revenus nets totaux</p>
            <p style="font-size:32px;font-weight:800;color:white">127 500 <span style="font-size:16px;font-weight:400;color:rgba(255,255,255,0.4)">XPF</span></p>
            <p style="font-size:12px;color:rgba(255,255,255,0.3);margin-top:4px">28 cours pay√©s ce mois</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div style="background:var(--dark-3);border-radius:14px;padding:16px;text-align:center;border:1px solid var(--border)">
                <p style="font-size:22px;font-weight:800">28</p>
                <p style="font-size:11px;color:var(--text-muted);margin-top:4px">R√©servations</p>
            </div>
            <div style="background:var(--dark-3);border-radius:14px;padding:16px;text-align:center;border:1px solid var(--border)">
                <p style="font-size:22px;font-weight:800">6</p>
                <p style="font-size:11px;color:var(--text-muted);margin-top:4px">Cr√©neaux</p>
            </div>
            <div style="background:var(--dark-3);border-radius:14px;padding:16px;text-align:center;border:1px solid var(--border)">
                <p style="font-size:22px;font-weight:800;color:var(--orange)">4.8</p>
                <p style="font-size:11px;color:var(--text-muted);margin-top:4px">Note /5</p>
            </div>
        </div>
    </div>
</div>

<!-- PRICING -->
<div class="section" style="padding-top:0">
    <p class="section-label reveal">Tarification</p>
    <h2 class="section-title reveal reveal-delay-1">Simple et transparent</h2>
    <p class="section-sub reveal reveal-delay-2">Pas d'abonnement, pas de frais cach√©s. Vous payez uniquement quand vous utilisez la plateforme.</p>

    <div class="pricing-grid">
        <div class="pricing-card reveal">
            <p class="pricing-who">√âl√®ves</p>
            <div class="pricing-amount"><sup></sup>Gratuit<sub></sub></div>
            <p class="pricing-desc">L'inscription et la recherche de moniteurs sont enti√®rement gratuites. Vous payez uniquement le cours.</p>
            <ul class="pricing-features">
                <li>Acc√®s √† tous les moniteurs</li>
                <li>Carte interactive en temps r√©el</li>
                <li>R√©servation et paiement en ligne</li>
                <li>Chat avec le moniteur</li>
                <li>Remboursement en cas d'annulation</li>
            </ul>
        </div>
        <div class="pricing-card featured reveal reveal-delay-1">
            <p class="pricing-who">Moniteurs</p>
            <div class="pricing-amount"><sup></sup>2%<sub> / cours</sub></div>
            <p class="pricing-desc">Une commission de 2% uniquement sur les cours effectu√©s et pay√©s. Z√©ro frais fixe, z√©ro risque.</p>
            <ul class="pricing-features">
                <li>Profil public avec photo</li>
                <li>Gestion des cr√©neaux</li>
                <li>Paiements automatiques</li>
                <li>Dashboard revenus & statistiques</li>
                <li>Chat avec les √©l√®ves</li>
                <li>Visibilit√© sur la carte</li>
            </ul>
        </div>
    </div>
</div>

<!-- CTA FINAL -->
<div class="cta-section">
    <div>
        <h2 class="cta-title">Pr√™t √† prendre<br>la route ?</h2>
        <p class="cta-sub">Rejoignez DriveConnect NC d√®s aujourd'hui.</p>
    </div>
    <a href="/app.html" class="cta-btn">Commencer maintenant ‚Üí</a>
</div>

<!-- FOOTER -->
<footer>
    <div style="font-weight:700">DriveConnect <span style="color:var(--orange)">NC</span></div>
    <div>
        <a href="/legal-2.html">Confidentialit√©</a>
        <a href="/legal-2.html">CGU</a>
        <a href="/app.html">Acc√©der √† l'app</a>
    </div>
</footer>

<script>
    // Scroll reveal
    const observer = new IntersectionObserver(entries => {
        entries.forEach(e => {
            if (e.isIntersecting) {
                e.target.classList.add('visible');
                observer.unobserve(e.target);
            }
        });
    }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    // Nav background on scroll
    const nav = document.querySelector('nav');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 60) {
            nav.style.background = 'rgba(13,13,13,0.95)';
            nav.style.borderBottom = '1px solid rgba(245,240,235,0.06)';
        } else {
            nav.style.background = 'linear-gradient(to bottom, rgba(13,13,13,0.9), transparent)';
            nav.style.borderBottom = 'none';
        }
    });
</script>

</div>

<!-- ========== APP ========== -->
<div id="app-container" style="display:none" class="bg-gray-50">

<div id="app"></div>
<script>
// ========== SUPABASE ==========
const SUPABASE_URL = 'https://nnmdvepfyccnehzbvpfn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ubWR2ZXBmeWNjbmVoemJ2cGZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTE4NjMsImV4cCI6MjA4NjkyNzg2M30.fCvcy_YdRs_Sn0AZobiq0OfGGm9mYJPKwEo9VPte1fY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== S√âCURIT√â ==========
function sanitize(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .trim();
}

function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validateInput(name, email, password) {
    if (!name || name.trim().length < 2) { notif('‚ùå Nom invalide', 'Minimum 2 caract√®res', 'red'); return false; }
    if (!validateEmail(email)) { notif('‚ùå Email invalide', 'Format incorrect', 'red'); return false; }
    if (!password || password.length < 6) { notif('‚ùå Mot de passe trop court', 'Minimum 6 caract√®res', 'red'); return false; }
    return true;
}

async function checkDoubleBooking(instructorId, date, time) {
    const { data } = await sb.from('bookings')
        .select('id')
        .eq('instructor_id', instructorId)
        .eq('date', date)
        .eq('time', time)
        .eq('status', 'confirmed');
    return data && data.length > 0;
}



const COMMISSION = 0.02;
const NOUMEA = { lat: -22.2758, lng: 166.4580 };

let currentUser = null;
let currentView = 'home';
let currentTab  = 'slots';
let map = null, userMarker = null, iMarkers = [], watchId = null;

// Cache local pour √©viter trop de requ√™tes
let DB = { instructors: [], slots: [], bookings: [] };

// ========== HELPERS ==========
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

function notif(title, msg, color='orange') {
    const n = document.createElement('div');
    n.className = `fixed top-4 right-4 bg-white p-4 rounded-2xl shadow-2xl z-[9999] border-l-4 border-${color}-500 max-w-sm fade-in`;
    n.innerHTML = `<p class="font-bold text-gray-800">${title}</p>${msg?`<p class="text-sm text-gray-500 mt-1">${msg}</p>`:''}`;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 5000);
}

function calcPrices(amount) {
    const commission = Math.round(amount * COMMISSION);
    return { total: amount, commission, net: amount - commission };
}

function cancellationPolicy(date, time) {
    const diff = (new Date(date+'T'+time) - new Date()) / 3600000;
    if (diff >= 48) return { pct:100, label:'‚úÖ Remboursement int√©gral (48h+)',  color:'green'  };
    if (diff >= 24) return { pct:50,  label:'‚ö†Ô∏è Remboursement 50% (24h‚Äì48h)',   color:'yellow' };
    return              { pct:0,   label:'‚ùå Aucun remboursement (< 24h)',      color:'red'    };
}

function sortedInstructors() {
    const now = new Date();
    return [...DB.instructors].sort((a,b) => {
        const sA = (a.rating||0)*100 - (a.penalty_until && new Date(a.penalty_until)>now ? (a.visibility_penalty||0) : 0);
        const sB = (b.rating||0)*100 - (b.penalty_until && new Date(b.penalty_until)>now ? (b.visibility_penalty||0) : 0);
        return sB - sA;
    });
}

// ========== CHARGEMENT DONN√âES SUPABASE ==========
async function loadData() {
    const [instRes, slotsRes] = await Promise.all([
        sb.from('instructors').select('*'),
        sb.from('slots').select('*').eq('available', true).gte('date', new Date().toISOString().split('T')[0])
    ]);
    DB.instructors = instRes.data || [];
    DB.slots = slotsRes.data || [];

    if (currentUser) {
        const field = currentUser.user_type === 'student' ? 'student_id' : 'instructor_id';
        const { data } = await sb.from('bookings').select('*').eq(field, currentUser.id).order('created_at', { ascending: false });
        DB.bookings = data || [];
    }
}

// ========== AUTH ==========
async function login(email, password, userType) {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) { notif('‚ùå Email ou mot de passe incorrect', '', 'red'); return; }

    const { data: profile } = await sb.from('users').select('*').eq('id', data.user.id).single();
    if (!profile || profile.user_type !== userType) {
        notif('‚ùå Ce compte n\'est pas un ' + (userType==='student'?'√©l√®ve':'moniteur'), '', 'red');
        await sb.auth.signOut();
        return;
    }
    currentUser = { ...profile, ...data.user };
    currentView = userType === 'student' ? 'student-dashboard' : 'instructor-dashboard';
    await loadData();
    render();
}

async function signup(email, password, name, userType) {
    if (!validateInput(name, email, password)) return;
    name = sanitize(name);
    email = email.trim().toLowerCase();
    const { data, error } = await sb.auth.signUp({
        email, password,
        options: { data: { name, user_type: userType } }
    });
    if (error) { notif('‚ùå ' + error.message, '', 'red'); return; }

    // Attendre que le trigger cr√©e le profil
    await new Promise(r => setTimeout(r, 1000));

    // Mettre √† jour le profil avec le nom si pas encore fait
    await sb.from('users').upsert({
        id: data.user.id,
        email, name,
        user_type: userType
    }, { onConflict: 'id' });

    // Si moniteur, cr√©er le profil instructeur
    if (userType === 'instructor') {
        await sb.from('instructors').upsert({
            id: data.user.id,
            user_id: data.user.id,
            name, email,
            rating: 0, total_reviews: 0, experience: 0,
            location: 'Noum√©a', hourly_rate: 4500,
            verified: false, is_online: false,
            lat: NOUMEA.lat, lng: NOUMEA.lng,
            visibility_penalty: 0
        }, { onConflict: 'id' });
    }

    const { data: profile } = await sb.from('users').select('*').eq('id', data.user.id).single();
    currentUser = { ...profile, ...data.user };
    currentView = userType === 'student' ? 'student-dashboard' : 'instructor-dashboard';
    await loadData();
    render();
    notif('‚úÖ Compte cr√©√© !', 'Bienvenue sur DriveConnect NC', 'green');
}

// ========== HOME ====================
function HomePage() {
    return `<div class="min-h-screen" style="background:linear-gradient(160deg,#0f0f0f 0%,#1a1a1a 50%,#0f0f0f 100%)">
        <!-- Hero -->
        <div class="flex flex-col min-h-screen px-6 pt-16 pb-8 max-w-lg mx-auto">
            <div class="flex-1 flex flex-col justify-center">
                <!-- Logo & Badge -->
                <div class="mb-8 fade-in">
                    <div class="inline-flex items-center gap-2 bg-white/10 border border-white/20 rounded-full px-4 py-2 mb-8">
                        <div class="w-2 h-2 rounded-full bg-green-400"></div>
                        <span class="text-white/80 text-sm font-medium">Disponible √† Noum√©a</span>
                    </div>
                    <h1 class="display-font text-5xl font-normal text-white leading-tight mb-4">
                        Apprenez √† <em style="color:#FF5A1F">conduire</em><br>√† votre rythme
                    </h1>
                    <p class="text-white/50 text-lg leading-relaxed">Trouvez un moniteur qualifi√© pr√®s de chez vous en Nouvelle-Cal√©donie.</p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-3 gap-4 mb-12 fade-in" style="animation-delay:0.1s">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-white">100%</p>
                        <p class="text-white/40 text-xs mt-1">Moniteurs v√©rifi√©s</p>
                    </div>
                    <div class="text-center border-x border-white/10">
                        <p class="text-2xl font-bold text-white">NC</p>
                        <p class="text-white/40 text-xs mt-1">Nouvelle-Cal.</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-white">2%</p>
                        <p class="text-white/40 text-xs mt-1">Commission seul.</p>
                    </div>
                </div>

                <!-- Boutons principaux -->
                <div class="space-y-3 fade-in" style="animation-delay:0.2s">
                    <button onclick="showView('student-login')" class="w-full py-4 rounded-2xl font-semibold text-lg transition-all active:scale-95" style="background:#FF5A1F;color:white">
                        Trouver un moniteur
                    </button>
                    <button onclick="showView('instructor-login')" class="w-full py-4 rounded-2xl font-semibold text-lg transition-all active:scale-95" style="background:rgba(255,255,255,0.08);color:white;border:1.5px solid rgba(255,255,255,0.15)">
                        Je suis moniteur
                    </button>
                </div>
            </div>

            <!-- Footer l√©gal -->
            <div class="flex justify-center gap-6 pt-8 fade-in" style="animation-delay:0.3s">
                <button onclick="showView('privacy')" class="text-white/30 text-sm hover:text-white/60 transition">Confidentialit√©</button>
                <button onclick="showView('terms')" class="text-white/30 text-sm hover:text-white/60 transition">CGU</button>
            </div>
        </div>
    </div>`;
}

// ========== LOGIN ====================
function LoginPage(type) {
    const isStudent = type === 'student';
    return `<div class="min-h-screen flex flex-col" style="background:var(--bg)">
        <!-- Header minimal -->
        <div class="px-6 pt-14 pb-6">
            <button onclick="showView('home')" class="flex items-center gap-2 text-sm font-medium mb-10" style="color:var(--text-muted)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Retour
            </button>
            <div class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 mb-4 text-xs font-semibold" style="background:${isStudent?'#FFF7ED':'#F0F9FF'};color:${isStudent?'#EA580C':'#0369A1'}">
                ${isStudent ? 'üéì Espace √âl√®ve' : 'üöó Espace Moniteur'}
            </div>
            <h2 class="text-3xl font-bold mb-2" id="form-title" style="color:var(--text)">Connexion</h2>
            <p class="text-sm" style="color:var(--text-muted)">Content de vous revoir !</p>
        </div>

        <!-- Formulaire -->
        <div class="flex-1 px-6">
            <form id="login-form" class="space-y-4">
                <div id="name-field" style="display:none">
                    <input type="text" id="name" class="input-field" placeholder="Nom complet">
                </div>
                <input type="email" id="email" required class="input-field" placeholder="Adresse email">
                <input type="password" id="password" required minlength="6" class="input-field" placeholder="Mot de passe">
                <button type="submit" class="btn-primary w-full text-center mt-2" style="font-size:16px">
                    <span id="submit-text">Se connecter</span>
                </button>
            </form>
            <div class="mt-6 text-center">
                <button onclick="toggleSignup('${type}')" class="text-sm font-medium" style="color:var(--primary)">
                    <span id="toggle-text">Pas de compte ? S'inscrire</span>
                </button>
            </div>
        </div>
    </div>`;
}

// ========== STUDENT DASHBOARD ====================
function StudentDashboard() {
    const myBookings = DB.bookings;
    const instructors = sortedInstructors();
    return `<div class="min-h-screen" style="background:var(--bg)">
        <header class="app-header">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold gradient-text">DriveConnect</h1>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 px-3 py-2 rounded-full" style="background:var(--bg)">
                        <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm font-bold text-white" style="background:var(--primary)">${currentUser.name.charAt(0).toUpperCase()}</div>
                        <span class="text-sm font-medium hide-mobile" style="color:var(--text)">${currentUser.name.split(' ')[0]}</span>
                    </div>
                    <button onclick="toggleDark()" class="w-9 h-9 flex items-center justify-center rounded-full transition" style="background:var(--bg);color:var(--text-muted)" id="dark-btn">üåô</button>
                    <button onclick="logout()" class="text-sm font-medium px-3 py-2 rounded-full transition" style="color:var(--text-muted)">Sortir</button>
                </div>
            </div>
        </header>
        <div class="container mx-auto px-4 py-8">
            <div class="card p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg" style="color:var(--text)">Moniteurs √† proximit√©</h2>
                    <button onclick="centerOnMe()" class="btn-primary" style="padding:8px 16px;font-size:13px">üìç Me localiser</button>
                </div>
                <div class="flex gap-3 mb-4">
                    <span class="badge badge-online"><span style="color:#16A34A">‚óè</span> Disponible</span>
                    <span class="badge badge-gray">‚óã Hors ligne</span>
                    <span class="badge" style="background:#EFF6FF;color:#1D4ED8">‚óè Moi</span>
                </div>
                <div id="map"></div>
            </div>
            ${myBookings.length>0?`
            <div class="card p-5 mb-6">
                <h2 class="font-bold text-lg mb-4" style="color:var(--text)">Mes r√©servations</h2>
                ${myBookings.map(b=>{
                    const pol = cancellationPolicy(b.date,b.time);
                    const canCancel = b.status!=='cancelled' && b.status!=='completed';
                    const isPast = new Date(b.date) < new Date();
                    const canRate = isPast && b.status==='confirmed' && !b.rated;
                    return `<div class="p-4 mb-3 fade-in" style="border-bottom:1px solid var(--border)">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold" style="color:var(--text)">${b.instructor_name||'Moniteur'}</p>
                                <p class="text-sm mt-0.5" style="color:var(--text-muted)">${b.date} ¬∑ ${b.time} ¬∑ ${b.duration}h</p>
                                <p class="text-sm font-bold mt-1" style="color:var(--primary)">${b.amount.toLocaleString()} XPF</p>
                            </div>
                            <div class="text-right flex flex-col items-end gap-2">
                                <span class="badge ${b.status==='confirmed'?'badge-green':b.status==='cancelled'?'badge-red':'badge-yellow'}">${b.status==='confirmed'?'Confirm√©':b.status==='cancelled'?'Annul√©':'En attente'}</span>
                                ${canCancel?`<button onclick="cancelStudent('${b.id}')" class="text-xs font-medium" style="color:#DC2626">Annuler</button>`:''}
                                ${isPast && b.status==='confirmed' && !b.rated?`<button onclick="showRating('${b.id}','${b.instructor_id}','${b.instructor_name}')" class="badge badge-orange" style="cursor:pointer;border:none">‚≠ê Noter</button>`:''}
                                ${b.status==='confirmed'?`<button onclick="openChat('${b.id}','${b.instructor_id}','${b.instructor_name}')" class="badge" style="background:#EFF6FF;color:#1D4ED8;cursor:pointer;border:none">üí¨ Chat</button>`:''}
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>`:''}
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg" style="color:var(--text)">Choisir un moniteur</h2>
                <span class="badge badge-gray">${instructors.length} disponible${instructors.length>1?'s':''}</span>
            </div>
            <div class="grid md:grid-cols-3 gap-4">
                ${instructors.map((i,idx)=>{
                    const now=new Date();
                    const hasPenalty=i.penalty_until&&new Date(i.penalty_until)>now;
                    const availableSlots=DB.slots.filter(s=>s.instructor_id===i.id).length;
                    const initials = (i.name||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                    return `<div class="instructor-card fade-in" onclick="showInstructorProfile('${i.id}')" style="animation-delay:${idx*0.05}s">
                        <div class="instructor-card-header">
                            <div class="flex justify-between items-start mb-4">
                                <span class="badge ${i.is_online?'badge-online':'badge-gray'}">${i.is_online?'‚óè En ligne':'‚óã Hors ligne'}</span>
                                ${idx===0?'<span class="badge badge-yellow">‚≠ê Top</span>':''}
                                ${hasPenalty?'<span class="badge badge-red">‚ö† P√©nalis√©</span>':''}
                            </div>
                            <div class="w-16 h-16 rounded-2xl overflow-hidden mb-3 flex items-center justify-center text-xl font-bold text-white" style="background:var(--primary)">
                                ${i.avatar_url ? '<img src="'+i.avatar_url+'" class="w-full h-full object-cover" alt="'+i.name+'">' : initials}
                            </div>
                            <h3 class="font-bold text-lg text-white mb-1">${i.name}</h3>
                            <p class="text-sm" style="color:rgba(255,255,255,0.5)">üìç ${i.location||'Noum√©a'}</p>
                        </div>
                        <div class="p-5">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="text-2xl font-bold" style="color:var(--text)">${i.hourly_rate||0} <span class="text-sm font-normal" style="color:var(--text-muted)">XPF/h</span></p>
                                    <p class="text-xs mt-0.5" style="color:var(--text-muted)">${availableSlots} cr√©neau${availableSlots>1?'x':''} dispo</p>
                                </div>
                                ${i.rating?`<div class="text-right"><p class="font-bold" style="color:var(--text)">${i.rating.toFixed(1)}</p><p class="text-xs" style="color:#F59E0B">${'‚òÖ'.repeat(Math.round(i.rating))}${'‚òÜ'.repeat(5-Math.round(i.rating))}</p></div>`:''}
                            </div>
                            <button onclick="event.stopPropagation();showSlots('${i.id}')" class="btn-primary w-full text-center" style="padding:12px;font-size:14px">Voir les cr√©neaux</button>
                        </div>
                    </div>`;
                }).join('')}
                ${instructors.length===0?'<div class="col-span-3 text-center py-16" style="color:var(--text-muted)"><p class="text-5xl mb-4">üöó</p><p class="font-medium">Aucun moniteur disponible</p></div>':''}
            </div>
        </div>
    </div>`;
}

// ========== INSTRUCTOR DASHBOARD ====================
function InstructorDashboard() {
    const myBookings = DB.bookings;
    const profile = DB.instructors.find(x=>x.id===currentUser.id) || {};
    const mySlots = DB.slots.filter(s=>s.instructor_id===currentUser.id);
    const paidBookings = myBookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid');
    const totalNet = paidBookings.reduce((s,b)=>s+(b.net||0),0);
    const confirmedCount = myBookings.filter(b=>b.status==='confirmed').length;
    const pendingCount = myBookings.filter(b=>b.status==='pending').length;
    const initials = (currentUser.name||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
    const avatarHtml = profile.avatar_url
        ? `<img src="${profile.avatar_url}" style="width:32px;height:32px;border-radius:50%;object-fit:cover" alt="avatar">`
        : `<div style="width:32px;height:32px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:white">${initials}</div>`;
    const tabs = [{id:'slots',icon:'üìÖ',label:'Cr√©neaux'},{id:'bookings',icon:'üìã',label:'R√©servations'},{id:'earnings',icon:'üí∞',label:'Revenus'},{id:'settings',icon:'‚öôÔ∏è',label:'Param√®tres'}];
    return `<div class="min-h-screen" style="background:var(--bg)">

        <!-- HEADER -->
        <header class="dash-header">
            <div class="dash-header-inner">
                <div class="dash-logo">Drive<span>Connect</span></div>
                <div class="dash-actions">
                    <button onclick="toggleOnline()" class="status-pill ${profile.is_online?'online':'offline'}">
                        <div class="status-dot"></div>
                        ${profile.is_online ? 'En ligne' : 'Hors ligne'}
                    </button>
                    <button onclick="toggleDark()" class="icon-btn" id="dark-btn" title="Mode sombre">üåô</button>
                    ${avatarHtml}
                    <button onclick="logout()" class="logout-btn">Sortir</button>
                </div>
            </div>
        </header>

        <!-- BODY -->
        <div class="dash-body">

            <!-- REVENUE HERO -->
            <div class="revenue-hero">
                <div class="revenue-badge">Tableau de bord</div>
                <div class="revenue-label">Revenus nets totaux</div>
                <div class="revenue-amount">${totalNet.toLocaleString()} <span>XPF</span></div>
                <div class="revenue-sub">${paidBookings.length} cours pay√©s${pendingCount > 0 ? ' &nbsp;¬∑&nbsp; ' + pendingCount + ' en attente' : ''}</div>
            </div>

            <!-- STATS CARDS -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-card-icon stat-icon-blue">üìã</div>
                    <div class="stat-card-value">${confirmedCount}</div>
                    <div class="stat-card-label">R√©servations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon stat-icon-purple">üìÖ</div>
                    <div class="stat-card-value">${mySlots.length}</div>
                    <div class="stat-card-label">Cr√©neaux actifs</div>
                </div>
                <div class="stat-card clickable" onclick="showMyReviews()">
                    <div class="stat-card-icon stat-icon-orange">‚≠ê</div>
                    <div class="stat-card-value accent">${profile.rating ? profile.rating.toFixed(1) : '‚Äî'}</div>
                    <div class="stat-card-label">Note / 5</div>
                    <div class="stat-card-sub">${profile.total_reviews || 0} avis ‚Ä∫</div>
                </div>
            </div>

            <!-- MAP -->
            <div class="map-card">
                <div class="map-card-header">
                    <div>
                        <div class="map-card-title">Ma position</div>
                        <div class="map-card-sub" id="gps-status">GPS non actif ‚Äî activez pour appara√Ætre sur la carte</div>
                    </div>
                    <button onclick="startTracking()" class="gps-btn">
                        üì° Partager GPS
                    </button>
                </div>
                <div id="map" style="height:300px;width:100%"></div>
            </div>

            <!-- TABS -->
            <div class="tabs-card">
                <div class="tabs-nav">
                    ${tabs.map(t=>`<button onclick="switchTab('${t.id}')" class="tab-pill ${currentTab===t.id?'active':''}"><span class="tab-pill-icon">${t.icon}</span>${t.label}</button>`).join('')}
                </div>
                <div class="tab-body">${getTabContent(profile, myBookings, mySlots)}</div>
            </div>

        </div>
    </div>`;
}

function getTabContent(profile, myBookings, mySlots) {
    if (currentTab==='slots') return SlotsTab(mySlots);
    if (currentTab==='bookings') return BookingsTab(myBookings);
    if (currentTab==='earnings') return EarningsTab(myBookings);
    if (currentTab==='settings') return SettingsTab(profile);
    return '';
}

function SlotsTab(mySlots) {
    const slotsHtml = mySlots.length === 0
        ? `<div class="empty-state"><div class="empty-state-icon">üìÖ</div><div class="empty-state-text">Aucun cr√©neau pour l'instant</div></div>`
        : mySlots.map(s => {
            const booking = DB.bookings.find(b=>b.slot_id===s.id&&b.status!=='cancelled');
            return `<div class="slot-item${booking?' booked':''} fade-in">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                    <div style="flex:1">
                        <div class="slot-date">${s.date} &nbsp;¬∑&nbsp; ${s.time}</div>
                        <div class="slot-meta">‚è± ${s.duration}h &nbsp;¬∑&nbsp; ${s.price.toLocaleString()} XPF</div>
                        ${booking?`<div class="slot-student">üë®‚Äçüéì ${booking.student_name}</div>`:''}
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">
                        ${booking
                            ? `<span class="slot-status-badge" style="background:#DBEAFE;color:#1D4ED8">üîí R√©serv√©</span>
                               <button onclick="cancelInstructor('${booking.id}')" class="danger-link">Annuler</button>`
                            : `<button onclick="deleteSlot('${s.id}')" class="danger-link">üóë Supprimer</button>`
                        }
                    </div>
                </div>
            </div>`;
        }).join('');

    return `<div class="section-hdr">
        <h3>Mes cr√©neaux</h3>
        <button onclick="showAddSlot()" class="btn-primary" style="padding:9px 18px;font-size:13px;border-radius:12px">+ Ajouter</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px">${slotsHtml}</div>
    <button onclick="showAddSlot()" class="add-slot-btn">+ Ajouter un cr√©neau</button>`;
}

function BookingsTab(myBookings) {
    const sorted = [...myBookings].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    if (sorted.length === 0) return `<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">Aucune r√©servation pour l'instant</div></div>`;
    return `<div style="display:flex;flex-direction:column;gap:10px">
        ${sorted.map(b=>{
            const statusCfg = b.status==='confirmed'
                ? {bg:'#ECFDF5',color:'#059669',label:'‚úì Confirm√©'}
                : b.status==='cancelled'
                ? {bg:'#FEF2F2',color:'#DC2626',label:'‚úï Annul√©'}
                : {bg:'#FFFBEB',color:'#D97706',label:'‚è≥ En attente'};
            return `<div class="booking-item fade-in">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                    <div style="flex:1">
                        <div class="booking-student">üë®‚Äçüéì ${b.student_name||'√âl√®ve'}</div>
                        <div class="booking-info">${b.date} √† ${b.time} &nbsp;¬∑&nbsp; ${b.duration}h</div>
                        <div class="booking-amount">${(b.net||0).toLocaleString()} XPF nets</div>
                        ${b.payment_status==='paid'?'<div style="font-size:11px;color:#059669;margin-top:2px;font-weight:600">‚úì Pay√©</div>':''}
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;flex-shrink:0">
                        <span style="font-size:11px;font-weight:700;padding:4px 10px;border-radius:100px;background:${statusCfg.bg};color:${statusCfg.color}">${statusCfg.label}</span>
                        ${b.status==='pending'
                            ? `<div style="display:flex;gap:6px">
                                <button onclick="confirmB('${b.id}')" style="font-size:11px;background:#059669;color:white;padding:5px 10px;border-radius:8px;border:none;cursor:pointer;font-family:inherit;font-weight:700">‚úì Oui</button>
                                <button onclick="rejectB('${b.id}')" style="font-size:11px;background:#DC2626;color:white;padding:5px 10px;border-radius:8px;border:none;cursor:pointer;font-family:inherit;font-weight:700">‚úï Non</button>
                               </div>` : ''}
                        ${b.status==='confirmed'
                            ? `<button onclick="openChat('${b.id}','${b.student_id}','${b.student_name}')" style="font-size:11px;background:#EFF6FF;color:#2563EB;padding:5px 12px;border-radius:8px;border:none;cursor:pointer;font-family:inherit;font-weight:700">üí¨ Chat</button>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('')}
    </div>`;
}

function EarningsTab(myBookings) {
    const paid = myBookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid');
    const total = paid.reduce((s,b)=>s+(b.net||0),0);
    const totalGross = paid.reduce((s,b)=>s+(b.amount||0),0);
    const totalCommission = paid.reduce((s,b)=>s+(b.commission||0),0);
    const months = {};
    paid.forEach(b=>{const m=b.date.substr(0,7);months[m]=(months[m]||0)+(b.net||0);});
    const avgPerCourse = paid.length > 0 ? Math.round(total/paid.length) : 0;
    const cancelled = myBookings.filter(b=>b.status==='cancelled').length;
    const completionRate = myBookings.length > 0 ? Math.round((paid.length/myBookings.length)*100) : 0;
    const rateColor = completionRate>=80?'#16A34A':completionRate>=50?'#D97706':'#DC2626';
    const maxVal = Object.values(months).length > 0 ? Math.max(...Object.values(months)) : 1;
    const monthsHTML = Object.entries(months).sort((a,b)=>b[0].localeCompare(a[0])).map(([m,v])=>{
        const pct = Math.min(100, Math.round(v/maxVal*100));
        return `<div class="month-bar">
            <div style="flex:1">
                <div style="font-size:13px;font-weight:600;color:var(--text)">${m}</div>
                <div class="month-bar-track"><div class="month-bar-fill" style="width:${pct}%"></div></div>
            </div>
            <div style="font-size:14px;font-weight:700;color:var(--primary);margin-left:16px">${v.toLocaleString()} XPF</div>
        </div>`;
    }).join('') || `<div class="empty-state"><div class="empty-state-icon">üí∞</div><div class="empty-state-text">Aucun revenu pour l'instant</div></div>`;

    return `<div>
        <div class="earnings-hero">
            <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;opacity:0.7;margin-bottom:8px">Total revenus nets</div>
            <div style="font-size:38px;font-weight:900;letter-spacing:-1px;line-height:1">${total.toLocaleString()} <span style="font-size:16px;font-weight:400;opacity:0.7">XPF</span></div>
            <div style="font-size:12px;opacity:0.6;margin-top:8px">Brut : ${totalGross.toLocaleString()} XPF &nbsp;¬∑&nbsp; Commission : ${totalCommission.toLocaleString()} XPF</div>
        </div>
        <div class="earnings-grid">
            <div class="earnings-mini">
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Moy. par cours</div>
                <div style="font-size:24px;font-weight:800;color:var(--primary);letter-spacing:-1px">${avgPerCourse.toLocaleString()}</div>
                <div style="font-size:11px;color:var(--text-muted)">XPF nets</div>
            </div>
            <div class="earnings-mini">
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Taux de compl√©tion</div>
                <div style="font-size:24px;font-weight:800;color:${rateColor};letter-spacing:-1px">${completionRate}%</div>
                <div style="font-size:11px;color:var(--text-muted)">${cancelled} annulation(s)</div>
            </div>
        </div>
        <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">Par mois</div>
        <div style="display:flex;flex-direction:column;gap:0">${monthsHTML}</div>
    </div>`;
}

function SettingsTab(profile) {
    const avatarUrl = profile.avatar_url || '';
    return `<div>
        <!-- Photo profil -->
        <div class="settings-section">
            <span class="settings-label">Photo de profil</span>
            <div class="avatar-upload-zone">
                <div id="avatar-preview" style="width:80px;height:80px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:white;background:var(--primary)">
                    ${avatarUrl ? '<img src="'+avatarUrl+'" style="width:100%;height:100%;object-fit:cover" alt="Photo profil">' : profile.name.charAt(0).toUpperCase()}
                </div>
                <div>
                    <div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px">Photo de profil</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Aidez vos √©l√®ves √† vous reconna√Ætre</div>
                    <label class="btn-primary" style="padding:9px 18px;font-size:13px;display:inline-flex;align-items:center;gap:6px;cursor:pointer;border-radius:12px">
                        üì∑ Choisir une photo
                        <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="previewAvatar(event)">
                    </label>
                </div>
                <div style="font-size:12px;font-weight:600;${avatarUrl ? 'color:#059669' : 'color:#DC2626'}">
                    ${!avatarUrl ? '‚ö†Ô∏è Photo requise pour √™tre visible par les √©l√®ves' : '‚úì Photo ajout√©e'}
                </div>
            </div>
        </div>

        <!-- Infos profil -->
        <div class="settings-section">
            <span class="settings-label">Informations</span>
            <form id="settings-form" style="display:flex;flex-direction:column;gap:14px">
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px">Localisation</label>
                    <input type="text" id="s-loc" value="${profile.location||''}" class="input-field" placeholder="Quartier / Ville">
                </div>
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px">T√©l√©phone</label>
                    <input type="tel" id="s-phone" value="${profile.phone_number||''}" class="input-field" placeholder="+687 XX XX XX">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px">Tarif horaire (XPF)</label>
                        <input type="number" id="s-rate" value="${profile.hourly_rate||4500}" class="input-field">
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px">Ann√©es d'exp√©rience</label>
                        <input type="number" id="s-exp" value="${profile.experience||0}" class="input-field">
                    </div>
                </div>
                <button type="submit" class="btn-primary w-full text-center" style="font-size:15px;border-radius:14px;padding:15px">Sauvegarder les modifications</button>
            </form>
        </div>

        <!-- Parrainage -->
        <div style="background:var(--bg);border-radius:18px;padding:20px;border:1.5px solid var(--border)">
            <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">üéÅ Parrainage</div>
            <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Parrainez un moniteur ‚Üí <strong style="color:var(--text)">1% de commission en moins</strong> pendant 10 cours.</div>
            <div style="margin-bottom:14px">
                <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px">Votre code</div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div id="referral-code-display" style="flex:1;padding:12px 16px;border-radius:12px;font-family:monospace;font-size:18px;font-weight:800;text-align:center;background:var(--surface);border:2px dashed var(--primary);color:var(--primary);letter-spacing:4px">...</div>
                    <button onclick="copyReferralCode()" class="btn-secondary" style="padding:12px 14px;border-radius:12px">üìã</button>
                </div>
            </div>
            <button onclick="shareReferralLink()" class="btn-primary w-full" style="padding:12px;border-radius:12px;margin-bottom:12px">üîó Partager mon lien de parrainage</button>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div style="padding:14px;border-radius:14px;text-align:center;background:var(--surface);border:1px solid var(--border)">
                    <div style="font-size:24px;font-weight:800;color:var(--text)" id="referral-count">0</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Filleuls</div>
                </div>
                <div style="padding:14px;border-radius:14px;text-align:center;background:var(--surface);border:1px solid var(--border)">
                    <div style="font-size:24px;font-weight:800;color:var(--primary)" id="referral-savings">0</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">XPF √©conomis√©s</div>
                </div>
            </div>
            <div id="referral-list" style="margin-top:12px;display:flex;flex-direction:column;gap:6px"></div>
        </div>
    </div>`;
}

// ========== ACTIONS CR√âNEAUX ==========
window.showAddSlot = function() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
    const today = new Date().toISOString().split('T')[0];
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl">
        <h3 class="text-xl font-bold mb-4">‚ûï Nouveau cr√©neau</h3>
        <form id="slot-form" class="space-y-4">
            <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="sl-date" min="${today}" required class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400"></div>
            <div><label class="block text-sm font-medium mb-1">Heure</label><select id="sl-time" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400">
                ${['07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30','11:00','11:30','12:00','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00'].map(t=>`<option>${t}</option>`).join('')}
            </select></div>
            <div><label class="block text-sm font-medium mb-1">Dur√©e (heures)</label><select id="sl-dur" class="w-full px-4 py-3 border rounded-xl outline-none focus:border-orange-400"><option value="1">1h</option><option value="1.5">1h30</option><option value="2">2h</option></select></div>
            <div id="sl-preview" class="bg-orange-50 rounded-xl p-3 text-sm text-orange-700"></div>
            <div class="flex gap-3">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 border border-gray-200 py-3 rounded-xl font-semibold">Annuler</button>
                <button type="submit" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">Cr√©er</button>
            </div>
        </form>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });

    modal.querySelector('#slot-form').onsubmit = async function(e) {
        e.preventDefault();
        const instructor = DB.instructors.find(x=>x.id===currentUser.id);
        const price = instructor ? instructor.hourly_rate : 4500;
        const { data, error } = await sb.from('slots').insert({
            instructor_id: currentUser.id,
            date: document.getElementById('sl-date').value,
            time: document.getElementById('sl-time').value,
            duration: parseFloat(document.getElementById('sl-dur').value),
            price, available: true
        }).select().single();
        if (error) { notif('‚ùå Erreur', error.message, 'red'); return; }
        DB.slots.push(data);
        modal.remove();
        notif('‚úÖ Cr√©neau ajout√©', '', 'green');
        render();
    };
};

window.showSlots = function(instructorId) {
    const instructor = DB.instructors.find(x=>x.id===instructorId);
    if (!instructor) return;
    const slots = DB.slots.filter(s=>s.instructor_id===instructorId&&s.available);
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4';
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <div><h3 class="text-xl font-bold">${instructor.name}</h3><p class="text-gray-400 text-sm">üìç ${instructor.location} ¬∑ ‚≠ê ${instructor.rating||'N/A'}</p></div>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 text-2xl">‚úï</button>
        </div>
        <div class="space-y-3">
            ${slots.length===0?'<p class="text-center text-gray-400 py-8">Aucun cr√©neau disponible</p>':slots.map(s=>`
            <div class="border border-gray-100 rounded-2xl p-4 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold">üìÖ ${s.date}</p>
                        <p class="text-sm text-gray-400">üïê ${s.time} ¬∑ ‚è±Ô∏è ${s.duration}h</p>
                        <p class="font-semibold text-orange-600 mt-1">${s.price} XPF</p>
                    </div>
                    <button onclick="bookSlot('${s.id}','${instructorId}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:bg-orange-600">R√©server</button>
                </div>
            </div>`).join('')}
        </div>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
};

window.bookSlot = function(slotId, instructorId) {
    if (!currentUser) { notif('‚ùå Connectez-vous d\'abord', '', 'red'); return; }
    const slot = DB.slots.find(s=>s.id===slotId);
    const instructor = DB.instructors.find(i=>i.id===instructorId);
    if (!slot || !instructor) return;
    const prices = calcPrices(slot.price);
    document.querySelectorAll('.fixed').forEach(m=>m.remove());
    showPaymentModal(slot, instructor, prices);
};

function showPaymentModal(slot, instructor, prices) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4';
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">üí≥ Paiement</h3>
            <button onclick="this.closest('.fixed').remove();document.body.style.overflow=''" class="text-gray-400 text-2xl">‚úï</button>
        </div>
        <div class="bg-orange-50 rounded-2xl p-4 mb-4">
            <p class="font-bold">${instructor.name}</p>
            <p class="text-sm text-gray-500">üìÖ ${slot.date} √† ${slot.time} ¬∑ ‚è±Ô∏è ${slot.duration}h</p>
            <p class="text-2xl font-extrabold text-orange-600 mt-2">${prices.total} XPF</p>
        </div>
        <div id="paypal-btns" class="mb-4"></div>
        <button id="pay-btn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition">üí≥ PAYER ${slot.price} XPF</button>
        <p class="text-xs text-gray-400 text-center mt-2">üîí Paiement s√©curis√©</p>
    </div>`;
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    modal.addEventListener('click', e => { if(e.target===modal){modal.remove();document.body.style.overflow='';}});


async function sendNotification(type, data) {
    try {
        const session = await sb.auth.getSession();
        await fetch('https://nnmdvepfyccnehzbvpfn.supabase.co/functions/v1/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + session.data.session.access_token
            },
            body: JSON.stringify({ type, ...data })
        });
    } catch(e) {
        console.warn('Notification error:', e);
    }
}

    async function completeBooking(paymentStatus, orderId) {
        const { error } = await sb.from('slots').update({ available: false }).eq('id', slot.id);
        if (error) { notif('‚ùå Erreur slot', error.message, 'red'); return; }

        const { data: booking, error: bError } = await sb.from('bookings').insert({
            slot_id: slot.id,
            student_id: currentUser.id,
            student_name: currentUser.name,
            instructor_id: instructor.id,
            instructor_name: instructor.name,
            date: slot.date, time: slot.time, duration: slot.duration,
            amount: slot.price, commission: prices.commission, net: prices.net,
            status: 'confirmed', payment_status: paymentStatus,
            paypal_order_id: orderId
        }).select().single();

        if (bError) { notif('‚ùå Erreur r√©servation', bError.message, 'red'); return; }
sendPushToUser(instructor.id, 'üéâ Nouvelle r√©servation !', 
    `${currentUser.name} a r√©serv√© le ${slot.date} √† ${slot.time}`);

        DB.slots = DB.slots.filter(s=>s.id!==slot.id);
        DB.bookings.push(booking);
        modal.remove(); document.body.style.overflow='';
        notif('‚úÖ R√©servation confirm√©e !', `Cours avec ${instructor.name} le ${slot.date}`, 'green');
        sendNotification('confirmation', {
            studentEmail: currentUser.email,
            studentName: currentUser.name,
            instructorName: instructor.name,
            date: slot.date,
            time: slot.time,
            amount: slot.price
        });
        render();
    }

    if (typeof paypal !== 'undefined') {
        try {
            paypal.Buttons({
                style:{layout:'vertical',color:'gold',label:'pay',height:48},
                createOrder:(d,a)=>a.order.create({purchase_units:[{amount:{value:(slot.price/100).toFixed(2),currency_code:'USD'}}]}),
                onApprove: async (d, a) => {
                    const capture = await a.order.capture();
                    if (capture.status !== 'COMPLETED') {
                        notif('‚ùå Paiement non compl√©t√©', '', 'red');
                        return;
                    }
                    // V√©rification c√¥t√© serveur via Edge Function
                    try {
                        const res = await fetch('https://nnmdvepfyccnehzbvpfn.supabase.co/functions/v1/validate-payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + (await sb.auth.getSession()).data.session.access_token
                            },
                            body: JSON.stringify({
                                orderId: d.orderID,
                                slotId: pendingSlot.id,
                                studentId: currentUser.id,
                                instructorId: pendingSlot.instructor_id,
                                amount: pendingSlot.price
                            })
                        });
                        const result = await res.json();
                        if (result.error) {
                            notif('‚ùå ' + result.error, '', 'red');
                            return;
                        }
                    } catch(e) {
                        console.warn('Edge function error, continuing:', e);
                    }
                    completeBooking('paid', d.orderID);
                },
                onError:()=>notif('‚ùå Erreur PayPal','','red')
            }).render('#paypal-btns');
        } catch(e) {}
    }

    document.getElementById('pay-btn').onclick = function() {
        if(confirm(`Confirmer le paiement de ${slot.price} XPF ?`)) completeBooking('paid','DIRECT_'+generateId());
    };
}

// ========== ANNULATIONS ==========
window.cancelStudent = async function(bookingId) {
    const b = DB.bookings.find(x=>x.id===bookingId);
    if (!b) return;
    const pol = cancellationPolicy(b.date,b.time);
    const refund = Math.round(b.amount*pol.pct/100);
    if (!confirm(`Annuler ce cours ?\n\n${pol.label}\nRemboursement : ${refund} XPF`)) return;

    await sb.from('bookings').update({ status:'cancelled', cancelled_by:'student', refund_amount:refund, cancelled_at:new Date().toISOString() }).eq('id', bookingId);
    const cancelledBooking = DB.bookings.find(b=>b.id===bookingId);
    if (cancelledBooking) {
        sendNotification('cancellation', {
            studentEmail: currentUser.email,
            studentName: currentUser.name,
            instructorName: cancelledBooking.instructor_name,
            date: cancelledBooking.date,
            time: cancelledBooking.time
        });
    }
    if (pol.pct>=50) await sb.from('slots').update({ available:true }).eq('id', b.slot_id);

    await loadData();
    notif('R√©servation annul√©e',`Remboursement de ${refund} XPF (${pol.pct}%)`,pol.pct===100?'green':pol.pct===50?'yellow':'red');
    render();
};

window.cancelInstructor = async function(bookingId) {
    const b = DB.bookings.find(x=>x.id===bookingId);
    if (!b) return;
    const diffH = (new Date(b.date+'T'+b.time)-new Date())/3600000;
    const isLate = diffH<24;
    if (!confirm(isLate?`‚ö†Ô∏è Annulation < 24h !\n\nP√©nalit√© visibilit√© -10% pendant 7 jours\nConfirmer ?`:`Annuler ce cours ? L'√©l√®ve sera rembours√©.`)) return;

    await sb.from('bookings').update({ status:'cancelled', cancelled_by:'instructor', refund_amount:b.amount, cancelled_at:new Date().toISOString() }).eq('id', bookingId);
    await sb.from('slots').update({ available:true }).eq('id', b.slot_id);

    if (isLate) {
        const end = new Date(); end.setDate(end.getDate()+7);
        await sb.from('instructors').update({ penalty_until:end.toISOString(), visibility_penalty:10 }).eq('id', currentUser.id);
    }

    await loadData();
    notif(isLate?'‚ö†Ô∏è P√©nalit√© appliqu√©e':'‚úÖ Cours annul√©',isLate?'Visibilit√© -10% pendant 7 jours':'√âl√®ve rembours√©',isLate?'red':'orange');
    render();
};

window.confirmB = async (id) => {
    await sb.from('bookings').update({ status:'confirmed' }).eq('id', id);
    await loadData(); notif('‚úÖ Cours accept√©','','green'); render();
};

window.rejectB = async (id) => {
    const b = DB.bookings.find(x=>x.id===id);
    await sb.from('bookings').update({ status:'rejected' }).eq('id', id);
    if (b) await sb.from('slots').update({ available:true }).eq('id', b.slot_id);
    await loadData(); notif('Cours refus√©','','red'); render();
};

window.deleteSlot = async (id) => {
    if (!confirm('Supprimer ce cr√©neau ?')) return;
    await sb.from('slots').delete().eq('id', id);
    DB.slots = DB.slots.filter(s=>s.id!==id);
    notif('Cr√©neau supprim√©','','orange'); render();
};

// ========== GPS & CARTE ==========
function initMap() {
    if (map){map.remove();map=null;iMarkers=[];}
    map=L.map('map').setView([NOUMEA.lat,NOUMEA.lng],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
    const now=new Date();
    sortedInstructors().forEach(i=>{
        if(!i.lat) return;
        const hasPenalty=i.penalty_until&&new Date(i.penalty_until)>now;
        const color=hasPenalty?'#f87171':i.is_online?'#22c55e':'#9ca3af';
        const avatarHtml = i.avatar_url
            ? `<img src="${i.avatar_url}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:3px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.25);display:block;">`
            : `<div style="background:${color};width:44px;height:44px;border-radius:50%;border:3px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:white;">${(i.name||'?').charAt(0).toUpperCase()}</div>`;
        const icon=L.divIcon({html:avatarHtml,className:'',iconSize:[44,44],iconAnchor:[22,22]});
        const slots=DB.slots.filter(s=>s.instructor_id===i.id).length;
        const marker=L.marker([i.lat,i.lng],{icon}).addTo(map).bindPopup(`<div style="text-align:center;padding:10px;min-width:180px"><p style="font-weight:800;font-size:15px">${i.name}</p><p style="color:#f97316;margin:4px 0">‚≠ê ${i.rating||'N/A'}</p><p style="color:#6b7280;font-size:13px">üìç ${i.location}</p><p style="font-weight:700;color:#f97316;font-size:17px;margin:6px 0">${i.hourly_rate} XPF/h</p><p style="font-size:12px;color:#6b7280;margin-bottom:8px">üìÜ ${slots} cr√©neaux</p><span style="background:${i.is_online?'#dcfce7':'#f3f4f6'};color:${i.is_online?'#16a34a':'#6b7280'};padding:3px 10px;border-radius:20px;font-size:12px;display:block;margin-bottom:10px">${i.is_online?'üü¢ Disponible':'‚ö´ Hors ligne'}</span><button onclick="showSlots('${i.id}')" style="background:#f97316;color:white;border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;width:100%">üìÖ Voir cr√©neaux</button></div>`,{maxWidth:220});
        iMarkers.push({id:i.id,marker});
    });
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{const ic=L.divIcon({html:`<div style="background:#3b82f6;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(59,130,246,0.5)"></div>`,className:'',iconSize:[16,16],iconAnchor:[8,8]});if(userMarker)map.removeLayer(userMarker);userMarker=L.marker([pos.coords.latitude,pos.coords.longitude],{icon:ic}).addTo(map).bindPopup('üìç Ma position');map.setView([pos.coords.latitude,pos.coords.longitude],14);},()=>{});}
}

window.centerOnMe=()=>{if(!navigator.geolocation)return;navigator.geolocation.getCurrentPosition(pos=>{map.setView([pos.coords.latitude,pos.coords.longitude],15);notif('üìç Localis√© !','','blue');},()=>{});};
window.focusInstructor=(id)=>{ showInstructorProfile(id); };

window.startTracking=()=>{
    if(!navigator.geolocation){notif('‚ùå GPS indisponible','','red');return;}
    if(watchId)navigator.geolocation.clearWatch(watchId);
    watchId=navigator.geolocation.watchPosition(async pos=>{
        await sb.from('instructors').update({lat:pos.coords.latitude,lng:pos.coords.longitude,is_online:true}).eq('id',currentUser.id);
        const ic=L.divIcon({html:`<div style="background:#f97316;width:48px;height:48px;border-radius:50%;border:3px solid white;box-shadow:0 4px 15px rgba(249,115,22,0.5);display:flex;align-items:center;justify-content:center;font-size:22px;">üöó</div>`,className:'',iconSize:[48,48],iconAnchor:[24,24]});
        if(userMarker)map.removeLayer(userMarker);
        userMarker=L.marker([pos.coords.latitude,pos.coords.longitude],{icon:ic}).addTo(map);
        map.setView([pos.coords.latitude,pos.coords.longitude],15);
        const el=document.getElementById('gps-status');
        if(el)el.textContent='üü¢ GPS actif ‚Äî Position partag√©e avec les √©l√®ves';
    },err=>notif('‚ùå GPS',err.message,'red'),{enableHighAccuracy:true});
};

window.toggleOnline=async ()=>{
    const i=DB.instructors.find(x=>x.id===currentUser.id);
    if(i){
        const newStatus=!i.is_online;
        await sb.from('instructors').update({is_online:newStatus}).eq('id',currentUser.id);
        i.is_online=newStatus;
        notif(newStatus?'üü¢ En ligne':'‚ö´ Hors ligne','','green');
        render();
    }
};

// ========== NAVIGATION ==========
window.showView=async (v)=>{currentView=v;render();};
window.switchTab=(t)=>{currentTab=t;render();};

window.logout=async ()=>{
    if(watchId)navigator.geolocation.clearWatch(watchId);
    if(currentUser && currentUser.user_type==='instructor'){
        await sb.from('instructors').update({is_online:false}).eq('id',currentUser.id);
    }
    await sb.auth.signOut();
    currentUser=null; currentView='home'; render();
};

window.toggleSignup=(type)=>{
    const s=document.getElementById('name-field').style.display==='none';
    document.getElementById('name-field').style.display=s?'block':'none';
    document.getElementById('name').required=s;
    document.getElementById('form-title').textContent=s?'Cr√©er un compte':'Se connecter';
    document.getElementById('submit-text').textContent=s?"S'inscrire":'Se connecter';
    document.getElementById('toggle-text').textContent=s?'D√©j√† un compte ?':"Pas de compte ?";
};

function setupLoginForm(type) {
    document.getElementById('login-form').onsubmit=async function(e){
        e.preventDefault();
        const email=document.getElementById('email').value;
        const password=document.getElementById('password').value;
        const isSignup=document.getElementById('name-field').style.display!=='none';
        const btn = document.getElementById('submit-text');
        btn.textContent='‚è≥ Chargement...';
        if(isSignup){
            await signup(email, password, document.getElementById('name').value, type);
        } else {
            await login(email, password, type);
        }
        if(document.getElementById('submit-text')) btn.textContent=isSignup?"S'inscrire":'Se connecter';
    };
}

document.addEventListener('submit', async function(e){
    if(e.target.id==='settings-form'){
        e.preventDefault();
        await sb.from('instructors').update({
            location: document.getElementById('s-loc').value,
            phone_number: document.getElementById('s-phone').value,
            hourly_rate: parseInt(document.getElementById('s-rate').value),
            experience: parseInt(document.getElementById('s-exp').value)
        }).eq('id', currentUser.id);
        await loadData();
        notif('‚úÖ Profil sauvegard√©','','green');
    }
});


// ========== ADMIN DASHBOARD ==========
let adminData = { users: [], instructors: [], bookings: [], slots: [] };
let adminTab = 'overview';

async function loadAdminData() {
    const [u, i, b, s] = await Promise.all([
        sb.from('users').select('*').order('created_at', { ascending: false }),
        sb.from('instructors').select('*'),
        sb.from('bookings').select('*').order('created_at', { ascending: false }),
        sb.from('slots').select('*')
    ]);
    adminData.users = u.data || [];
    adminData.instructors = i.data || [];
    adminData.bookings = b.data || [];
    adminData.slots = s.data || [];
    document.getElementById('app').innerHTML = AdminDashboard();
}

function AdminDashboard() {
    const totalRevenue = adminData.bookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid').reduce((s,b)=>s+(b.amount||0),0);
    const totalCommission = Math.round(totalRevenue * COMMISSION);
    const tabs = [{id:'overview',label:'üìä Vue globale'},{id:'users',label:'üë• Utilisateurs'},{id:'instructors',label:'üöó Moniteurs'},{id:'bookings',label:'üìã R√©servations'},{id:'danger',label:'‚ö†Ô∏è Danger Zone'}];
    return `<div class="min-h-screen bg-gray-900 text-white">
        <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üõ°Ô∏è</span>
                    <div><h1 class="text-xl font-extrabold text-orange-400">Admin Panel</h1><p class="text-xs text-gray-400">DriveConnect NC</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-400">üëã ${currentUser.name}</span>
                    <button onclick="showView('student-dashboard')" class="px-3 py-2 text-sm bg-orange-500 hover:bg-orange-600 rounded-xl">üöó App</button>
                    <button onclick="logout()" class="px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 rounded-xl">D√©connexion</button>
                </div>
            </div>
        </header>
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700"><p class="text-gray-400 text-sm">Utilisateurs</p><p class="text-3xl font-extrabold">${adminData.users.length}</p></div>
                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700"><p class="text-gray-400 text-sm">Moniteurs</p><p class="text-3xl font-extrabold text-orange-400">${adminData.instructors.length}</p></div>
                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700"><p class="text-gray-400 text-sm">R√©servations</p><p class="text-3xl font-extrabold text-green-400">${adminData.bookings.length}</p></div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-5"><p class="text-orange-200 text-sm">Commission totale</p><p class="text-3xl font-extrabold">${totalCommission.toLocaleString()} XPF</p></div>
            </div>
            <div class="bg-gray-800 rounded-3xl overflow-hidden border border-gray-700">
                <div class="flex border-b border-gray-700 overflow-x-auto">
                    ${tabs.map(t=>`<button onclick="switchAdminTab('${t.id}')" class="px-6 py-4 font-semibold whitespace-nowrap text-sm transition ${adminTab===t.id?'text-orange-400 border-b-2 border-orange-400 bg-gray-700':'text-gray-400 hover:text-white'}">${t.label}</button>`).join('')}
                </div>
                <div class="p-6">${getAdminTabContent()}</div>
            </div>
        </div>
    </div>`;
}

function getAdminTabContent() {
    if (adminTab==='overview') return `<h3 class="font-bold text-lg mb-4">üìã Derni√®res r√©servations</h3><div class="space-y-3">${adminData.bookings.slice(0,10).map(b=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${b.student_name||'?'} ‚Üí ${b.instructor_name||'?'}</p><p class="text-sm text-gray-400">üìÖ ${b.date} √† ${b.time} ¬∑ ${b.amount||0} XPF</p></div><span class="px-3 py-1 rounded-full text-xs font-bold ${b.status==='confirmed'?'bg-green-900 text-green-400':b.status==='cancelled'?'bg-red-900 text-red-400':'bg-yellow-900 text-yellow-400'}">${b.status}</span></div>`).join('')||'<p class="text-gray-400">Aucune r√©servation</p>'}</div>`;
    if (adminTab==='users') return `<h3 class="font-bold text-lg mb-4">üë• Utilisateurs (${adminData.users.length})</h3><div class="space-y-2">${adminData.users.map(u=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${u.name||'?'} ${u.is_admin?'üõ°Ô∏è':''}</p><p class="text-sm text-gray-400">${u.email}</p></div><div class="flex gap-2"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.user_type==='student'?'bg-blue-900 text-blue-400':'bg-orange-900 text-orange-400'}">${u.user_type||'?'}</span>${!u.is_admin?`<button onclick="adminDeleteUser('${u.id}')" class="text-red-400 text-xs">üóëÔ∏è</button>`:''}</div></div>`).join('')||'<p class="text-gray-400">Aucun</p>'}</div>`;
    if (adminTab==='instructors') return `<h3 class="font-bold text-lg mb-4">üöó Moniteurs (${adminData.instructors.length})</h3><div class="space-y-2">${adminData.instructors.map(i=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${i.name||'?'}</p><p class="text-sm text-gray-400">üìç ${i.location||'?'} ¬∑ ‚≠ê ${i.rating||0} ¬∑ ${i.hourly_rate||0} XPF/h</p>${i.penalty_until&&new Date(i.penalty_until)>new Date()?'<p class="text-xs text-red-400">‚ö†Ô∏è P√©nalis√©</p>':''}</div><div class="flex gap-2"><span class="px-2 py-1 rounded-full text-xs ${i.is_online?'bg-green-900 text-green-400':'bg-gray-600 text-gray-400'}">${i.is_online?'üü¢':'‚ö´'}</span><button onclick="adminVerifyInstructor('${i.id}',${!i.verified})" class="text-xs px-2 py-1 rounded-lg ${i.verified?'bg-green-800 text-green-400':'bg-gray-600 text-gray-300'}">${i.verified?'‚úÖ':'V√©rifier'}</button>${i.penalty_until?`<button onclick="adminRemovePenalty('${i.id}')" class="text-xs px-2 py-1 bg-red-900 text-red-400 rounded-lg">Lever</button>`:''}</div></div>`).join('')||'<p class="text-gray-400">Aucun</p>'}</div>`;
    if (adminTab==='bookings') return `<h3 class="font-bold text-lg mb-4">üìã R√©servations (${adminData.bookings.length})</h3><div class="space-y-2">${adminData.bookings.map(b=>`<div class="bg-gray-700 rounded-xl p-4 flex justify-between items-center"><div><p class="font-semibold">${b.student_name||'?'} ‚Üí ${b.instructor_name||'?'}</p><p class="text-sm text-gray-400">üìÖ ${b.date} ¬∑ ${b.amount||0} XPF ¬∑ Net: ${b.net||0} XPF</p></div><span class="px-3 py-1 rounded-full text-xs font-bold ${b.status==='confirmed'?'bg-green-900 text-green-400':b.status==='cancelled'?'bg-red-900 text-red-400':'bg-yellow-900 text-yellow-400'}">${b.status}</span></div>`).join('')||'<p class="text-gray-400">Aucune</p>'}</div>`;
    if (adminTab==='danger') return `<h3 class="font-bold text-lg mb-4 text-red-400">‚ö†Ô∏è Zone Danger</h3><div class="space-y-4"><div class="bg-red-900/30 border border-red-700 rounded-xl p-4"><p class="font-bold text-red-400 mb-1">Nettoyer les cr√©neaux pass√©s</p><p class="text-sm text-gray-400 mb-3">Supprime tous les cr√©neaux dont la date est d√©pass√©e.</p><button onclick="adminCleanSlots()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl text-sm font-bold">üóëÔ∏è Nettoyer</button></div><div class="bg-gray-700 rounded-xl p-4"><p class="text-sm text-gray-400">üë• ${adminData.users.length} users ¬∑ üöó ${adminData.instructors.length} moniteurs ¬∑ üìã ${adminData.bookings.length} r√©servations ¬∑ üìÖ ${adminData.slots.length} cr√©neaux</p></div></div>`;
    return '';
}

window.switchAdminTab = (t) => { adminTab = t; document.getElementById('app').innerHTML = AdminDashboard(); };
window.adminVerifyInstructor = async (id, v) => { await sb.from('instructors').update({verified:v}).eq('id',id); notif(v?'‚úÖ V√©rifi√©':'Retir√©','','green'); await loadAdminData(); };
window.adminRemovePenalty = async (id) => { await sb.from('instructors').update({penalty_until:null,visibility_penalty:0}).eq('id',id); notif('‚úÖ P√©nalit√© lev√©e','','green'); await loadAdminData(); };
window.adminDeleteUser = async (id) => { if(!confirm('Supprimer ?')) return; await sb.from('users').delete().eq('id',id); notif('Supprim√©','','red'); await loadAdminData(); };
window.adminCleanSlots = async () => { if(!confirm('Supprimer cr√©neaux pass√©s ?')) return; const t=new Date().toISOString().split('T')[0]; await sb.from('slots').delete().lt('date',t); notif('‚úÖ Nettoy√©','','green'); await loadAdminData(); };



// ========== PAGES L√âGALES ==========
function LegalPage(tab) {
    const privacy = `
        <h2 style="font-size:1.5rem;font-weight:800;margin-bottom:1rem">üîí Politique de confidentialit√©</h2>
        <p style="color:#6b7280;margin-bottom:1.5rem">Derni√®re mise √† jour : F√©vrier 2026</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Donn√©es collect√©es</h3>
        <p style="margin-bottom:1rem">Nous collectons votre nom, email, type de compte, et pour les moniteurs votre position GPS en temps r√©el.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">H√©bergement</h3>
        <p style="margin-bottom:1rem"><strong>Supabase</strong> ‚Äî base de donn√©es et authentification (Cor√©e du Sud).<br><strong>Vercel</strong> ‚Äî h√©bergement de l'application web.<br><strong>PayPal</strong> ‚Äî traitement des paiements. Vos donn√©es bancaires ne sont jamais stock√©es sur nos serveurs.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Cookies</h3>
        <p style="margin-bottom:1rem">Nous utilisons uniquement des cookies fonctionnels essentiels (session Supabase). Aucun cookie publicitaire ou tracking tiers.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">GPS</h3>
        <p style="margin-bottom:1rem">Le partage de position est optionnel et r√©serv√© aux moniteurs. Les donn√©es GPS ne sont pas conserv√©es apr√®s la session.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Droit de suppression</h3>
        <p style="margin-bottom:1rem">Vous pouvez demander la suppression de toutes vos donn√©es √† tout moment en nous contactant. Nous r√©pondons sous 30 jours.</p>

        <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:1rem;margin-top:1.5rem">
            <p style="font-weight:600;color:#ea580c">Contact</p>
            <p style="color:#374151">üìß privacy@driveconnect-nc.app<br>üìû +687 84.40.22</p>
        </div>`;

    const terms = `
        <h2 style="font-size:1.5rem;font-weight:800;margin-bottom:1rem">üìã Conditions G√©n√©rales d'Utilisation</h2>
        <p style="color:#6b7280;margin-bottom:1.5rem">Derni√®re mise √† jour : F√©vrier 2026</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Objet de la plateforme</h3>
        <p style="margin-bottom:1rem">DriveConnect NC est une plateforme de mise en relation entre √©l√®ves et moniteurs de conduite √† Noum√©a, Nouvelle-Cal√©donie.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">R√¥le de DriveConnect</h3>
        <p style="margin-bottom:1rem">DriveConnect NC agit comme interm√©diaire technique. Nous ne sommes pas employeur des moniteurs et pr√©levons une commission de 2% sur chaque transaction.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Responsabilit√© des moniteurs</h3>
        <p style="margin-bottom:1rem">Les moniteurs doivent √™tre titulaires des dipl√¥mes l√©gaux requis, disposer d'un v√©hicule assur√©, et honorer les cr√©neaux r√©serv√©s.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Politique d'annulation</h3>
        <p style="margin-bottom:0.5rem">‚Ä¢ Plus de 48h avant le cours ‚Üí remboursement 100%</p>
        <p style="margin-bottom:0.5rem">‚Ä¢ Entre 24h et 48h ‚Üí remboursement 50%</p>
        <p style="margin-bottom:1rem">‚Ä¢ Moins de 24h ‚Üí aucun remboursement</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Paiements</h3>
        <p style="margin-bottom:1rem">Tous les paiements sont trait√©s via PayPal. Les remboursements sont effectu√©s sous 5 √† 10 jours ouvr√©s.</p>

        <h3 style="font-weight:700;margin-bottom:0.5rem">Suspension de compte</h3>
        <p style="margin-bottom:1rem">DriveConnect NC peut suspendre tout compte en cas de violation des CGU, fausse d√©claration, comportement abusif ou fraude av√©r√©e.</p>

        <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:1rem;margin-top:1.5rem">
            <p style="font-weight:600;color:#ea580c">Contact</p>
            <p style="color:#374151">üìß legal@driveconnect-nc.app<br>üìû +687 84.40.22</p>
        </div>`;

    return `<div class="min-h-screen bg-gray-50">
        <div class="max-w-2xl mx-auto px-4 py-8">
            <button onclick="showView('home')" class="mb-6 text-orange-500 font-semibold flex items-center gap-2">‚Üê Retour</button>
            <div class="flex gap-3 mb-8">
                <button onclick="showView('privacy')" class="px-5 py-2 rounded-xl font-semibold text-sm transition ${tab==='privacy'?'bg-orange-500 text-white':'bg-white border border-gray-200 text-gray-500'}"}>üîí Confidentialit√©</button>
                <button onclick="showView('terms')" class="px-5 py-2 rounded-xl font-semibold text-sm transition ${tab==='terms'?'bg-orange-500 text-white':'bg-white border border-gray-200 text-gray-500'}"}>üìã CGU</button>
            </div>
            <div class="bg-white rounded-3xl shadow-sm p-8" style="line-height:1.7">
                ${tab==='privacy' ? privacy : terms}
            </div>
        </div>
    </div>`;
}

function render() {
    if(map){map.remove();map=null;iMarkers=[];}
    const app=document.getElementById('app');
    switch(currentView){
        case 'home':                app.innerHTML=HomePage(); break;
        case 'student-login':       app.innerHTML=LoginPage('student');    setupLoginForm('student');    break;
        case 'instructor-login':    app.innerHTML=LoginPage('instructor'); setupLoginForm('instructor'); break;
        case 'student-dashboard':   app.innerHTML=StudentDashboard();      setTimeout(()=>initMap(),100); break;
        case 'instructor-dashboard':app.innerHTML=InstructorDashboard();   setTimeout(()=>initMap(),100); break;
        case 'admin':               loadAdminData(); break;
        case 'privacy':             app.innerHTML=LegalPage('privacy'); break;
        case 'terms':               app.innerHTML=LegalPage('terms'); break;
    }
}

// ========== D√âMARRAGE ==========
// ========== SERVICE WORKER PWA ==========
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}
const VAPID_PUBLIC = 'BMjTOVHtirDedvOuVi151Q7lrkGvJM0h8tmgwHxrfbPzXc0-P4LQufCwlfXYw5pKLV6-SIKeTMVZNAQMxVtjqHU';

async function subscribeToPush() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
    try {
        const reg = await navigator.serviceWorker.ready;
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;
        const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: VAPID_PUBLIC });
        const { endpoint, keys } = sub.toJSON();
        await sb.from('push_subscriptions').upsert({ user_id: currentUser.id, endpoint, p256dh: keys.p256dh, auth: keys.auth }, { onConflict: 'user_id,endpoint' });
    } catch(e) { console.error('Push:', e); }
}

async function sendPushToUser(userId, title, body) {
    try {
        const token = (await sb.auth.getSession()).data.session?.access_token;
        await fetch('https://nnmdvepfyccnehzbvpfn.supabase.co/functions/v1/send-push', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ user_id: userId, title, body, url: '/app.html' })
        });
    } catch(e) { console.error(e); }
}

// ===== AVIS =====
async function showMyReviews() {
    if (!currentUser) return;
    const { data: reviews } = await sb.from('reviews').select('*').eq('instructor_id', currentUser.id).order('created_at', { ascending: false }).limit(20);
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-[9999] p-4';
    const list = reviews?.length ? reviews.map(r => `
        <div class="p-4 rounded-xl mb-3" style="background:var(--bg)">
            <div class="flex justify-between items-center mb-2">
                <p class="font-semibold text-sm" style="color:var(--text)">${r.student_name || '√âl√®ve'}</p>
                <span style="color:#F59E0B">${'‚≠ê'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</span>
            </div>
            ${r.comment ? `<p class="text-sm" style="color:var(--text-muted)">"${r.comment}"</p>` : ''}
            <p class="text-xs mt-2" style="color:var(--text-muted)">${new Date(r.created_at).toLocaleDateString('fr-FR')}</p>
        </div>`).join('') : '<p class="text-center py-8" style="color:var(--text-muted)">Aucun avis pour l'instant</p>';
    modal.innerHTML = `<div class="rounded-3xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto" style="background:var(--surface)">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg" style="color:var(--text)">‚≠ê Mes avis (${reviews?.length || 0})</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-2xl" style="color:var(--text-muted)">√ó</button>
        </div>
        ${list}
    </div>`;
    document.body.appendChild(modal);
}

async function checkPendingRatings() {
    if (!currentUser || currentUser.user_type !== 'student') return;
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const { data: unrated } = await sb.from('bookings')
        .select('id, instructor_id, instructor_name, date, time')
        .eq('student_id', currentUser.id)
        .eq('status', 'confirmed')
        .eq('rated', false)
        .lt('date', new Date().toISOString().split('T')[0])
        .limit(1);
    if (unrated && unrated.length > 0) {
        const b = unrated[0];
        setTimeout(() => {
            notif('‚≠ê Comment s'est pass√© votre cours ?', `Avec ${b.instructor_name} le ${b.date}`, 'orange');
            setTimeout(() => showRating(b.id, b.instructor_id, b.instructor_name), 3000);
        }, 2000);
    }
}

async function boot() {
    document.getElementById('app').innerHTML = '<div class="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center"><div class="text-center"><div class="text-5xl mb-4">üöó</div><p class="text-xl font-bold text-orange-600">DriveConnect NC</p><p class="text-gray-400 mt-2">Connexion √† la base de donn√©es...</p><div class="mt-4 w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div></div>';

    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        const { data: profile } = await sb.from('users').select('*').eq('id', session.user.id).single();
        if (profile) {
            currentUser = { ...profile, ...session.user };
            if (profile.is_admin) {
                currentView = 'admin';
            } else {
                currentView = profile.user_type === 'student' ? 'student-dashboard' : 'instructor-dashboard';
            }
        }
}
    subscribeToPush();

    await loadData();
    render();

    setInterval(async () => {
        if (!document.hidden && currentView !== 'admin') {
            await loadData();
            if (currentUser) render();
        }
    }, 15000);
}


window.submitRating = async function(bookingId, instructorId) {
    const rating = window._selectedRating || 0;
    if (!rating) { notif('\u274c Choisissez une note', '', 'red'); return; }
    const comment = document.getElementById('review-text')?.value || '';

    const { data: instructor } = await sb.from('instructors').select('rating,total_reviews').eq('id', instructorId).single();
    if (!instructor) { notif('\u274c Erreur', '', 'red'); return; }

    const newTotal = (instructor.total_reviews || 0) + 1;
    const newRating = (((instructor.rating || 0) * (instructor.total_reviews || 0)) + rating) / newTotal;

    await sb.from('instructors').update({
        rating: Math.round(newRating * 10) / 10,
        total_reviews: newTotal
    }).eq('id', instructorId);

    await sb.from('bookings').update({ rated: true, rating_given: rating, rating_comment: comment }).eq('id', bookingId);

    // Sauvegarder dans la table reviews
    await sb.from('reviews').insert({
        booking_id: bookingId,
        student_id: currentUser.id,
        instructor_id: instructorId,
        rating: rating,
        comment: comment,
        student_name: currentUser.name
    });

    // Notifier le moniteur
    sendPushToUser(instructorId, `${'‚≠ê'.repeat(rating)} Nouvel avis !`,
        `${currentUser.name} vous a donn√© ${rating}/5 √©toiles${comment ? ' : "' + comment.substring(0,50) + '"' : ''}`);

    document.getElementById('rating-modal')?.remove();
    notif('\u2b50 Merci pour votre avis !', `Vous avez donn\u00e9 ${rating}/5 \u00e9toiles`, 'green');
    await loadData();
    render();
}

window.hoverStar = function(val) {
    document.querySelectorAll('.star').forEach((s,i) => { s.textContent = i < val ? '\u2b50' : '\u2606'; });
}

window.resetStars = function() {
    const selected = window._selectedRating || 0;
    document.querySelectorAll('.star').forEach((s,i) => { s.textContent = i < selected ? '\u2b50' : '\u2606'; });
}

window.selectStar = function(val) {
    window._selectedRating = val;
    document.querySelectorAll('.star').forEach((s,i) => { s.textContent = i < val ? '\u2b50' : '\u2606'; });
}



// ========== MODE SOMBRE ==========
let isDark = localStorage.getItem('darkMode') === 'true';
function applyDark() {
    if (isDark) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
}
function toggleDark() {
    isDark = !isDark;
    localStorage.setItem('darkMode', isDark);
    applyDark();
    document.querySelectorAll('#dark-btn').forEach(b => b.textContent = isDark ? '‚òÄÔ∏è' : 'üåô');
}
applyDark();

window.showRating = function(bookingId, instructorId, instructorName) {
    window._selectedRating = 0;
    const stars = [1,2,3,4,5].map(i =>
        '<span style="font-size:2.2rem;cursor:pointer;transition:transform 0.1s" data-val="' + i + '" ' +
        'onclick="window.selectStar(' + i + ')" ' +
        'onmouseover="window.hoverStar(' + i + ')" ' +
        'onmouseout="window.resetStars()">‚òÜ</span>'
    ).join('');
    const modal = document.createElement('div');
    modal.id = 'rating-modal';
    modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-[9999] p-4';
    modal.innerHTML =
        '<div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">' +
        '<h3 class="text-xl font-bold mb-2 text-center">‚≠ê Noter ' + instructorName + '</h3>' +
        '<p class="text-gray-400 text-sm text-center mb-6">Comment s&#39;est pass&#233; votre cours ?</p>' +
        '<div class="flex justify-center gap-3 mb-6" id="star-container">' + stars + '</div>' +
        '<textarea id="review-text" class="w-full border border-gray-200 rounded-xl p-3 text-sm mb-4 outline-none focus:border-orange-400" rows="3" placeholder="Commentaire optionnel..."></textarea>' +
        '<div class="flex gap-3">' +
        '<button onclick="document.getElementById(\'rating-modal\').remove()" class="flex-1 border border-gray-200 py-3 rounded-xl font-semibold text-gray-500">Annuler</button>' +
        '<button onclick="window.submitRating(\''+bookingId+'\',\''+instructorId+'\')" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">Envoyer ‚≠ê</button>' +
        '</div></div>';
    document.body.appendChild(modal);
}


// ========== CHAT ==========
let chatSubscription = null;

window.openChat = async function(bookingId, otherUserId, otherName) {
    // Corriger le null si otherName est vide
    if (!otherName || otherName === 'null' || otherName === 'undefined') {
        otherName = 'Votre contact';
    }
    // Fermer subscription pr√©c√©dente
    if (chatSubscription) {
        chatSubscription.unsubscribe();
        chatSubscription = null;
    }

    const modal = document.createElement('div');
    modal.id = 'chat-modal';
    modal.className = 'fixed inset-0 bg-black/60 flex items-end md:items-center justify-center z-[9999] p-0 md:p-4';
    const chatHTML = [
        '<div class="bg-white w-full md:max-w-md md:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col" style="height:85vh;max-height:600px">',
        '<div class="flex items-center justify-between p-4 border-b">',
        '<div><h3 class="font-bold text-lg">&#128172; ' + otherName + '</h3>',
        '<p class="text-xs text-gray-400">Messages en temps r&#233;el</p></div>',
        '<button onclick="window.closeChat()" class="text-gray-400 hover:text-gray-600 text-2xl">&#x2715;</button>',
        '</div>',
        '<div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>',
        '<div class="p-4 border-t flex gap-2">',
        '<input id="chat-input" type="text" placeholder="Message..." class="flex-1 border border-gray-200 rounded-xl px-4 py-2 outline-none focus:border-blue-400 text-sm">',
        '<button id="chat-send-btn" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:bg-blue-600">&#8594;</button>',
        '</div></div>'
    ].join('');
    modal.innerHTML = chatHTML;
    document.body.appendChild(modal);

    // Event listeners
    const sendBtn = document.getElementById('chat-send-btn');
    const chatInput = document.getElementById('chat-input');
    if (sendBtn) sendBtn.onclick = () => sendMessage(bookingId);
    if (chatInput) chatInput.addEventListener('keydown', (e) => { if(e.key==='Enter') sendMessage(bookingId); });

    // Charger les messages existants
    await loadMessages(bookingId);

    // Souscrire aux nouveaux messages - Broadcast pour instantan√© + postgres_changes pour fiabilit√©
    chatSubscription = sb.channel('chat-' + bookingId)
        .on('broadcast', { event: 'new_message' }, (payload) => {
            // Message re√ßu instantan√©ment via broadcast
            if (payload.payload.sender_id !== currentUser.id) {
                appendMessage(payload.payload);
            }
        })
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages',
            filter: 'booking_id=eq.' + bookingId
        }, (payload) => {
            // √âviter les doublons pour les messages de l'autre personne
            const existing = document.querySelector('[data-msg-id="' + payload.new.id + '"]');
            if (!existing) appendMessage(payload.new);
        })
        .subscribe();
}

window.closeChat = function() {
    if (chatSubscription) {
        chatSubscription.unsubscribe();
        chatSubscription = null;
    }
    document.getElementById('chat-modal')?.remove();
}

async function loadMessages(bookingId) {
    const { data } = await sb.from('messages')
        .select('*')
        .eq('booking_id', bookingId)
        .order('created_at', { ascending: true });

    const container = document.getElementById('chat-messages');
    if (!container) return;
    container.innerHTML = '';
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 text-sm py-8">Aucun message ¬∑ Commencez la conversation !</p>';
        return;
    }
    data.forEach(msg => appendMessage(msg));
}

function appendMessage(msg) {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    // Supprimer le message "Aucun message" si pr√©sent
    const empty = container.querySelector('p');
    if (empty) empty.remove();

    const isMe = msg.sender_id === currentUser.id;
    const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
    const div = document.createElement('div');
    div.className = 'flex ' + (isMe ? 'justify-end' : 'justify-start');
    div.innerHTML =
        '<div class="max-w-xs">' +
        '<div class="' + (isMe ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800') + ' rounded-2xl ' + (isMe ? 'rounded-br-sm' : 'rounded-bl-sm') + ' px-4 py-2 text-sm">' +
        msg.content +
        '</div>' +
        '<p class="text-xs text-gray-400 mt-1 ' + (isMe ? 'text-right' : '') + '">' + (isMe ? 'Vous' : msg.sender_name) + ' ¬∑ ' + time + '</p>' +
        '</div>';
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

window.sendMessage = async function(bookingId) {
    const input = document.getElementById('chat-input');
    const msgContent = input?.value?.trim();
    if (!msgContent) return;
    input.value = '';

    const msg = {
        booking_id: bookingId,
        sender_id: currentUser.id,
        sender_name: currentUser.name || 'Moi',
        content: sanitize(msgContent),
        created_at: new Date().toISOString()
    };

    // Afficher imm√©diatement c√¥t√© envoyeur
    appendMessage(msg);

    // Broadcaster pour l'autre personne (instantan√©)
    sb.channel('chat-' + bookingId).send({
        type: 'broadcast',
        event: 'new_message',
        payload: msg
    });

    // Sauvegarder en base (persistant)
    const { error } = await sb.from('messages').insert({
        booking_id: msg.booking_id,
        sender_id: msg.sender_id,
        sender_name: msg.sender_name,
        content: msg.content
    });

    if (error) notif('‚ùå Erreur envoi', error.message, 'red');
}


// ========== AVATAR ==========
window.previewAvatar = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { notif('‚ùå Fichier trop lourd', 'Maximum 5MB', 'red'); return; }

    const reader = new FileReader();
    reader.onload = (e) => {
        const preview = document.getElementById('avatar-preview');
        if (preview) preview.innerHTML = '<img src="'+e.target.result+'" class="w-full h-full object-cover" alt="Preview">';
    };
    reader.readAsDataURL(file);

    // Upload imm√©diat
    uploadAvatar(file);
}

async function uploadAvatar(file) {
    const ext = file.name.split('.').pop();
    const path = currentUser.id + '/avatar.' + ext;

    notif('‚è≥ Upload en cours...', '', 'orange');

    const { data, error } = await sb.storage.from('avatars').upload(path, file, {
        upsert: true,
        contentType: file.type
    });

    if (error) { notif('‚ùå Erreur upload', error.message, 'red'); return; }

    const { data: urlData } = sb.storage.from('avatars').getPublicUrl(path);
    const avatarUrl = urlData.publicUrl + '?t=' + Date.now();

    await sb.from('instructors').update({ avatar_url: avatarUrl }).eq('id', currentUser.id);
    await sb.from('users').update({ avatar_url: avatarUrl }).eq('id', currentUser.id);

    currentUser.avatar_url = avatarUrl;
    notif('‚úÖ Photo mise √† jour !', 'Visible par tous les √©l√®ves', 'green');
    await loadData();
    render();
}



// ========== PROFIL PUBLIC MONITEUR ==========
window.focusInstructor = function(id) { window.showInstructorProfile(id); };

window.showInstructorProfile = function(instructorId) {
    const inst = DB.instructors.find(x => x.id === instructorId);
    if (!inst) return;
    const slots = DB.slots.filter(s => s.instructor_id === instructorId && s.available);
    const initials = (inst.name || '?').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    const stars = inst.rating ? Math.round(inst.rating) : 0;

    // Supprimer modal existant
    document.getElementById('profile-modal')?.remove();

    // Cr√©er overlay
    const overlay = document.createElement('div');
    overlay.id = 'profile-modal';
    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center';
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });

    // Cr√©er panel
    const panel = document.createElement('div');
    panel.style.cssText = 'width:100%;max-width:480px;border-radius:24px 24px 0 0;overflow:hidden;max-height:90vh;overflow-y:auto;background:var(--surface)';

    // Header sombre
    const header = document.createElement('div');
    header.style.cssText = 'background:linear-gradient(135deg,#1A1A1A,#2D2D2D);padding:24px;position:relative';

    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&#x2715;';
    closeBtn.style.cssText = 'position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:16px';
    closeBtn.onclick = () => overlay.remove();

    const avatarDiv = document.createElement('div');
    avatarDiv.style.cssText = 'width:72px;height:72px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:white;background:var(--primary);flex-shrink:0';
    if (inst.avatar_url) {
        const img = document.createElement('img');
        img.src = inst.avatar_url;
        img.style.cssText = 'width:100%;height:100%;object-fit:cover';
        img.alt = inst.name;
        avatarDiv.appendChild(img);
    } else {
        avatarDiv.textContent = initials;
    }

    const infoDiv = document.createElement('div');
    infoDiv.innerHTML = '<h2 style="font-size:20px;font-weight:700;color:white;margin-bottom:4px">' + inst.name + (inst.verified ? ' <span style="background:#DCFCE7;color:#16A34A;font-size:11px;padding:2px 8px;border-radius:20px;font-weight:600">‚úì V√©rifi√©</span>' : '') + '</h2>' +
        '<p style="color:rgba(255,255,255,0.5);font-size:13px">üìç ' + (inst.location || 'Noum√©a') + '</p>' +
        '<p style="color:#F59E0B;font-size:14px;margin-top:4px">' + '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5 - stars) + (inst.rating ? ' <span style="color:rgba(255,255,255,0.7)">' + inst.rating.toFixed(1) + '</span>' : '') + ' <span style="color:rgba(255,255,255,0.3);font-size:12px">(' + (inst.total_reviews || 0) + ' avis)</span></p>';

    const flexRow = document.createElement('div');
    flexRow.style.cssText = 'display:flex;align-items:center;gap:16px';
    flexRow.appendChild(avatarDiv);
    flexRow.appendChild(infoDiv);
    header.appendChild(closeBtn);
    header.appendChild(flexRow);

    // Stats bar
    const statsBar = document.createElement('div');
    statsBar.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr;padding:20px;border-bottom:1px solid var(--border)';
    const statsData = [
        { val: (inst.hourly_rate || 0).toLocaleString(), label: 'XPF/heure' },
        { val: inst.experience || '‚Äî', label: 'ans exp.' },
        { val: slots.length, label: 'cr√©neaux' }
    ];
    statsData.forEach((s, i) => {
        const cell = document.createElement('div');
        cell.style.cssText = 'text-align:center' + (i > 0 ? ';border-left:1px solid var(--border)' : '');
        cell.innerHTML = '<p style="font-size:22px;font-weight:700;color:' + (i === 0 ? 'var(--primary)' : 'var(--text)') + '">' + s.val + '</p><p style="font-size:12px;color:var(--text-muted);margin-top:4px">' + s.label + '</p>';
        statsBar.appendChild(cell);
    });

    // Statut en ligne
    const statusBar = document.createElement('div');
    statusBar.style.cssText = 'padding:12px 20px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)';
    statusBar.innerHTML = '<div style="width:10px;height:10px;border-radius:50%;background:' + (inst.is_online ? '#22C55E' : '#9CA3AF') + '"></div><p style="font-size:14px;font-weight:500;color:var(--text)">' + (inst.is_online ? 'En ligne maintenant' : 'Hors ligne') + '</p>';

    // Cr√©neaux
    const slotsSection = document.createElement('div');
    slotsSection.style.cssText = 'padding:20px';
    const slotsTitle = document.createElement('h3');
    slotsTitle.style.cssText = 'font-weight:700;font-size:16px;color:var(--text);margin-bottom:16px';
    slotsTitle.textContent = 'Cr√©neaux disponibles';
    slotsSection.appendChild(slotsTitle);

    if (slots.length === 0) {
        const empty = document.createElement('p');
        empty.style.cssText = 'text-align:center;color:var(--text-muted);font-size:14px;padding:32px 0';
        empty.textContent = 'Aucun cr√©neau disponible pour le moment';
        slotsSection.appendChild(empty);
    } else {
        slots.forEach(s => {
            const slotCard = document.createElement('div');
            slotCard.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:16px;margin-bottom:8px;background:var(--bg);border:1px solid var(--border)';
            const slotInfo = document.createElement('div');
            slotInfo.innerHTML = '<p style="font-weight:600;font-size:14px;color:var(--text)">' + s.date + ' √† ' + s.time + '</p><p style="font-size:12px;color:var(--text-muted);margin-top:2px">Dur√©e : ' + s.duration + 'h</p>';
            const slotRight = document.createElement('div');
            slotRight.style.cssText = 'display:flex;align-items:center;gap:12px';
            const price = document.createElement('p');
            price.style.cssText = 'font-weight:700;color:var(--primary)';
            price.textContent = s.price.toLocaleString() + ' XPF';
            const bookBtn = document.createElement('button');
            bookBtn.className = 'btn-primary';
            bookBtn.style.cssText = 'padding:8px 16px;font-size:13px';
            bookBtn.textContent = 'R√©server';
            bookBtn.onclick = () => {
                overlay.remove();
                window.bookSlot(s.id, instructorId);
            };
            slotRight.appendChild(price);
            slotRight.appendChild(bookBtn);
            slotCard.appendChild(slotInfo);
            slotCard.appendChild(slotRight);
            slotsSection.appendChild(slotCard);
        });
    }

    panel.appendChild(header);
    panel.appendChild(statsBar);
    panel.appendChild(statusBar);
    panel.appendChild(slotsSection);
    overlay.appendChild(panel);
    document.body.appendChild(overlay);
}
// boot() sera appel√© par showApp()
</script>

</div>

<!-- SCRIPT LANDING -->
<script>
// ===== V√âRIFIER SESSION AU CHARGEMENT =====
// Si l'utilisateur est d√©j√† connect√©, montrer l'app directement
const SUPABASE_URL_CHECK = 'https://nnmdvepfyccnehzbvpfn.supabase.co';
const SUPABASE_KEY_CHECK = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ubWR2ZXBmeWNjbmVoemJ2cGZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTE4NjMsImV4cCI6MjA4NjkyNzg2M30.fCvcy_YdRs_Sn0AZobiq0OfGGm9mYJPKwEo9VPte1fY';
const sbCheck = supabase.createClient(SUPABASE_URL_CHECK, SUPABASE_KEY_CHECK);

(async () => {
    const { data: { session } } = await sbCheck.auth.getSession();
    if (session) {
        // D√©j√† connect√© ‚Üí aller directement √† l'app
        showApp();
    }
})();

// ===== LANDING SCROLL & NAV =====

    // Scroll reveal
    const observer = new IntersectionObserver(entries => {
        entries.forEach(e => {
            if (e.isIntersecting) {
                e.target.classList.add('visible');
                observer.unobserve(e.target);
            }
        });
    }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    // Nav background on scroll
    const nav = document.querySelector('nav');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 60) {
            nav.style.background = 'rgba(13,13,13,0.95)';
            nav.style.borderBottom = '1px solid rgba(245,240,235,0.06)';
        } else {
            nav.style.background = 'linear-gradient(to bottom, rgba(13,13,13,0.9), transparent)';
            nav.style.borderBottom = 'none';
        }
    });


// Montrer l'app quand on clique sur "Commencer"
let appBooted = false;
function showApp() {
    document.getElementById('landing-page').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    document.body.classList.add('app-mode');
    if (!appBooted) {
        appBooted = true;
        boot();
    }
}

// Remplacer les liens /app.html par showApp()
document.querySelectorAll('a[href*="app.html"], .nav-cta').forEach(a => {
    a.href = '#';
    a.onclick = (e) => { e.preventDefault(); showApp(); };
});
</script>

</body>
</html>
