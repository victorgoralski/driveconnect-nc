<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>DriveConnect NC</title>
    <meta name="description" content="La plateforme de cours de conduite √† Noum√©a, Nouvelle-Cal√©donie">
    <meta name="theme-color" content="#f97316">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DriveConnect">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=BAA-pkXDiQDK70NDleUwYfDK09m2Gpfm_yrFugTNqSiGLoHWmHxtD49w6f9SsLdWKk9AKeHVJWe35qNdek&components=hosted-buttons&disable-funding=venmo&currency=EUR"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap');
        :root {
            --primary: #FF5A1F;
            --primary-dark: #e04a12;
            --primary-glow: rgba(255,90,31,0.2);
            --surface: #FFFFFF;
            --bg: #F5F5F5;
            --text: #111111;
            --text-secondary: #555555;
            --text-muted: #999999;
            --border: #E8E8E8;
            --border-hover: #CCCCCC;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow: 0 2px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 24px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 48px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.06);
            --shadow-orange: 0 4px 24px rgba(255,90,31,0.25);
            --radius: 16px;
            --radius-lg: 24px;
            --radius-xl: 28px;
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { font-family: 'DM Sans', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); overscroll-behavior-y: contain; -webkit-font-smoothing: antialiased; }
        input, textarea, select { font-size: 16px !important; font-family: 'DM Sans', sans-serif; }

        /* TYPOGRAPHIE */
        .display-font { font-family: 'DM Serif Display', serif; }
        .gradient-text { background: linear-gradient(135deg, #FF5A1F, #FF8C42); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        /* COMPOSANTS */
        .card { background: var(--surface); border-radius: var(--radius-xl); box-shadow: var(--shadow); border: 1px solid var(--border); }
        .btn-primary { 
            background: linear-gradient(135deg, #FF5A1F, #FF7340); color: white; border-radius: 14px; font-weight: 700; padding: 15px 28px; 
            transition: all var(--transition); border: none; cursor: pointer; position: relative; overflow: hidden;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-orange); filter: brightness(1.05); }
        .btn-primary:active { transform: translateY(0); box-shadow: var(--shadow-sm); filter: brightness(0.95); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; box-shadow: none !important; filter: grayscale(0.3); }
        .btn-secondary { 
            background: var(--surface); color: var(--text); border: 1.5px solid var(--border); border-radius: 14px; font-weight: 600; padding: 14px 24px; 
            transition: all var(--transition); cursor: pointer; 
        }
        .btn-secondary:hover { border-color: var(--text); background: var(--bg); transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn-secondary:active { transform: translateY(0); }
        .input-field { 
            width: 100%; padding: 15px 18px; border: 2px solid var(--border); border-radius: 14px; outline: none; 
            background: var(--surface); color: var(--text); transition: all var(--transition-fast); font-size: 15px !important;
        }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }
        .input-field:hover:not(:focus) { border-color: var(--border-hover); }
        .input-field::placeholder { color: var(--text-muted); }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 5px 12px; border-radius: 100px; font-size: 12px; font-weight: 700; letter-spacing: 0.2px; }
        .badge-green { background: #ECFDF5; color: #059669; }
        .badge-red { background: #FEF2F2; color: #DC2626; }
        .badge-yellow { background: #FFFBEB; color: #D97706; }
        .badge-orange { background: #FFF7ED; color: #EA580C; }
        .badge-gray { background: #F3F4F6; color: #6B7280; }
        .badge-online { background: #DCFCE7; color: #16A34A; }

        /* MAP */
        #map { height: 380px; width: 100%; border-radius: var(--radius); overflow: hidden; }
        .leaflet-popup-content-wrapper { border-radius: 14px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }

        /* TABS */
        .tab-btn { transition: all var(--transition); color: var(--text-muted); font-weight: 500; padding: 14px 20px; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }
        .tab-btn:hover:not(.active) { color: var(--text-secondary); }

        /* ANIMATIONS */
        @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideIn { from { opacity:0; transform:translateX(-12px); } to { opacity:1; transform:translateX(0); } }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes successPop { 0% { transform:scale(0.5); opacity:0; } 50% { transform:scale(1.1); } 100% { transform:scale(1); opacity:1; } }
        @keyframes shake { 0%,100% { transform:translateX(0); } 20%,60% { transform:translateX(-6px); } 40%,80% { transform:translateX(6px); } }
        .fade-in { animation: fadeUp 0.4s ease-out forwards; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        .scale-in { animation: scaleIn 0.3s ease-out forwards; }
        .success-pop { animation: successPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .shake { animation: shake 0.4s ease-in-out; }

        /* Staggered children animation */
        .stagger > * { opacity: 0; animation: fadeUp 0.4s ease-out forwards; }
        .stagger > *:nth-child(1) { animation-delay: 0.05s; }
        .stagger > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger > *:nth-child(3) { animation-delay: 0.15s; }
        .stagger > *:nth-child(4) { animation-delay: 0.2s; }
        .stagger > *:nth-child(5) { animation-delay: 0.25s; }
        .stagger > *:nth-child(6) { animation-delay: 0.3s; }
        .stagger > *:nth-child(7) { animation-delay: 0.35s; }
        .stagger > *:nth-child(8) { animation-delay: 0.4s; }

        /* HEADER */
        .app-header { background: rgba(255,255,255,0.92); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 40; }

        /* INSTRUCTOR CARD */
        .instructor-card { background: var(--surface); border-radius: var(--radius-xl); border: 1.5px solid var(--border); overflow: hidden; transition: all var(--transition); cursor: pointer; }
        .instructor-card:hover { border-color: var(--primary); box-shadow: var(--shadow-lg); transform: translateY(-3px); }
        .instructor-card:active { transform: translateY(-1px); }
        .instructor-card-header { background: linear-gradient(135deg, #0D0D0D 0%, #1F1F1F 100%); padding: 28px; }

        /* MODE SOMBRE */
        .dark { --surface: #1C1C1E; --bg: #000000; --text: #F5F5F5; --text-secondary: #AEAEB2; --text-muted: #636366; --border: #2C2C2E; --border-hover: #3A3A3C; --shadow: 0 2px 16px rgba(0,0,0,0.4); }
        .dark .app-header { background: rgba(28,28,30,0.92); }
        .dark .input-field { background: #2C2C2E; color: #F5F5F5; }
        .dark .badge-gray { background: #3A3A3C; color: #AEAEB2; }

        /* MOBILE */
        @media (max-width: 640px) {
            .grid-cols-mobile-1 { grid-template-columns: 1fr !important; }
            .hide-mobile { display: none !important; }
        }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* MODE SOMBRE ‚Äî COULEURS */
        .dark body { background: #0f172a !important; color: #e2e8f0 !important; }
        .dark .bg-white { background: #1e293b !important; }
        .dark .bg-gray-50 { background: #0f172a !important; }
        .dark .bg-gray-100 { background: #1e293b !important; }
        .dark .border-gray-100, .dark .border-gray-200 { border-color: #334155 !important; }
        .dark .text-gray-400 { color: #94a3b8 !important; }
        .dark .text-gray-500 { color: #94a3b8 !important; }
        .dark .text-gray-600 { color: #cbd5e1 !important; }
        .dark .text-gray-800 { color: #e2e8f0 !important; }
        .dark .shadow-xl { box-shadow: 0 20px 60px rgba(0,0,0,0.4) !important; }
        .dark .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; }
        .dark input { background: #0f172a !important; color: #e2e8f0 !important; border-color: #334155 !important; }
        .dark .bg-orange-50 { background: #1c1108 !important; }
        .dark header { background: #1e293b !important; border-color: #334155 !important; }
        .dark .tab-btn { color: #94a3b8; }
        .dark .tab-btn.active { color: #f97316; }

        /* √âTOILES */
        .stars { display:flex; gap:4px; }
        .star { font-size:1.5rem; cursor:pointer; transition: transform var(--transition-fast); }
        .star:hover { transform: scale(1.25); }

        /* ‚îÄ‚îÄ UBER DASHBOARD ‚îÄ‚îÄ */
        .db-hero { background: linear-gradient(160deg,#0D0D0D 0%,#1A1A1A 100%); }
        .db-stat-pill { 
            background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); border-radius:18px; 
            padding:16px 20px; text-align:center; min-width:96px; flex-shrink:0; 
            transition: all var(--transition-fast); 
        }
        .db-stat-pill:hover { background:rgba(255,255,255,0.1); border-color:rgba(255,255,255,0.15); }

        .db-section-title {
            font-size: 13px; font-weight: 800; color: var(--text-muted); letter-spacing: 1.2px; text-transform: uppercase;
            margin: 0 0 16px; padding: 0;
        }

        .db-booking-card { 
            background:#fff; border-radius:22px; padding:20px; border:1px solid #F0F0F0; 
            box-shadow: var(--shadow); transition: all var(--transition); 
        }
        .db-booking-card:hover { transform:translateY(-2px); box-shadow: var(--shadow-md); border-color: #E0E0E0; }
        .db-booking-card:active { transform:translateY(0); }
        .dark .db-booking-card { background:#1C1C1E; border-color:#2C2C2E; }

        .db-action-btn { 
            display:flex; flex-direction:column; align-items:center; gap:8px; padding:20px 12px; 
            background:#fff; border-radius:20px; border:1.5px solid #F0F0F0; cursor:pointer; 
            transition: all var(--transition); flex:1; box-shadow: var(--shadow-sm);
        }
        .db-action-btn:hover { background:#FFF7F3; border-color:#FFD6C4; transform:translateY(-2px); box-shadow: var(--shadow); }
        .db-action-btn:active { transform:translateY(0); }
        .dark .db-action-btn { background:#1C1C1E; border-color:#2C2C2E; }
        .db-action-icon { width:52px; height:52px; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:24px; }

        .db-tab-bar { 
            position:sticky; bottom:0; background:rgba(255,255,255,0.97); backdrop-filter:blur(24px); 
            -webkit-backdrop-filter:blur(24px); border-top:1px solid #E8E8E8; 
            padding:10px 0 env(safe-area-inset-bottom); z-index:30; display:flex; 
        }
        .dark .db-tab-bar { background:rgba(28,28,30,0.97); border-color:#2C2C2E; }
        .db-tab { 
            display:flex; flex-direction:column; align-items:center; gap:4px; padding:6px 0; flex:1; 
            cursor:pointer; border:none; background:none; color:#BBBBBB; transition: all var(--transition-fast); 
            position: relative;
        }
        .db-tab.active { color:#FF5A1F; }
        .db-tab.active::after { 
            content:''; position:absolute; top:-1px; left:50%; transform:translateX(-50%); 
            width:24px; height:3px; background:#FF5A1F; border-radius:0 0 3px 3px; 
        }
        .db-tab:not(.active):hover { color:#888; }
        .db-tab .tab-icon { font-size:22px; transition: transform var(--transition-fast); }
        .db-tab.active .tab-icon { transform: scale(1.1); }
        .db-tab .tab-label { font-size:10px; font-weight:700; letter-spacing:0.3px; }

        .db-instructor-chip { 
            display:flex; align-items:center; gap:14px; padding:16px 18px; background:#fff; 
            border-radius:20px; border:1.5px solid #F0F0F0; box-shadow: var(--shadow-sm); 
            cursor:pointer; transition: all var(--transition); 
        }
        .db-instructor-chip:hover { border-color:#FF5A1F; box-shadow: 0 4px 24px rgba(255,90,31,0.12); transform:translateY(-2px); }
        .db-instructor-chip:active { transform:translateY(0); }
        .dark .db-instructor-chip { background:#1C1C1E; border-color:#2C2C2E; }

        .slot-card { 
            background:#fff; border-radius:18px; padding:16px 18px; border:1px solid #F0F0F0; 
            display:flex; align-items:center; justify-content:space-between; gap:14px; 
            transition: all var(--transition); box-shadow: var(--shadow-sm);
        }
        .slot-card:hover { box-shadow: var(--shadow); }
        .dark .slot-card { background:#1C1C1E; border-color:#2C2C2E; }
        .slot-card.booked { border-color:#93C5FD; background:#EFF6FF; }
        .dark .slot-card.booked { background:#0c1f3d; border-color:#1e3a6e; }

        /* ‚îÄ‚îÄ BOUTONS ACTIONS ‚îÄ‚îÄ */
        button[onclick*="openValidateModal"],
        button[onclick*="openProgressNoteModal"],
        button[onclick*="openChat"],
        button[onclick*="cancelStudent"],
        button[onclick*="cancelInstructor"],
        button[onclick*="showRating"],
        button[onclick*="viewStudentProgress"],
        button[onclick*="confirmB"],
        button[onclick*="rejectB"] {
            transition: all var(--transition-fast) !important;
        }
        button[onclick*="openValidateModal"]:hover,
        button[onclick*="openProgressNoteModal"]:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button[onclick*="openValidateModal"]:active,
        button[onclick*="openProgressNoteModal"]:active { transform: translateY(0); filter: brightness(0.95); }
        button[onclick*="openChat"]:hover { background: #DBEAFE !important; }
        button[onclick*="confirmB"]:hover { background: #D1FAE5 !important; }
        button[onclick*="rejectB"]:hover { background: #FEE2E2 !important; }
        button[onclick*="cancelStudent"]:hover,
        button[onclick*="cancelInstructor"]:hover { color: #991B1B !important; }
        button[onclick*="showRating"]:hover { background: #FED7AA !important; }
        button[onclick*="viewStudentProgress"]:hover { background: #E5E7EB !important; }

        /* ‚îÄ‚îÄ NOTIFICATION AM√âLIOR√âE ‚îÄ‚îÄ */
        .notif-toast {
            animation: fadeUp 0.35s ease-out forwards;
            transition: all var(--transition);
        }
        .notif-toast.hiding {
            animation: none;
            opacity: 0; transform: translateY(-20px);
            transition: all 0.3s ease-in;
        }

        /* ‚îÄ‚îÄ MODALS OVERLAY ‚îÄ‚îÄ */
        .validate-modal, .progress-modal, .progress-view-modal, .reset-pwd-modal, .dc-modal-overlay {
            animation: fadeUp 0.3s ease-out;
        }
        .validate-modal > div, .progress-modal > div, .progress-view-modal > div {
            animation: scaleIn 0.3s ease-out;
        }

        /* ‚îÄ‚îÄ SMOOTH SCROLLBAR ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
    </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>
<script>
// ========== SUPABASE ==========
const SUPABASE_URL = 'https://nnmdvepfyccnehzbvpfn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ubWR2ZXBmeWNjbmVoemJ2cGZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTE4NjMsImV4cCI6MjA4NjkyNzg2M30.fCvcy_YdRs_Sn0AZobiq0OfGGm9mYJPKwEo9VPte1fY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== S√âCURIT√â ==========
function sanitize(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .trim();
}

function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validateInput(name, email, password) {
    if (!name || name.trim().length < 2) { notif('‚ùå Nom invalide', 'Minimum 2 caract√®res', 'red'); return false; }
    if (!validateEmail(email)) { notif('‚ùå Email invalide', 'Format incorrect', 'red'); return false; }
    if (!password || password.length < 6) { notif('‚ùå Mot de passe trop court', 'Minimum 6 caract√®res', 'red'); return false; }
    return true;
}

async function checkDoubleBooking(instructorId, date, time) {
    const { data } = await sb.from('bookings')
        .select('id')
        .eq('instructor_id', instructorId)
        .eq('date', date)
        .eq('time', time)
        .eq('status', 'confirmed');
    return data && data.length > 0;
}



const COMMISSION = 0.15;
const NOUMEA = { lat: -22.2758, lng: 166.4580 };

let currentUser = null;
let currentView = 'home';
let currentTab = 'home';
let map = null, userMarker = null, iMarkers = [], watchId = null;

// Cache local pour √©viter trop de requ√™tes
let DB = { instructors: [], slots: [], bookings: [], progressNotes: [] };

// ========== HELPERS ==========
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

function notif(title, msg, color='orange') {
    const colors = {
        green: { bg:'#ECFDF5', border:'#059669', icon:'#059669', iconBg:'#D1FAE5' },
        red:   { bg:'#FEF2F2', border:'#DC2626', icon:'#DC2626', iconBg:'#FEE2E2' },
        orange:{ bg:'#FFF7ED', border:'#EA580C', icon:'#EA580C', iconBg:'#FED7AA' },
        yellow:{ bg:'#FFFBEB', border:'#D97706', icon:'#D97706', iconBg:'#FEF3C7' }
    };
    const c = colors[color] || colors.orange;
    const icons = { green:'‚úÖ', red:'‚ùå', orange:'‚ö†Ô∏è', yellow:'‚è≥' };
    const n = document.createElement('div');
    n.className = 'notif-toast';
    n.style.cssText = `position:fixed;top:20px;right:20px;max-width:380px;z-index:99999;display:flex;align-items:flex-start;gap:14px;padding:18px 20px;border-radius:20px;background:${c.bg};border:1.5px solid ${c.border}22;box-shadow:0 12px 48px rgba(0,0,0,0.12),0 4px 12px rgba(0,0,0,0.06);cursor:pointer`;
    n.innerHTML = `
        <div style="width:38px;height:38px;border-radius:12px;background:${c.iconBg};display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">${icons[color]||'‚ö†Ô∏è'}</div>
        <div style="flex:1;min-width:0">
            <p style="font-weight:800;font-size:14px;color:#111;margin-bottom:${msg?'3px':'0'}">${title}</p>
            ${msg?`<p style="font-size:13px;color:#6B7280;line-height:1.4">${msg}</p>`:''}
        </div>
        <div style="width:4px;height:100%;min-height:32px;background:${c.border};border-radius:2px;position:absolute;left:0;top:50%;transform:translateY(-50%);border-radius:20px 0 0 20px"></div>`;
    n.onclick = () => { n.classList.add('hiding'); setTimeout(() => n.remove(), 300); };
    document.body.appendChild(n);
    // Progress bar
    const bar = document.createElement('div');
    bar.style.cssText = `position:absolute;bottom:0;left:20px;right:20px;height:3px;border-radius:2px;background:${c.border}40;overflow:hidden`;
    const fill = document.createElement('div');
    fill.style.cssText = `height:100%;background:${c.border};border-radius:2px;width:100%;transition:width 4.5s linear`;
    bar.appendChild(fill);
    n.appendChild(bar);
    n.style.position = 'fixed'; // ensure relative for bar
    requestAnimationFrame(() => fill.style.width = '0%');
    setTimeout(() => { n.classList.add('hiding'); setTimeout(() => n.remove(), 300); }, 5000);
}

function calcPrices(amount) {
    const commission = Math.round(amount * COMMISSION);
    return { total: amount, commission, net: amount - commission };
}

function cancellationPolicy(date, time) {
    const diff = (new Date(date+'T'+time) - new Date()) / 3600000;
    if (diff >= 48) return { pct:100, label:'‚úÖ Remboursement int√©gral (48h+)',  color:'green'  };
    if (diff >= 24) return { pct:50,  label:'‚ö†Ô∏è Remboursement 50% (24h‚Äì48h)',   color:'yellow' };
    return              { pct:0,   label:'‚ùå Aucun remboursement (< 24h)',      color:'red'    };
}

function sortedInstructors() {
    const now = new Date();
    return [...DB.instructors].sort((a,b) => {
        const sA = (a.rating||0)*100 - (a.penalty_until && new Date(a.penalty_until)>now ? (a.visibility_penalty||0) : 0);
        const sB = (b.rating||0)*100 - (b.penalty_until && new Date(b.penalty_until)>now ? (b.visibility_penalty||0) : 0);
        return sB - sA;
    });
}

// ========== CHARGEMENT DONN√âES SUPABASE ==========
async function loadData() {
    const [instRes, slotsRes] = await Promise.all([
        sb.from('instructors').select('*'),
        sb.from('slots').select('*').eq('available', true).gte('date', new Date().toISOString().split('T')[0])
    ]);
    DB.instructors = instRes.data || [];
    DB.slots = slotsRes.data || [];

    if (currentUser) {
        const field = currentUser.user_type === 'student' ? 'student_id' : 'instructor_id';
        const { data } = await sb.from('bookings').select('*').eq(field, currentUser.id).order('created_at', { ascending: false });
        DB.bookings = data || [];

        // Charger les fiches de suivi
        if (currentUser.user_type === 'student') {
            const { data: notes } = await sb.from('progress_notes').select('*').eq('student_id', currentUser.id).order('created_at', { ascending: false });
            DB.progressNotes = notes || [];
        } else {
            // Moniteur : charger les notes qu'il a √©crites
            const { data: notes } = await sb.from('progress_notes').select('*').eq('instructor_id', currentUser.id).order('created_at', { ascending: false });
            DB.progressNotes = notes || [];
        }
    }
}

// ========== AUTH ==========
async function login(email, password, userType) {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) { 
        if (error.message.includes('Email not confirmed') || error.message.includes('not confirmed')) {
            notif('‚ùå Email non confirm√©', 'V√©rifiez votre bo√Æte mail et cliquez le lien de confirmation', 'red');
        } else {
            notif('‚ùå Email ou mot de passe incorrect', '', 'red'); 
        }
        return; 
    }

    const userId = data.user.id;
    const meta = data.user.user_metadata || {};
    // Source de v√©rit√© : user_metadata sauvegard√© lors du signUp
    const savedType = meta.user_type || null;

    // Tenter de r√©cup√©rer le profil
    let { data: profile, error: profileErr } = await sb.from('users').select('*').eq('id', userId).maybeSingle();
    console.log('[LOGIN] Profile fetch:', profile ? 'found, type=' + profile.user_type : 'NOT FOUND', 'error:', profileErr?.message || 'none');
    
    // Si pas de profil ‚Üí le cr√©er
    if (!profile) {
        console.log('[LOGIN] Creating missing profile for', userId, 'type:', savedType || userType);
        const { data: newProfile, error: createErr } = await sb.from('users').upsert({
            id: userId,
            email: data.user.email,
            name: meta.name || email.split('@')[0],
            user_type: savedType || userType
        }, { onConflict: 'id' }).select().single();
        
        if (createErr) console.error('[LOGIN] Profile create error:', createErr.message);
        profile = newProfile;
        
        // Si toujours pas de profil, attendre et r√©essayer (trigger Supabase peut √™tre lent)
        if (!profile) {
            await new Promise(r => setTimeout(r, 1500));
            const retry = await sb.from('users').select('*').eq('id', userId).maybeSingle();
            profile = retry.data;
            if (profile && !profile.user_type) {
                await sb.from('users').update({ user_type: savedType || userType }).eq('id', userId);
                profile.user_type = savedType || userType;
            }
        }
    }

    // Si profil existe mais user_type est null ‚Üí le mettre √† jour
    if (profile && !profile.user_type) {
        console.log('[LOGIN] Fixing null user_type to:', savedType || userType);
        await sb.from('users').update({ user_type: savedType || userType }).eq('id', userId);
        profile.user_type = savedType || userType;
    }

    // D√©terminer le vrai type de l'utilisateur
    const actualType = profile?.user_type || savedType || userType;

    // V√©rifier que le type correspond √† ce qu'il essaie de faire
    if (actualType && actualType !== userType) {
        notif('‚ùå Ce compte est un compte ' + (actualType==='student'?'√©l√®ve':'moniteur') + '. Connectez-vous sur la bonne page.', '', 'red');
        await sb.auth.signOut();
        return;
    }

    // Si on n'a toujours pas de profil, en cr√©er un minimal en m√©moire
    if (!profile) {
        profile = { id: userId, email: data.user.email, name: meta.name || email.split('@')[0], user_type: userType };
    }

    currentUser = { ...profile, ...data.user, user_type: actualType };

    if (actualType === 'instructor') {
        let { data: instProfile } = await sb.from('instructors').select('approval_status').eq('id', userId).maybeSingle();
        if (!instProfile) {
            const { error: instErr } = await sb.from('instructors').upsert({
                id: userId, user_id: userId,
                name: profile.name, email: profile.email,
                rating: 0, total_reviews: 0, experience: 0,
                location: 'Noum√©a', hourly_rate: 4500,
                verified: false, is_online: false,
                lat: NOUMEA.lat, lng: NOUMEA.lng,
                visibility_penalty: 0, approval_status: 'pending_documents'
            }, { onConflict: 'id' });
            if (instErr) console.error('[LOGIN] Instructor create error:', instErr.message);
            currentView = 'instructor-upload-docs';
        } else {
            const status = instProfile.approval_status || 'pending_documents';
            if (status === 'approved') currentView = 'instructor-dashboard';
            else if (status === 'pending_documents') currentView = 'instructor-upload-docs';
            else if (status === 'rejected') currentView = 'instructor-rejected';
            else currentView = 'instructor-pending';
        }
    } else {
        currentView = 'student-dashboard';
    }
    await loadData();
    render();
}

async function signup(email, password, name, userType) {
    if (!validateInput(name, email, password)) return;
    name = sanitize(name);
    email = email.trim().toLowerCase();

    const btn = document.getElementById('submit-text');
    if (btn) btn.textContent = '‚è≥ Cr√©ation du compte...';

    // Cr√©er le compte
    const { data, error } = await sb.auth.signUp({
        email, password,
        options: { 
            data: { name, user_type: userType },
            emailRedirectTo: window.location.origin + '/app.html?role=' + userType
        }
    });
    if (error) { 
        notif('‚ùå ' + error.message, '', 'red'); 
        if (btn) btn.textContent = "S'inscrire";
        return; 
    }

    // V√©rifier si une session a √©t√© cr√©√©e imm√©diatement (= confirmation email d√©sactiv√©e)
    if (data.session) {
        await finalizeSignup(email, name, userType);
        return;
    }

    // Confirmation email activ√©e ‚Üí afficher l'√©cran d'attente
    showEmailConfirmationScreen(email, password, name, userType);
}

function showEmailConfirmationScreen(email, password, name, userType) {
    document.querySelectorAll('.otp-verify-modal').forEach(m => m.remove());
    const modal = document.createElement('div');
    modal.className = 'otp-verify-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeUp 0.3s ease-out';
    modal.innerHTML = `
    <div style="background:#0D0D0D;border-radius:28px;padding:32px;max-width:420px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,0.5);animation:scaleIn 0.3s ease-out">
        <div style="text-align:center;margin-bottom:20px">
            <div style="width:64px;height:64px;background:rgba(255,90,31,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 16px;border:1px solid rgba(255,90,31,0.3)">üìß</div>
            <h3 style="color:#fff;font-weight:900;font-size:20px;margin-bottom:6px">Confirmez votre email</h3>
            <p style="color:#6B7280;font-size:14px;line-height:1.6">Un email de confirmation a √©t√© envoy√© √†</p>
            <p style="color:#FF5A1F;font-weight:700;font-size:15px;margin-top:4px">${email}</p>
        </div>
        
        <div style="background:#1A1A1A;border-radius:16px;padding:16px;margin-bottom:16px">
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px">
                <span style="background:rgba(255,90,31,0.15);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#FF5A1F;flex-shrink:0">1</span>
                <p style="color:#D1D5DB;font-size:13px;line-height:1.5">Ouvrez votre bo√Æte mail <strong style="color:#fff">${email}</strong></p>
            </div>
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px">
                <span style="background:rgba(255,90,31,0.15);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#FF5A1F;flex-shrink:0">2</span>
                <p style="color:#D1D5DB;font-size:13px;line-height:1.5">Cliquez sur le <strong style="color:#fff">lien de confirmation</strong> dans l'email de DriveConnect NC</p>
            </div>
            <div style="display:flex;align-items:flex-start;gap:12px">
                <span style="background:rgba(255,90,31,0.15);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#FF5A1F;flex-shrink:0">3</span>
                <p style="color:#D1D5DB;font-size:13px;line-height:1.5">Revenez ici et cliquez sur <strong style="color:#fff">"J'ai confirm√©"</strong></p>
            </div>
        </div>

        <p id="email-check-status" style="color:#6B7280;font-size:13px;text-align:center;margin-bottom:14px;min-height:20px">
            <span style="animation:pulse 1.5s ease-in-out infinite">‚è≥ En attente de confirmation...</span>
        </p>
        
        <button id="email-confirmed-btn" onclick="window._checkEmailConfirmed()" style="width:100%;padding:16px;background:linear-gradient(135deg,#FF5A1F,#FF7340);color:#fff;border:none;border-radius:16px;font-weight:900;font-size:16px;cursor:pointer;transition:all 0.2s;margin-bottom:10px">
            ‚úÖ J'ai confirm√© mon email
        </button>

        <button onclick="window._resendConfirmation()" id="resend-confirm-btn" style="width:100%;padding:12px;background:transparent;color:#6B7280;border:1px solid #333;border-radius:14px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.15s">
            üìß Renvoyer l'email
        </button>

        <p style="color:#3B3B3B;font-size:11px;text-align:center;margin-top:14px;line-height:1.5">Pensez √† v√©rifier vos spams ¬∑ L'email peut prendre quelques minutes</p>
    </div>`;
    document.body.appendChild(modal);

    // V√©rification automatique toutes les 3s
    let checkInterval = setInterval(async () => {
        try {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                clearInterval(checkInterval);
                modal.remove();
                await finalizeSignup(email, name, userType);
            }
        } catch(e) {}
    }, 3000);

    // Bouton "J'ai confirm√©" : tente de se connecter
    window._checkEmailConfirmed = async () => {
        const btn = document.getElementById('email-confirmed-btn');
        const statusEl = document.getElementById('email-check-status');
        if (btn) { btn.textContent = '‚è≥ V√©rification...'; btn.disabled = true; btn.style.opacity = '0.6'; }

        try {
            const { data: loginData, error: loginErr } = await sb.auth.signInWithPassword({ email, password });
            
            if (loginErr) {
                if (loginErr.message.includes('not confirmed')) {
                    if (statusEl) statusEl.innerHTML = '<span style="color:#EF4444">‚ùå Email pas encore confirm√©. Cliquez le lien dans votre bo√Æte mail.</span>';
                } else {
                    if (statusEl) statusEl.innerHTML = '<span style="color:#EF4444">‚ùå ' + loginErr.message + '</span>';
                }
                if (btn) { btn.textContent = '‚úÖ J\'ai confirm√© mon email'; btn.disabled = false; btn.style.opacity = '1'; }
                return;
            }

            // Connexion r√©ussie = email confirm√©
            clearInterval(checkInterval);
            modal.remove();
            await finalizeSignup(email, name, userType);
        } catch(e) {
            if (statusEl) statusEl.innerHTML = '<span style="color:#EF4444">‚ùå Erreur de v√©rification</span>';
            if (btn) { btn.textContent = '‚úÖ J\'ai confirm√© mon email'; btn.disabled = false; btn.style.opacity = '1'; }
        }
    };

    // Renvoyer l'email
    window._resendConfirmation = async () => {
        const resendBtn = document.getElementById('resend-confirm-btn');
        if (resendBtn) { resendBtn.textContent = '‚è≥ Envoi...'; resendBtn.disabled = true; }
        try {
            await sb.auth.resend({ type: 'signup', email });
            notif('üìß Email renvoy√©', 'V√©rifiez votre bo√Æte mail', 'green');
        } catch(e) {
            notif('‚ö†Ô∏è Erreur', 'Impossible de renvoyer', 'orange');
        }
        if (resendBtn) { resendBtn.textContent = '‚úÖ Email renvoy√©'; setTimeout(() => { resendBtn.textContent = 'üìß Renvoyer l\'email'; resendBtn.disabled = false; }, 3000); }
    };
}

async function finalizeSignup(email, name, userType) {
    // R√©cup√©rer la session
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
        notif('‚ùå Session expir√©e', 'Veuillez vous reconnecter', 'red');
        return;
    }

    const userId = session.user.id;
    console.log('[SIGNUP] Finalizing for', userId, 'type:', userType);

    // Attendre que le trigger Supabase cr√©e le profil (si configur√©)
    await new Promise(r => setTimeout(r, 1000));

    // Essayer de cr√©er/mettre √† jour le profil
    const { data: upsertResult, error: upsertErr } = await sb.from('users').upsert({
        id: userId,
        email, name,
        user_type: userType
    }, { onConflict: 'id' }).select().single();
    
    console.log('[SIGNUP] Upsert result:', upsertResult ? 'OK' : 'null', 'error:', upsertErr?.message || 'none');

    // Si l'upsert a √©chou√© (RLS), essayer un update simple
    if (upsertErr || !upsertResult) {
        console.log('[SIGNUP] Upsert failed, trying update...');
        const { error: updateErr } = await sb.from('users').update({ 
            name, user_type: userType, email 
        }).eq('id', userId);
        console.log('[SIGNUP] Update result:', updateErr?.message || 'OK');
        
        // Si update √©choue aussi, essayer insert
        if (updateErr) {
            console.log('[SIGNUP] Update failed, trying insert...');
            const { error: insertErr } = await sb.from('users').insert({ 
                id: userId, email, name, user_type: userType 
            });
            console.log('[SIGNUP] Insert result:', insertErr?.message || 'OK');
        }
    }

    // V√©rifier que le profil existe maintenant
    await new Promise(r => setTimeout(r, 500));
    let { data: profile } = await sb.from('users').select('*').eq('id', userId).maybeSingle();
    console.log('[SIGNUP] Final profile check:', profile ? 'found, type=' + profile.user_type : 'NOT FOUND');

    // Si moniteur, cr√©er le profil instructeur
    if (userType === 'instructor') {
        const { error: instErr } = await sb.from('instructors').upsert({
            id: userId,
            user_id: userId,
            name, email,
            rating: 0, total_reviews: 0, experience: 0,
            location: 'Noum√©a', hourly_rate: 4500,
            verified: false, is_online: false,
            lat: NOUMEA.lat, lng: NOUMEA.lng,
            visibility_penalty: 0,
            approval_status: 'pending_documents'
        }, { onConflict: 'id' });
        if (instErr) console.error('[SIGNUP] Instructor create error:', instErr.message);
    }

    // Construire currentUser m√™me si le profil n'existe pas encore en DB
    if (profile) {
        currentUser = { ...profile, ...session.user, user_type: userType };
    } else {
        // Fallback : utiliser les donn√©es en m√©moire
        console.warn('[SIGNUP] Profile not found in DB, using memory fallback');
        currentUser = { id: userId, email, name, user_type: userType, ...session.user };
    }

    if (userType === 'instructor') {
        currentView = 'instructor-upload-docs';
    } else {
        currentView = 'student-dashboard';
    }
    await loadData();
    render();
    notif('‚úÖ Compte cr√©√© !', userType === 'instructor' ? 'Envoyez vos documents pour valider votre profil' : 'Bienvenue sur DriveConnect NC', 'green');
}

// ========== HOME ====================
function HomePage() {
    return `<div class="min-h-screen" style="background:linear-gradient(160deg,#0f0f0f 0%,#1a1a1a 50%,#0f0f0f 100%)">
        <!-- Hero -->
        <div class="flex flex-col min-h-screen px-6 pt-16 pb-8 max-w-lg mx-auto">
            <div class="flex-1 flex flex-col justify-center">
                <!-- Logo & Badge -->
                <div class="mb-8 fade-in">
                    <div class="inline-flex items-center gap-2 bg-white/10 border border-white/20 rounded-full px-4 py-2 mb-8">
                        <div class="w-2 h-2 rounded-full bg-green-400"></div>
                        <span class="text-white/80 text-sm font-medium">Disponible √† Noum√©a</span>
                    </div>
                    <h1 class="display-font text-5xl font-normal text-white leading-tight mb-4">
                        Apprenez √† <em style="color:#FF5A1F">conduire</em><br>√† votre rythme
                    </h1>
                    <p class="text-white/50 text-lg leading-relaxed">Trouvez un moniteur qualifi√© pr√®s de chez vous en Nouvelle-Cal√©donie.</p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-3 gap-4 mb-12 fade-in" style="animation-delay:0.1s">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-white">100%</p>
                        <p class="text-white/40 text-xs mt-1">Moniteurs v√©rifi√©s</p>
                    </div>
                    <div class="text-center border-x border-white/10">
                        <p class="text-2xl font-bold text-white">NC</p>
                        <p class="text-white/40 text-xs mt-1">Nouvelle-Cal.</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-white">15%</p>
                        <p class="text-white/40 text-xs mt-1">Commission seul.</p>
                    </div>
                </div>

                <!-- Boutons principaux -->
                <div class="space-y-3 fade-in" style="animation-delay:0.2s">
                    <button onclick="showView('student-login')" class="w-full py-4 rounded-2xl font-semibold text-lg transition-all active:scale-95" style="background:#FF5A1F;color:white">
                        Trouver un moniteur
                    </button>
                    <button onclick="showView('instructor-login')" class="w-full py-4 rounded-2xl font-semibold text-lg transition-all active:scale-95" style="background:rgba(255,255,255,0.08);color:white;border:1.5px solid rgba(255,255,255,0.15)">
                        Je suis moniteur
                    </button>
                </div>
            </div>

            <!-- Footer l√©gal -->
            <div class="flex justify-center gap-6 pt-8 fade-in" style="animation-delay:0.3s">
                <button onclick="showView('privacy')" class="text-white/30 text-sm hover:text-white/60 transition">Confidentialit√©</button>
                <button onclick="showView('terms')" class="text-white/30 text-sm hover:text-white/60 transition">CGU</button>
                <button onclick="showView('mentions')" class="text-white/30 text-sm hover:text-white/60 transition">Mentions l√©gales</button>
            </div>
        </div>
    </div>`;
}

// ========== LOGIN ====================
function LoginPage(type) {
    const isStudent = type === 'student';
    return `<div class="min-h-screen flex flex-col" style="background:var(--bg)">
        <!-- Header minimal -->
        <div class="px-6 pt-14 pb-6">
            <button onclick="showView('home')" class="flex items-center gap-2 text-sm font-medium mb-10" style="color:var(--text-muted)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Retour
            </button>
            <div class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 mb-4 text-xs font-semibold" style="background:${isStudent?'#FFF7ED':'#F0F9FF'};color:${isStudent?'#EA580C':'#0369A1'}">
                ${isStudent ? 'üéì Espace √âl√®ve' : 'üöó Espace Moniteur'}
            </div>
            <h2 class="text-3xl font-bold mb-2" id="form-title" style="color:var(--text)">Connexion</h2>
            <p class="text-sm" style="color:var(--text-muted)">Content de vous revoir !</p>
        </div>

        <!-- Formulaire -->
        <div class="flex-1 px-6">
            <form id="login-form" class="space-y-4">
                <div id="name-field" style="display:none">
                    <input type="text" id="name" class="input-field" placeholder="Nom complet">
                </div>
                <input type="email" id="email" required class="input-field" placeholder="Adresse email">
                <input type="password" id="password" required minlength="6" class="input-field" placeholder="Mot de passe">
                <!-- CGU visible en mode inscription -->
                <div id="legal-check" style="display:none;padding:12px;background:#FFF7ED;border:1px solid #FED7AA;border-radius:12px">
                    <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">
                        <input type="checkbox" id="legal-accept" style="margin-top:3px;accent-color:#FF5A1F;width:18px;height:18px;flex-shrink:0">
                        <span style="font-size:13px;color:#374151;line-height:1.5">
                            J&#39;ai lu et j&#39;accepte les
                            <a onclick="showView('terms')" style="color:#FF5A1F;font-weight:700;text-decoration:underline;cursor:pointer">CGU</a>
                            et la
                            <a onclick="showView('privacy')" style="color:#FF5A1F;font-weight:700;text-decoration:underline;cursor:pointer">Politique de confidentialit&#233;</a>
                            de DriveConnect NC
                        </span>
                    </label>
                </div>
                <button type="submit" class="btn-primary w-full text-center mt-2" style="font-size:16px">
                    <span id="submit-text">Se connecter</span>
                </button>
            </form>
            <div class="mt-6 text-center">
                <button onclick="toggleSignup('${type}')" class="text-sm font-medium" style="color:var(--primary)">
                    <span id="toggle-text">Pas de compte ? S'inscrire</span>
                </button>
                <br>
                <button onclick="forgotPassword()" id="forgot-pwd-btn" class="text-sm mt-3 inline-block" style="color:var(--text-muted)">
                    Mot de passe oubli√© ?
                </button>
            </div>
        </div>
    </div>`;
}

// ========== STUDENT DASHBOARD ====================
function StudentDashboard() {
    const myBookings = DB.bookings;
    const instructors = sortedInstructors();
    const confirmed = myBookings.filter(b=>b.status==='confirmed').length;
    const totalSpent = myBookings.filter(b=>b.status==='confirmed'&&b.payment_status==='paid').reduce((s,b)=>s+(b.amount||0),0);
    const firstName = (currentUser.name||'').split(' ')[0];

    // Onglet actif pour l'√©l√®ve
    const tab = currentTab || 'home';

    return `<div class="min-h-screen" style="background:var(--bg)">

        <!-- HEADER UBER SOMBRE -->
        <div class="db-hero px-5 pt-14 pb-8">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p style="color:rgba(255,255,255,0.4);font-size:12px;font-weight:700;letter-spacing:1.5px">BONJOUR</p>
                    <h1 style="color:#fff;font-size:28px;font-weight:900;margin:4px 0 2px">${firstName} üëã</h1>
                    <p style="color:rgba(255,255,255,0.35);font-size:14px">Pr√™t pour votre prochain cours ?</p>
                </div>
                <div style="display:flex;align-items:center;gap:12px">
                    <button onclick="toggleDark()" style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.2s" id="dark-btn" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">üåô</button>
                    <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#FF5A1F,#FF8C42);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:17px;flex-shrink:0;box-shadow:0 4px 16px rgba(255,90,31,0.3)">
                        ${(currentUser.name||'?').charAt(0).toUpperCase()}
                    </div>
                </div>
            </div>
            <!-- Stats pills -->
            <div style="display:flex;gap:12px;overflow-x:auto;padding-bottom:4px">
                <div class="db-stat-pill">
                    <p style="color:rgba(255,255,255,0.35);font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:6px">COURS</p>
                    <p style="color:#fff;font-size:24px;font-weight:900">${confirmed}</p>
                </div>
                <div class="db-stat-pill">
                    <p style="color:rgba(255,255,255,0.35);font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:6px">D√âPENS√â</p>
                    <p style="color:#FF5A1F;font-size:18px;font-weight:900">${totalSpent.toLocaleString()}</p>
                    <p style="color:rgba(255,255,255,0.25);font-size:10px;margin-top:2px">XPF</p>
                </div>
                <div class="db-stat-pill">
                    <p style="color:rgba(255,255,255,0.35);font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:6px">MONITEURS</p>
                    <p style="color:#fff;font-size:24px;font-weight:900">${instructors.length}</p>
                </div>
            </div>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div style="padding:24px 20px 120px">

        ${tab==='home' ? `
            <!-- Carte -->
            <div class="fade-in" style="background:#fff;border-radius:24px;overflow:hidden;box-shadow:var(--shadow);margin-bottom:28px;border:1px solid #F0F0F0">
                <div style="padding:18px 20px 12px;display:flex;justify-content:space-between;align-items:center">
                    <p class="db-section-title" style="margin:0">Moniteurs √† proximit√©</p>
                    <span class="badge badge-online" style="font-size:11px">‚óè Temps r√©el</span>
                </div>
                <div style="display:flex;gap:8px;padding:0 20px 14px">
                    <span class="badge badge-online" style="font-size:11px"><span style="color:#16A34A">‚óè</span> Disponible</span>
                    <span class="badge badge-gray" style="font-size:11px">‚óã Hors ligne</span>
                </div>
                <div id="map" style="height:240px;border-radius:0"></div>
            </div>

            <!-- Actions rapides -->
            <p class="db-section-title">Actions rapides</p>
            <div class="stagger" style="display:flex;gap:12px;margin-bottom:28px">
                <button class="db-action-btn" onclick="switchTab('bookings')">
                    <div class="db-action-icon" style="background:#FFF7ED">üìã</div>
                    <span style="font-size:12px;font-weight:700;color:var(--text)">Mes cours</span>
                </button>
                <button class="db-action-btn" onclick="switchTab('map')">
                    <div class="db-action-icon" style="background:#EFF6FF">üó∫Ô∏è</div>
                    <span style="font-size:12px;font-weight:700;color:var(--text)">Carte</span>
                </button>
                <button class="db-action-btn" onclick="logout()">
                    <div class="db-action-icon" style="background:#FEF2F2">üö™</div>
                    <span style="font-size:12px;font-weight:700;color:#DC2626">Sortir</span>
                </button>
            </div>

            <!-- Prochain cours -->
            ${(()=>{
                const next = myBookings.filter(b=>b.status==='confirmed'&&new Date(b.date)>=new Date()).sort((a,b)=>new Date(a.date)-new Date(b.date))[0];
                if (!next) return '';
                const daysLeft = Math.ceil((new Date(next.date)-new Date())/(1000*60*60*24));
                return `<p class="db-section-title" style="margin-top:4px">Prochain cours</p>
                <div class="db-booking-card fade-in" style="border-left:4px solid #FF5A1F;margin-bottom:28px">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div>
                            <p style="font-weight:800;font-size:17px;color:var(--text)">${next.instructor_name||'Moniteur'}</p>
                            <p style="color:var(--text-muted);font-size:13px;margin:5px 0">üìÖ ${next.date} ¬∑ ${next.time} ¬∑ ${next.duration}h</p>
                            <p style="color:#FF5A1F;font-weight:900;font-size:16px;margin:8px 0 0">${next.amount.toLocaleString()} XPF</p>
                        </div>
                        <div style="text-align:right">
                            <div style="background:#FF5A1F;color:#fff;border-radius:10px;padding:4px 10px;font-size:11px;font-weight:700;margin-bottom:8px">${daysLeft<=0?"Aujourd\'hui":daysLeft===1?'Demain':'J-'+daysLeft}</div>
                            ${next.status==='confirmed'?`<button onclick="openChat('${next.id}','${next.instructor_id}','${next.instructor_name}')" style="background:#EFF6FF;color:#1D4ED8;border:none;border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer">üí¨ Chat</button>`:''}
                        </div>
                    </div>
                    ${next.completion_code?`<div style="margin-top:12px;padding:10px 14px;background:#FFF7ED;border-radius:12px;display:flex;align-items:center;gap:10px">
                        <span style="font-family:monospace;font-weight:900;font-size:18px;color:#FF5A1F;letter-spacing:4px">${next.completion_code}</span>
                        <span style="font-size:11px;color:#9CA3AF">üîë Code de validation</span>
                    </div>`:''}
                </div>`;
            })()}

            <!-- Moniteurs dispo -->
            <p class="db-section-title">Moniteurs disponibles <span style="background:#F0F0F0;color:#6B7280;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700">${instructors.length}</span></p>
            <div class="stagger" style="display:flex;flex-direction:column;gap:12px">
                ${instructors.slice(0,5).map((i,idx)=>{
                    const slots = DB.slots.filter(s=>s.instructor_id===i.id).length;
                    const initials = (i.name||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                    return `<div class="db-instructor-chip" onclick="showInstructorProfile('${i.id}')">
                        <div style="width:48px;height:48px;border-radius:14px;overflow:hidden;flex-shrink:0;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:17px">
                            ${i.avatar_url?`<img src="${i.avatar_url}" style="width:100%;height:100%;object-fit:cover">`:`${initials}`}
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:6px">
                                <p style="font-weight:800;font-size:15px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${i.name}</p>
                                <div style="width:7px;height:7px;border-radius:50%;background:${i.is_online?'#22C55E':'#D1D5DB'};flex-shrink:0"></div>
                            </div>
                            <p style="font-size:12px;color:var(--text-muted);margin:2px 0">üìç ${i.location||'Noum√©a'} ¬∑ ${slots} cr√©neau${slots>1?'x':''}</p>
                            ${i.rating?`<p style="font-size:12px;color:#F59E0B">‚òÖ ${i.rating.toFixed(1)}</p>`:''}
                        </div>
                        <div style="text-align:right;flex-shrink:0">
                            <p style="font-weight:900;font-size:16px;color:var(--text)">${i.hourly_rate||0}</p>
                            <p style="font-size:11px;color:var(--text-muted)">XPF/h</p>
                        </div>
                    </div>`;
                }).join('')}
                ${instructors.length===0?`<div style="text-align:center;padding:40px;color:var(--text-muted)"><p style="font-size:40px">üöó</p><p>Aucun moniteur disponible</p></div>`:''}
                ${instructors.length>5?`<button onclick="switchTab('map')" style="width:100%;padding:14px;border-radius:16px;border:1.5px dashed #E5E7EB;background:none;color:var(--text-muted);font-weight:600;cursor:pointer;font-size:14px">Voir tous les moniteurs ‚Üí</button>`:''}
            </div>
        ` : ''}

        ${tab==='bookings' ? `
            <p class="db-section-title">Mes r√©servations</p>
            ${myBookings.length===0?`<div class="fade-in" style="text-align:center;padding:80px 20px;color:var(--text-muted)"><p style="font-size:56px;margin-bottom:16px">üìã</p><p style="font-weight:800;font-size:18px;color:var(--text)">Aucune r√©servation</p><p style="font-size:14px;margin-top:6px">R√©servez un cr√©neau avec un moniteur !</p></div>`:''}
            <div class="stagger" style="display:flex;flex-direction:column;gap:14px">
            ${myBookings.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(b=>{
                const isPast = new Date(b.date) < new Date();
                const canCancel = b.status!=='cancelled' && b.status!=='completed' && !isPast;
                const statusColor = b.status==='confirmed'?'#059669':b.status==='cancelled'?'#DC2626':b.status==='completed'?'#059669':b.status==='dispute'?'#9333EA':'#D97706';
                const statusBg = b.status==='confirmed'?'#ECFDF5':b.status==='cancelled'?'#FEF2F2':b.status==='completed'?'#ECFDF5':b.status==='dispute'?'#F3E8FF':'#FFFBEB';
                const statusLabel = b.status==='confirmed'?'Confirm√©':b.status==='cancelled'?'Annul√©':b.status==='completed'?'‚úÖ Termin√©':b.status==='dispute'?'‚ö†Ô∏è Litige':'En attente';
                return `<div class="db-booking-card">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
                        <div>
                            <p style="font-weight:800;font-size:15px;color:var(--text)">${b.instructor_name||'Moniteur'}</p>
                            <p style="color:var(--text-muted);font-size:13px;margin:3px 0">üìÖ ${b.date} ¬∑ ${b.time} ¬∑ ${b.duration}h</p>
                        </div>
                        <span style="background:${statusBg};color:${statusColor};border-radius:20px;padding:4px 10px;font-size:11px;font-weight:700">${statusLabel}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <p style="font-weight:900;font-size:17px;color:#FF5A1F">${b.amount.toLocaleString()} XPF</p>
                        <div style="display:flex;gap:8px;align-items:center">
                            ${b.status==='confirmed'&&!isPast?`<button onclick="cancelStudent('${b.id}')" style="color:#DC2626;background:none;border:none;font-size:12px;font-weight:700;cursor:pointer">Annuler</button>`:''}
                            ${isPast&&b.status==='completed'&&!b.rated?`<button onclick="showRating('${b.id}','${b.instructor_id}','${b.instructor_name}')" style="background:#FFF7ED;color:#EA580C;border:none;border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer">‚≠ê Noter</button>`:''}
                            ${b.status==='confirmed'?`<button onclick="openChat('${b.id}','${b.instructor_id}','${b.instructor_name}')" style="background:#EFF6FF;color:#1D4ED8;border:none;border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer">üí¨ Chat</button>`:''}
                        </div>
                    </div>
                    ${b.completion_code&&b.status==='confirmed'?`<div style="margin-top:10px;padding:8px 12px;background:#FFF7ED;border-radius:10px;display:flex;align-items:center;gap:8px">
                        <span style="font-family:monospace;font-weight:900;font-size:15px;color:#FF5A1F;letter-spacing:3px">${b.completion_code}</span>
                        <span style="font-size:11px;color:#9CA3AF">üîë Donnez ce code au moniteur</span>
                    </div>`:''}
                    ${b.status==='completed'?`<div style="margin-top:10px;padding:8px 12px;background:#ECFDF5;border-radius:10px;text-align:center">
                        <span style="font-size:12px;color:#059669;font-weight:700">‚úÖ Cours valid√© par le moniteur</span>
                    </div>`:''}
                </div>`;
            }).join('')}
            </div>
        ` : ''}

        ${tab==='map' ? `
            <p class="db-section-title">Tous les moniteurs</p>
            <div style="background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08);margin-bottom:16px">
                <div id="map" style="height:280px;border-radius:0"></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px">
            ${instructors.map((i,idx)=>{
                const slots = DB.slots.filter(s=>s.instructor_id===i.id).length;
                const initials = (i.name||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                return `<div class="db-instructor-chip" onclick="showInstructorProfile('${i.id}')">
                    <div style="width:48px;height:48px;border-radius:14px;overflow:hidden;flex-shrink:0;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:17px">
                        ${i.avatar_url?`<img src="${i.avatar_url}" style="width:100%;height:100%;object-fit:cover">`:`${initials}`}
                    </div>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:6px">
                            <p style="font-weight:800;font-size:15px;color:var(--text)">${i.name}</p>
                            <div style="width:7px;height:7px;border-radius:50%;background:${i.is_online?'#22C55E':'#D1D5DB'};flex-shrink:0"></div>
                        </div>
                        <p style="font-size:12px;color:var(--text-muted)">üìç ${i.location||'Noum√©a'} ¬∑ ${slots} cr√©neau${slots>1?'x':''}</p>
                    </div>
                    <div>
                        <button onclick="event.stopPropagation();showSlots('${i.id}')" style="background:#FF5A1F;color:#fff;border:none;border-radius:10px;padding:8px 14px;font-size:12px;font-weight:700;cursor:pointer">R√©server</button>
                    </div>
                </div>`;
            }).join('')}
            </div>
        ` : ''}

        ${tab==='suivi' ? `
            <p class="db-section-title">üìñ Ma fiche de suivi</p>
            ${(DB.progressNotes||[]).length === 0 ? `
                <div style="text-align:center;padding:60px 20px;color:var(--text-muted)">
                    <p style="font-size:50px;margin-bottom:12px">üìñ</p>
                    <p style="font-weight:700;font-size:17px;color:var(--text)">Aucune note pour le moment</p>
                    <p style="font-size:14px;margin-top:4px">Votre moniteur remplira votre fiche apr√®s chaque cours</p>
                </div>
            ` : `
                <div style="background:#fff;border-radius:20px;padding:18px;border:1px solid #F0F0F0;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.05)">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
                        <span style="font-size:20px">üìä</span>
                        <div>
                            <p style="font-weight:800;font-size:15px;color:var(--text)">${(DB.progressNotes||[]).length} note${(DB.progressNotes||[]).length>1?'s':''} de suivi</p>
                            <p style="font-size:12px;color:var(--text-muted)">${[...new Set((DB.progressNotes||[]).map(n=>n.instructor_name))].length} moniteur(s) diff√©rent(s)</p>
                        </div>
                    </div>
                </div>
                ${(()=>{
                    const lastLevel = (DB.progressNotes||[]).find(n=>n.level);
                    return lastLevel ? '<div style="background:linear-gradient(135deg,#0D0D0D,#1A1A1A);border-radius:20px;padding:18px;margin-bottom:14px;text-align:center;border:1px solid #252525">' +
                        '<p style="color:#9CA3AF;font-size:11px;font-weight:700;letter-spacing:1px;margin-bottom:8px">VOTRE NIVEAU ACTUEL</p>' +
                        '<p style="font-size:24px;font-weight:900;color:#fff">' + (lastLevel.level==='D√©butant'?'üü°':lastLevel.level==='En progression'?'üü†':lastLevel.level==='Bon niveau'?'üü¢':'üîµ') + ' ' + lastLevel.level + '</p>' +
                        '<p style="color:#4B5563;font-size:12px;margin-top:4px">√âvalu√© par ' + lastLevel.instructor_name + ' le ' + lastLevel.lesson_date + '</p>' +
                    '</div>' : '';
                })()}
                <div style="display:flex;flex-direction:column;gap:12px">
                ${(DB.progressNotes||[]).map(note => `
                    <div style="background:#fff;border-radius:20px;padding:18px;border:1px solid #F0F0F0;box-shadow:0 2px 8px rgba(0,0,0,0.05)">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
                            <div style="display:flex;align-items:center;gap:10px">
                                <div style="width:40px;height:40px;border-radius:12px;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:16px;flex-shrink:0">
                                    ${(note.instructor_name||'?').charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p style="font-weight:800;font-size:14px;color:var(--text)">${note.instructor_name||'Moniteur'}</p>
                                    <p style="font-size:11px;color:var(--text-muted)">üìÖ Cours du ${note.lesson_date||note.created_at?.split('T')[0]||''}</p>
                                </div>
                            </div>
                            ${note.level ? `<span style="padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;background:${note.level==='D√©butant'?'#FFFBEB;color:#D97706':note.level==='En progression'?'#FFF7ED;color:#EA580C':note.level==='Bon niveau'?'#ECFDF5;color:#059669':'#EFF6FF;color:#2563EB'}">${note.level==='D√©butant'?'üü°':note.level==='En progression'?'üü†':note.level==='Bon niveau'?'üü¢':'üîµ'} ${note.level}</span>` : ''}
                        </div>
                        ${note.skills && note.skills.length > 0 ? `
                            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
                                ${note.skills.map(s => `<span style="padding:3px 10px;border-radius:12px;background:#FFF7ED;color:#EA580C;font-size:11px;font-weight:700">${s}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div style="background:#F9FAFB;border-radius:14px;padding:14px;border-left:3px solid #FF5A1F">
                            <p style="font-size:14px;color:#374151;line-height:1.6;white-space:pre-wrap">${(note.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>
                        </div>
                        <p style="font-size:10px;color:#D1D5DB;margin-top:8px;text-align:right">R√©dig√© le ${new Date(note.created_at).toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})}</p>
                    </div>
                `).join('')}
                </div>
            `}
        ` : ''}

        ${tab==='profile' ? `
            <p class="db-section-title">Mon profil</p>

            <!-- Carte identit√© -->
            <div style="background:#fff;border-radius:20px;padding:20px;border:1px solid #F0F0F0;margin-bottom:14px;display:flex;align-items:center;gap:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05)">
                <div style="width:72px;height:72px;border-radius:20px;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:28px;flex-shrink:0">
                    ${(currentUser.name||'?').charAt(0).toUpperCase()}
                </div>
                <div>
                    <p style="font-weight:900;font-size:17px;color:var(--text)">${currentUser.name||''}</p>
                    <p style="font-size:13px;color:var(--text-muted);margin-top:2px">${currentUser.email||''}</p>
                    <span style="background:#EFF6FF;color:#1D4ED8;border-radius:20px;padding:3px 10px;font-size:11px;font-weight:700;margin-top:6px;display:inline-block">üë®‚Äçüéì √âl√®ve</span>
                </div>
            </div>

            <!-- T√©l√©phone avec v√©rification -->
            <div style="background:#fff;border-radius:20px;padding:20px;border:1px solid #F0F0F0;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.05)">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                    <div style="width:40px;height:40px;background:#FFF7ED;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px">üì±</div>
                    <div>
                        <p style="font-weight:800;font-size:15px;color:var(--text)">Num√©ro de t√©l√©phone</p>
                        <p style="font-size:12px;color:var(--text-muted)">Utilis√© par vos moniteurs pour vous contacter</p>
                    </div>
                </div>
                ${currentUser.phone_number && currentUser.phone_verified ?
                    `<div style="background:#ECFDF5;border-radius:14px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div>
                            <p style="font-size:12px;color:#059669;font-weight:700;margin-bottom:2px">‚úÖ V√©rifi√©</p>
                            <p style="font-weight:800;font-size:17px;color:#065F46;font-family:monospace">${currentUser.phone_number}</p>
                        </div>
                        <button onclick="showPhoneVerification('change')" style="background:#fff;color:#DC2626;border:1px solid #FCA5A5;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">Modifier</button>
                    </div>` :
                    currentUser.phone_number && !currentUser.phone_verified ?
                    `<div style="background:#FFFBEB;border-radius:14px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div>
                            <p style="font-size:12px;color:#D97706;font-weight:700;margin-bottom:2px">‚ö†Ô∏è Non v√©rifi√©</p>
                            <p style="font-weight:800;font-size:15px;color:#92400E;font-family:monospace">${currentUser.phone_number}</p>
                        </div>
                        <button onclick="showPhoneVerification('verify','${currentUser.phone_number}')" style="background:#F59E0B;color:#fff;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">V√©rifier</button>
                    </div>` :
                    `<p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">Aucun num√©ro ajout√© ‚Äî les moniteurs ne pourront pas vous appeler.</p>`
                }
                <button onclick="showPhoneVerification('add')" style="width:100%;padding:14px;background:#FF5A1F;color:#fff;border:none;border-radius:14px;font-weight:700;font-size:15px;cursor:pointer;display:${currentUser.phone_number&&currentUser.phone_verified?'none':'block'}">
                    üì± ${currentUser.phone_number ? 'Renvoyer le code SMS' : 'Ajouter un num√©ro'}
                </button>
            </div>

            <!-- D√©connexion -->
            <button onclick="logout()" style="width:100%;padding:14px;border-radius:16px;border:1.5px solid #FEE2E2;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:15px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.background='#FEE2E2'" onmouseout="this.style.background='#FEF2F2'">
                üö™ Se d√©connecter
            </button>

            <!-- Admin access (discret) -->
            <p onclick="(function(){let c=window._adminTaps=(window._adminTaps||0)+1;if(c>=5){window._adminTaps=0;currentView='admin';render();}setTimeout(()=>{if(window._adminTaps<5)window._adminTaps=0;},3000)})()" style="text-align:center;font-size:11px;color:#E5E7EB;margin-top:20px;cursor:default;user-select:none">DriveConnect NC v2.1</p>
        ` : ''}

        </div>

        <!-- BARRE DE NAVIGATION BAS (Uber style) -->
        <div class="db-tab-bar">
            <button class="db-tab ${tab==='home'?'active':''}" onclick="switchTab('home')">
                <span class="tab-icon">üè†</span>
                <span class="tab-label">Accueil</span>
            </button>
            <button class="db-tab ${tab==='bookings'?'active':''}" onclick="switchTab('bookings')">
                <span class="tab-icon">üìã</span>
                <span class="tab-label">Mes cours</span>
            </button>
            <button class="db-tab ${tab==='suivi'?'active':''}" onclick="switchTab('suivi')">
                <span class="tab-icon">üìñ</span>
                <span class="tab-label">Suivi</span>
            </button>
            <button class="db-tab ${tab==='map'?'active':''}" onclick="switchTab('map')">
                <span class="tab-icon">üó∫Ô∏è</span>
                <span class="tab-label">Moniteurs</span>
            </button>
            <button class="db-tab ${tab==='profile'?'active':''}" onclick="switchTab('profile')">
                <span class="tab-icon">üë§</span>
                <span class="tab-label">Profil</span>
            </button>
        </div>

    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// V√âRIFICATION DOCUMENTS MONITEUR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function InstructorUploadDocs() {
    return `<div class="min-h-screen flex flex-col" style="background:linear-gradient(160deg,#0f0f0f 0%,#1a1a1a 50%,#0f0f0f 100%)">
        <div class="flex-1 px-6 pt-14 pb-8 max-w-lg mx-auto w-full">
            <div class="mb-8">
                <div class="w-16 h-16 rounded-2xl flex items-center justify-center mb-5" style="background:rgba(255,90,31,0.15);border:1px solid rgba(255,90,31,0.3)">
                    <span class="text-3xl">üìã</span>
                </div>
                <h1 class="text-2xl font-extrabold text-white mb-2">V√©rification de votre profil</h1>
                <p style="color:rgba(255,255,255,0.5);font-size:14px;line-height:1.6">
                    Pour exercer sur DriveConnect NC, nous devons v√©rifier vos qualifications.<br>
                    Envoyez les documents ci-dessous pour valider votre compte.
                </p>
            </div>
            <div class="space-y-4 mb-8">
                <div id="doc-zone-1" class="rounded-2xl p-5 border-2 border-dashed transition-all cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-1').click()">
                    <input type="file" id="doc-input-1" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-start gap-4">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(255,90,31,0.12)"><span class="text-xl">ü™™</span></div>
                        <div class="flex-1">
                            <p class="font-bold text-white text-sm mb-1">Autorisation d'enseigner la conduite</p>
                            <p style="color:#666;font-size:12px;line-height:1.5">Titre professionnel ECSR, BEPECASER, ou autorisation pr√©fectorale</p>
                            <p id="doc-name-1" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:6px;display:none"></p>
                        </div>
                        <div id="doc-status-1" class="flex-shrink-0 mt-1"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    </div>
                </div>
                <div id="doc-zone-2" class="rounded-2xl p-5 border-2 border-dashed transition-all cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-2').click()">
                    <input type="file" id="doc-input-2" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-start gap-4">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(255,90,31,0.12)"><span class="text-xl">üÜî</span></div>
                        <div class="flex-1">
                            <p class="font-bold text-white text-sm mb-1">Pi√®ce d'identit√©</p>
                            <p style="color:#666;font-size:12px;line-height:1.5">Carte d'identit√©, passeport ou permis de conduire en cours de validit√©</p>
                            <p id="doc-name-2" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:6px;display:none"></p>
                        </div>
                        <div id="doc-status-2" class="flex-shrink-0 mt-1"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    </div>
                </div>
                <div id="doc-zone-3" class="rounded-2xl p-5 border-2 border-dashed transition-all cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-3').click()">
                    <input type="file" id="doc-input-3" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-start gap-4">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(255,90,31,0.12)"><span class="text-xl">üõ°Ô∏è</span></div>
                        <div class="flex-1">
                            <p class="font-bold text-white text-sm mb-1">Assurance professionnelle <span style="color:#666;font-weight:400">(optionnel)</span></p>
                            <p style="color:#666;font-size:12px;line-height:1.5">Attestation d'assurance responsabilit√© civile professionnelle</p>
                            <p id="doc-name-3" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:6px;display:none"></p>
                        </div>
                        <div id="doc-status-3" class="flex-shrink-0 mt-1"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    </div>
                </div>
                <div id="doc-zone-4" class="rounded-2xl p-5 border-2 border-dashed transition-all cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-4').click()">
                    <input type="file" id="doc-input-4" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-start gap-4">
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(59,130,246,0.12)"><span class="text-xl">üè¶</span></div>
                        <div class="flex-1">
                            <p class="font-bold text-white text-sm mb-1">RIB / Coordonn√©es bancaires</p>
                            <p style="color:#666;font-size:12px;line-height:1.5">Pour recevoir vos paiements par virement bancaire</p>
                            <p id="doc-name-4" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:6px;display:none"></p>
                        </div>
                        <div id="doc-status-4" class="flex-shrink-0 mt-1"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    </div>
                </div>
            </div>
            <div class="rounded-2xl p-4 mb-6" style="background:rgba(255,90,31,0.08);border:1px solid rgba(255,90,31,0.2)">
                <p style="color:#FF8C42;font-size:12px;line-height:1.6">
                    üì∏ <strong>Formats accept√©s :</strong> images (JPG, PNG) ou PDF<br>
                    üîí Documents envoy√©s de mani√®re s√©curis√©e, consult√©s uniquement par l'admin.<br>
                    ‚è±Ô∏è <strong>D√©lai :</strong> 24-48h en g√©n√©ral.
                </p>
            </div>
            <button id="send-docs-btn" onclick="uploadInstructorDocs()" disabled class="w-full py-4 rounded-2xl font-extrabold text-lg transition-all" style="background:#333;color:#666;cursor:not-allowed">Envoyer mes documents</button>
            <button onclick="logout()" class="w-full mt-4 py-3 rounded-2xl text-sm font-medium" style="background:transparent;color:#666;border:1px solid #333">Se d√©connecter</button>
        </div>
    </div>`;
}

function InstructorPending() {
    return `<div class="min-h-screen flex flex-col items-center justify-center px-6" style="background:linear-gradient(160deg,#0f0f0f 0%,#1a1a1a 50%,#0f0f0f 100%)">
        <div class="max-w-md w-full text-center">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background:rgba(255,200,0,0.12);border:2px solid rgba(255,200,0,0.3)"><span class="text-4xl">‚è≥</span></div>
            <h1 class="text-2xl font-extrabold text-white mb-3">Demande en cours d'examen</h1>
            <p style="color:rgba(255,255,255,0.5);font-size:14px;line-height:1.7;margin-bottom:32px">Vos documents ont bien √©t√© re√ßus. Vous recevrez une notification d√®s validation.</p>
            <div class="rounded-2xl p-5 mb-6 text-left" style="background:#111;border:1px solid #1C1C1C">
                <div class="flex items-center gap-3 mb-4"><div class="w-3 h-3 rounded-full animate-pulse" style="background:#FFD700"></div><p class="font-bold text-white text-sm">Statut : En attente de validation</p></div>
                <div class="space-y-3">
                    <div class="flex items-center gap-3"><span style="color:#00C853">‚úÖ</span><p style="color:#999;font-size:13px">Compte cr√©√©</p></div>
                    <div class="flex items-center gap-3"><span style="color:#00C853">‚úÖ</span><p style="color:#999;font-size:13px">Documents envoy√©s</p></div>
                    <div class="flex items-center gap-3"><span style="color:#FFD700">‚è≥</span><p style="color:#FFF;font-size:13px;font-weight:600">V√©rification en cours...</p></div>
                    <div class="flex items-center gap-3"><span style="color:#555">‚óã</span><p style="color:#555;font-size:13px">Acc√®s au tableau de bord</p></div>
                </div>
            </div>
            <p style="color:#555;font-size:12px;margin-bottom:24px">D√©lai habituel : 24 √† 48h</p>
            <button onclick="checkApprovalStatus()" class="w-full py-4 rounded-2xl font-bold text-base mb-3" style="background:#FF5A1F;color:white">üîÑ V√©rifier mon statut</button>
            <button onclick="logout()" class="w-full py-3 rounded-2xl text-sm font-medium" style="background:transparent;color:#666;border:1px solid #333">Se d√©connecter</button>
        </div>
    </div>`;
}

function InstructorRejected() {
    return `<div class="min-h-screen flex flex-col items-center justify-center px-6" style="background:linear-gradient(160deg,#0f0f0f 0%,#1a1a1a 50%,#0f0f0f 100%)">
        <div class="max-w-md w-full text-center">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background:rgba(220,38,38,0.12);border:2px solid rgba(220,38,38,0.3)"><span class="text-4xl">‚ùå</span></div>
            <h1 class="text-2xl font-extrabold text-white mb-3">Demande refus√©e</h1>
            <p style="color:rgba(255,255,255,0.5);font-size:14px;line-height:1.7;margin-bottom:16px">Votre demande n'a pas √©t√© valid√©e.</p>
            <div id="rejection-reason-box" class="rounded-2xl p-5 mb-6 text-left" style="background:rgba(220,38,38,0.08);border:1px solid rgba(220,38,38,0.25)">
                <p style="color:#FCA5A5;font-size:12px;font-weight:700;margin-bottom:6px">Motif du refus :</p>
                <p id="rejection-reason-text" style="color:#F87171;font-size:14px;line-height:1.6">Chargement...</p>
            </div>
            <p style="color:rgba(255,255,255,0.5);font-size:14px;line-height:1.7;margin-bottom:24px">Vous pouvez renvoyer vos documents corrig√©s ci-dessous.</p>
            <div class="space-y-4 mb-6 text-left">
                <div id="doc-zone-1" class="rounded-2xl p-4 border-2 border-dashed cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-1').click()">
                    <input type="file" id="doc-input-1" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-center gap-3"><span class="text-lg">ü™™</span><div class="flex-1"><p class="font-bold text-white text-sm">Autorisation d'enseigner</p><p id="doc-name-1" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:4px;display:none"></p></div><div id="doc-status-1"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div></div>
                </div>
                <div id="doc-zone-2" class="rounded-2xl p-4 border-2 border-dashed cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-2').click()">
                    <input type="file" id="doc-input-2" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-center gap-3"><span class="text-lg">üÜî</span><div class="flex-1"><p class="font-bold text-white text-sm">Pi√®ce d'identit√©</p><p id="doc-name-2" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:4px;display:none"></p></div><div id="doc-status-2"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div></div>
                </div>
                <div id="doc-zone-3" class="rounded-2xl p-4 border-2 border-dashed cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-3').click()">
                    <input type="file" id="doc-input-3" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-center gap-3"><span class="text-lg">üõ°Ô∏è</span><div class="flex-1"><p class="font-bold text-white text-sm">Assurance pro <span style="color:#666">(optionnel)</span></p><p id="doc-name-3" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:4px;display:none"></p></div><div id="doc-status-3"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div></div>
                </div>
                <div id="doc-zone-4" class="rounded-2xl p-4 border-2 border-dashed cursor-pointer" style="border-color:#333;background:#111" onclick="document.getElementById('doc-input-4').click()">
                    <input type="file" id="doc-input-4" accept="image/*,.pdf" style="display:none">
                    <div class="flex items-center gap-3"><span class="text-lg">üè¶</span><div class="flex-1"><p class="font-bold text-white text-sm">RIB / Coordonn√©es bancaires</p><p id="doc-name-4" style="color:#FF5A1F;font-size:12px;font-weight:700;margin-top:4px;display:none"></p></div><div id="doc-status-4"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div></div>
                </div>
            </div>
            <button id="send-docs-btn" onclick="uploadInstructorDocs()" disabled class="w-full py-4 rounded-2xl font-extrabold text-lg mb-3" style="background:#333;color:#666;cursor:not-allowed">Renvoyer mes documents</button>
            <button onclick="logout()" class="w-full py-3 rounded-2xl text-sm font-medium" style="background:transparent;color:#666;border:1px solid #333">Se d√©connecter</button>
        </div>
    </div>`;
}

function setupDocUpload() {
    // Persister les fichiers entre re-renders
    if (!window._docFiles) window._docFiles = {};
    const docFiles = window._docFiles;

    [1,2,3,4].forEach(i => {
        const input = document.getElementById('doc-input-'+i);
        if (!input) return;

        // Restaurer l'√©tat visuel si un fichier est d√©j√† s√©lectionn√©
        if (docFiles[i]) {
            const nameEl = document.getElementById('doc-name-'+i);
            const zoneEl = document.getElementById('doc-zone-'+i);
            const statusEl = document.getElementById('doc-status-'+i);
            if (nameEl) { nameEl.textContent = '‚úÖ ' + docFiles[i].name; nameEl.style.display = 'block'; }
            if (zoneEl) { zoneEl.style.borderColor = '#00C853'; zoneEl.style.background = 'rgba(0,200,83,0.05)'; }
            if (statusEl) statusEl.innerHTML = '<span style="color:#00C853;font-size:20px">‚úÖ</span>';
        }

        input.onchange = function() {
            const file = this.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { notif('‚ùå Fichier trop volumineux', 'Maximum 10 Mo', 'red'); this.value = ''; return; }
            docFiles[i] = file;
            window._docFiles = docFiles;
            const nameEl = document.getElementById('doc-name-'+i);
            const zoneEl = document.getElementById('doc-zone-'+i);
            const statusEl = document.getElementById('doc-status-'+i);
            if (nameEl) { nameEl.textContent = '‚úÖ ' + file.name; nameEl.style.display = 'block'; }
            if (zoneEl) { zoneEl.style.borderColor = '#00C853'; zoneEl.style.background = 'rgba(0,200,83,0.05)'; }
            if (statusEl) statusEl.innerHTML = '<span style="color:#00C853;font-size:20px">‚úÖ</span>';
            // Activer le bouton si docs obligatoires (1, 2, 4) sont l√†
            const btn = document.getElementById('send-docs-btn');
            if (btn && docFiles[1] && docFiles[2] && docFiles[4]) { btn.disabled = false; btn.style.background = 'linear-gradient(135deg,#FF5A1F,#FF7340)'; btn.style.color = 'white'; btn.style.cursor = 'pointer'; btn.style.opacity = '1'; }
        };
    });

    // Activer le bouton si les docs obligatoires sont d√©j√† l√†
    const btn = document.getElementById('send-docs-btn');
    if (btn && docFiles[1] && docFiles[2] && docFiles[4]) { btn.disabled = false; btn.style.background = 'linear-gradient(135deg,#FF5A1F,#FF7340)'; btn.style.color = 'white'; btn.style.cursor = 'pointer'; btn.style.opacity = '1'; }

    if (currentView === 'instructor-rejected') loadRejectionReason();
}

async function loadRejectionReason() {
    if (!currentUser) return;
    const { data } = await sb.from('instructors').select('rejection_reason').eq('id', currentUser.id).single();
    const el = document.getElementById('rejection-reason-text');
    if (el && data) el.textContent = data.rejection_reason || 'Documents non conformes. Veuillez renvoyer des documents lisibles et valides.';
}

async function uploadInstructorDocs() {
    const docFiles = window._docFiles || {};
    if (!docFiles[1] || !docFiles[2] || !docFiles[4]) { notif('‚ùå Documents manquants', 'Autorisation, pi√®ce d\'identit√© et RIB obligatoires', 'red'); return; }
    const btn = document.getElementById('send-docs-btn');
    if (btn) { btn.textContent = '‚è≥ Envoi en cours...'; btn.disabled = true; }
    const userId = currentUser.id;
    const docUrls = [];
    const docTypes = { '1':'autorisation', '2':'identite', '3':'assurance', '4':'rib' };
    try {
        for (const [idx, file] of Object.entries(docFiles)) {
            const ext = file.name.split('.').pop();
            const safeName = Date.now() + '_doc' + idx + '.' + ext;
            const storagePath = userId + '/' + safeName;
            const { error: uploadErr } = await sb.storage.from('instructor-docs').upload(storagePath, file, { upsert: true, contentType: file.type });
            if (uploadErr) { notif('‚ùå Erreur envoi document '+idx, uploadErr.message, 'red'); if (btn) { btn.textContent = 'R√©essayer'; btn.disabled = false; } return; }
            const { data: urlData } = sb.storage.from('instructor-docs').getPublicUrl(storagePath);
            docUrls.push({ doc_type: docTypes[idx] || 'autre', url: urlData.publicUrl, filename: file.name });
        }
        await sb.from('instructors').update({ approval_status: 'pending_review', documents_urls: docUrls, rejection_reason: null }).eq('id', userId);
        notif('‚úÖ Documents envoy√©s !', 'Votre demande est en cours d\'examen', 'green');
        window._docFiles = {};
        currentView = 'instructor-pending';
        render();
    } catch(e) {
        console.error('Upload error:', e);
        notif('‚ùå Erreur', 'Impossible d\'envoyer les documents', 'red');
        if (btn) { btn.textContent = 'R√©essayer'; btn.disabled = false; }
    }
}

window.checkApprovalStatus = async function() {
    if (!currentUser) return;
    const { data } = await sb.from('instructors').select('approval_status').eq('id', currentUser.id).single();
    if (!data) return;
    if (data.approval_status === 'approved') {
        notif('‚úÖ Profil valid√© !', 'Bienvenue sur DriveConnect NC', 'green');
        currentView = 'instructor-dashboard'; await loadData(); render();
    } else if (data.approval_status === 'rejected') {
        currentView = 'instructor-rejected'; render();
    } else {
        notif('‚è≥ Toujours en attente', 'Votre demande est en cours d\'examen', 'orange');
    }
};

// ========== INSTRUCTOR DASHBOARD ====================
function InstructorDashboard() {
    const myBookings = DB.bookings;
    const profile = DB.instructors.find(x=>x.id===currentUser.id) || {};
    const mySlots = DB.slots.filter(s=>s.instructor_id===currentUser.id);
    const paidBookings = myBookings.filter(b=>(b.status==='confirmed'||b.status==='completed')&&b.payment_status==='paid');
    const totalNet = paidBookings.reduce((s,b)=>s+(b.net||0),0);
    const pending = myBookings.filter(b=>b.status==='pending').length;
    const tab = currentTab || 'home';
    const firstName = (currentUser.name||'').split(' ')[0];

    return `<div class="min-h-screen" style="background:var(--bg)">

        <!-- HEADER SOMBRE -->
        <div class="db-hero px-5 pt-14 pb-8">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px">
                <div>
                    <p style="color:rgba(255,255,255,0.4);font-size:12px;font-weight:700;letter-spacing:1.5px">TABLEAU DE BORD</p>
                    <h1 style="color:#fff;font-size:26px;font-weight:900;margin:4px 0 2px">${firstName} üëã</h1>
                    <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
                        <button onclick="toggleOnline()" style="display:flex;align-items:center;gap:6px;background:${profile.is_online?'rgba(34,197,94,0.15)':'rgba(255,255,255,0.06)'};border:1px solid ${profile.is_online?'rgba(34,197,94,0.4)':'rgba(255,255,255,0.15)'};border-radius:20px;padding:6px 14px;cursor:pointer;color:${profile.is_online?'#4ADE80':'rgba(255,255,255,0.4)'};font-size:12px;font-weight:700;transition:all 0.2s" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                            <span style="width:8px;height:8px;border-radius:50%;background:${profile.is_online?'#22C55E':'#6B7280'}"></span>
                            ${profile.is_online?'En ligne':'Hors ligne'}
                        </button>
                        ${pending>0?`<span style="background:rgba(239,68,68,0.2);color:#FCA5A5;border-radius:20px;padding:6px 14px;font-size:12px;font-weight:700">${pending} en attente</span>`:''}
                    </div>
                </div>
                <div style="display:flex;gap:10px;align-items:center">
                    <button onclick="toggleDark()" style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">üåô</button>
                    <div style="width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,90,31,0.5);flex-shrink:0;background:linear-gradient(135deg,#FF5A1F,#FF8C42);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:19px;box-shadow:0 4px 16px rgba(255,90,31,0.3)">
                        ${profile.avatar_url?`<img src="${profile.avatar_url}" style="width:100%;height:100%;object-fit:cover">`:(currentUser.name||'?').charAt(0).toUpperCase()}
                    </div>
                </div>
            </div>

            <!-- Grande carte revenus -->
            <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:22px;padding:22px;margin-bottom:14px">
                <p style="color:rgba(255,255,255,0.35);font-size:11px;font-weight:700;letter-spacing:1.5px;margin-bottom:8px">REVENUS NETS TOTAUX</p>
                <p style="color:#fff;font-size:38px;font-weight:900;line-height:1">${totalNet.toLocaleString()} <span style="font-size:16px;color:rgba(255,255,255,0.35)">XPF</span></p>
                <p style="color:rgba(255,255,255,0.3);font-size:12px;margin-top:8px">${paidBookings.length} cours compl√©t√©s</p>
            </div>

            <!-- Mini stats -->
            <div style="display:flex;gap:12px">
                <div class="db-stat-pill" style="flex:1">
                    <p style="color:rgba(255,255,255,0.35);font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:6px">CONFIRM√âS</p>
                    <p style="color:#fff;font-size:24px;font-weight:900">${myBookings.filter(b=>b.status==='confirmed').length}</p>
                </div>
                <div class="db-stat-pill" style="flex:1">
                    <p style="color:rgba(255,255,255,0.35);font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:6px">CR√âNEAUX</p>
                    <p style="color:#fff;font-size:24px;font-weight:900">${mySlots.length}</p>
                </div>
                <div class="db-stat-pill" style="flex:1">
                    <p style="color:rgba(255,255,255,0.35);font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:6px">NOTE</p>
                    <p style="color:#FF5A1F;font-size:24px;font-weight:900">${profile.rating?profile.rating.toFixed(1):'‚Äî'}</p>
                </div>
            </div>
        </div>

        <!-- CONTENU -->
        <div style="padding:24px 20px 120px">

        ${tab==='home' ? `
            <!-- Actions rapides -->
            <p class="db-section-title">Actions rapides</p>
            <div class="stagger" style="display:flex;gap:12px;margin-bottom:28px">
                <button class="db-action-btn" onclick="showAddSlot()">
                    <div class="db-action-icon" style="background:#FFF7ED">‚ûï</div>
                    <span style="font-size:12px;font-weight:700;color:var(--text)">Cr√©neau</span>
                </button>
                <button class="db-action-btn" onclick="switchTab('bookings')" style="position:relative">
                    <div class="db-action-icon" style="background:#ECFDF5">üìã</div>
                    <span style="font-size:12px;font-weight:700;color:var(--text)">R√©servations</span>
                    ${pending>0?`<span style="position:absolute;top:10px;right:10px;background:#EF4444;color:#fff;border-radius:50%;width:20px;height:20px;font-size:10px;font-weight:900;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(239,68,68,0.4)">${pending}</span>`:''}
                </button>
                <button class="db-action-btn" onclick="watchId?stopTracking():startTracking()" id="gps-action-btn">
                    <div class="db-action-icon" style="background:#EFF6FF" id="gps-icon">üìç</div>
                    <span style="font-size:12px;font-weight:700;color:var(--text)" id="gps-btn-label">GPS</span>
                </button>
                <button class="db-action-btn" onclick="switchTab('earnings')">
                    <div class="db-action-icon" style="background:#F0FDF4">üí∞</div>
                    <span style="font-size:12px;font-weight:700;color:var(--text)">Revenus</span>
                </button>
            </div>

            <!-- Prochains cours -->
            ${(()=>{
                const upcoming = myBookings.filter(b=>b.status==='confirmed'&&new Date(b.date)>=new Date()).sort((a,b)=>new Date(a.date)-new Date(b.date));
                if (!upcoming.length) return '<div style="text-align:center;padding:30px;background:#fff;border-radius:20px;border:1px solid #F0F0F0"><p style="font-size:36px;margin-bottom:8px">üìÖ</p><p style="font-weight:700;color:var(--text)">Aucun cours √† venir</p><p style="font-size:13px;color:var(--text-muted);margin-top:4px">Ajoutez des cr√©neaux pour √™tre r√©serv√©</p></div>';
                return `<p class="db-section-title">Prochains cours</p>
                <div style="display:flex;flex-direction:column;gap:10px">
                ${upcoming.slice(0,3).map(b=>{
                    const daysLeft = Math.ceil((new Date(b.date)-new Date())/(1000*60*60*24));
                    return `<div class="db-booking-card">
                        <div style="display:flex;align-items:center;gap:12px">
                            <div style="width:44px;height:44px;background:#0D0D0D;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">üë®‚Äçüéì</div>
                            <div style="flex:1">
                                <p style="font-weight:800;color:var(--text);font-size:15px">${b.student_name||'√âl√®ve'}</p>
                                <p style="color:var(--text-muted);font-size:13px">üìÖ ${b.date} ¬∑ ${b.time} ¬∑ ${b.duration}h</p>
                            </div>
                            <div style="text-align:right">
                                <p style="font-weight:900;color:#FF5A1F;font-size:15px">${(b.net||0).toLocaleString()} XPF</p>
                                <p style="font-size:11px;color:var(--text-muted)">${daysLeft<=0?"Aujourd\'hui":daysLeft===1?'Demain':'J-'+daysLeft}</p>
                                <button onclick="openChat('${b.id}','${b.student_id}','${b.student_name}')" style="background:#EFF6FF;color:#1D4ED8;border:none;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;margin-top:4px">üí¨</button>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
                </div>`;
            })()}

            <!-- Carte GPS -->
            <p class="db-section-title" style="margin-top:20px">Ma position en direct</p>
            <div style="background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08);margin-bottom:8px;border:1px solid #F0F0F0">
                <div style="padding:10px 16px;display:flex;justify-content:space-between;align-items:center">
                    <p id="gps-status" style="font-size:12px;color:#9CA3AF;margin:0">GPS non actif</p>
                    <button onclick="watchId?stopTracking():startTracking()" style="background:#FF5A1F;color:#fff;border:none;border-radius:10px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer" id="gps-toggle-btn">‚ñ∂ Activer</button>
                </div>
                <div id="map" style="height:220px;border-radius:0"></div>
            </div>
        ` : ''}

        ${tab==='slots' ? `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <p class="db-section-title" style="margin:0">Mes cr√©neaux</p>
                <button onclick="showAddSlot()" style="background:#FF5A1F;color:#fff;border:none;border-radius:12px;padding:10px 18px;font-size:13px;font-weight:700;cursor:pointer">+ Ajouter</button>
            </div>
            ${mySlots.length===0?`<div style="text-align:center;padding:60px 20px;color:var(--text-muted)"><p style="font-size:50px;margin-bottom:12px">üìÖ</p><p style="font-weight:700;font-size:17px;color:var(--text)">Aucun cr√©neau</p><p style="font-size:14px;margin-top:4px">Cr√©ez un cr√©neau pour √™tre r√©serv√©</p><button onclick="showAddSlot()" style="margin-top:16px;background:#FF5A1F;color:#fff;border:none;border-radius:14px;padding:14px 28px;font-size:15px;font-weight:700;cursor:pointer">‚ûï Cr√©er mon premier cr√©neau</button></div>`:
            `<div style="display:flex;flex-direction:column;gap:10px">
            ${mySlots.map(s=>{
                const booking=DB.bookings.find(b=>b.slot_id===s.id&&b.status!=='cancelled');
                return `<div class="slot-card${booking?' booked':''}">
                    <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <div style="width:44px;height:44px;border-radius:12px;background:${booking?'#DBEAFE':'#F3F4F6'};display:flex;align-items:center;justify-content:center;font-size:18px">
                            ${booking?'üîí':'üìÖ'}
                        </div>
                        <div>
                            <p style="font-weight:800;color:var(--text);font-size:15px">${s.date} √† ${s.time}</p>
                            <p style="color:var(--text-muted);font-size:13px">‚è± ${s.duration}h ¬∑ ${s.price} XPF</p>
                            ${booking?`<p style="font-size:12px;color:#2563EB;font-weight:600;margin-top:2px">üë®‚Äçüéì ${booking.student_name}</p>`:''}
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center">
                        ${booking&&booking.status==='confirmed'?`<button onclick="openValidateModal('${booking.id}','${(booking.student_name||'').replace(/'/g,'')}')" style="background:linear-gradient(135deg,#FF5A1F,#FF8C42);color:#fff;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer">üîë Valider</button>`:''}
                        ${booking?`<button onclick="cancelInstructor('${booking.id}')" style="color:#DC2626;background:none;border:none;font-size:12px;font-weight:700;cursor:pointer">Annuler</button>`:
                        `<button onclick="deleteSlot('${s.id}')" style="color:#DC2626;background:none;border:none;font-size:13px;cursor:pointer">üóë</button>`}
                    </div>
                </div>`;
            }).join('')}
            </div>`}
        ` : ''}

        ${tab==='bookings' ? `
            <p class="db-section-title">Toutes les r√©servations</p>
            ${myBookings.length===0?`<div class="fade-in" style="text-align:center;padding:80px 20px;color:var(--text-muted)"><p style="font-size:56px;margin-bottom:16px">üìã</p><p style="font-weight:800;font-size:18px;color:var(--text)">Aucune r√©servation</p></div>`:''}
            <div class="stagger" style="display:flex;flex-direction:column;gap:14px">
            ${[...myBookings].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(b=>{
                const statusColor = b.status==='confirmed'?'#059669':b.status==='cancelled'?'#DC2626':b.status==='completed'?'#059669':b.status==='pending'?'#D97706':b.status==='dispute'?'#9333EA':'#6B7280';
                const statusBg   = b.status==='confirmed'?'#ECFDF5':b.status==='cancelled'?'#FEF2F2':b.status==='completed'?'#ECFDF5':b.status==='pending'?'#FFFBEB':b.status==='dispute'?'#F3E8FF':'#F3F4F6';
                const statusLabel= b.status==='confirmed'?'‚úÖ Confirm√©':b.status==='cancelled'?'‚ùå Annul√©':b.status==='completed'?'‚úÖ Valid√©':b.status==='pending'?'‚è≥ En attente':b.status==='dispute'?'‚ö†Ô∏è Litige':'Inconnu';
                return `<div class="db-booking-card">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
                        <div>
                            <p style="font-weight:800;font-size:15px;color:var(--text)">üë®‚Äçüéì ${b.student_name||'√âl√®ve'}</p>
                            <p style="color:var(--text-muted);font-size:13px;margin-top:3px">üìÖ ${b.date} ¬∑ ${b.time} ¬∑ ${b.duration}h</p>
                        </div>
                        <span style="background:${statusBg};color:${statusColor};border-radius:20px;padding:4px 10px;font-size:11px;font-weight:700;flex-shrink:0">${statusLabel}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <p style="font-weight:900;font-size:16px;color:#FF5A1F">${(b.net||0).toLocaleString()} XPF nets</p>
                            ${b.payment_status==='paid'?'<p style="font-size:11px;color:#059669">‚úÖ Pay√©</p>':''}
                        </div>
                        <div style="display:flex;gap:6px;align-items:center">
                            ${b.status==='pending'?`
                                <button onclick="confirmB('${b.id}')" style="background:#ECFDF5;color:#059669;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">‚úÖ Accepter</button>
                                <button onclick="rejectB('${b.id}')" style="background:#FEF2F2;color:#DC2626;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">‚ùå</button>
                            `:''}
                            ${b.status==='confirmed'?`
                                <button onclick="openValidateModal('${b.id}','${(b.student_name||'').replace(/'/g,'')}')" style="background:linear-gradient(135deg,#FF5A1F,#FF8C42);color:#fff;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">üîë Valider</button>
                                <button onclick="openChat('${b.id}','${b.student_id}','${b.student_name}')" style="background:#EFF6FF;color:#1D4ED8;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">üí¨ Chat</button>
                            `:''}
                            ${b.status==='completed'?`
                                ${b.completed_at && (new Date()-new Date(b.completed_at))<86400000 && !(DB.progressNotes||[]).find(n=>n.booking_id===b.id) ?
                                    `<button onclick="openProgressNoteModal('${b.id}','${(b.student_name||'').replace(/'/g,'')}','${b.student_id}','${b.date}')" style="background:linear-gradient(135deg,#FF5A1F,#FF8C42);color:#fff;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">üìù Fiche</button>` :
                                    (DB.progressNotes||[]).find(n=>n.booking_id===b.id) ?
                                    `<span style="font-size:11px;color:#059669;font-weight:700">üìù Fiche r√©dig√©e</span>` :
                                    `<span style="font-size:11px;color:#9CA3AF">‚è± D√©lai expir√©</span>`
                                }
                                <button onclick="viewStudentProgress('${b.student_id}','${(b.student_name||'').replace(/'/g,'')}')" style="background:#F3F4F6;color:#374151;border:none;border-radius:10px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer">üëÅÔ∏è Suivi</button>
                            `:''}
                        </div>
                    </div>
                </div>`;
            }).join('')}
            </div>
        ` : ''}

        ${tab==='earnings' ? `
            <p class="db-section-title">Revenus</p>
            <div style="background:linear-gradient(135deg,#0D0D0D,#1A1A1A);border-radius:24px;padding:24px;margin-bottom:16px">
                <p style="color:rgba(255,255,255,0.4);font-size:11px;font-weight:700;letter-spacing:1px">TOTAL NETS</p>
                <p style="color:#fff;font-size:38px;font-weight:900;margin:6px 0">${totalNet.toLocaleString()} XPF</p>
                <p style="color:rgba(255,255,255,0.3);font-size:13px">${paidBookings.length} cours pay√©s</p>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">
                <div style="background:#fff;border-radius:18px;padding:18px;border:1px solid #F0F0F0">
                    <p style="color:var(--text-muted);font-size:12px;margin-bottom:6px">Moy. par cours</p>
                    <p style="font-size:22px;font-weight:900;color:#FF5A1F">${paidBookings.length>0?Math.round(totalNet/paidBookings.length).toLocaleString():0}</p>
                    <p style="color:var(--text-muted);font-size:11px">XPF nets</p>
                </div>
                <div style="background:#fff;border-radius:18px;padding:18px;border:1px solid #F0F0F0">
                    <p style="color:var(--text-muted);font-size:12px;margin-bottom:6px">Taux compl√©tion</p>
                    <p style="font-size:22px;font-weight:900;color:${myBookings.length>0&&paidBookings.length/myBookings.length>=0.8?'#059669':myBookings.length>0&&paidBookings.length/myBookings.length>=0.5?'#D97706':'#DC2626'}">${myBookings.length>0?Math.round(paidBookings.length/myBookings.length*100):0}%</p>
                    <p style="color:var(--text-muted);font-size:11px">${myBookings.filter(b=>b.status==='cancelled').length} annulation(s)</p>
                </div>
            </div>
            <p class="db-section-title">Par mois</p>
            ${(()=>{
                const months={};
                paidBookings.forEach(b=>{const m=b.date.substr(0,7);months[m]=(months[m]||0)+(b.net||0);});
                const entries=Object.entries(months).sort((a,b)=>b[0].localeCompare(a[0]));
                const maxVal=entries.length>0?Math.max(...entries.map(e=>e[1])):1;
                if(!entries.length) return '<p style="text-align:center;color:var(--text-muted);padding:30px">Aucun revenu</p>';
                return '<div style="display:flex;flex-direction:column;gap:8px">'+entries.map(([m,v])=>{
                    const pct=Math.min(100,Math.round(v/maxVal*100));
                    return `<div style="background:#fff;border-radius:16px;padding:14px 16px;border:1px solid #F0F0F0">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <p style="font-weight:700;color:var(--text)">${m}</p>
                            <p style="font-weight:900;color:#FF5A1F">${v.toLocaleString()} XPF</p>
                        </div>
                        <div style="background:#F3F4F6;border-radius:99px;height:4px"><div style="background:#FF5A1F;height:4px;border-radius:99px;width:${pct}%"></div></div>
                    </div>`;
                }).join('')+'</div>';
            })()}
        ` : ''}

        ${tab==='settings' ? `
            <p class="db-section-title">Param√®tres</p>
            <!-- Photo de profil -->
            <div style="background:#fff;border-radius:20px;padding:20px;border:1px solid #F0F0F0;margin-bottom:14px;display:flex;align-items:center;gap:16px">
                <div id="avatar-preview" style="width:72px;height:72px;border-radius:20px;overflow:hidden;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:24px;flex-shrink:0">
                    ${profile.avatar_url?`<img src="${profile.avatar_url}" style="width:100%;height:100%;object-fit:cover">`:(currentUser.name||'?').charAt(0).toUpperCase()}
                </div>
                <div style="flex:1">
                    <p style="font-weight:700;font-size:15px;color:var(--text);margin-bottom:4px">Photo de profil</p>
                    <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px">${profile.avatar_url?'‚úÖ Photo ajout√©e':'‚ö†Ô∏è Requise pour √™tre visible'}</p>
                    <label style="background:#FF5A1F;color:#fff;border-radius:10px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;display:inline-block">
                        üì∑ Changer
                        <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="previewAvatar(event)">
                    </label>
                </div>
            </div>
            <!-- Formulaire -->
            <div style="background:#fff;border-radius:20px;padding:20px;border:1px solid #F0F0F0;margin-bottom:14px">
                <form id="settings-form" style="display:flex;flex-direction:column;gap:14px">
                    <div>
                        <label style="display:block;font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Localisation</label>
                        <input type="text" id="s-loc" value="${profile.location||''}" class="input-field" placeholder="Quartier / Ville">
                    </div>
                    <!-- T√©l√©phone avec v√©rification SMS -->
                    <div>
                        <label style="display:block;font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">T√©l√©phone</label>
                        ${profile.phone_number && profile.phone_verified ?
                            `<div style="background:#ECFDF5;border-radius:14px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center">
                                <div>
                                    <p style="font-size:11px;color:#059669;font-weight:700;margin-bottom:2px">‚úÖ Num√©ro v√©rifi√©</p>
                                    <p style="font-weight:800;font-size:16px;color:#065F46;font-family:monospace">${profile.phone_number}</p>
                                </div>
                                <button type="button" onclick="showPhoneVerification('change')" style="background:#fff;color:#DC2626;border:1px solid #FCA5A5;border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer">Modifier</button>
                            </div>` :
                            profile.phone_number ?
                            `<div style="background:#FFFBEB;border-radius:14px;padding:12px 16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                                <div>
                                    <p style="font-size:11px;color:#D97706;font-weight:700;margin-bottom:2px">‚ö†Ô∏è Non v√©rifi√©</p>
                                    <p style="font-weight:700;font-size:14px;color:#92400E;font-family:monospace">${profile.phone_number}</p>
                                </div>
                                <button type="button" onclick="showPhoneVerification('verify','${profile.phone_number}')" style="background:#F59E0B;color:#fff;border:none;border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer">V√©rifier</button>
                            </div>
                            <button type="button" onclick="showPhoneVerification('add')" style="width:100%;padding:12px;background:var(--bg);color:var(--text);border:1.5px dashed var(--border);border-radius:12px;font-weight:700;font-size:14px;cursor:pointer">üì± Ajouter / Changer le num√©ro</button>` :
                            `<button type="button" onclick="showPhoneVerification('add')" style="width:100%;padding:14px;background:#FF5A1F;color:#fff;border:none;border-radius:14px;font-weight:700;font-size:15px;cursor:pointer">üì± Ajouter mon num√©ro</button>`
                        }
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Tarif horaire (XPF)</label>
                        <input type="number" id="s-rate" value="${profile.hourly_rate||4500}" class="input-field">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Ann√©es d'exp√©rience</label>
                        <input type="number" id="s-exp" value="${profile.experience||0}" class="input-field">
                    </div>
                    <button type="submit" class="btn-primary w-full" style="font-size:15px;padding:14px">Sauvegarder les modifications</button>
                </form>
            </div>
            <!-- Parrainage -->
            <div style="background:#fff;border-radius:20px;padding:20px;border:1px solid #F0F0F0;margin-bottom:14px">
                <h3 style="font-weight:800;font-size:16px;margin-bottom:4px;color:var(--text)">üéÅ Parrainage</h3>
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Parrainez un moniteur ‚Üí <strong>2% de commission en moins</strong> pendant 10 cours.</p>
                <div id="referral-code-display" style="background:#FFF7ED;border:2px dashed #FF5A1F;border-radius:14px;padding:14px;text-align:center;font-family:monospace;font-size:22px;font-weight:900;color:#FF5A1F;letter-spacing:6px;margin-bottom:12px">${profile.referral_code||'Chargement...'}</div>
                <div style="display:flex;gap:8px;margin-bottom:12px">
                    <button onclick="copyReferralCode()" style="flex:1;padding:12px;background:#F3F4F6;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;color:var(--text);transition:all 0.15s" onmouseover="this.style.background='#E5E7EB'" onmouseout="this.style.background='#F3F4F6'">üìã Copier</button>
                    <button onclick="shareReferralLink()" style="flex:1;padding:12px;background:linear-gradient(135deg,#FF5A1F,#FF7340);border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;color:#fff;transition:all 0.15s" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='none'">üîó Partager</button>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div style="background:#F9FAFB;border-radius:12px;padding:14px;text-align:center">
                        <p id="referral-count" style="font-size:24px;font-weight:900;color:var(--text)">0</p>
                        <p style="font-size:12px;color:var(--text-muted);margin-top:2px">Filleuls</p>
                    </div>
                    <div style="background:#F9FAFB;border-radius:12px;padding:14px;text-align:center">
                        <p id="referral-savings" style="font-size:24px;font-weight:900;color:#FF5A1F">0</p>
                        <p style="font-size:12px;color:var(--text-muted);margin-top:2px">XPF √©conomis√©s</p>
                    </div>
                </div>
                <div id="referral-list" class="mt-4"></div>
            </div>
            <!-- D√©connexion -->
            <button onclick="logout()" style="width:100%;padding:14px;border-radius:16px;border:1.5px solid #FEE2E2;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:15px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.background='#FEE2E2'" onmouseout="this.style.background='#FEF2F2'">üö™ Se d√©connecter</button>

            <!-- Admin access (discret) -->
            <p onclick="(function(){let c=window._adminTaps=(window._adminTaps||0)+1;if(c>=5){window._adminTaps=0;currentView='admin';render();}setTimeout(()=>{if(window._adminTaps<5)window._adminTaps=0;},3000)})()" style="text-align:center;font-size:11px;color:#E5E7EB;margin-top:20px;cursor:default;user-select:none">DriveConnect NC v2.1</p>
        ` : ''}

        </div>

        <!-- BARRE DE NAVIGATION BAS (Uber style) -->
        <div class="db-tab-bar">
            <button class="db-tab ${tab==='home'?'active':''}" onclick="switchTab('home')">
                <span class="tab-icon">üè†</span>
                <span class="tab-label">Accueil</span>
            </button>
            <button class="db-tab ${tab==='slots'?'active':''}" onclick="switchTab('slots')">
                <span class="tab-icon">üìÖ</span>
                <span class="tab-label">Cr√©neaux</span>
            </button>
            <button class="db-tab ${tab==='bookings'?'active':''}" onclick="switchTab('bookings')" style="position:relative">
                <span class="tab-icon">üìã</span>
                <span class="tab-label">R√©servations</span>
                ${pending>0?`<span style="position:absolute;top:6px;right:calc(50% - 22px);background:#EF4444;color:#fff;border-radius:50%;width:16px;height:16px;font-size:9px;font-weight:900;display:flex;align-items:center;justify-content:center">${pending}</span>`:''}
            </button>
            <button class="db-tab ${tab==='earnings'?'active':''}" onclick="switchTab('earnings')">
                <span class="tab-icon">üí∞</span>
                <span class="tab-label">Revenus</span>
            </button>
            <button class="db-tab ${tab==='settings'?'active':''}" onclick="switchTab('settings')">
                <span class="tab-icon">‚öôÔ∏è</span>
                <span class="tab-label">Param√®tres</span>
            </button>
        </div>

    </div>`;
}

function getTabContent(profile, myBookings, mySlots) {
    if (currentTab==='slots') return '';
    if (currentTab==='bookings') return '';
    if (currentTab==='earnings') return '';
    if (currentTab==='settings') return '';
    return '';
}

// ========== ACTIONS CR√âNEAUX ==========
window.showAddSlot = function() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
    const today = new Date().toISOString().split('T')[0];
    const instructor = DB.instructors.find(x=>x.id===currentUser.id);
    const defaultRate = instructor ? instructor.hourly_rate : 4500;
    modal.innerHTML = `<div style="background:#fff;border-radius:28px;padding:28px;width:100%;max-width:420px;box-shadow:0 24px 80px rgba(0,0,0,0.25)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
            <div style="width:44px;height:44px;background:#FFF7ED;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px">üìÖ</div>
            <h3 style="font-size:20px;font-weight:900;color:#0D0D0D">Nouveau cr√©neau</h3>
        </div>
        <form id="slot-form" style="display:flex;flex-direction:column;gap:16px">
            <div>
                <label style="display:block;font-size:11px;font-weight:700;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Date</label>
                <input type="date" id="sl-date" min="${today}" required style="width:100%;padding:13px 16px;border:1.5px solid #E5E7EB;border-radius:14px;font-size:16px;outline:none;font-family:inherit;color:#0D0D0D;background:#fff">
            </div>
            <div>
                <label style="display:block;font-size:11px;font-weight:700;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Heure</label>
                <select id="sl-time" style="width:100%;padding:13px 16px;border:1.5px solid #E5E7EB;border-radius:14px;font-size:16px;outline:none;font-family:inherit;color:#0D0D0D;background:#fff;-webkit-appearance:none">
                    ${['07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30','11:00','11:30','12:00','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00'].map(t=>`<option>${t}</option>`).join('')}
                </select>
            </div>
            <div>
                <label style="display:block;font-size:11px;font-weight:700;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Dur√©e</label>
                <select id="sl-dur" style="width:100%;padding:13px 16px;border:1.5px solid #E5E7EB;border-radius:14px;font-size:16px;outline:none;font-family:inherit;color:#0D0D0D;background:#fff;-webkit-appearance:none">
                    <option value="1">1 heure</option>
                    <option value="1.5">1h30</option>
                    <option value="2">2 heures</option>
                </select>
            </div>
            <div>
                <label style="display:block;font-size:11px;font-weight:700;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Tarif pour ce cr√©neau (XPF)</label>
                <div style="position:relative">
                    <input type="number" id="sl-price" value="${defaultRate}" min="1000" max="50000" step="100" required
                        style="width:100%;padding:13px 56px 13px 16px;border:1.5px solid #E5E7EB;border-radius:14px;font-size:16px;outline:none;font-family:inherit;color:#0D0D0D;background:#fff">
                    <span style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:13px;font-weight:700;color:#9CA3AF">XPF</span>
                </div>
                <p style="font-size:11px;color:#9CA3AF;margin-top:5px">Votre tarif habituel : ${defaultRate.toLocaleString()} XPF/h</p>
            </div>
            <div id="sl-preview" style="background:#FFF7ED;border-radius:12px;padding:12px 14px;font-size:13px;color:#EA580C;font-weight:600;display:none"></div>
            <div style="display:flex;gap:10px;margin-top:4px">
                <button type="button" onclick="this.closest('.fixed').remove()" style="flex:1;padding:14px;border:1.5px solid #E5E7EB;border-radius:14px;font-weight:700;font-size:15px;background:#fff;cursor:pointer;color:#0D0D0D">Annuler</button>
                <button type="submit" style="flex:1;padding:14px;background:#FF5A1F;color:#fff;border:none;border-radius:14px;font-weight:900;font-size:15px;cursor:pointer">Cr√©er le cr√©neau</button>
            </div>
        </form>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });

    // Pr√©visualisation du tarif en direct
    const previewDiv = modal.querySelector('#sl-preview');
    function updatePreview() {
        const price = parseInt(modal.querySelector('#sl-price').value) || 0;
        const dur = parseFloat(modal.querySelector('#sl-dur').value) || 1;
        const total = Math.round(price * dur);
        const commission = Math.round(total * 0.15);
        const net = total - commission;
        if (price > 0) {
            previewDiv.style.display = 'block';
            previewDiv.innerHTML = `üí∞ Total √©l√®ve : <strong>\${total.toLocaleString()} XPF</strong> ¬∑ Vos revenus nets : <strong>\${net.toLocaleString()} XPF</strong>`;
        }
    }
    modal.querySelector('#sl-price').addEventListener('input', updatePreview);
    modal.querySelector('#sl-dur').addEventListener('change', updatePreview);
    updatePreview();

    modal.querySelector('#slot-form').onsubmit = async function(e) {
        e.preventDefault();
        const price = parseInt(document.getElementById('sl-price').value);
        if (!price || price < 1000) { notif('‚ùå Tarif invalide', 'Minimum 1000 XPF', 'red'); return; }
        const btn = modal.querySelector('button[type=submit]');
        btn.textContent = 'Cr√©ation...'; btn.disabled = true;
        const { data, error } = await sb.from('slots').insert({
            instructor_id: currentUser.id,
            date: document.getElementById('sl-date').value,
            time: document.getElementById('sl-time').value,
            duration: parseFloat(document.getElementById('sl-dur').value),
            price, available: true
        }).select().single();
        if (error) { notif('‚ùå Erreur', error.message, 'red'); btn.textContent='Cr√©er le cr√©neau'; btn.disabled=false; return; }
        DB.slots.push(data);
        modal.remove();
        notif('‚úÖ Cr√©neau cr√©√©', price.toLocaleString() + ' XPF', 'green');
        render();
    };
};

window.showSlots = function(instructorId) {
    const instructor = DB.instructors.find(x=>x.id===instructorId);
    if (!instructor) return;
    const slots = DB.slots.filter(s=>s.instructor_id===instructorId&&s.available);
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4';
    modal.innerHTML = `<div class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <div><h3 class="text-xl font-bold">${instructor.name}</h3><p class="text-gray-400 text-sm">üìç ${instructor.location} ¬∑ ‚≠ê ${instructor.rating||'N/A'}</p></div>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 text-2xl">‚úï</button>
        </div>
        <div class="space-y-3">
            ${slots.length===0?'<p class="text-center text-gray-400 py-8">Aucun cr√©neau disponible</p>':slots.map(s=>`
            <div class="border border-gray-100 rounded-2xl p-4 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold">üìÖ ${s.date}</p>
                        <p class="text-sm text-gray-400">üïê ${s.time} ¬∑ ‚è±Ô∏è ${s.duration}h</p>
                        <p class="font-semibold text-orange-600 mt-1">${s.price} XPF</p>
                    </div>
                    <button onclick="bookSlot('${s.id}','${instructorId}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:bg-orange-600">R√©server</button>
                </div>
            </div>`).join('')}
        </div>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
};

window.bookSlot = function(slotId, instructorId) {
    if (!currentUser) { notif('‚ùå Connectez-vous d\'abord', '', 'red'); return; }
    const slot = DB.slots.find(s=>s.id===slotId);
    const instructor = DB.instructors.find(i=>i.id===instructorId);
    if (!slot || !instructor) return;
    const prices = calcPrices(slot.price);
    document.querySelectorAll('.fixed').forEach(m=>m.remove());
    showPaymentModal(slot, instructor, prices);
};

function showPaymentModal(slot, instructor, prices) {
    // Taux de change fixe officiel XPF/EUR (parit√© fixe - ne change jamais)
    const XPF_TO_EUR = 119.3317;
    const amountEUR  = (slot.price / XPF_TO_EUR).toFixed(2);
    const instrName  = instructor.name;  // null voulu par le dev
    const PAYPAL_CLIENT_ID = 'EH6_wDSUHjZ155FCNOGogvRtTF11vlyr-I42_7VsyiHE9dDdc8slqZZ43aMXXYk1onXf77XgmWnThZqp';

    document.querySelectorAll('.dc-modal-overlay').forEach(m => m.remove());
    document.body.style.overflow = 'hidden';

    const modal = document.createElement('div');
    modal.className = 'dc-modal-overlay';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;display:flex;align-items:flex-end;justify-content:center';
    document.body.appendChild(modal);

    modal.innerHTML = `
    <div id="pay-sheet" style="background:#fff;border-radius:28px 28px 0 0;width:100%;max-width:520px;box-shadow:0 -8px 60px rgba(0,0,0,0.3);overflow:hidden;max-height:92vh;overflow-y:auto">

        <!-- Header sombre -->
        <div style="background:#0D0D0D;padding:20px 24px 24px">
            <div style="width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 18px"></div>
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div style="flex:1;min-width:0;padding-right:12px">
                    <p style="color:rgba(255,255,255,0.4);font-size:11px;font-weight:700;letter-spacing:1px;margin-bottom:6px">PAIEMENT S√âCURIS√â</p>
                    <p style="color:#fff;font-weight:900;font-size:20px;margin-bottom:2px">${instrName}</p>
                    <p style="color:rgba(255,255,255,0.4);font-size:13px">üìÖ ${slot.date} ¬∑ ${slot.time} ¬∑ ${slot.duration}h</p>
                </div>
                <button id="close-pay-btn" style="color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.08);border:none;width:36px;height:36px;border-radius:50%;font-size:16px;cursor:pointer;flex-shrink:0">‚úï</button>
            </div>
            <div style="display:flex;align-items:baseline;gap:8px;margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.08)">
                <span style="color:#FF5A1F;font-size:38px;font-weight:900;line-height:1">${slot.price.toLocaleString()}</span>
                <span style="color:rgba(255,255,255,0.35);font-size:16px">XPF</span>
                <span style="color:rgba(255,255,255,0.2);font-size:12px">‚âà ${amountEUR} ‚Ç¨</span>
            </div>
        </div>

        <!-- Corps -->
        <div style="padding:24px">

            <!-- R√©cap -->
            <div style="background:#F9FAFB;border-radius:16px;padding:16px;margin-bottom:20px;display:flex;gap:14px;align-items:center">
                <div style="width:44px;height:44px;background:#0D0D0D;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">üöó</div>
                <div style="flex:1">
                    <p style="font-weight:800;color:#0D0D0D;font-size:15px">Cours avec ${instrName}</p>
                    <p style="color:#6B7280;font-size:13px;margin-top:2px">${slot.date} √† ${slot.time} ‚Äî ${slot.duration}h</p>
                </div>
                <div style="text-align:right;flex-shrink:0">
                    <p style="font-weight:900;color:#FF5A1F;font-size:16px">${slot.price.toLocaleString()} XPF</p>
                </div>
            </div>

            <!-- Logos cartes -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
                <div style="background:#1A1F71;border-radius:6px;padding:5px 10px"><span style="color:#fff;font-weight:900;font-size:12px;letter-spacing:1px">VISA</span></div>
                <div style="position:relative;width:36px;height:24px">
                    <div style="position:absolute;left:0;top:0;width:22px;height:22px;border-radius:50%;background:#EB001B"></div>
                    <div style="position:absolute;left:12px;top:0;width:22px;height:22px;border-radius:50%;background:#F79E1B;opacity:0.9"></div>
                </div>
                <span style="color:#9CA3AF;font-size:12px">Visa ¬∑ Mastercard ¬∑ Compte PayPal</span>
                <span style="margin-left:auto">üîí</span>
            </div>

            <!-- Zone PayPal : 5000 XPF et 4500 XPF -->
            <div id="paypal-btn-zone">
                ${slot.price === 5000 || slot.price === 4500 || slot.price === 4200 || slot.price === 1000 || slot.price === 1500 || slot.price === 2000 || slot.price === 2500 || slot.price === 3000 || slot.price === 3500 || slot.price === 4000 || slot.price === 5500 || slot.price === 6000 || slot.price === 6500 || slot.price === 7000 || slot.price === 7500 || slot.price === 8000 || slot.price === 8500 || slot.price === 9000 || slot.price === 10000 ? `
                <div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:18px;background:#F9FAFB;border-radius:14px">
                    <div style="width:20px;height:20px;border:2px solid #E5E7EB;border-top-color:#FF5A1F;border-radius:50%;animation:spin 0.7s linear infinite"></div>
                    <span style="color:#9CA3AF;font-size:14px">Chargement du paiement‚Ä¶</span>
                </div>` : `
                <div style="background:#FFF7ED;border-radius:14px;padding:16px;text-align:center;border:1.5px solid #FED7AA">
                    <p style="font-size:20px;margin-bottom:8px">‚ö†Ô∏è</p>
                    <p style="color:#EA580C;font-weight:800;font-size:14px;margin-bottom:4px">Paiement en ligne non disponible</p>
                    <p style="color:#9CA3AF;font-size:12px">Le paiement en ligne n'est pas encore disponible pour ce montant.</p>
                </div>`}
            </div>

            <p style="text-align:center;font-size:11px;color:#D1D5DB;margin-top:16px;line-height:1.5">
                üîí Paiement trait√© par <strong style="color:#9CA3AF">PayPal</strong> ‚Äî DriveConnect NC ne stocke jamais vos coordonn√©es bancaires
            </p>
        </div>
    </div>`;

    modal.querySelector('#close-pay-btn').addEventListener('click', () => {
        modal.remove(); document.body.style.overflow = '';
    });
    modal.addEventListener('click', e => {
        if (e.target === modal) { modal.remove(); document.body.style.overflow = ''; }
    });

    // ‚îÄ‚îÄ Compl√©ter la r√©servation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _bookingInProgress = false;
    async function completeBooking(paymentStatus, orderId) {
        // Protection double-clic
        if (_bookingInProgress) return;
        _bookingInProgress = true;

        // V√©rifier que le cr√©neau est toujours disponible (protection double r√©servation)
        const { data: freshSlot, error: slotErr } = await sb.from('slots').select('available').eq('id', slot.id).single();
        if (slotErr || !freshSlot || freshSlot.available === false) {
            notif('‚ùå Cr√©neau d√©j√† r√©serv√©', 'Ce cr√©neau vient d\'√™tre pris par un autre √©l√®ve', 'red');
            _bookingInProgress = false;
            setTimeout(() => { modal.remove(); document.body.style.overflow = ''; render(); }, 2000);
            return;
        }

        // Marquer le slot comme indisponible imm√©diatement
        const { error } = await sb.from('slots').update({ available: false }).eq('id', slot.id).eq('available', true);
        if (error) { notif('‚ùå Cr√©neau indisponible', 'Ce cr√©neau a √©t√© r√©serv√© par un autre √©l√®ve', 'red'); _bookingInProgress = false; return; }

        // G√©n√©rer un code unique de 6 caract√®res
        const completionCode = Math.random().toString(36).substring(2, 8).toUpperCase();

        const { data: booking, error: bError } = await sb.from('bookings').insert({
            slot_id: slot.id,
            student_id: currentUser.id,
            student_name: currentUser.name,
            instructor_id: instructor.id,
            instructor_name: instrName,
            date: slot.date, time: slot.time, duration: slot.duration,
            amount: slot.price, commission: prices.commission, net: prices.net,
            status: 'confirmed', payment_status: paymentStatus,
            paypal_order_id: orderId,
            completion_code: completionCode
        }).select().single();

        if (bError) { notif('‚ùå Erreur r√©servation', bError.message, 'red'); _bookingInProgress = false; return; }

        sendPushToUser(instructor.id, 'üéâ Nouvelle r√©servation !',
            `${currentUser.name} a r√©serv√© le ${slot.date} √† ${slot.time}`);
        DB.slots   = DB.slots.filter(s => s.id !== slot.id);
        DB.bookings.push(booking);

        // Succ√®s dans le modal avec le code de validation
        const body = modal.querySelector('[style*="padding:24px"]');
        if (body) body.innerHTML = `
            <div style="text-align:center;padding:40px 20px">
                <div style="width:72px;height:72px;background:#ECFDF5;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px">‚úÖ</div>
                <p style="font-weight:900;font-size:22px;color:#0D0D0D;margin-bottom:8px">Paiement r√©ussi !</p>
                <p style="color:#6B7280;font-size:15px">R√©servation confirm√©e avec <strong>${instrName}</strong><br>le ${slot.date} √† ${slot.time}</p>
                <div style="margin-top:20px;padding:16px;background:#FFF7ED;border-radius:16px;border:2px solid #FED7AA">
                    <p style="font-size:11px;font-weight:700;color:#9CA3AF;letter-spacing:1px;margin-bottom:8px">üîë VOTRE CODE DE VALIDATION</p>
                    <p style="font-family:monospace;font-weight:900;font-size:32px;color:#FF5A1F;letter-spacing:6px">${completionCode}</p>
                    <p style="font-size:12px;color:#9CA3AF;margin-top:8px">Donnez ce code au moniteur √† la fin du cours</p>
                </div>
            </div>`;

        notif('‚úÖ R√©servation confirm√©e !', `Cours avec ${instrName} le ${slot.date}`, 'green');
        try {
            const session = await sb.auth.getSession();
            await fetch('https://nnmdvepfyccnehzbvpfn.supabase.co/functions/v1/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.data.session.access_token },
                body: JSON.stringify({ type: 'confirmation', studentEmail: currentUser.email, studentName: currentUser.name, instructorName: instrName, date: slot.date, time: slot.time, amount: slot.price })
            });
        } catch(e) {}
        setTimeout(() => { modal.remove(); document.body.style.overflow = ''; render(); }, 5000);
    }

    // ‚îÄ‚îÄ Charger le SDK PayPal dynamiquement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderPayPalButton() {
        const zone = document.getElementById('paypal-btn-zone');
        if (!zone) return;

        // Choisir le bon bouton selon le prix
        let hostedButtonId = null;
        let containerId = null;
        if (slot.price === 5000) {
            hostedButtonId = "CRCHZV8RAJNYE";
            containerId = "paypal-container-CRCHZV8RAJNYE";
        } else if (slot.price === 4500) {
            hostedButtonId = "6929WMFL3HEZL";
            containerId = "paypal-container-6929WMFL3HEZL";
        } else if (slot.price === 4200) {
            hostedButtonId = "SXRG8EMYJAMVQ";
            containerId = "paypal-container-SXRG8EMYJAMVQ";
        } else if (slot.price === 1000) {
            hostedButtonId = "2EZBK2H3CR3TL";
            containerId = "paypal-container-2EZBK2H3CR3TL";
        } else if (slot.price === 1500) {
            hostedButtonId = "8ZC7EWJ6W964N";
            containerId = "paypal-container-8ZC7EWJ6W964N";
        } else if (slot.price === 2000) {
            hostedButtonId = "ZP52Y53MUQERU";
            containerId = "paypal-container-ZP52Y53MUQERU";
        } else if (slot.price === 2500) {
            hostedButtonId = "JV27CZB5SP8QQ";
            containerId = "paypal-container-JV27CZB5SP8QQ";
        } else if (slot.price === 3000) {
            hostedButtonId = "HR6CXW2M6Y96Q";
            containerId = "paypal-container-HR6CXW2M6Y96Q";
        } else if (slot.price === 3500) {
            hostedButtonId = "CDYJV45KPGSUQ";
            containerId = "paypal-container-CDYJV45KPGSUQ";
        } else if (slot.price === 4000) {
            hostedButtonId = "S4K9WX4D95TNE";
            containerId = "paypal-container-S4K9WX4D95TNE";
        } else if (slot.price === 5500) {
            hostedButtonId = "CEFSQN2YN9LB4";
            containerId = "paypal-container-CEFSQN2YN9LB4";
        } else if (slot.price === 6000) {
            hostedButtonId = "BBAAEPSCZRN4Q";
            containerId = "paypal-container-BBAAEPSCZRN4Q";
        } else if (slot.price === 6500) {
            hostedButtonId = "4G7B39BAXCQTJ";
            containerId = "paypal-container-4G7B39BAXCQTJ";
        } else if (slot.price === 7000) {
            hostedButtonId = "SP8HAQEBDQ5PN";
            containerId = "paypal-container-SP8HAQEBDQ5PN";
        } else if (slot.price === 7500) {
            hostedButtonId = "DQ2NQCGZQQZLC";
            containerId = "paypal-container-DQ2NQCGZQQZLC";
        } else if (slot.price === 8000) {
            hostedButtonId = "SQG73NEM3HGM8";
            containerId = "paypal-container-SQG73NEM3HGM8";
        } else if (slot.price === 8500) {
            hostedButtonId = "QVX586SSDZ8YU";
            containerId = "paypal-container-QVX586SSDZ8YU";
        } else if (slot.price === 9000) {
            hostedButtonId = "QWDPKGADV45AU";
            containerId = "paypal-container-QWDPKGADV45AU";
        } else if (slot.price === 10000) {
            hostedButtonId = "N8Y9WHUFQ473E";
            containerId = "paypal-container-N8Y9WHUFQ473E";
        } else {
            return; // Pas de bouton pour les autres montants
        }

        try {
            zone.innerHTML = `<div id="${containerId}"></div>`;
            window.paypal.HostedButtons({
                hostedButtonId: hostedButtonId,
                onApprove: async (data) => {
                    zone.innerHTML = '<div style="text-align:center;padding:14px;color:#9CA3AF;font-size:13px"><div style="width:24px;height:24px;border:2px solid #E5E7EB;border-top-color:#FF5A1F;border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto 8px"></div>Traitement‚Ä¶</div>';
                    await completeBooking('paid', data.orderID);
                },
                onError: err => {
                    console.error('PayPal:', err);
                    zone.innerHTML = '<div style="background:#FFF7ED;border-radius:14px;padding:16px;text-align:center;border:1.5px solid #FED7AA"><p style="color:#EA580C;font-weight:700;margin-bottom:6px">üõ°Ô∏è PayPal bloqu√©</p><p style="color:#6B7280;font-size:12px">D√©sactivez votre bloqueur de pub ou ouvrez en <strong>navigation priv√©e</strong> (Ctrl+Maj+N)</p></div>';
                }
            }).render(`#${containerId}`);
        } catch(e) {
            console.error('PayPal render:', e);
            zone.innerHTML = '<div style="background:#FFF7ED;border-radius:14px;padding:16px;text-align:center;border:1.5px solid #FED7AA"><p style="color:#EA580C;font-weight:700;margin-bottom:6px">üõ°Ô∏è PayPal bloqu√©</p><p style="color:#6B7280;font-size:12px">D√©sactivez votre bloqueur de pub ou ouvrez en <strong>navigation priv√©e</strong> (Ctrl+Maj+N)</p></div>';
        }
    }

    // Lancer le bouton PayPal pour 5000 et 4500 XPF
    if (slot.price === 5000 || slot.price === 4500 || slot.price === 4200 || slot.price === 1000 || slot.price === 1500 || slot.price === 2000 || slot.price === 2500 || slot.price === 3000 || slot.price === 3500 || slot.price === 4000 || slot.price === 5500 || slot.price === 6000 || slot.price === 6500 || slot.price === 7000 || slot.price === 7500 || slot.price === 8000 || slot.price === 8500 || slot.price === 9000 || slot.price === 10000) {
        setTimeout(() => {
            if (typeof window.paypal !== 'undefined' && window.paypal.HostedButtons) {
                renderPayPalButton();
            } else {
                const zone = document.getElementById('paypal-btn-zone');
                if (zone) zone.innerHTML = '<div style="background:#FFF7ED;border-radius:14px;padding:16px;text-align:center;border:1.5px solid #FED7AA"><p style="color:#EA580C;font-weight:700;margin-bottom:6px">üõ°Ô∏è PayPal bloqu√©</p><p style="color:#6B7280;font-size:12px">D√©sactivez votre bloqueur de pub ou ouvrez en <strong>navigation priv√©e</strong> (Ctrl+Maj+N)</p></div>';
            }
        }, 400);
    }
}


// ========== ANNULATIONS ==========
window.cancelStudent = async function(bookingId) {
    const b = DB.bookings.find(x=>x.id===bookingId);
    if (!b) return;
    const pol = cancellationPolicy(b.date,b.time);
    const refund = Math.round(b.amount*pol.pct/100);
    if (!confirm(`Annuler ce cours ?\n\n${pol.label}\nRemboursement : ${refund} XPF\n\n‚ö†Ô∏è Le cr√©neau sera supprim√©. Le moniteur devra en cr√©er un nouveau.`)) return;

    await sb.from('bookings').update({ status:'cancelled', cancelled_by:'student', refund_amount:refund, cancelled_at:new Date().toISOString() }).eq('id', bookingId);
    // SUPPRIMER le cr√©neau (pas le remettre disponible)
    if (b.slot_id) await sb.from('slots').delete().eq('id', b.slot_id);
    DB.slots = DB.slots.filter(s => s.id !== b.slot_id);

    const cancelledBooking = DB.bookings.find(x=>x.id===bookingId);
    if (cancelledBooking) {
        sendNotification('cancellation', {
            studentEmail: currentUser.email,
            studentName: currentUser.name,
            instructorName: cancelledBooking.instructor_name,
            date: cancelledBooking.date,
            time: cancelledBooking.time
        });
        sendPushToUser(cancelledBooking.instructor_id, '‚ùå Cours annul√©', `${currentUser.name} a annul√© le cours du ${cancelledBooking.date} √† ${cancelledBooking.time}. Cr√©neau supprim√©.`);
    }

    await loadData();
    notif('R√©servation annul√©e',`Remboursement de ${refund} XPF (${pol.pct}%)`,pol.pct===100?'green':pol.pct===50?'yellow':'red');
    render();
};

window.cancelInstructor = async function(bookingId) {
    const b = DB.bookings.find(x=>x.id===bookingId);
    if (!b) return;
    const diffH = (new Date(b.date+'T'+b.time)-new Date())/3600000;
    const isLate = diffH<24;
    if (!confirm(isLate?`‚ö†Ô∏è Annulation < 24h !\n\nP√©nalit√© visibilit√© -10% pendant 7 jours\nLe cr√©neau sera supprim√©.\nConfirmer ?`:`Annuler ce cours ? L'√©l√®ve sera rembours√©.\nLe cr√©neau sera supprim√©.`)) return;

    await sb.from('bookings').update({ status:'cancelled', cancelled_by:'instructor', refund_amount:b.amount, cancelled_at:new Date().toISOString() }).eq('id', bookingId);
    // SUPPRIMER le cr√©neau
    if (b.slot_id) await sb.from('slots').delete().eq('id', b.slot_id);
    DB.slots = DB.slots.filter(s => s.id !== b.slot_id);

    if (isLate) {
        const end = new Date(); end.setDate(end.getDate()+7);
        await sb.from('instructors').update({ penalty_until:end.toISOString(), visibility_penalty:10 }).eq('id', currentUser.id);
    }

    sendPushToUser(b.student_id, '‚ùå Cours annul√© par le moniteur', `Le cours du ${b.date} √† ${b.time} a √©t√© annul√©. Remboursement en cours.`);
    await loadData();
    notif(isLate?'‚ö†Ô∏è P√©nalit√© appliqu√©e':'‚úÖ Cours annul√©',isLate?'Visibilit√© -10% pendant 7 jours':'√âl√®ve rembours√© ¬∑ Cr√©neau supprim√©',isLate?'red':'orange');
    render();
};

window.confirmB = async (id) => {
    await sb.from('bookings').update({ status:'confirmed' }).eq('id', id);
    await loadData(); notif('‚úÖ Cours accept√©','','green'); render();
};

window.rejectB = async (id) => {
    const b = DB.bookings.find(x=>x.id===id);
    await sb.from('bookings').update({ status:'rejected' }).eq('id', id);
    if (b && b.slot_id) await sb.from('slots').delete().eq('id', b.slot_id);
    await loadData(); notif('Cours refus√© ¬∑ Cr√©neau supprim√©','','red'); render();
};

window.deleteSlot = async (id) => {
    if (!confirm('Supprimer ce cr√©neau ?')) return;
    await sb.from('slots').delete().eq('id', id);
    DB.slots = DB.slots.filter(s=>s.id!==id);
    notif('Cr√©neau supprim√©','','orange'); render();
};

// ========== VALIDATION CODE MONITEUR ==========
window.openValidateModal = function(bookingId, studentName) {
    document.querySelectorAll('.validate-modal').forEach(m => m.remove());
    const m = document.createElement('div');
    m.className = 'validate-modal';
    m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px';
    m.innerHTML = `
    <div style="background:#0D0D0D;border-radius:28px;width:100%;max-width:400px;padding:32px;text-align:center">
        <div style="width:64px;height:64px;background:linear-gradient(135deg,#FF5A1F,#FF8C42);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 16px">üîë</div>
        <h3 style="color:#fff;font-weight:900;font-size:20px;margin-bottom:6px">Valider le cours</h3>
        <p style="color:#6B7280;font-size:13px;margin-bottom:24px">Entrez le code √† 6 caract√®res donn√© par <strong style="color:#fff">${studentName || 'votre √©l√®ve'}</strong></p>
        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:8px" id="code-inputs">
            <input type="text" maxlength="1" class="vc-input" style="width:48px;height:56px;text-align:center;font-family:monospace;font-weight:900;font-size:24px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#FF5A1F;outline:none" autofocus>
            <input type="text" maxlength="1" class="vc-input" style="width:48px;height:56px;text-align:center;font-family:monospace;font-weight:900;font-size:24px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#FF5A1F;outline:none">
            <input type="text" maxlength="1" class="vc-input" style="width:48px;height:56px;text-align:center;font-family:monospace;font-weight:900;font-size:24px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#FF5A1F;outline:none">
            <input type="text" maxlength="1" class="vc-input" style="width:48px;height:56px;text-align:center;font-family:monospace;font-weight:900;font-size:24px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#FF5A1F;outline:none">
            <input type="text" maxlength="1" class="vc-input" style="width:48px;height:56px;text-align:center;font-family:monospace;font-weight:900;font-size:24px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#FF5A1F;outline:none">
            <input type="text" maxlength="1" class="vc-input" style="width:48px;height:56px;text-align:center;font-family:monospace;font-weight:900;font-size:24px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#FF5A1F;outline:none">
        </div>
        <p id="validate-error" style="color:#EF4444;font-size:13px;font-weight:700;min-height:24px;margin-bottom:16px"></p>
        <button id="validate-submit-btn" onclick="submitValidationCode('${bookingId}')" style="width:100%;padding:16px;background:linear-gradient(135deg,#FF5A1F,#FF8C42);color:#fff;border:none;border-radius:16px;font-weight:900;font-size:16px;cursor:pointer;opacity:0.4;pointer-events:none" disabled>
            Valider le cours
        </button>
        <button onclick="this.closest('.validate-modal').remove()" style="width:100%;padding:14px;background:none;border:none;color:#6B7280;font-weight:700;font-size:14px;cursor:pointer;margin-top:8px">
            Annuler
        </button>
    </div>`;
    document.body.appendChild(m);
    m.addEventListener('click', e => { if (e.target === m) m.remove(); });

    // Auto-focus et navigation entre inputs
    const inputs = m.querySelectorAll('.vc-input');
    inputs[0].focus();
    inputs.forEach((inp, i) => {
        inp.addEventListener('input', (e) => {
            inp.value = inp.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (inp.value && i < 5) inputs[i + 1].focus();
            // Activer le bouton si 6 chars remplis
            const code = Array.from(inputs).map(x => x.value).join('');
            const btn = document.getElementById('validate-submit-btn');
            if (btn) {
                btn.disabled = code.length < 6;
                btn.style.opacity = code.length < 6 ? '0.4' : '1';
                btn.style.pointerEvents = code.length < 6 ? 'none' : 'auto';
            }
            document.getElementById('validate-error').textContent = '';
        });
        inp.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !inp.value && i > 0) {
                inputs[i - 1].focus();
                inputs[i - 1].value = '';
            }
            if (e.key === 'Enter') {
                const code = Array.from(inputs).map(x => x.value).join('');
                if (code.length === 6) submitValidationCode(bookingId);
            }
        });
        // Support paste
        inp.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasted = (e.clipboardData.getData('text') || '').toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
            pasted.split('').forEach((ch, j) => { if (inputs[j]) inputs[j].value = ch; });
            if (pasted.length > 0) inputs[Math.min(pasted.length, 5)].focus();
            const btn = document.getElementById('validate-submit-btn');
            if (btn) {
                btn.disabled = pasted.length < 6;
                btn.style.opacity = pasted.length < 6 ? '0.4' : '1';
                btn.style.pointerEvents = pasted.length < 6 ? 'none' : 'auto';
            }
        });
    });
};

window.submitValidationCode = async function(bookingId) {
    const inputs = document.querySelectorAll('.vc-input');
    const code = Array.from(inputs).map(x => x.value).join('').toUpperCase();
    const errEl = document.getElementById('validate-error');
    const btn = document.getElementById('validate-submit-btn');

    if (code.length !== 6) {
        if (errEl) errEl.textContent = 'Entrez les 6 caract√®res';
        return;
    }

    if (btn) { btn.textContent = 'V√©rification...'; btn.disabled = true; btn.style.opacity = '0.6'; }

    // R√©cup√©rer le vrai code depuis Supabase
    const { data: booking, error } = await sb.from('bookings').select('completion_code, student_id, student_name, date, time').eq('id', bookingId).single();
    if (error || !booking) {
        if (errEl) errEl.textContent = 'Erreur de v√©rification';
        if (btn) { btn.textContent = 'Valider le cours'; btn.disabled = false; btn.style.opacity = '1'; }
        return;
    }

    if (code !== (booking.completion_code || '').toUpperCase()) {
        // Code incorrect - shake animation
        if (errEl) errEl.textContent = '‚ùå Code incorrect, r√©essayez';
        inputs.forEach(inp => {
            inp.style.borderColor = '#EF4444';
            inp.value = '';
            setTimeout(() => inp.style.borderColor = '#333', 1500);
        });
        inputs[0].focus();
        if (btn) { btn.textContent = 'Valider le cours'; btn.disabled = true; btn.style.opacity = '0.4'; btn.style.pointerEvents = 'none'; }
        return;
    }

    // ‚úÖ Code correct ‚Üí marquer comme termin√©
    await sb.from('bookings').update({
        status: 'completed',
        completed_at: new Date().toISOString()
    }).eq('id', bookingId);

    // Notifier l'√©l√®ve
    sendPushToUser(booking.student_id, '‚úÖ Cours valid√© !', `Votre cours du ${booking.date} a √©t√© valid√© par le moniteur`);

    // Succ√®s visuel avec bouton fiche de suivi
    const modal = document.querySelector('.validate-modal');
    if (modal) {
        const inner = modal.querySelector('[style*="background:#0D0D0D"]');
        if (inner) inner.innerHTML = `
            <div style="text-align:center;padding:24px">
                <div style="width:80px;height:80px;background:#ECFDF5;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 16px">‚úÖ</div>
                <h3 style="color:#fff;font-weight:900;font-size:22px;margin-bottom:8px">Cours valid√© !</h3>
                <p style="color:#6B7280;font-size:14px;margin-bottom:20px">Le cours avec <strong style="color:#fff">${booking.student_name}</strong> du ${booking.date} √† ${booking.time} a √©t√© valid√©.</p>
                <button onclick="document.querySelectorAll('.validate-modal').forEach(m=>m.remove());openProgressNoteModal('${bookingId}','${(booking.student_name||'').replace(/'/g,'')}','${booking.student_id}','${booking.date}')" style="width:100%;padding:16px;background:linear-gradient(135deg,#FF5A1F,#FF8C42);color:#fff;border:none;border-radius:16px;font-weight:900;font-size:15px;cursor:pointer;margin-bottom:10px">
                    üìù Remplir la fiche de suivi
                </button>
                <p style="color:#4B5563;font-size:12px">Vous avez <strong style="color:#FBBF24">24h</strong> pour remplir la fiche de suivi</p>
            </div>`;
    }

    await loadData();
    notif('‚úÖ Cours valid√© !', `${booking.student_name} ‚Äî ${booking.date}`, 'green');
};

// ========== FICHE DE SUIVI ==========
window.openProgressNoteModal = function(bookingId, studentName, studentId, lessonDate) {
    document.querySelectorAll('.progress-modal').forEach(m => m.remove());
    const m = document.createElement('div');
    m.className = 'progress-modal';
    m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px';
    m.innerHTML = `
    <div style="background:#0D0D0D;border-radius:28px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:28px">
        <div style="text-align:center;margin-bottom:20px">
            <div style="width:56px;height:56px;background:linear-gradient(135deg,#FF5A1F,#FF8C42);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 12px">üìù</div>
            <h3 style="color:#fff;font-weight:900;font-size:20px;margin-bottom:4px">Fiche de suivi</h3>
            <p style="color:#6B7280;font-size:13px">Cours du <strong style="color:#fff">${lessonDate}</strong> avec <strong style="color:#FF5A1F">${studentName}</strong></p>
        </div>

        <div style="margin-bottom:16px">
            <label style="display:block;color:#9CA3AF;font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:8px">COMP√âTENCES TRAVAILL√âES</label>
            <div id="skills-tags" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px">
                ${['D√©marrage','Cr√©neau','Demi-tour','Priorit√©s','Rond-point','Autoroute','Stationnement','R√©troviseurs','Vitesse','Direction','Freinage','Signalisation'].map(skill =>
                    `<button type="button" onclick="this.classList.toggle('selected');this.style.background=this.classList.contains('selected')?'#FF5A1F':'#1A1A1A';this.style.color=this.classList.contains('selected')?'#fff':'#6B7280';this.style.borderColor=this.classList.contains('selected')?'#FF5A1F':'#333'" style="padding:6px 14px;border-radius:20px;border:1.5px solid #333;background:#1A1A1A;color:#6B7280;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s">${skill}</button>`
                ).join('')}
            </div>
        </div>

        <div style="margin-bottom:16px">
            <label style="display:block;color:#9CA3AF;font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:8px">NIVEAU GLOBAL</label>
            <div id="level-select" style="display:flex;gap:8px">
                ${[{l:'D√©butant',e:'üü°',c:'#FBBF24'},{l:'En progression',e:'üü†',c:'#F97316'},{l:'Bon niveau',e:'üü¢',c:'#22C55E'},{l:'Pr√™t pour examen',e:'üîµ',c:'#3B82F6'}].map(lv =>
                    `<button type="button" data-level="${lv.l}" onclick="document.querySelectorAll('#level-select button').forEach(b=>{b.style.background='#1A1A1A';b.style.borderColor='#333';b.style.color='#6B7280'});this.style.background='${lv.c}22';this.style.borderColor='${lv.c}';this.style.color='${lv.c}'" style="flex:1;padding:10px 6px;border-radius:12px;border:1.5px solid #333;background:#1A1A1A;color:#6B7280;font-size:11px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s">${lv.e}<br>${lv.l}</button>`
                ).join('')}
            </div>
        </div>

        <div style="margin-bottom:16px">
            <label style="display:block;color:#9CA3AF;font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:8px">OBSERVATIONS</label>
            <textarea id="progress-note-text" placeholder="D√©crivez la progression, les points forts et les axes d'am√©lioration..." style="width:100%;min-height:120px;padding:14px;border:2px solid #333;border-radius:14px;background:#1A1A1A;color:#fff;font-size:14px;font-family:inherit;resize:vertical;outline:none;line-height:1.5" onfocus="this.style.borderColor='#FF5A1F'" onblur="this.style.borderColor='#333'"></textarea>
        </div>

        <button onclick="submitProgressNote('${bookingId}','${studentId}','${(studentName||'').replace(/'/g,'')}','${lessonDate}')" style="width:100%;padding:16px;background:linear-gradient(135deg,#FF5A1F,#FF8C42);color:#fff;border:none;border-radius:16px;font-weight:900;font-size:16px;cursor:pointer">
            Enregistrer la note
        </button>
        <button onclick="this.closest('.progress-modal').remove()" style="width:100%;padding:14px;background:none;border:none;color:#6B7280;font-weight:700;font-size:14px;cursor:pointer;margin-top:6px">
            Annuler
        </button>
    </div>`;
    document.body.appendChild(m);
    m.addEventListener('click', e => { if (e.target === m) m.remove(); });
    setTimeout(() => document.getElementById('progress-note-text')?.focus(), 200);
};

window.submitProgressNote = async function(bookingId, studentId, studentName, lessonDate) {
    const noteText = document.getElementById('progress-note-text')?.value?.trim();
    if (!noteText) { notif('‚ö†Ô∏è √âcrivez une observation', '', 'orange'); return; }

    // R√©cup√©rer les comp√©tences s√©lectionn√©es
    const skills = Array.from(document.querySelectorAll('#skills-tags button.selected')).map(b => b.textContent.trim());

    // R√©cup√©rer le niveau
    const levelBtn = document.querySelector('#level-select button[style*="border-color"]');
    const level = levelBtn?.getAttribute('data-level') || null;

    // V√©rifier que le booking est bien completed et dans les 24h
    const { data: booking, error: bErr } = await sb.from('bookings').select('status, completed_at, instructor_id, student_id').eq('id', bookingId).single();
    if (bErr || !booking) { notif('‚ùå Erreur', 'R√©servation introuvable', 'red'); return; }
    if (booking.status !== 'completed') { notif('‚ùå Ce cours n\'a pas √©t√© valid√©', '', 'red'); return; }
    if (booking.instructor_id !== currentUser.id) { notif('‚ùå Vous n\'√™tes pas le moniteur de ce cours', '', 'red'); return; }
    if (booking.completed_at && (new Date() - new Date(booking.completed_at)) > 86400000) {
        notif('‚ùå D√©lai de 24h d√©pass√©', 'Vous ne pouvez plus modifier la fiche', 'red'); return;
    }

    // V√©rifier qu'il n'y a pas d√©j√† une note pour ce booking
    const { data: existing } = await sb.from('progress_notes').select('id').eq('booking_id', bookingId).single();
    if (existing) { notif('‚ö†Ô∏è Note d√©j√† enregistr√©e', '', 'orange'); return; }

    // Ins√©rer la note
    const { error } = await sb.from('progress_notes').insert({
        booking_id: bookingId,
        student_id: studentId,
        instructor_id: currentUser.id,
        instructor_name: currentUser.name,
        lesson_date: lessonDate,
        note: noteText,
        skills: skills,
        level: level
    });

    if (error) { notif('‚ùå Erreur', error.message, 'red'); return; }

    document.querySelectorAll('.progress-modal').forEach(m => m.remove());
    sendPushToUser(studentId, 'üìù Fiche de suivi mise √† jour', `Votre moniteur a rempli votre fiche de suivi pour le cours du ${lessonDate}`);
    await loadData();
    notif('‚úÖ Fiche de suivi enregistr√©e !', studentName, 'green');
    render();
};

window.viewStudentProgress = async function(studentId, studentName) {
    document.querySelectorAll('.progress-view-modal').forEach(m => m.remove());

    // Charger toutes les notes de cet √©l√®ve
    const { data: notes, error } = await sb.from('progress_notes').select('*').eq('student_id', studentId).order('created_at', { ascending: false });
    if (error) { notif('‚ùå Erreur', error.message, 'red'); return; }

    const m = document.createElement('div');
    m.className = 'progress-view-modal';
    m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px';
    m.innerHTML = `
    <div style="background:#0D0D0D;border-radius:28px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:28px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <div>
                <h3 style="color:#fff;font-weight:900;font-size:20px">üìñ Fiche de suivi</h3>
                <p style="color:#FF5A1F;font-size:14px;font-weight:700">${studentName}</p>
            </div>
            <button onclick="this.closest('.progress-view-modal').remove()" style="color:#6B7280;background:#1A1A1A;border:none;width:36px;height:36px;border-radius:50%;font-size:16px;cursor:pointer">‚úï</button>
        </div>

        ${(!notes || notes.length === 0) ? `
            <div style="text-align:center;padding:40px 20px">
                <p style="font-size:40px;margin-bottom:12px">üìñ</p>
                <p style="color:#6B7280;font-size:14px">Aucune note de suivi pour cet √©l√®ve</p>
            </div>
        ` : `
            ${notes[0]?.level ? `
                <div style="background:#1A1A1A;border-radius:16px;padding:14px;margin-bottom:16px;text-align:center">
                    <p style="color:#9CA3AF;font-size:11px;font-weight:700;letter-spacing:1px;margin-bottom:6px">DERNIER NIVEAU √âVALU√â</p>
                    <p style="color:#fff;font-size:18px;font-weight:900">${notes[0].level === 'D√©butant' ? 'üü°' : notes[0].level === 'En progression' ? 'üü†' : notes[0].level === 'Bon niveau' ? 'üü¢' : 'üîµ'} ${notes[0].level}</p>
                </div>
            ` : ''}
            <div style="display:flex;flex-direction:column;gap:14px">
            ${notes.map(note => `
                <div style="background:#1A1A1A;border-radius:18px;padding:16px;border-left:3px solid ${note.instructor_id === currentUser?.id ? '#FF5A1F' : '#333'}">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <p style="color:#fff;font-weight:800;font-size:14px">${note.instructor_name || 'Moniteur'}</p>
                        <p style="color:#4B5563;font-size:11px">üìÖ ${note.lesson_date || ''}</p>
                    </div>
                    ${note.skills && note.skills.length > 0 ? `
                        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                            ${note.skills.map(s => `<span style="padding:3px 10px;border-radius:12px;background:rgba(255,90,31,0.12);color:#FF5A1F;font-size:11px;font-weight:700">${s}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${note.level ? `<p style="color:#9CA3AF;font-size:12px;margin-bottom:8px">Niveau: <strong style="color:#fff">${note.level}</strong></p>` : ''}
                    <p style="color:#D1D5DB;font-size:13px;line-height:1.6;white-space:pre-wrap">${(note.note||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>
                </div>
            `).join('')}
            </div>
        `}
    </div>`;
    document.body.appendChild(m);
    m.addEventListener('click', e => { if (e.target === m) m.remove(); });
};

// ========== GPS & CARTE ==========
let mapRealtimeChannel = null;
let broadcastChannel = null;  // Canal broadcast ultra-rapide
let lastDbUpdate = 0;          // Throttle DB updates (toutes les 4s max)

// ‚îÄ‚îÄ Cr√©er/mettre √† jour un marqueur moniteur sur la carte ‚îÄ‚îÄ
function _buildInstructorIcon(i) {
    const now = new Date();
    const hasPenalty = i.penalty_until && new Date(i.penalty_until) > now;
    const color = hasPenalty ? '#ef4444' : i.is_online ? '#22c55e' : '#9ca3af';
    const borderColor = i.is_online ? '#22c55e' : '#fff';
    const shadow = i.is_online 
        ? 'box-shadow:0 0 0 4px rgba(34,197,94,0.25),0 4px 20px rgba(0,0,0,0.3)' 
        : 'box-shadow:0 4px 16px rgba(0,0,0,0.25)';
    const pulse = i.is_online ? `<div style="position:absolute;inset:-6px;border-radius:50%;border:2.5px solid rgba(34,197,94,0.4);animation:pulse-ring 2s ease-out infinite"></div>
        <div style="position:absolute;inset:-6px;border-radius:50%;border:2.5px solid rgba(34,197,94,0.2);animation:pulse-ring 2s ease-out infinite 0.5s"></div>` : '';
    const avatarHtml = i.avatar_url
        ? `<img src="${i.avatar_url}" style="width:46px;height:46px;border-radius:50%;object-fit:cover;border:3px solid ${borderColor};${shadow};display:block">`
        : `<div style="background:${color};width:46px;height:46px;border-radius:50%;border:3px solid ${borderColor};${shadow};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:white;letter-spacing:-0.5px">${(i.name||'?').charAt(0).toUpperCase()}</div>`;
    const statusDot = `<div style="position:absolute;bottom:-1px;right:-1px;width:14px;height:14px;border-radius:50%;background:${color};border:2.5px solid #fff;z-index:2"></div>`;
    return L.divIcon({
        html: `<div style="position:relative;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.15))">${pulse}${avatarHtml}${statusDot}</div>`,
        className: '', iconSize: [46, 46], iconAnchor: [23, 23]
    });
}

function _buildInstructorPopup(i) {
    const slots = DB.slots.filter(s => s.instructor_id === i.id).length;
    const stars = i.rating ? Math.round(i.rating) : 0;
    return `<div style="text-align:center;padding:14px 12px;min-width:200px;font-family:'DM Sans',sans-serif">
        <div style="width:56px;height:56px;border-radius:50%;margin:0 auto 10px;overflow:hidden;border:2px solid ${i.is_online?'#22c55e':'#E5E7EB'};box-shadow:0 4px 12px rgba(0,0,0,0.1)">
            ${i.avatar_url ? `<img src="${i.avatar_url}" style="width:100%;height:100%;object-fit:cover">` : `<div style="width:100%;height:100%;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#fff">${(i.name||'?').charAt(0).toUpperCase()}</div>`}
        </div>
        <p style="font-weight:900;font-size:16px;color:#0D0D0D;margin-bottom:3px">${i.name}</p>
        ${i.rating ? `<p style="color:#F59E0B;font-size:14px;margin:2px 0">${'‚òÖ'.repeat(stars)}${'‚òÜ'.repeat(5-stars)} <span style="color:#9CA3AF;font-size:12px">${i.rating.toFixed(1)}</span></p>` : ''}
        <p style="color:#9CA3AF;font-size:12px;margin:4px 0 8px">üìç ${i.location||'Noum√©a'} ¬∑ ${i.experience||0} ans</p>
        <p style="font-weight:900;color:#FF5A1F;font-size:20px;margin:6px 0">${(i.hourly_rate||0).toLocaleString()} <span style="font-size:12px;color:#9CA3AF">XPF/h</span></p>
        <p style="font-size:12px;color:#6B7280;margin-bottom:10px">üìÜ ${slots} cr√©neau${slots>1?'x':''} dispo</p>
        <span style="background:${i.is_online?'#DCFCE7':'#F3F4F6'};color:${i.is_online?'#16A34A':'#6B7280'};padding:4px 14px;border-radius:20px;font-size:11px;font-weight:700;display:inline-block;margin-bottom:12px">${i.is_online?'üü¢ En ligne':'‚ö´ Hors ligne'}</span><br>
        <button onclick="showSlots('${i.id}')" style="background:linear-gradient(135deg,#FF5A1F,#FF7340);color:white;border:none;padding:11px;border-radius:12px;font-weight:700;cursor:pointer;width:100%;font-size:13px;font-family:inherit;box-shadow:0 4px 16px rgba(255,90,31,0.25);transition:all 0.15s">Voir les cr√©neaux</button>
    </div>`;
}

function upsertInstructorMarker(i) {
    if (!map || !i.lat || !i.lng) return;
    const existing = iMarkers.find(m => m.id === i.id);
    if (existing) {
        // Mouvement fluide avec animation CSS transition
        existing.marker.setLatLng([i.lat, i.lng]);
        existing.marker.setIcon(_buildInstructorIcon(i));
        existing.marker.setPopupContent(_buildInstructorPopup(i));
    } else {
        const marker = L.marker([i.lat, i.lng], { icon: _buildInstructorIcon(i) })
            .addTo(map)
            .bindPopup(_buildInstructorPopup(i), { maxWidth: 220, closeButton: true });
        iMarkers.push({ id: i.id, marker });
    }
}

function updateMapMarkers() {
    if (!map) return;
    sortedInstructors().forEach(i => upsertInstructorMarker(i));
}

// ‚îÄ‚îÄ Canal BROADCAST temps-r√©el (quasi-z√©ro latence) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribeBroadcast() {
    if (broadcastChannel) { broadcastChannel.unsubscribe(); broadcastChannel = null; }
    broadcastChannel = sb.channel('instructor-positions', {
        config: { broadcast: { self: false } }
    })
    .on('broadcast', { event: 'position' }, ({ payload }) => {
        if (!payload || !payload.id) return;
        // Mettre √† jour le cache local imm√©diatement
        const idx = DB.instructors.findIndex(i => i.id === payload.id);
        if (idx >= 0) {
            DB.instructors[idx].lat = payload.lat;
            DB.instructors[idx].lng = payload.lng;
            DB.instructors[idx].is_online = true;
            upsertInstructorMarker(DB.instructors[idx]);
        }
    })
    .subscribe();
}

// ‚îÄ‚îÄ Canal POSTGRES pour les mises √† jour durables (statut online, avatar‚Ä¶) ‚îÄ‚îÄ‚îÄ
function subscribeMapRealtime() {
    if (mapRealtimeChannel) { mapRealtimeChannel.unsubscribe(); mapRealtimeChannel = null; }
    mapRealtimeChannel = sb.channel('map-instructors-db')
        .on('postgres_changes', {
            event: 'UPDATE', schema: 'public', table: 'instructors'
        }, (payload) => {
            const idx = DB.instructors.findIndex(i => i.id === payload.new.id);
            if (idx >= 0) {
                DB.instructors[idx] = { ...DB.instructors[idx], ...payload.new };
            } else {
                DB.instructors.push(payload.new);
            }
            upsertInstructorMarker(DB.instructors[idx >= 0 ? idx : DB.instructors.length - 1]);
        })
        .subscribe();
}

function initMap() {
    if (map) { map.remove(); map = null; iMarkers = []; }
    if (mapRealtimeChannel) { mapRealtimeChannel.unsubscribe(); mapRealtimeChannel = null; }
    if (broadcastChannel) { broadcastChannel.unsubscribe(); broadcastChannel = null; }

    map = L.map('map', {
        zoomControl: false,
        attributionControl: false,
        zoomAnimation: true,
        markerZoomAnimation: true
    }).setView([NOUMEA.lat, NOUMEA.lng], 14);

    // Tuiles CartoDB Voyager - design propre et moderne
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd', maxZoom: 20, maxNativeZoom: 18
    }).addTo(map);

    // Contr√¥le zoom discret
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Styles CSS pour la carte
    if (!document.getElementById('map-pulse-style')) {
        const st = document.createElement('style');
        st.id = 'map-pulse-style';
        st.textContent = `
            @keyframes pulse-ring { 0% { transform:scale(1); opacity:0.6; } 100% { transform:scale(2); opacity:0; } }
            .leaflet-marker-icon { transition: transform 0.5s cubic-bezier(0.25,0.46,0.45,0.94) !important; }
            .leaflet-popup-content-wrapper { border-radius:18px !important; box-shadow:0 8px 32px rgba(0,0,0,0.15) !important; border:none !important; }
            .leaflet-popup-tip { box-shadow:0 4px 12px rgba(0,0,0,0.1) !important; }
            .leaflet-popup-close-button { font-size:20px !important; padding:6px 10px !important; color:#999 !important; }
        `;
        document.head.appendChild(st);
    }

    // Placer les marqueurs moniteurs
    sortedInstructors().forEach(i => upsertInstructorMarker(i));

    const isInstructor = currentUser && currentUser.user_type === 'instructor';

    if (isInstructor) {
        if (userMarker && userMarker.getLatLng) {
            userMarker.addTo(map);
        }
    } else {
        // √âl√®ve : tenter de g√©olocaliser pour centrer la carte
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => { if (map) map.setView([pos.coords.latitude, pos.coords.longitude], 14, { animate: true }); },
                () => {},
                { enableHighAccuracy: false, maximumAge: 60000, timeout: 5000 }
            );
        }
    }

    // Souscrire aux deux canaux
    subscribeMapRealtime();
    subscribeBroadcast();
}

window.centerOnMe = () => {
    if (!map) return;
    map.setView([NOUMEA.lat, NOUMEA.lng], 13);
};

window.focusInstructor = (id) => { showInstructorProfile(id); };

window.startTracking = () => {
    if (!navigator.geolocation) { notif('‚ùå GPS indisponible', 'Votre navigateur ne supporte pas le GPS', 'red'); return; }
    if (watchId) navigator.geolocation.clearWatch(watchId);

    const statusEl = document.getElementById('gps-status');
    if (statusEl) { statusEl.textContent = '‚è≥ Activation GPS...'; statusEl.style.color = '#F59E0B'; }

    notif('üì° GPS activ√©', 'Votre position est partag√©e en temps r√©el', 'green');
    // Mettre √† jour visuellement les boutons GPS
    const gpsToggleBtn = document.getElementById('gps-toggle-btn');
    if (gpsToggleBtn) { gpsToggleBtn.textContent = '‚èπ Arr√™ter'; gpsToggleBtn.style.background = '#EF4444'; }
    const gpsIcon = document.getElementById('gps-icon');
    if (gpsIcon) gpsIcon.textContent = 'üü¢';
    const gpsBtnLabel = document.getElementById('gps-btn-label');
    if (gpsBtnLabel) { gpsBtnLabel.textContent = 'GPS actif'; gpsBtnLabel.style.color = '#22C55E'; }

    watchId = navigator.geolocation.watchPosition(
        async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const acc = Math.round(pos.coords.accuracy);
            const now = Date.now();

            // ‚îÄ‚îÄ BROADCAST IMM√âDIAT (< 100ms de latence c√¥t√© autres users) ‚îÄ‚îÄ
            if (broadcastChannel) {
                broadcastChannel.send({
                    type: 'broadcast',
                    event: 'position',
                    payload: { id: currentUser.id, lat, lng }
                });
            }

            // ‚îÄ‚îÄ Mise √† jour carte locale instantan√©e ‚îÄ‚îÄ
            if (map) {
                const icon = L.divIcon({
                    html: `<div style="position:relative">
                        <div style="position:absolute;inset:-6px;border-radius:50%;background:rgba(255,90,31,0.2);animation:pulse-ring 1.5s ease-out infinite"></div>
                        <div style="background:#FF5A1F;width:48px;height:48px;border-radius:50%;border:3px solid white;box-shadow:0 4px 20px rgba(255,90,31,0.5);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:white">üöó</div>
                    </div>`,
                    className: '', iconSize: [48, 48], iconAnchor: [24, 24]
                });
                if (userMarker) {
                    userMarker.setLatLng([lat, lng]);
                    userMarker.setIcon(icon);
                } else {
                    userMarker = L.marker([lat, lng], { icon }).addTo(map);
                    userMarker.bindPopup('<div style="text-align:center;padding:8px"><p style="font-weight:800">üìç Vous</p></div>');
                }
                // Suivre la position sans recentrer violemment (seulement si loin du centre)
                const currentCenter = map.getCenter();
                const dist = map.distance(currentCenter, L.latLng(lat, lng));
                if (dist > 500) map.panTo([lat, lng], { animate: true, duration: 0.8 });
            }

            // ‚îÄ‚îÄ Mise √† jour cache local ‚îÄ‚îÄ
            const idx = DB.instructors.findIndex(i => i.id === currentUser.id);
            if (idx >= 0) { DB.instructors[idx].lat = lat; DB.instructors[idx].lng = lng; DB.instructors[idx].is_online = true; }

            // ‚îÄ‚îÄ Mise √† jour BDD (throttl√©e toutes les 2s pour r√©activit√© maximale) ‚îÄ‚îÄ
            if (now - lastDbUpdate > 2000) {
                lastDbUpdate = now;
                sb.from('instructors').update({ lat, lng, is_online: true }).eq('id', currentUser.id);
            }

            if (statusEl) {
                statusEl.innerHTML = `üü¢ GPS actif &mdash; Pr√©cision : ${acc}m &mdash; ${new Date().toLocaleTimeString()}`;
                statusEl.style.color = acc < 30 ? '#22C55E' : acc < 100 ? '#F59E0B' : '#EF4444';
            }
        },
        err => {
            const msg = err.code === 1 ? 'Permission refus√©e' : err.code === 2 ? 'Position indisponible' : 'D√©lai d√©pass√©';
            if (statusEl) { statusEl.textContent = '‚ùå GPS erreur : ' + msg; statusEl.style.color = '#EF4444'; }
            notif('‚ùå GPS', msg, 'red');
        },
        {
            enableHighAccuracy: true,
            maximumAge: 0,        // Toujours position fra√Æche
            timeout: 5000         // 5s max pour r√©ponse plus rapide
        }
    );
};

window.stopTracking = () => {
    if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    sb.from('instructors').update({ is_online: false }).eq('id', currentUser.id);
    const statusEl = document.getElementById('gps-status');
    if (statusEl) { statusEl.textContent = 'GPS arr√™t√©'; statusEl.style.color = '#9CA3AF'; }
    const gpsToggleBtn = document.getElementById('gps-toggle-btn');
    if (gpsToggleBtn) { gpsToggleBtn.textContent = '‚ñ∂ Activer'; gpsToggleBtn.style.background = '#FF5A1F'; }
    const gpsIcon = document.getElementById('gps-icon');
    if (gpsIcon) gpsIcon.textContent = 'üìç';
    const gpsBtnLabel = document.getElementById('gps-btn-label');
    if (gpsBtnLabel) { gpsBtnLabel.textContent = 'GPS'; gpsBtnLabel.style.color = ''; }
    notif('‚ö´ GPS arr√™t√©', '', 'orange');
};

// ========== V√âRIFICATION T√âL√âPHONE PAR SMS ==========================
// Utilise Supabase Auth OTP (n√©cessite Twilio configur√© dans Supabase)
// Tables : ALTER TABLE users ADD COLUMN IF NOT EXISTS phone_verified BOOLEAN DEFAULT FALSE;
//          ALTER TABLE instructors ADD COLUMN IF NOT EXISTS phone_verified BOOLEAN DEFAULT FALSE;

window.showPhoneVerification = function(mode, prefillPhone) {
    // mode: 'add' | 'change' | 'verify'
    const isInstructor = currentUser.user_type === 'instructor';
    const existingPhone = prefillPhone || (isInstructor
        ? (DB.instructors.find(x=>x.id===currentUser.id)||{}).phone_number
        : currentUser.phone_number) || '';

    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:flex-end;justify-content:center;padding:0';

    function renderStep1() {
        modal.innerHTML = `<div style="background:#fff;border-radius:28px 28px 0 0;padding:28px 24px 32px;width:100%;max-width:480px;box-shadow:0 -8px 40px rgba(0,0,0,0.2)">
            <div style="width:40px;height:4px;background:#E5E7EB;border-radius:2px;margin:0 auto 24px"></div>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <div style="width:48px;height:48px;background:#FFF7ED;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:22px">üì±</div>
                <div>
                    <p style="font-weight:900;font-size:18px;color:#0D0D0D">V√©rification SMS</p>
                    <p style="font-size:13px;color:#9CA3AF">Entrez votre num√©ro pour recevoir un code</p>
                </div>
            </div>
            <div style="height:1px;background:#F0F0F0;margin:20px 0"></div>
            <label style="display:block;font-size:11px;font-weight:700;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Num√©ro de t√©l√©phone</label>
            <div style="display:flex;align-items:center;gap:0;border:1.5px solid #E5E7EB;border-radius:14px;overflow:hidden;margin-bottom:8px">
                <span style="padding:14px 14px;background:#F9FAFB;font-weight:700;font-size:16px;color:#374151;border-right:1px solid #E5E7EB;white-space:nowrap">üá≥üá® +687</span>
                <input id="phone-input" type="tel" inputmode="numeric" maxlength="10"
                    placeholder="XX XX XX"
                    value="${existingPhone.startsWith('+687') ? existingPhone.slice(4).trim() : existingPhone.startsWith('687') ? existingPhone.slice(3) : existingPhone}"
                    style="flex:1;padding:14px 16px;border:none;outline:none;font-size:18px;font-weight:700;color:#0D0D0D;font-family:monospace;background:#fff;letter-spacing:2px">
            </div>
            <p style="font-size:12px;color:#9CA3AF;margin-bottom:20px">Ex : 79 12 34 ‚Üí votre num√©ro NC √† 6 chiffres</p>
            <div id="phone-error" style="display:none;background:#FEF2F2;border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:#DC2626;font-weight:600"></div>
            <button id="send-sms-btn" onclick="sendPhoneOTP()" style="width:100%;padding:16px;background:#FF5A1F;color:#fff;border:none;border-radius:16px;font-weight:900;font-size:16px;cursor:pointer;transition:opacity 0.2s">
                üì§ Envoyer le code SMS
            </button>
            <button onclick="this.closest('.fixed-modal').remove()" style="width:100%;padding:14px;background:none;border:none;color:#9CA3AF;font-size:15px;cursor:pointer;margin-top:8px">Annuler</button>
        </div>`;
        modal.querySelector('.fixed-modal') || (modal.className = 'fixed-modal');
    }

    function renderStep2(fullPhone) {
        modal.innerHTML = `<div style="background:#fff;border-radius:28px 28px 0 0;padding:28px 24px 32px;width:100%;max-width:480px;box-shadow:0 -8px 40px rgba(0,0,0,0.2)">
            <div style="width:40px;height:4px;background:#E5E7EB;border-radius:2px;margin:0 auto 24px"></div>
            <div style="text-align:center;margin-bottom:24px">
                <div style="width:64px;height:64px;background:#FFF7ED;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 12px">üí¨</div>
                <p style="font-weight:900;font-size:18px;color:#0D0D0D">Code envoy√© !</p>
                <p style="font-size:13px;color:#9CA3AF;margin-top:4px">SMS envoy√© au <strong style="color:#0D0D0D;font-family:monospace">${fullPhone}</strong></p>
            </div>
            <label style="display:block;font-size:11px;font-weight:700;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Code √† 6 chiffres</label>
            <input id="otp-input" type="text" inputmode="numeric" maxlength="6" placeholder="_ _ _ _ _ _"
                style="width:100%;padding:16px;border:1.5px solid #E5E7EB;border-radius:14px;outline:none;font-size:28px;font-weight:900;color:#0D0D0D;font-family:monospace;text-align:center;letter-spacing:12px;box-sizing:border-box"
                autocomplete="one-time-code">
            <div id="otp-error" style="display:none;background:#FEF2F2;border-radius:10px;padding:10px 14px;margin-top:10px;font-size:13px;color:#DC2626;font-weight:600"></div>
            <button id="verify-btn" onclick="verifyPhoneOTP('${fullPhone}')" style="width:100%;padding:16px;background:#0D0D0D;color:#fff;border:none;border-radius:16px;font-weight:900;font-size:16px;cursor:pointer;margin-top:16px">
                ‚úÖ Confirmer
            </button>
            <div style="display:flex;justify-content:center;gap:16px;margin-top:12px">
                <button onclick="renderStep1()" style="background:none;border:none;color:#9CA3AF;font-size:13px;cursor:pointer;font-weight:600">‚Üê Changer le num√©ro</button>
                <button onclick="sendPhoneOTP(true)" style="background:none;border:none;color:#FF5A1F;font-size:13px;cursor:pointer;font-weight:700">Renvoyer le SMS</button>
            </div>
        </div>`;
        // Auto-focus et validation auto si 6 chiffres
        setTimeout(()=>{
            const inp = document.getElementById('otp-input');
            if (inp) {
                inp.focus();
                inp.addEventListener('input', ()=>{
                    if (inp.value.replace(/\D/g,'').length === 6) {
                        document.getElementById('verify-btn').click();
                    }
                });
            }
        }, 100);
    }

    // Expose pour les boutons inline
    window._phoneVerifStep1 = renderStep1;
    window._phoneVerifStep2 = renderStep2;
    window._phoneModal = modal;

    window.sendPhoneOTP = async function(resend) {
        const rawInput = document.getElementById('phone-input') ?
            document.getElementById('phone-input').value.replace(/\s/g,'') :
            existingPhone.replace('+687','').replace(/\s/g,'');
        const digits = rawInput.replace(/\D/g,'');
        const fullPhone = '+687' + digits;
        const errEl = document.getElementById('phone-error');

        if (digits.length < 6) {
            if (errEl) { errEl.style.display='block'; errEl.textContent='‚ùå Num√©ro invalide ‚Äî 6 chiffres minimum'; }
            return;
        }

        const btn = document.getElementById('send-sms-btn');
        if (btn) { btn.textContent = '‚è≥ Envoi...'; btn.disabled = true; }

        try {
            // Supabase Auth OTP phone ‚Äî envoie un SMS via Twilio
            const { error } = await sb.auth.signInWithOtp({
                phone: fullPhone,
                options: { shouldCreateUser: false }
            });

            if (error) {
                // Fallback: essayer sans shouldCreateUser: false (ancien Supabase)
                const { error: e2 } = await sb.auth.signInWithOtp({ phone: fullPhone });
                if (e2) {
                    if (errEl) { errEl.style.display='block'; errEl.textContent='‚ùå ' + (e2.message || 'Erreur envoi SMS'); }
                    if (btn) { btn.textContent = 'üì§ Envoyer le code SMS'; btn.disabled = false; }
                    return;
                }
            }
            renderStep2(fullPhone);
        } catch(e) {
            if (errEl) { errEl.style.display='block'; errEl.textContent='‚ùå Erreur r√©seau: ' + e.message; }
            if (btn) { btn.textContent = 'üì§ Envoyer le code SMS'; btn.disabled = false; }
        }
    };

    window.verifyPhoneOTP = async function(fullPhone) {
        const otp = (document.getElementById('otp-input').value || '').replace(/\D/g,'').trim();
        const errEl = document.getElementById('otp-error');
        if (otp.length !== 6) {
            if (errEl) { errEl.style.display='block'; errEl.textContent='‚ùå Le code doit contenir 6 chiffres'; }
            return;
        }

        const btn = document.getElementById('verify-btn');
        if (btn) { btn.textContent = '‚è≥ V√©rification...'; btn.disabled = true; }

        try {
            // V√©rifier le code OTP via Supabase
            const { data, error } = await sb.auth.verifyOtp({
                phone: fullPhone,
                token: otp,
                type: 'sms'
            });

            if (error) {
                if (errEl) { errEl.style.display='block'; errEl.textContent='‚ùå Code incorrect ou expir√© ‚Äî r√©essayez'; }
                if (btn) { btn.textContent = '‚úÖ Confirmer'; btn.disabled = false; }
                // Shake animation
                const inp = document.getElementById('otp-input');
                if (inp) { inp.style.borderColor='#EF4444'; inp.style.background='#FEF2F2'; setTimeout(()=>{inp.style.borderColor='#E5E7EB';inp.style.background='#fff';},1500); }
                return;
            }

            // ‚úÖ OTP valid√© ‚Äî sauvegarder le num√©ro en base
            const isInst = currentUser.user_type === 'instructor';
            if (isInst) {
                await sb.from('instructors').update({ phone_number: fullPhone, phone_verified: true }).eq('id', currentUser.id);
                const idx = DB.instructors.findIndex(i=>i.id===currentUser.id);
                if (idx>=0) { DB.instructors[idx].phone_number = fullPhone; DB.instructors[idx].phone_verified = true; }
            }
            // Toujours sauvegarder dans users aussi
            await sb.from('users').update({ phone_number: fullPhone, phone_verified: true }).eq('id', currentUser.id);
            currentUser.phone_number = fullPhone;
            currentUser.phone_verified = true;

            modal.remove();
            notif('‚úÖ Num√©ro v√©rifi√© !', fullPhone + ' ‚Äî confirm√© par SMS', 'green');
            render();
        } catch(e) {
            if (errEl) { errEl.style.display='block'; errEl.textContent='‚ùå Erreur: ' + e.message; }
            if (btn) { btn.textContent = '‚úÖ Confirmer'; btn.disabled = false; }
        }
    };

    renderStep1();
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });

    // Focus auto sur l'input t√©l√©phone
    setTimeout(()=>{ const inp = document.getElementById('phone-input'); if(inp) inp.focus(); }, 100);
};

// ========== NAVIGATION ==========
window.showView=async (v)=>{currentView=v;render();};
window.switchTab=(t)=>{currentTab=t;render();if(t==='settings')setTimeout(()=>loadReferralData(),200);};

window.logout=async ()=>{
    if(watchId)navigator.geolocation.clearWatch(watchId);
    if(broadcastChannel){broadcastChannel.unsubscribe();broadcastChannel=null;}
    if(currentUser && currentUser.user_type==='instructor'){
        await sb.from('instructors').update({is_online:false}).eq('id',currentUser.id);
    }
    await sb.auth.signOut();
    currentUser=null; currentView='home'; render();
};

window.toggleSignup=(type)=>{
    const s=document.getElementById('name-field').style.display==='none';
    document.getElementById('name-field').style.display=s?'block':'none';
    document.getElementById('name').required=s;
    // Afficher/cacher le checkbox CGU
    const legalCheck = document.getElementById('legal-check');
    if (legalCheck) legalCheck.style.display=s?'block':'none';
    const legalInput = document.getElementById('legal-accept');
    if (legalInput && !s) legalInput.checked = false;
    document.getElementById('form-title').textContent=s?'Cr√©er un compte':'Se connecter';
    document.getElementById('submit-text').textContent=s?"S'inscrire":'Se connecter';
    document.getElementById('toggle-text').textContent=s?'D√©j√† un compte ?':"Pas de compte ?";
    const fpBtn=document.getElementById('forgot-pwd-btn');
    if(fpBtn) fpBtn.style.display=s?'none':'inline-block';
};

window.forgotPassword = async () => {
    const email = document.getElementById('email')?.value?.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        notif('‚ö†Ô∏è Saisissez votre email', 'Remplissez le champ email avant de cliquer', 'orange');
        const inp = document.getElementById('email');
        if (inp) { inp.style.border = '2px solid #FF5A1F'; inp.focus(); setTimeout(() => inp.style.border = '', 2000); }
        return;
    }
    const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/app.html?reset=true'
    });
    if (error) {
        notif('‚ùå Erreur', error.message, 'red');
    } else {
        notif('üìß Email envoy√© !', 'V√©rifiez votre bo√Æte mail pour r√©initialiser votre mot de passe', 'green');
    }
};

function setupLoginForm(type) {
    document.getElementById('login-form').onsubmit=async function(e){
        e.preventDefault();
        const email=document.getElementById('email').value;
        const password=document.getElementById('password').value;
        const isSignup=document.getElementById('name-field').style.display!=='none';
        if(isSignup){
            const accepted=document.getElementById('legal-accept')?.checked;
            if(!accepted){
                notif('‚ùå CGU obligatoires','Vous devez accepter les CGU et la politique de confidentialit√©','red');
                const lc=document.getElementById('legal-check');
                if(lc){lc.style.border='2px solid #DC2626';setTimeout(()=>lc.style.border='1px solid #FED7AA',2000);}
                return;
            }
        }
        const btn=document.getElementById('submit-text');
        btn.textContent='‚è≥ Chargement...';
        if(isSignup){
            await signup(email,password,document.getElementById('name').value,type);
        }else{
            await login(email,password,type);
        }
        if(document.getElementById('submit-text'))btn.textContent=isSignup?"S'inscrire":'Se connecter';
    };
}

document.addEventListener('submit', async function(e){
    if(e.target.id==='settings-form'){
        e.preventDefault();
        await sb.from('instructors').update({
            location: document.getElementById('s-loc').value,
            phone_number: document.getElementById('s-phone').value,
            hourly_rate: parseInt(document.getElementById('s-rate').value),
            experience: parseInt(document.getElementById('s-exp').value)
        }).eq('id', currentUser.id);
        await loadData();
        notif('‚úÖ Profil sauvegard√©','','green');
    }
});


// ========== ADMIN DASHBOARD ==========
let adminData = { users: [], instructors: [], bookings: [], slots: [] };
let adminTab = 'overview';

async function loadAdminData() {
    // Afficher un loading
    const app = document.getElementById('app');
    const existingContent = app?.innerHTML || '';
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'admin-loading';
    loadingOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;height:3px;background:linear-gradient(90deg,#FF5A1F,#FF7340,#FF5A1F);background-size:200%;animation:shimmer 1s infinite linear';
    document.body.appendChild(loadingOverlay);

    try {
    // Essayer RPC admin (bypass RLS) ‚Äî timeout rapide si pas dispo
    let usersData = null;
    let bookingsData = null;

    const rpcResult = await sb.rpc('admin_get_all_users');
    if (!rpcResult.error && rpcResult.data) {
        usersData = rpcResult.data;
        console.log('[ADMIN] RPC OK:', usersData.length, 'users');
    } else {
        const u = await sb.from('users').select('*').order('created_at', { ascending: false });
        usersData = u.data || [];
    }

    const rpcBookings = await sb.rpc('admin_get_all_bookings');
    if (!rpcBookings.error && rpcBookings.data) {
        bookingsData = rpcBookings.data;
    } else {
        const b = await sb.from('bookings').select('*').order('created_at', { ascending: false });
        bookingsData = b.data || [];
    }

    const [i, s] = await Promise.all([
        sb.from('instructors').select('*').order('created_at', { ascending: false }),
        sb.from('slots').select('*').order('date', { ascending: false })
    ]);

    adminData.users        = usersData;
    adminData.instructors  = i.data || [];
    adminData.bookings     = bookingsData;
    adminData.slots        = s.data || [];
    adminData._rlsWarning  = usersData.length <= 1;

    if (app) app.innerHTML = AdminDashboard();
    if (adminTab === 'map') setTimeout(() => initMap(), 100);
    } finally {
        const lo = document.getElementById('admin-loading');
        if (lo) lo.remove();
    }
}
window.loadAdminData = loadAdminData;

function AdminDashboard() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];

    // ‚îÄ‚îÄ M√©triques globales ‚îÄ‚îÄ
    const totalUsers       = adminData.users.length;
    const totalStudents    = adminData.users.filter(u => u.user_type === 'student').length;
    const totalInstructors = adminData.instructors.length;
    const onlineInst       = adminData.instructors.filter(i => i.is_online).length;
    const verifiedInst     = adminData.instructors.filter(i => i.verified).length;
    const totalBookings    = adminData.bookings.length;
    const confirmedBook    = adminData.bookings.filter(b => b.status === 'confirmed').length;
    const cancelledBook    = adminData.bookings.filter(b => b.status === 'cancelled').length;
    const pendingBook      = adminData.bookings.filter(b => b.status === 'pending').length;
    const totalRevenue     = adminData.bookings.filter(b => b.status === 'confirmed' && b.payment_status === 'paid').reduce((s,b) => s + (b.amount||0), 0);
    const totalCommission  = adminData.bookings.filter(b => b.status === 'confirmed' && b.payment_status === 'paid').reduce((s,b) => s + (b.commission||0), 0);
    const availableSlots   = adminData.slots.filter(s => s.available).length;
    const todayBookings    = adminData.bookings.filter(b => b.date === today).length;
    const recentUsers      = adminData.users.filter(u => u.created_at && new Date(u.created_at) > new Date(Date.now() - 7*24*60*60*1000)).length;

    const pendingApprovals = adminData.instructors.filter(i => i.approval_status === 'pending_review').length;

    const tabs = [
        { id: 'overview',     icon: 'üìä', label: 'Vue d\'ensemble' },
        { id: 'approvals',    icon: 'üì®', label: 'Approbations' + (pendingApprovals > 0 ? ' üî¥' : '') },
        { id: 'bookings',     icon: 'üìã', label: `R√©servations ${pendingBook > 0 ? 'üî¥' : ''}` },
        { id: 'students',     icon: 'üë®‚Äçüéì', label: '√âl√®ves' },
        { id: 'instructors',  icon: 'üöó', label: 'Moniteurs' },
        { id: 'revenue',      icon: 'üí∞', label: 'Revenus' },
        { id: 'map',          icon: 'üó∫Ô∏è', label: 'Carte live' },
        { id: 'danger',       icon: '‚ö†Ô∏è', label: 'Admin' }
    ];

    return `<div style="min-height:100vh;background:#0A0A0A;color:#fff;font-family:'DM Sans',sans-serif">

        <!-- Header Admin -->
        <div style="background:linear-gradient(135deg,#0D0D0D,#1A0A00);border-bottom:1px solid rgba(255,90,31,0.2);padding:0 24px;position:sticky;top:0;z-index:50">
            <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px">
                <div style="display:flex;align-items:center;gap:12px">
                    <div style="width:36px;height:36px;background:#FF5A1F;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px">üõ°Ô∏è</div>
                    <div>
                        <p style="font-weight:900;font-size:16px;color:#fff">DriveConnect Admin</p>
                        <p style="font-size:11px;color:#FF5A1F;font-weight:600">Acc√®s restreint ‚Äî Victor Goralski</p>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:12px">
                    <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:20px;padding:6px 14px;display:flex;align-items:center;gap:6px">
                        <div style="width:7px;height:7px;border-radius:50%;background:#22C55E;animation:pulse-ring 2s infinite"></div>
                        <span style="font-size:12px;font-weight:700;color:#22C55E">${onlineInst} moniteur${onlineInst>1?'s':''} en ligne</span>
                    </div>
                    <button onclick="this.textContent='‚è≥ Chargement...';this.disabled=true;loadAdminData()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:10px;padding:8px 14px;font-size:13px;font-weight:600;cursor:pointer">üîÑ Actualiser</button>
                    <button onclick="logout()" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#EF4444;border-radius:10px;padding:8px 14px;font-size:13px;font-weight:600;cursor:pointer">D√©connexion</button>
                </div>
            </div>
        </div>

        <div style="max-width:1200px;margin:0 auto;padding:24px">

            <!-- KPIs top -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px">
                ${[
                    { icon:'üë•', val: totalUsers,       label:'Utilisateurs',    sub:`+${recentUsers} cette semaine`,  color:'#60A5FA' },
                    { icon:'üë®‚Äçüéì', val: totalStudents,   label:'√âl√®ves',          sub:`${totalStudents} inscrits`,      color:'#818CF8' },
                    { icon:'üöó', val: totalInstructors, label:'Moniteurs',       sub:`${onlineInst} en ligne`,         color:'#FF5A1F' },
                    { icon:'üìã', val: totalBookings,    label:'R√©servations',    sub:`${confirmedBook} confirm√©es`,    color:'#34D399' },
                    { icon:'üí∞', val: totalRevenue.toLocaleString()+' XPF', label:'Chiffre d\'affaires', sub:`${totalCommission.toLocaleString()} XPF commission`, color:'#FBBF24' },
                    { icon:'üìÖ', val: availableSlots,   label:'Cr√©neaux dispo',  sub:`${todayBookings} cours aujourd\'hui`, color:'#F472B6' },
                ].map(k => `
                <div style="background:#111;border:1px solid #1F1F1F;border-radius:18px;padding:18px;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-10px;right:-10px;font-size:48px;opacity:0.06">${k.icon}</div>
                    <p style="font-size:11px;color:#6B7280;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">${k.label}</p>
                    <p style="font-size:26px;font-weight:900;color:${k.color};margin-bottom:4px">${k.val}</p>
                    <p style="font-size:11px;color:#4B5563">${k.sub}</p>
                </div>`).join('')}
            </div>

            <!-- Onglets -->
            <div style="display:flex;gap:4px;background:#111;border-radius:16px;padding:6px;margin-bottom:24px;overflow-x:auto;border:1px solid #1F1F1F">
                ${tabs.map(t => `
                <button onclick="switchAdminTab('${t.id}')"
                    style="white-space:nowrap;padding:10px 18px;border-radius:12px;border:none;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;
                    background:${adminTab===t.id?'#FF5A1F':'transparent'};
                    color:${adminTab===t.id?'#fff':'#6B7280'}">
                    ${t.icon} ${t.label}
                </button>`).join('')}
            </div>

            <!-- Contenu onglet -->
            <div id="admin-content">
                ${getAdminTabContent(adminTab, { totalRevenue, totalCommission, confirmedBook, cancelledBook, pendingBook, today })}
            </div>
        </div>
    </div>`;
}

function getAdminTabContent(tab, stats) {
    const now = new Date();

    // ‚îÄ‚îÄ APPROBATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'approvals') {
        const pendingInstructors = adminData.instructors.filter(i => i.approval_status === 'pending_review');
        const rejectedInstructors = adminData.instructors.filter(i => i.approval_status === 'rejected');
        const pendingDocsInstructors = adminData.instructors.filter(i => i.approval_status === 'pending_documents' || !i.approval_status);

        return `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px">
            <div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:18px;padding:18px;text-align:center">
                <p style="font-size:32px;font-weight:900;color:#FBBF24">${pendingInstructors.length}</p>
                <p style="font-size:12px;color:#92400E">En attente de validation</p>
            </div>
            <div style="background:#111;border:1px solid #1F1F1F;border-radius:18px;padding:18px;text-align:center">
                <p style="font-size:32px;font-weight:900;color:#6B7280">${pendingDocsInstructors.length}</p>
                <p style="font-size:12px;color:#4B5563">Sans documents</p>
            </div>
            <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:18px;padding:18px;text-align:center">
                <p style="font-size:32px;font-weight:900;color:#EF4444">${rejectedInstructors.length}</p>
                <p style="font-size:12px;color:#7F1D1D">Refus√©s</p>
            </div>
        </div>

        ${pendingInstructors.length === 0 ?
        '<div style="text-align:center;padding:48px;background:#111;border:1px solid #1F1F1F;border-radius:20px"><p style="font-size:48px;margin-bottom:12px">‚úÖ</p><p style="color:#6B7280;font-size:16px;font-weight:600">Aucune demande en attente</p></div>'
        :
        '<div style="display:flex;flex-direction:column;gap:16px">' + pendingInstructors.map(inst => {
            const docs = inst.documents_urls || [];
            const user = adminData.users.find(u => u.id === inst.id || u.id === inst.user_id);
            return `<div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;padding:24px">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                    <div>
                        <p style="font-weight:900;font-size:18px;color:#fff">${inst.name||'?'}</p>
                        <p style="font-size:13px;color:#6B7280">${user?.email||inst.email||'?'}</p>
                        <p style="font-size:11px;color:#4B5563;margin-top:4px">Inscrit le ${user?.created_at ? new Date(user.created_at).toLocaleDateString('fr-FR') : '?'}</p>
                    </div>
                    <span style="background:rgba(251,191,36,0.15);color:#FBBF24;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700">‚è≥ En attente</span>
                </div>
                <div style="margin-bottom:16px">
                    <p style="font-size:11px;font-weight:700;color:#6B7280;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Documents fournis (${docs.length})</p>
                    <div style="display:flex;flex-direction:column;gap:8px">
                    ${docs.map(d => `<div style="display:flex;align-items:center;gap:12px;background:#1A1A1A;border-radius:14px;padding:12px 16px">
                        <span style="font-size:20px">${d.doc_type==='autorisation'?'ü™™':d.doc_type==='identite'?'üÜî':'üõ°Ô∏è'}</span>
                        <div style="flex:1">
                            <p style="font-size:13px;font-weight:700;color:#fff">${d.doc_type==='autorisation'?'Autorisation d&#39;enseigner':d.doc_type==='identite'?'Pi√®ce d&#39;identit\u00e9':'Assurance pro'}</p>
                            <p style="font-size:11px;color:#4B5563">${d.filename||'document'}</p>
                        </div>
                        <a href="${d.url}" target="_blank" style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);color:#60A5FA;padding:6px 14px;border-radius:10px;font-size:12px;font-weight:700;text-decoration:none">üëÅÔ∏è Voir</a>
                    </div>`).join('')}
                    ${docs.length === 0 ? '<p style="color:#4B5563;font-style:italic">Aucun document</p>' : ''}
                    </div>
                </div>
                <div style="display:flex;gap:12px">
                    <button onclick="adminApproveInstructor('${inst.id}')" style="flex:1;padding:14px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#22C55E;border-radius:14px;font-weight:800;font-size:14px;cursor:pointer">‚úÖ Accepter</button>
                    <button onclick="adminRejectInstructorModal('${inst.id}','${(inst.name||'').replace(/'/g,'')}')" style="flex:1;padding:14px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#EF4444;border-radius:14px;font-weight:800;font-size:14px;cursor:pointer">‚ùå Refuser</button>
                </div>
            </div>`;
        }).join('') + '</div>'}

        ${rejectedInstructors.length > 0 ? `
        <div style="margin-top:32px">
            <p style="font-weight:800;font-size:15px;color:#EF4444;margin-bottom:12px">Derniers refus√©s</p>
            <div style="display:flex;flex-direction:column;gap:8px">
            ${rejectedInstructors.slice(0,5).map(inst => `
            <div style="background:#111;border:1px solid #1F1F1F;border-radius:14px;padding:14px;display:flex;justify-content:space-between;align-items:center">
                <div>
                    <p style="font-weight:700;font-size:13px;color:#fff">${inst.name||'?'}</p>
                    <p style="font-size:12px;color:#EF4444;margin-top:2px">${inst.rejection_reason||'Aucun motif'}</p>
                </div>
                <span style="background:rgba(239,68,68,0.1);color:#EF4444;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700">Refus√©</span>
            </div>`).join('')}
            </div>
        </div>` : ''}`;
    }

    // ‚îÄ‚îÄ VUE D'ENSEMBLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'overview') {
        const recent = adminData.bookings.slice(0, 8);
        const alerts = [];
        if (stats.pendingBook > 0) alerts.push({ type: 'warn', msg: `${stats.pendingBook} r√©servation(s) en attente de confirmation` });
        adminData.instructors.filter(i => i.penalty_until && new Date(i.penalty_until) > now).forEach(i => alerts.push({ type: 'danger', msg: `Moniteur ${i.name||'?'} p√©nalis√© jusqu\'au ${i.penalty_until?.split('T')[0]}` }));
        adminData.instructors.filter(i => !i.verified).forEach(i => alerts.push({ type: 'info', msg: `Moniteur ${i.name||'?'} non v√©rifi√© ‚Äî en attente de validation` }));

        return `
        ${alerts.length > 0 ? `
        <div style="margin-bottom:24px;display:flex;flex-direction:column;gap:8px">
            <p style="font-weight:800;font-size:15px;color:#fff;margin-bottom:8px">üö® Alertes (${alerts.length})</p>
            ${alerts.map(a => `
            <div style="background:${a.type==='danger'?'rgba(239,68,68,0.08)':a.type==='warn'?'rgba(251,191,36,0.08)':'rgba(96,165,250,0.08)'};border:1px solid ${a.type==='danger'?'rgba(239,68,68,0.2)':a.type==='warn'?'rgba(251,191,36,0.2)':'rgba(96,165,250,0.2)'};border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px">
                <span>${a.type==='danger'?'üî¥':a.type==='warn'?'üü°':'üîµ'}</span>
                <span style="font-size:13px;color:#E5E7EB">${a.msg}</span>
            </div>`).join('')}
        </div>` : ''}

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <!-- Derni√®res r√©servations -->
            <div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;padding:20px">
                <p style="font-weight:800;font-size:15px;margin-bottom:16px">üìã Derni√®res r√©servations</p>
                <div style="display:flex;flex-direction:column;gap:8px">
                ${recent.length === 0 ? '<p style="color:#4B5563;text-align:center;padding:20px">Aucune r√©servation</p>' :
                recent.map(b => `
                <div style="background:#1A1A1A;border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <p style="font-weight:700;font-size:13px">${b.student_name||'?'} ‚Üí ${b.instructor_name||'?'}</p>
                        <p style="font-size:11px;color:#6B7280;margin-top:2px">üìÖ ${b.date} ¬∑ ${(b.amount||0).toLocaleString()} XPF</p>
                    </div>
                    <span style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;
                        background:${b.status==='confirmed'?'rgba(52,211,153,0.1)':b.status==='cancelled'?'rgba(239,68,68,0.1)':'rgba(251,191,36,0.1)'};
                        color:${b.status==='confirmed'?'#34D399':b.status==='cancelled'?'#EF4444':'#FBBF24'}">
                        ${b.status==='confirmed'?'‚úÖ Confirm√©':b.status==='cancelled'?'‚ùå Annul√©':'‚è≥ En attente'}
                    </span>
                </div>`).join('')}
                </div>
            </div>

            <!-- Moniteurs actifs + Stats -->
            <div style="display:flex;flex-direction:column;gap:16px">
                <div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;padding:20px">
                    <p style="font-weight:800;font-size:15px;margin-bottom:16px">üöó Moniteurs en ligne maintenant</p>
                    ${adminData.instructors.filter(i => i.is_online).length === 0 ?
                    '<p style="color:#4B5563;text-align:center;padding:16px">Aucun moniteur en ligne</p>' :
                    adminData.instructors.filter(i => i.is_online).map(i => `
                    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:#1A1A1A;border-radius:12px;margin-bottom:8px">
                        <div style="width:36px;height:36px;border-radius:10px;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;flex-shrink:0">
                            ${(i.name||'?').charAt(0)}
                        </div>
                        <div style="flex:1">
                            <p style="font-weight:700;font-size:13px">${i.name||'?'}</p>
                            <p style="font-size:11px;color:#6B7280">üìç ${i.location||'?'} ¬∑ ‚≠ê ${i.rating||0}</p>
                        </div>
                        <div style="width:8px;height:8px;border-radius:50%;background:#22C55E"></div>
                    </div>`).join('')}
                </div>

                <div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;padding:20px">
                    <p style="font-weight:800;font-size:15px;margin-bottom:16px">üìä Statuts r√©servations</p>
                    ${[
                        { label: 'Confirm√©es', val: stats.confirmedBook, color: '#34D399', pct: Math.round(stats.confirmedBook / Math.max(adminData.bookings.length,1) * 100) },
                        { label: 'En attente', val: stats.pendingBook,   color: '#FBBF24', pct: Math.round(stats.pendingBook / Math.max(adminData.bookings.length,1) * 100) },
                        { label: 'Annul√©es',   val: stats.cancelledBook, color: '#EF4444', pct: Math.round(stats.cancelledBook / Math.max(adminData.bookings.length,1) * 100) },
                    ].map(s => `
                    <div style="margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                            <span style="font-size:12px;color:#9CA3AF">${s.label}</span>
                            <span style="font-size:12px;font-weight:700;color:${s.color}">${s.val} (${s.pct}%)</span>
                        </div>
                        <div style="background:#1F1F1F;border-radius:4px;height:6px">
                            <div style="background:${s.color};height:6px;border-radius:4px;width:${s.pct}%;transition:width 0.5s"></div>
                        </div>
                    </div>`).join('')}
                </div>
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ R√âSERVATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'bookings') {
        const pending   = adminData.bookings.filter(b => b.status === 'pending');
        const confirmed = adminData.bookings.filter(b => b.status === 'confirmed');
        const cancelled = adminData.bookings.filter(b => b.status === 'cancelled');

        const bookingRow = (b, showActions) => `
        <div style="background:#1A1A1A;border-radius:14px;padding:16px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                    <p style="font-weight:800;font-size:14px">${b.student_name||'?'}</p>
                    <span style="color:#6B7280;font-size:12px">‚Üí</span>
                    <p style="font-weight:700;font-size:14px;color:#FF5A1F">${b.instructor_name||'?'}</p>
                </div>
                <p style="font-size:12px;color:#6B7280">üìÖ ${b.date} √† ${b.time||'?'} ¬∑ ‚è±Ô∏è ${b.duration||1}h ¬∑ üí∞ ${(b.amount||0).toLocaleString()} XPF</p>
                ${b.paypal_order_id ? `<p style="font-size:10px;color:#4B5563;margin-top:2px">PayPal: ${b.paypal_order_id}</p>` : ''}
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
                <span style="padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;
                    background:${b.payment_status==='paid'?'rgba(52,211,153,0.1)':'rgba(251,191,36,0.1)'};
                    color:${b.payment_status==='paid'?'#34D399':'#FBBF24'}">
                    ${b.payment_status==='paid'?'üí≥ Pay√©':'‚è≥ Non pay√©'}
                </span>
                ${showActions ? `
                <button onclick="adminForceCancel('${b.id}')" style="padding:6px 12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#EF4444;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer">Annuler</button>
                                <button onclick="adminSetDispute('${b.id}')" style="padding:6px 12px;background:rgba(147,51,234,0.1);border:1px solid rgba(147,51,234,0.2);color:#9333EA;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer">‚ö†Ô∏è Litige</button>
                ` : ''}
            </div>
        </div>`;

        return `
        <div style="display:flex;flex-direction:column;gap:24px">
            ${pending.length > 0 ? `
            <div>
                <p style="font-weight:800;font-size:16px;color:#FBBF24;margin-bottom:12px">‚è≥ En attente (${pending.length})</p>
                <div style="display:flex;flex-direction:column;gap:8px">${pending.map(b => bookingRow(b, true)).join('')}</div>
            </div>` : ''}

            <div>
                <p style="font-weight:800;font-size:16px;color:#34D399;margin-bottom:12px">‚úÖ Confirm√©es (${confirmed.length})</p>
                <div style="display:flex;flex-direction:column;gap:8px">${confirmed.length ? confirmed.map(b => bookingRow(b, true)).join('') : '<p style="color:#4B5563;padding:20px;text-align:center">Aucune</p>'}</div>
            </div>

            <div>
                <p style="font-weight:800;font-size:16px;color:#EF4444;margin-bottom:12px">‚ùå Annul√©es (${cancelled.length})</p>
                <div style="display:flex;flex-direction:column;gap:8px">${cancelled.length ? cancelled.slice(0,10).map(b => bookingRow(b, false)).join('') : '<p style="color:#4B5563;padding:20px;text-align:center">Aucune</p>'}</div>
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ √âL√àVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'students') {
        const students = adminData.users.filter(u => u.user_type === 'student');
        return `
        <div>
            ${adminData._rlsWarning ? `
            <div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.25);border-radius:14px;padding:16px;margin-bottom:16px">
                <p style="color:#FBBF24;font-weight:800;font-size:14px;margin-bottom:6px">‚ö†Ô∏è Acc√®s limit√© ‚Äî √âl√®ves non visibles</p>
                <p style="color:#9CA3AF;font-size:12px;line-height:1.6;margin-bottom:10px">Les politiques RLS de Supabase bloquent l'acc√®s aux donn√©es des autres utilisateurs. Copiez et ex√©cutez ce SQL dans <strong style="color:#fff">Supabase ‚Üí SQL Editor</strong> :</p>
                <div style="background:#111;border-radius:10px;padding:12px;font-family:monospace;font-size:11px;color:#A5B4FC;word-break:break-all;line-height:1.6;white-space:pre-wrap;max-height:200px;overflow-y:auto">-- Fonction admin pour voir tous les users
CREATE OR REPLACE FUNCTION admin_get_all_users()
RETURNS SETOF users LANGUAGE sql SECURITY DEFINER AS $$
  SELECT * FROM users ORDER BY created_at DESC;
$$;

-- Fonction admin pour voir toutes les r√©servations
CREATE OR REPLACE FUNCTION admin_get_all_bookings()
RETURNS SETOF bookings LANGUAGE sql SECURITY DEFINER AS $$
  SELECT * FROM bookings ORDER BY created_at DESC;
$$;

-- Fonction admin pour reset GPS
CREATE OR REPLACE FUNCTION admin_reset_all_gps()
RETURNS void LANGUAGE sql SECURITY DEFINER AS $$
  UPDATE instructors SET is_online = false;
$$;

-- Accorder les droits
GRANT EXECUTE ON FUNCTION admin_get_all_users TO authenticated;
GRANT EXECUTE ON FUNCTION admin_get_all_bookings TO authenticated;
GRANT EXECUTE ON FUNCTION admin_reset_all_gps TO authenticated;</div>
                <button onclick="navigator.clipboard.writeText(document.querySelector('[style*=pre-wrap]').textContent);this.textContent='‚úÖ Copi√© !';setTimeout(()=>this.textContent='üìã Copier le SQL',2000)" style="margin-top:10px;padding:8px 14px;background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);color:#FBBF24;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer">üìã Copier le SQL</button>
            </div>` : ''}
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <p style="font-weight:800;font-size:16px">${students.length} √©l√®ve${students.length>1?'s':''} inscrits</p>
                <div style="display:flex;gap:8px;align-items:center">
                    <button onclick="this.textContent='‚è≥...';this.disabled=true;loadAdminData()" style="padding:8px 14px;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.2);color:#60A5FA;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer">üîÑ Actualiser</button>
                    <input id="search-students" oninput="adminFilter('students')" placeholder="üîç Rechercher..." 
                        style="background:#1A1A1A;border:1px solid #2A2A2A;border-radius:10px;padding:8px 14px;color:#fff;font-size:13px;outline:none">
                </div>
            </div>
            <div id="students-list" style="display:flex;flex-direction:column;gap:8px">
            ${students.map(u => {
                const myBookings = adminData.bookings.filter(b => b.student_id === u.id);
                const spent = myBookings.filter(b => b.payment_status === 'paid').reduce((s,b) => s+(b.amount||0), 0);
                return `
                <div style="background:#1A1A1A;border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px">
                    <div style="width:44px;height:44px;border-radius:12px;background:#1D4ED8;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;flex-shrink:0;color:#fff">
                        ${(u.name||'?').charAt(0).toUpperCase()}
                    </div>
                    <div style="flex:1;min-width:0">
                        <p style="font-weight:800;font-size:14px">${u.name||'?'} ${u.phone_verified?'üì±':''}${u.is_admin?'üõ°Ô∏è':''}</p>
                        <p style="font-size:12px;color:#6B7280;margin-top:1px">${u.email}</p>
                        ${u.phone_number ? `<p style="font-size:11px;color:#4B5563">${u.phone_number}</p>` : ''}
                    </div>
                    <div style="text-align:right;flex-shrink:0">
                        <p style="font-size:13px;font-weight:700;color:#FBBF24">${spent.toLocaleString()} XPF</p>
                        <p style="font-size:11px;color:#6B7280">${myBookings.length} r√©servation${myBookings.length>1?'s':''}</p>
                        <p style="font-size:10px;color:#4B5563">${u.created_at?.split('T')[0]||'?'}</p>
                    </div>
                    <button onclick="adminDeleteUser('${u.id}')" style="padding:6px 10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#EF4444;border-radius:8px;font-size:12px;cursor:pointer;flex-shrink:0">üóëÔ∏è</button>
                </div>`}).join('') || '<p style="color:#4B5563;text-align:center;padding:40px">Aucun √©l√®ve trouv√©</p>'}
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ MONITEURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'instructors') {
        return `
        <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <p style="font-weight:800;font-size:16px">${adminData.instructors.length} moniteur${adminData.instructors.length>1?'s':''}</p>
                <input id="search-instructors" oninput="adminFilter('instructors')" placeholder="üîç Rechercher..."
                    style="background:#1A1A1A;border:1px solid #2A2A2A;border-radius:10px;padding:8px 14px;color:#fff;font-size:13px;outline:none">
            </div>
            <div id="instructors-list" style="display:flex;flex-direction:column;gap:10px">
            ${adminData.instructors.map(i => {
                const myBookings = adminData.bookings.filter(b => b.instructor_id === i.id);
                const revenue = myBookings.filter(b => b.status === 'confirmed' && b.payment_status === 'paid').reduce((s,b) => s+(b.net||0), 0);
                const penalised = i.penalty_until && new Date(i.penalty_until) > now;
                return `
                <div style="background:#1A1A1A;border-radius:16px;padding:16px;border:1px solid ${penalised?'rgba(239,68,68,0.3)':i.is_online?'rgba(34,197,94,0.15)':'#222'}">
                    <div style="display:flex;align-items:flex-start;gap:14px">
                        <div style="width:50px;height:50px;border-radius:14px;background:#FF5A1F;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px;flex-shrink:0;color:#fff;overflow:hidden">
                            ${i.avatar_url ? `<img src="${i.avatar_url}" style="width:100%;height:100%;object-fit:cover">` : (i.name||'?').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px">
                                <p style="font-weight:900;font-size:15px">${i.name||'?'}</p>
                                <span style="padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;background:${i.is_online?'rgba(34,197,94,0.1)':'rgba(107,114,128,0.1)'};color:${i.is_online?'#34D399':'#6B7280'}">${i.is_online?'üü¢ En ligne':'‚ö´ Hors ligne'}</span>
                                ${i.verified ? '<span style="padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;background:rgba(52,211,153,0.1);color:#34D399">‚úÖ V√©rifi√©</span>' : '<span style="padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;background:rgba(251,191,36,0.1);color:#FBBF24">‚ö†Ô∏è Non v√©rifi√©</span>'}
                                ${penalised ? `<span style="padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;background:rgba(239,68,68,0.1);color:#EF4444">üö´ P√©nalis√©</span>` : ''}
                            </div>
                            <p style="font-size:12px;color:#6B7280">üìç ${i.location||'?'} ¬∑ ‚≠ê ${i.rating||0} ¬∑ ${(i.hourly_rate||0).toLocaleString()} XPF/h ¬∑ ${i.experience||0} ans exp.</p>
                            ${i.phone_number ? `<p style="font-size:11px;color:#4B5563;margin-top:2px">üì± ${i.phone_number} ${i.phone_verified?'‚úÖ':''}</p>` : ''}
                            <div style="display:flex;gap:16px;margin-top:8px">
                                <span style="font-size:12px;color:#FBBF24">üí∞ ${revenue.toLocaleString()} XPF gagn√©s</span>
                                <span style="font-size:12px;color:#60A5FA">üìã ${myBookings.length} r√©servations</span>
                                <span style="font-size:12px;color:#A78BFA">üìÖ ${adminData.slots.filter(s=>s.instructor_id===i.id&&s.available).length} cr√©neaux dispo</span>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
                        <button onclick="adminVerifyInstructor('${i.id}',${!i.verified})" 
                            style="padding:7px 14px;background:${i.verified?'rgba(239,68,68,0.1)':'rgba(52,211,153,0.1)'};border:1px solid ${i.verified?'rgba(239,68,68,0.2)':'rgba(52,211,153,0.2)'};color:${i.verified?'#EF4444':'#34D399'};border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">
                            ${i.verified ? '‚ùå Retirer v√©rification' : '‚úÖ V√©rifier'}
                        </button>
                        ${penalised ? `
                        <button onclick="adminRemovePenalty('${i.id}')" style="padding:7px 14px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);color:#FBBF24;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">
                            üîì Lever la p√©nalit√©
                        </button>` : `
                        <button onclick="adminPenalizeInstructor('${i.id}')" style="padding:7px 14px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.15);color:#6B7280;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">
                            üö´ P√©naliser
                        </button>`}
                        <button onclick="adminSetOnline('${i.id}',${!i.is_online})" style="padding:7px 14px;background:rgba(255,255,255,0.03);border:1px solid #2A2A2A;color:#9CA3AF;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">
                            ${i.is_online ? 'üì¥ Mettre hors ligne' : 'üì∂ Mettre en ligne'}
                        </button>
                        <button onclick="adminDeleteUser('${i.user_id||i.id}')" style="padding:7px 10px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.1);color:#EF4444;border-radius:8px;font-size:12px;cursor:pointer">üóëÔ∏è</button>
                    </div>
                </div>`}).join('') || '<p style="color:#4B5563;text-align:center;padding:40px">Aucun moniteur</p>'}
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ REVENUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'revenue') {
        const paid = adminData.bookings.filter(b => b.status === 'confirmed' && b.payment_status === 'paid');
        const totalRev = paid.reduce((s,b) => s+(b.amount||0), 0);
        const totalCom = paid.reduce((s,b) => s+(b.commission||0), 0);
        const totalNet = paid.reduce((s,b) => s+(b.net||0), 0);

        // Regrouper par mois
        const byMonth = {};
        paid.forEach(b => {
            const m = (b.date||'').substring(0, 7);
            if (!byMonth[m]) byMonth[m] = { amount: 0, commission: 0, count: 0 };
            byMonth[m].amount     += b.amount     || 0;
            byMonth[m].commission += b.commission || 0;
            byMonth[m].count++;
        });
        const months = Object.entries(byMonth).sort((a,b) => b[0].localeCompare(a[0]));

        // Top moniteurs
        const byInstructor = {};
        paid.forEach(b => {
            if (!byInstructor[b.instructor_id]) byInstructor[b.instructor_id] = { name: b.instructor_name, amount: 0, count: 0 };
            byInstructor[b.instructor_id].amount += b.net || 0;
            byInstructor[b.instructor_id].count++;
        });
        const topInst = Object.values(byInstructor).sort((a,b) => b.amount - a.amount).slice(0, 5);

        return `
        <div style="display:flex;flex-direction:column;gap:20px">
            <!-- Totaux -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">
                <div style="background:linear-gradient(135deg,rgba(255,90,31,0.1),rgba(255,90,31,0.05));border:1px solid rgba(255,90,31,0.2);border-radius:18px;padding:20px;text-align:center">
                    <p style="font-size:11px;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Chiffre d'affaires</p>
                    <p style="font-size:28px;font-weight:900;color:#FF5A1F">${totalRev.toLocaleString()}</p>
                    <p style="font-size:13px;color:#6B7280">XPF total</p>
                </div>
                <div style="background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(251,191,36,0.05));border:1px solid rgba(251,191,36,0.2);border-radius:18px;padding:20px;text-align:center">
                    <p style="font-size:11px;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Commission DriveConnect</p>
                    <p style="font-size:28px;font-weight:900;color:#FBBF24">${totalCom.toLocaleString()}</p>
                    <p style="font-size:13px;color:#6B7280">XPF (${totalRev > 0 ? Math.round(totalCom/totalRev*100) : 0}%)</p>
                </div>
                <div style="background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(52,211,153,0.05));border:1px solid rgba(52,211,153,0.2);border-radius:18px;padding:20px;text-align:center">
                    <p style="font-size:11px;color:#9CA3AF;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Revers√© aux moniteurs</p>
                    <p style="font-size:28px;font-weight:900;color:#34D399">${totalNet.toLocaleString()}</p>
                    <p style="font-size:13px;color:#6B7280">XPF net</p>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                <!-- Par mois -->
                <div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;padding:20px">
                    <p style="font-weight:800;font-size:15px;margin-bottom:16px">üìà Par mois</p>
                    ${months.length === 0 ? '<p style="color:#4B5563;text-align:center;padding:20px">Pas encore de donn√©es</p>' :
                    months.map(([m, d]) => `
                    <div style="margin-bottom:14px">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                            <span style="font-size:13px;font-weight:700">${m}</span>
                            <span style="font-size:13px;color:#FBBF24">${d.amount.toLocaleString()} XPF ¬∑ ${d.count} cours</span>
                        </div>
                        <div style="background:#1F1F1F;border-radius:4px;height:6px">
                            <div style="background:#FF5A1F;height:6px;border-radius:4px;width:${Math.round(d.amount / Math.max(...months.map(([,x])=>x.amount)) * 100)}%"></div>
                        </div>
                        <p style="font-size:10px;color:#4B5563;margin-top:2px">Commission: ${d.commission.toLocaleString()} XPF</p>
                    </div>`).join('')}
                </div>

                <!-- Top moniteurs -->
                <div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;padding:20px">
                    <p style="font-weight:800;font-size:15px;margin-bottom:16px">üèÜ Top moniteurs</p>
                    ${topInst.length === 0 ? '<p style="color:#4B5563;text-align:center;padding:20px">Pas encore de donn√©es</p>' :
                    topInst.map((inst, idx) => `
                    <div style="display:flex;align-items:center;gap:12px;padding:10px;background:#1A1A1A;border-radius:12px;margin-bottom:8px">
                        <span style="font-size:18px">${['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'][idx]}</span>
                        <div style="flex:1">
                            <p style="font-weight:700;font-size:13px">${inst.name||'?'}</p>
                            <p style="font-size:11px;color:#6B7280">${inst.count} cours</p>
                        </div>
                        <p style="font-weight:800;color:#34D399;font-size:14px">${inst.amount.toLocaleString()} XPF</p>
                    </div>`).join('')}
                </div>
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ CARTE LIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'map') {
        return `
        <div>
            <p style="font-weight:800;font-size:16px;margin-bottom:16px">üó∫Ô∏è Position des moniteurs en temps r√©el</p>
            <div style="background:#111;border:1px solid #1F1F1F;border-radius:20px;overflow:hidden">
                <div id="map" style="height:500px"></div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
                ${adminData.instructors.filter(i => i.lat).map(i => `
                <div style="background:#1A1A1A;border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:8px">
                    <div style="width:8px;height:8px;border-radius:50%;background:${i.is_online?'#22C55E':'#6B7280'}"></div>
                    <span style="font-size:13px;font-weight:600">${i.name||'?'}</span>
                    <span style="font-size:11px;color:#4B5563">${i.location||''}</span>
                </div>`).join('')}
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ ZONE ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (tab === 'danger') {
        return `
        <div style="display:flex;flex-direction:column;gap:16px;max-width:600px">
            <div style="background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.2);border-radius:16px;padding:20px">
                <p style="font-weight:800;font-size:15px;color:#FBBF24;margin-bottom:4px">üßπ Nettoyer les cr√©neaux pass√©s</p>
                <p style="font-size:13px;color:#6B7280;margin-bottom:14px">Supprime tous les cr√©neaux dont la date est d√©pass√©e.</p>
                <button onclick="adminCleanSlots()" style="padding:10px 20px;background:#FBBF24;color:#000;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer">üóëÔ∏è Nettoyer</button>
            </div>

            <div style="background:rgba(96,165,250,0.05);border:1px solid rgba(96,165,250,0.2);border-radius:16px;padding:20px">
                <p style="font-weight:800;font-size:15px;color:#60A5FA;margin-bottom:4px">üìä √âtat de la base de donn√©es</p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
                    ${[
                        { label: 'Utilisateurs',   val: adminData.users.length },
                        { label: 'Moniteurs',       val: adminData.instructors.length },
                        { label: 'R√©servations',    val: adminData.bookings.length },
                        { label: 'Cr√©neaux total',  val: adminData.slots.length },
                        { label: 'Cr√©neaux dispo',  val: adminData.slots.filter(s=>s.available).length },
                        { label: 'Cr√©neaux r√©serv√©s', val: adminData.slots.filter(s=>!s.available).length },
                    ].map(s => `
                    <div style="background:#1A1A1A;border-radius:10px;padding:12px;text-align:center">
                        <p style="font-size:22px;font-weight:900;color:#60A5FA">${s.val}</p>
                        <p style="font-size:11px;color:#6B7280">${s.label}</p>
                    </div>`).join('')}
                </div>
            </div>

            <div style="background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2);border-radius:16px;padding:20px">
                <p style="font-weight:800;font-size:15px;color:#EF4444;margin-bottom:4px">üö® R√©initialiser tous les GPS</p>
                <p style="font-size:13px;color:#6B7280;margin-bottom:14px">Remet tous les moniteurs hors ligne (GPS).</p>
                <button onclick="adminResetAllGPS()" style="padding:10px 20px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:#EF4444;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer">üì¥ Mettre tous hors ligne</button>
            </div>
        </div>`;
    }

    return '';
}

window.switchAdminTab = (t) => {
    adminTab = t;
    document.getElementById('app').innerHTML = AdminDashboard();
    if (t === 'map') setTimeout(() => initMap(), 100);
};

window.adminFilter = (type) => {
    const q = (document.getElementById(`search-${type}`)?.value || '').toLowerCase();
    const listEl = document.getElementById(`${type}-list`);
    if (!listEl) return;
    // Filtrer visuellement les √©l√©ments d√©j√† affich√©s
    Array.from(listEl.children).forEach(child => {
        const text = child.textContent.toLowerCase();
        child.style.display = text.includes(q) ? '' : 'none';
    });
};

// ‚îÄ‚îÄ Helper : ex√©cuter une action admin via RPC (bypass RLS) ‚îÄ‚îÄ
async function adminExec(table, action, data, filterCol, filterVal) {
    // Tenter RPC g√©n√©rique admin
    const rpc = await sb.rpc('admin_exec', { 
        p_table: table, p_action: action, 
        p_data: JSON.stringify(data || {}), 
        p_filter_col: filterCol || 'id', 
        p_filter_val: filterVal || '' 
    });
    if (!rpc.error) return { success: true };
    // Fallback direct (marche si RLS le permet)
    console.warn('[ADMIN] RPC admin_exec failed, trying direct:', rpc.error.message);
    if (action === 'update') {
        const r = await sb.from(table).update(data).eq(filterCol || 'id', filterVal);
        return r.error ? { success: false, error: r.error.message } : { success: true };
    }
    if (action === 'delete') {
        const r = await sb.from(table).delete().eq(filterCol || 'id', filterVal);
        return r.error ? { success: false, error: r.error.message } : { success: true };
    }
    return { success: false, error: 'Unknown action' };
}

window.adminVerifyInstructor = async (id, v) => {
    await adminExec('instructors', 'update', { verified: v }, 'id', id);
    notif(v ? '‚úÖ Moniteur v√©rifi√©' : '‚ùå V√©rification retir√©e', '', v ? 'green' : 'orange');
    await loadAdminData();
};

// ========== APPROBATION MONITEURS ==========
window.adminApproveInstructor = async (id) => {
    if (!confirm('Valider ce moniteur ? Il pourra acc√©der au tableau de bord et recevoir des r√©servations.')) return;
    await adminExec('instructors', 'update', { approval_status: 'approved', verified: true, rejection_reason: null }, 'id', id);
    sendPushToUser(id, '‚úÖ Profil valid√© !', 'Votre demande a √©t√© accept√©e. Bienvenue sur DriveConnect NC ! üéâ');
    notif('‚úÖ Moniteur approuv√©', '', 'green');
    await loadAdminData();
};

window.adminRejectInstructorModal = (id, name) => {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 flex items-center justify-center z-[9999] p-4';
    modal.style.background = 'rgba(0,0,0,0.7)';
    modal.innerHTML = `<div style="background:#1A1A1A;border:1px solid #333;border-radius:20px;padding:24px;max-width:420px;width:100%">
        <h3 style="font-weight:900;font-size:18px;color:#fff;margin-bottom:8px">‚ùå Refuser ${name}</h3>
        <p style="font-size:13px;color:#6B7280;margin-bottom:16px">Indiquez le motif du refus pour aider le moniteur √† corriger ses documents.</p>
        <textarea id="reject-reason" rows="3" style="width:100%;background:#111;border:1px solid #333;border-radius:12px;padding:12px;color:#fff;font-size:14px;resize:none;outline:none;font-family:inherit" placeholder="Ex: Pi√®ce d'identit√© illisible, autorisation expir√©e..."></textarea>
        <div style="display:flex;gap:12px;margin-top:16px">
            <button onclick="this.closest('.fixed').remove()" style="flex:1;padding:14px;background:#222;color:#999;border:1px solid #333;border-radius:14px;font-weight:600;font-size:14px;cursor:pointer">Annuler</button>
            <button onclick="adminRejectInstructor('${id}', document.getElementById('reject-reason').value, this.closest('.fixed'))" style="flex:1;padding:14px;background:#DC2626;color:white;border:none;border-radius:14px;font-weight:800;font-size:14px;cursor:pointer">Refuser</button>
        </div>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
};

window.adminRejectInstructor = async (id, reason, modal) => {
    if (!reason.trim()) { notif('‚ö†Ô∏è Motif obligatoire', 'Indiquez le motif du refus', 'yellow'); return; }
    await adminExec('instructors', 'update', { approval_status: 'rejected', rejection_reason: reason.trim() }, 'id', id);
    sendPushToUser(id, '‚ùå Demande refus√©e', 'Votre demande n\'a pas √©t√© valid√©e. Consultez l\'app pour plus d\'infos.');
    if (modal) modal.remove();
    notif('‚ùå Moniteur refus√©', '', 'red');
    await loadAdminData();
};

window.adminRemovePenalty = async (id) => {
    await adminExec('instructors', 'update', { penalty_until: null, visibility_penalty: 0 }, 'id', id);
    notif('‚úÖ P√©nalit√© lev√©e', '', 'green');
    await loadAdminData();
};

window.adminPenalizeInstructor = async (id) => {
    const days = prompt('Dur√©e de la p√©nalit√© (jours) :', '7');
    if (!days) return;
    const until = new Date(Date.now() + parseInt(days) * 86400000).toISOString();
    await adminExec('instructors', 'update', { penalty_until: until, visibility_penalty: 100 }, 'id', id);
    notif(`üö´ P√©nalis√© ${days} jours`, '', 'red');
    await loadAdminData();
};

window.adminSetOnline = async (id, online) => {
    await adminExec('instructors', 'update', { is_online: online }, 'id', id);
    notif(online ? 'üü¢ Mis en ligne' : '‚ö´ Mis hors ligne', '', 'green');
    await loadAdminData();
};

window.adminDeleteUser = async (id) => {
    if (!confirm('‚ö†Ô∏è Supprimer cet utilisateur d√©finitivement ?')) return;
    // Supprimer de instructors aussi si c'est un moniteur
    await adminExec('instructors', 'delete', {}, 'id', id);
    await adminExec('users', 'delete', {}, 'id', id);
    notif('üóëÔ∏è Utilisateur supprim√©', '', 'red');
    await loadAdminData();
};

window.adminForceCancel = async (id) => {
    if (!confirm('Annuler cette r√©servation ?')) return;
    const b = adminData.bookings.find(x => x.id === id);
    await adminExec('bookings', 'update', { status: 'cancelled' }, 'id', id);
    if (b && b.slot_id) await adminExec('slots', 'delete', {}, 'id', b.slot_id);
    notif('‚ùå R√©servation annul√©e ¬∑ Cr√©neau supprim√©', '', 'red');
    await loadAdminData();
};

window.adminSetDispute = async (id) => {
    if (!confirm('Mettre cette r√©servation en litige ?')) return;
    await adminExec('bookings', 'update', { status: 'dispute' }, 'id', id);
    notif('‚ö†Ô∏è R√©servation en litige', '', 'orange');
    await loadAdminData();
};

window.adminCleanSlots = async () => {
    if (!confirm('Supprimer tous les cr√©neaux pass√©s ?')) return;
    const t = new Date().toISOString().split('T')[0];
    await sb.from('slots').delete().lt('date', t);
    notif('‚úÖ Cr√©neaux pass√©s supprim√©s', '', 'green');
    await loadAdminData();
};

window.adminResetAllGPS = async () => {
    if (!confirm('Mettre TOUS les moniteurs hors ligne ?')) return;
    
    // Essayer RPC d'abord (bypass RLS)
    const rpc = await sb.rpc('admin_reset_all_gps');
    if (!rpc.error) {
        notif('üì¥ Tous les moniteurs mis hors ligne', '', 'orange');
        await loadAdminData();
        return;
    }
    
    // Fallback : mettre √† jour chaque moniteur individuellement
    console.warn('[ADMIN] RPC admin_reset_all_gps failed, using fallback:', rpc.error.message);
    const promises = adminData.instructors.map(i => 
        sb.from('instructors').update({ is_online: false }).eq('id', i.id)
    );
    const results = await Promise.all(promises);
    const errors = results.filter(r => r.error);
    if (errors.length > 0) {
        console.warn('[ADMIN] Reset GPS errors:', errors.length, 'failed');
        notif('‚ö†Ô∏è Certains moniteurs n\'ont pas pu √™tre mis √† jour (RLS)', 'Ex√©cutez le SQL admin dans Supabase', 'yellow');
    } else {
        notif('üì¥ Tous les moniteurs mis hors ligne', '', 'orange');
    }
    await loadAdminData();
};


// ========== PAGES L√âGALES ==========
function LegalPage(type) {
    const tabs = [
        { id:'privacy', label:'üîí Confidentialit√©' },
        { id:'terms', label:'üìã CGU' },
        { id:'mentions', label:'üìÑ Mentions l√©gales' }
    ];
    const activeTab = type || 'privacy';

    let content = '';

    if (activeTab === 'privacy') {
        content = `
        <h2 style="font-size:24px;font-weight:900;margin-bottom:16px;color:#fff">Politique de confidentialit√©</h2>
        <p class="lg-date">Derni√®re mise √† jour : 26 f√©vrier 2026</p>

        <h3>1. Responsable du traitement</h3>
        <p>DriveConnect NC exploite la plateforme de mise en relation entre √©l√®ves et moniteurs de conduite √† Noum√©a, Nouvelle-Cal√©donie. Cette politique d√©crit comment nous collectons, utilisons et prot√©geons vos donn√©es personnelles.</p>

        <h3>2. Donn√©es collect√©es</h3>
        <p><strong>Donn√©es d'inscription :</strong> nom, pr√©nom, adresse email, mot de passe (hash√©), type de compte (√©l√®ve/moniteur).</p>
        <p><strong>Donn√©es moniteur :</strong> autorisation d'enseigner, pi√®ce d'identit√©, assurance professionnelle, RIB/coordonn√©es bancaires, num√©ro de t√©l√©phone, localisation GPS (volontaire).</p>
        <p><strong>Donn√©es de r√©servation :</strong> dates, heures, montants, codes de validation, notes de suivi p√©dagogique.</p>
        <p><strong>Donn√©es techniques :</strong> adresse IP, type de navigateur, donn√©es de g√©olocalisation GPS (uniquement pour les moniteurs ayant activ√© le suivi).</p>
        <p><strong>Donn√©es de paiement :</strong> les paiements sont trait√©s par PayPal. DriveConnect NC ne stocke aucun num√©ro de carte bancaire.</p>

        <h3>3. Finalit√© du traitement</h3>
        <p>Vos donn√©es sont utilis√©es pour : la cr√©ation et gestion de votre compte, la mise en relation √©l√®ves/moniteurs, le traitement des paiements et commissions (15%), la g√©olocalisation des moniteurs disponibles, l'envoi de notifications li√©es aux r√©servations, et l'am√©lioration de nos services.</p>

        <h3>4. Base l√©gale</h3>
        <p>Le traitement de vos donn√©es repose sur : l'ex√©cution du contrat (r√©servations, paiements), votre consentement (g√©olocalisation, notifications), nos int√©r√™ts l√©gitimes (s√©curit√©, am√©lioration du service), et nos obligations l√©gales.</p>

        <h3>5. Stockage et s√©curit√©</h3>
        <p>Vos donn√©es sont h√©berg√©es sur Supabase (infrastructure cloud s√©curis√©e). Les mots de passe sont hash√©s avec bcrypt. Les communications sont chiffr√©es via HTTPS/TLS. Les documents d'identit√© sont stock√©s dans un bucket s√©curis√© accessible uniquement par l'administration.</p>

        <h3>6. G√©olocalisation</h3>
        <p>La g√©olocalisation GPS est utilis√©e uniquement pour les moniteurs ayant activ√© le partage de position. Elle permet aux √©l√®ves de voir les moniteurs disponibles sur la carte. Le moniteur peut activer/d√©sactiver le GPS √† tout moment. La position n'est pas conserv√©e apr√®s d√©connexion.</p>

        <h3>7. Dur√©e de conservation</h3>
        <p>Donn√©es de compte : conserv√©es tant que le compte est actif + 3 ans apr√®s suppression. Donn√©es de r√©servation : 5 ans (obligation comptable). Documents d'identit√© moniteur : dur√©e de l'activit√© + 1 an. Donn√©es GPS : non conserv√©es apr√®s d√©connexion.</p>

        <h3>8. Vos droits</h3>
        <p>Conform√©ment √† la r√©glementation en vigueur, vous disposez d'un droit d'acc√®s, de rectification, de suppression, de portabilit√© et d'opposition. Pour exercer ces droits : contact@driveconnect.nc. D√©lai de r√©ponse : 30 jours maximum.</p>

        <h3>9. Cookies</h3>
        <p>DriveConnect NC utilise uniquement des cookies techniques essentiels au fonctionnement (session d'authentification, pr√©f√©rences d'affichage). Aucun cookie publicitaire ou de suivi n'est utilis√©.</p>

        <h3>10. Protection des mineurs</h3>
        <p>DriveConnect NC s'adresse aux personnes de 16 ans et plus (√¢ge l√©gal pour la conduite accompagn√©e en Nouvelle-Cal√©donie). Les mineurs de 16-17 ans doivent avoir l'autorisation de leur repr√©sentant l√©gal.</p>`;
    }

    if (activeTab === 'terms') {
        content = `
        <h2 style="font-size:24px;font-weight:900;margin-bottom:16px;color:#fff">Conditions G√©n√©rales d'Utilisation</h2>
        <p class="lg-date">Derni√®re mise √† jour : 26 f√©vrier 2026</p>

        <h3>1. Objet</h3>
        <p>DriveConnect NC est une plateforme de mise en relation entre √©l√®ves souhaitant prendre des cours de conduite et moniteurs ind√©pendants √† Noum√©a, Nouvelle-Cal√©donie. L'utilisation de la plateforme implique l'acceptation pleine et enti√®re des pr√©sentes CGU.</p>

        <h3>2. R√¥le de DriveConnect NC</h3>
        <p>DriveConnect NC est un interm√©diaire technique. La plateforme ne dispense pas de cours de conduite et n'est pas une auto-√©cole. Elle met en relation des moniteurs ind√©pendants v√©rifi√©s avec des √©l√®ves. DriveConnect NC pr√©l√®ve une commission de <strong>15%</strong> sur chaque r√©servation pay√©e.</p>

        <h3>3. Inscription et v√©rification</h3>
        <p><strong>√âl√®ves :</strong> inscription avec email v√©rifi√©, nom et mot de passe. <strong>Moniteurs :</strong> inscription avec v√©rification email + envoi obligatoire de : autorisation d'enseigner la conduite (ECSR, BEPECASER ou autorisation pr√©fectorale), pi√®ce d'identit√© valide, RIB/coordonn√©es bancaires. L'assurance professionnelle est optionnelle mais recommand√©e. Les documents sont v√©rifi√©s manuellement par l'administration avant validation du compte.</p>

        <h3>4. R√©servations et paiements</h3>
        <p>Les paiements sont effectu√©s en XPF via PayPal (conversion automatique en EUR au taux fixe officiel de 1 EUR = 119,3317 XPF). Un code de validation √† 6 caract√®res est g√©n√©r√© √† chaque r√©servation. L'√©l√®ve communique ce code au moniteur √† la fin du cours pour valider la s√©ance.</p>
        <p>Un cr√©neau pay√© ne peut pas √™tre r√©serv√© par un autre √©l√®ve. En cas d'annulation, le cr√©neau est d√©finitivement supprim√© et le moniteur doit en cr√©er un nouveau.</p>

        <h3>5. Statuts des r√©servations</h3>
        <p><strong>En attente :</strong> r√©servation cr√©√©e, en attente de confirmation. <strong>Confirm√©e :</strong> paiement valid√©, cours programm√©. <strong>Termin√©e :</strong> cours valid√© par le code de validation. <strong>Annul√©e :</strong> cours annul√© par l'√©l√®ve ou le moniteur. <strong>Litige :</strong> contestation en cours, g√©r√©e par l'administration.</p>

        <h3>6. Commission</h3>
        <p>DriveConnect NC pr√©l√®ve une commission de <strong>15%</strong> sur le montant de chaque r√©servation confirm√©e. Le moniteur re√ßoit 85% du montant. En cas de parrainage d'un moniteur, la commission est r√©duite de 2% (soit 13%) pendant les 10 premiers cours du moniteur parrain√©.</p>

        <h3>7. Annulations et remboursements</h3>
        <p><strong>Par l'√©l√®ve :</strong> remboursement √† 100% si annulation plus de 48h avant le cours, 50% entre 24h et 48h, 0% moins de 24h avant. <strong>Par le moniteur :</strong> remboursement int√©gral √† l'√©l√®ve. Si annulation moins de 24h avant : p√©nalit√© de visibilit√© -10% pendant 7 jours. Dans tous les cas, le cr√©neau est d√©finitivement supprim√©.</p>

        <h3>8. Obligations des moniteurs</h3>
        <p>Le moniteur s'engage √† : poss√©der les qualifications l√©gales valides, disposer d'un v√©hicule √† double commande assur√©, respecter les horaires des r√©servations, ne pas annuler de mani√®re r√©p√©titive (p√©nalit√©s de visibilit√©), et respecter le code de la route et les r√®gles de s√©curit√©.</p>

        <h3>9. Obligations des √©l√®ves</h3>
        <p>L'√©l√®ve s'engage √† : fournir des informations exactes, se pr√©senter √† l'heure aux rendez-vous, respecter le moniteur et le v√©hicule, et communiquer le code de validation uniquement √† la fin du cours effectivement r√©alis√©.</p>

        <h3>10. Suspension et r√©siliation</h3>
        <p>DriveConnect NC se r√©serve le droit de suspendre ou r√©silier tout compte en cas de : violation des pr√©sentes CGU, fraude ou tentative de fraude, comportement inappropri√©, faux documents, ou utilisation abusive de la plateforme.</p>

        <h3>11. Limitation de responsabilit√©</h3>
        <p>DriveConnect NC n'est pas responsable : de la qualit√© des cours dispens√©s par les moniteurs, des dommages survenant pendant un cours de conduite, des retards ou absences des moniteurs ou √©l√®ves, ni des probl√®mes techniques ind√©pendants de sa volont√©.</p>

        <h3>12. Droit applicable</h3>
        <p>Les pr√©sentes CGU sont soumises au droit fran√ßais applicable en Nouvelle-Cal√©donie. En cas de litige, les parties s'engagent √† rechercher une solution amiable. √Ä d√©faut, les tribunaux de Noum√©a seront seuls comp√©tents.</p>`;
    }

    if (activeTab === 'mentions') {
        content = `
        <h2 style="font-size:24px;font-weight:900;margin-bottom:16px;color:#fff">Mentions l√©gales</h2>
        <p class="lg-date">Derni√®re mise √† jour : 26 f√©vrier 2026</p>

        <h3>1. √âditeur du site</h3>
        <p><strong>Nom :</strong> DriveConnect NC<br>
        <strong>Forme juridique :</strong> Entreprise individuelle<br>
        <strong>Si√®ge social :</strong> Noum√©a, Nouvelle-Cal√©donie<br>
        <strong>Email :</strong> contact@driveconnect.nc<br>
        <strong>Directeur de la publication :</strong> Le g√©rant de DriveConnect NC</p>

        <h3>2. H√©bergement</h3>
        <p><strong>Site web :</strong> h√©berg√© par Vercel Inc., 440 N Barranca Ave #4133, Covina, CA 91723, USA.<br>
        <strong>Base de donn√©es :</strong> h√©berg√©e par Supabase Inc.<br>
        <strong>Paiements :</strong> trait√©s par PayPal (Europe) S.√† r.l. et Cie, S.C.A., 22-24 Boulevard Royal, L-2449 Luxembourg.</p>

        <h3>3. Propri√©t√© intellectuelle</h3>
        <p>L'ensemble du contenu du site DriveConnect NC (textes, graphismes, logos, ic√¥nes, logiciels) est la propri√©t√© exclusive de DriveConnect NC ou de ses partenaires. Toute reproduction, repr√©sentation ou diffusion, en tout ou partie, du contenu de ce site est interdite sans autorisation √©crite pr√©alable.</p>

        <h3>4. Donn√©es personnelles</h3>
        <p>Conform√©ment √† la r√©glementation applicable en mati√®re de protection des donn√©es personnelles, vous disposez d'un droit d'acc√®s, de rectification et de suppression de vos donn√©es. Pour plus de d√©tails, consultez notre Politique de confidentialit√©.</p>

        <h3>5. Cookies</h3>
        <p>Le site utilise uniquement des cookies techniques n√©cessaires au fonctionnement du service. Aucun cookie publicitaire ou de suivi marketing n'est utilis√©.</p>

        <h3>6. Activit√©</h3>
        <p>DriveConnect NC est une plateforme de mise en relation entre √©l√®ves et moniteurs de conduite ind√©pendants. DriveConnect NC n'est pas un √©tablissement d'enseignement de la conduite (auto-√©cole) et n'emploie pas directement les moniteurs. La commission pr√©lev√©e est de 15% sur chaque transaction.</p>

        <h3>7. M√©diation</h3>
        <p>En cas de litige, le consommateur peut recourir gratuitement au service de m√©diation. Les litiges relatifs √† l'utilisation de la plateforme sont soumis √† la comp√©tence des tribunaux de Noum√©a, Nouvelle-Cal√©donie.</p>

        <h3>8. Cr√©dits</h3>
        <p>Cartographie : OpenStreetMap & CartoDB. Paiements : PayPal. Ic√¥nes : syst√®me emoji natif. Police : DM Sans (Google Fonts).</p>`;
    }

    return `<div class="min-h-screen" style="background:linear-gradient(160deg,#0f0f0f 0%,#1a1a1a 50%,#0f0f0f 100%)">
        <div style="max-width:700px;margin:0 auto;padding:20px 20px 60px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-top:12px">
                <button onclick="currentView='home';render()" style="background:rgba(255,255,255,0.08);border:none;width:40px;height:40px;border-radius:50%;color:#fff;font-size:18px;cursor:pointer">‚Üê</button>
                <h1 style="color:#fff;font-weight:900;font-size:22px">Informations l√©gales</h1>
            </div>
            <div style="display:flex;gap:6px;margin-bottom:28px;overflow-x:auto;padding-bottom:4px">
                ${tabs.map(t => `<button onclick="currentView='${t.id}';render()" style="padding:10px 16px;border-radius:12px;font-size:13px;font-weight:700;border:none;cursor:pointer;white-space:nowrap;transition:all 0.15s;${activeTab===t.id?'background:linear-gradient(135deg,#FF5A1F,#FF7340);color:#fff':'background:rgba(255,255,255,0.06);color:#6B7280'}">${t.label}</button>`).join('')}
            </div>
            <style>
                .legal-content h3 { color:#FF5A1F;font-weight:800;font-size:16px;margin:24px 0 8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.06); }
                .legal-content h3:first-of-type { border-top:none;margin-top:16px; }
                .legal-content p { color:#9CA3AF;font-size:14px;line-height:1.8;margin-bottom:10px; }
                .legal-content p strong { color:#D1D5DB; }
                .legal-content .lg-date { color:#4B5563;font-size:12px;font-style:italic;margin-bottom:20px; }
            </style>
            <div class="legal-content" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:20px;padding:28px">
                ${content}
            </div>
        </div>
    </div>`;
}

function render() {
    if(map){map.remove();map=null;iMarkers=[];}
    if(mapRealtimeChannel){mapRealtimeChannel.unsubscribe();mapRealtimeChannel=null;}
    const app=document.getElementById('app');
    switch(currentView){
        case 'home':                app.innerHTML=HomePage(); break;
        case 'student-login':       app.innerHTML=LoginPage('student');    setupLoginForm('student');    break;
        case 'instructor-login':    app.innerHTML=LoginPage('instructor'); setupLoginForm('instructor'); break;
        case 'student-dashboard':   app.innerHTML=StudentDashboard();      setTimeout(()=>initMap(),100); break;
        case 'instructor-dashboard':app.innerHTML=InstructorDashboard();   setTimeout(()=>{initMap();if(currentTab==='settings')loadReferralData();},150); break;
        case 'instructor-upload-docs': app.innerHTML=InstructorUploadDocs(); setTimeout(()=>setupDocUpload(),100); break;
        case 'instructor-pending':  app.innerHTML=InstructorPending(); break;
        case 'instructor-rejected': app.innerHTML=InstructorRejected(); setTimeout(()=>setupDocUpload(),100); break;
        case 'admin':               loadAdminData(); break;
        case 'privacy':             app.innerHTML=LegalPage('privacy'); break;
        case 'terms':               app.innerHTML=LegalPage('terms'); break;
        case 'mentions':            app.innerHTML=LegalPage('mentions'); break;
    }
}

// ========== D√âMARRAGE ==========
// ========== SERVICE WORKER PWA ==========
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}
const VAPID_PUBLIC = 'BMjTOVHtirDedvOuVi151Q7lrkGvJM0h8tmgwHxrfbPzXc0-P4LQufCwlfXYw5pKLV6-SIKeTMVZNAQMxVtjqHU';

async function subscribeToPush() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
    try {
        const reg = await navigator.serviceWorker.ready;
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;
        const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: VAPID_PUBLIC });
        const { endpoint, keys } = sub.toJSON();
        await sb.from('push_subscriptions').upsert({ user_id: currentUser.id, endpoint, p256dh: keys.p256dh, auth: keys.auth }, { onConflict: 'user_id,endpoint' });
    } catch(e) { console.error('Push:', e); }
}

async function sendPushToUser(userId, title, body) {
    try {
        const token = (await sb.auth.getSession()).data.session?.access_token;
        await fetch('https://nnmdvepfyccnehzbvpfn.supabase.co/functions/v1/send-push', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ user_id: userId, title, body, url: '/app.html' })
        });
    } catch(e) { console.error(e); }
}
// ===== PARRAINAGE =====
async function loadReferralData() {
    if (!currentUser || currentUser.user_type !== 'instructor') return;
    const { data: instructor } = await sb.from('instructors').select('referral_code').eq('id', currentUser.id).single();
    if (instructor?.referral_code) {
        const el = document.getElementById('referral-code-display');
        if (el) el.textContent = instructor.referral_code;
    }
    const { data: referrals } = await sb.from('referrals').select('*, referred:referred_id(name)').eq('referrer_id', currentUser.id).eq('status', 'active');
    if (referrals) {
        const countEl = document.getElementById('referral-count');
        if (countEl) countEl.textContent = referrals.length;
        const savingsEl = document.getElementById('referral-savings');
        if (savingsEl) savingsEl.textContent = (referrals.reduce((s, r) => s + r.bonus_courses_remaining * 450, 0)).toLocaleString();
        const listEl = document.getElementById('referral-list');
        if (listEl && referrals.length > 0) listEl.innerHTML = referrals.map(r => `<div class="flex justify-between items-center p-3 rounded-xl" style="background:var(--bg)"><p class="text-sm font-semibold">${r.referred?.name||'Moniteur'}</p><span class="text-xs" style="color:var(--primary)">${r.bonus_courses_remaining} cours restants</span></div>`).join('');
    }
}

async function copyReferralCode() {
    const code = document.getElementById('referral-code-display')?.textContent;
    if (!code || code === '...') return;
    await navigator.clipboard.writeText(code);
    notif('‚úÖ Copi√© !', 'Code de parrainage copi√©', 'green');
}

async function shareReferralLink() {
    const code = document.getElementById('referral-code-display')?.textContent;
    if (!code || code === '...') return;
    const link = `https://driveconnect-nc.vercel.app/app.html?ref=${code}`;
    if (navigator.share) {
        await navigator.share({ title: 'DriveConnect NC', text: `Rejoins DriveConnect NC avec mon code ${code} üöó`, url: link });
    } else {
        await navigator.clipboard.writeText(link);
        notif('‚úÖ Lien copi√© !', link, 'green');
    }
}

async function applyReferralCode(newInstructorId, referralCode) {
    if (!referralCode || referralCode.length !== 8) return;
    const code = referralCode.toUpperCase().trim();
    const { data: referrer } = await sb.from('instructors').select('id, name').eq('referral_code', code).single();
    if (!referrer) { notif('‚ö†Ô∏è Code invalide', 'Ce code de parrainage n\'existe pas', 'yellow'); return; }
    await sb.from('referrals').insert({ referrer_id: referrer.id, referred_id: newInstructorId, referral_code: code, status: 'active', bonus_courses_remaining: 10, commission_discount: 2 });
    sendPushToUser(referrer.id, 'üéâ Nouveau filleul !', `Un nouveau moniteur a rejoint DriveConnect avec votre code !`);
    notif('‚úÖ Code appliqu√© !', `Parrain : ${referrer.name}. 2% de commission en moins pendant 10 cours.`, 'green');
}

function checkReferralInUrl() {
    const params = new URLSearchParams(window.location.search);
    const ref = params.get('ref');
    if (ref) localStorage.setItem('pending_referral', ref.toUpperCase());
}

// ===== R√âINITIALISATION MOT DE PASSE =====
window.showResetPasswordModal = function() {
    document.querySelectorAll('.reset-pwd-modal').forEach(m => m.remove());
    const m = document.createElement('div');
    m.className = 'reset-pwd-modal fixed inset-0 z-[9999] flex items-center justify-center p-4';
    m.style.background = 'rgba(0,0,0,0.8)';
    m.innerHTML = `<div style="background:#fff;border-radius:24px;padding:32px;max-width:400px;width:100%;text-align:center">
        <div style="font-size:2.5rem;margin-bottom:8px">üîê</div>
        <h2 style="font-size:1.3rem;font-weight:800;color:#111;margin-bottom:8px">Nouveau mot de passe</h2>
        <p style="color:#888;font-size:13px;margin-bottom:20px">Choisissez un nouveau mot de passe s√©curis√© (6 caract√®res minimum)</p>
        <input type="password" id="new-pwd-1" placeholder="Nouveau mot de passe" minlength="6" style="width:100%;padding:14px;border:2px solid #E5E7EB;border-radius:14px;font-size:15px;margin-bottom:10px;outline:none;font-family:inherit">
        <input type="password" id="new-pwd-2" placeholder="Confirmer le mot de passe" minlength="6" style="width:100%;padding:14px;border:2px solid #E5E7EB;border-radius:14px;font-size:15px;margin-bottom:6px;outline:none;font-family:inherit">
        <p id="reset-pwd-err" style="color:#DC2626;font-size:12px;min-height:20px;margin-bottom:12px"></p>
        <button onclick="submitNewPassword()" style="width:100%;background:#FF5A1F;color:white;border:none;padding:15px;border-radius:14px;font-weight:800;font-size:16px;cursor:pointer">
            Changer mon mot de passe
        </button>
    </div>`;
    document.body.appendChild(m);
    setTimeout(() => document.getElementById('new-pwd-1')?.focus(), 100);
};

window.submitNewPassword = async function() {
    const p1 = document.getElementById('new-pwd-1')?.value;
    const p2 = document.getElementById('new-pwd-2')?.value;
    const err = document.getElementById('reset-pwd-err');
    if (!p1 || p1.length < 6) { if(err) err.textContent = '‚ö†Ô∏è Minimum 6 caract√®res'; return; }
    if (p1 !== p2) { if(err) err.textContent = '‚ö†Ô∏è Les mots de passe ne correspondent pas'; return; }
    const { error } = await sb.auth.updateUser({ password: p1 });
    if (error) { if(err) err.textContent = '‚ùå ' + error.message; return; }
    document.querySelectorAll('.reset-pwd-modal').forEach(m => m.remove());
    notif('‚úÖ Mot de passe chang√© !', 'Vous pouvez maintenant vous connecter', 'green');
    window.history.replaceState({}, '', window.location.pathname);
};

async function boot() {
    document.getElementById('app').innerHTML = '<div class="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center"><div class="text-center"><div class="text-5xl mb-4">üöó</div><p class="text-xl font-bold text-orange-600">DriveConnect NC</p><p class="text-gray-400 mt-2">Connexion √† la base de donn√©es...</p><div class="mt-4 w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div></div>';

    // D√©tecter le retour de r√©initialisation de mot de passe
    const urlHash = window.location.hash;
    if (urlHash.includes('type=recovery') || new URLSearchParams(window.location.search).get('reset') === 'true') {
        setTimeout(() => showResetPasswordModal(), 500);
    }

    // Lire les param√®tres URL pour routing direct
    const urlParams = new URLSearchParams(window.location.search);
    const roleParam = urlParams.get('role');
    const adminKey = urlParams.get('admin');

    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        const userId = session.user.id;
        const meta = session.user.user_metadata || {};
        let { data: profile, error: profErr } = await sb.from('users').select('*').eq('id', userId).maybeSingle();
        
        // Si pas de profil, le cr√©er depuis les m√©tadonn√©es
        if (!profile) {
            console.log('[BOOT] No profile found, creating from metadata...');
            const savedType = meta.user_type || null;
            const { data: newProf } = await sb.from('users').upsert({
                id: userId,
                email: session.user.email,
                name: meta.name || session.user.email.split('@')[0],
                user_type: savedType
            }, { onConflict: 'id' }).select().single();
            profile = newProf;
            // Si toujours pas, attendre et r√©essayer
            if (!profile) {
                await new Promise(r => setTimeout(r, 1000));
                const retry = await sb.from('users').select('*').eq('id', userId).maybeSingle();
                profile = retry.data;
            }
        }
        
        // Si profil existe mais user_type null, corriger
        if (profile && !profile.user_type && meta.user_type) {
            await sb.from('users').update({ user_type: meta.user_type }).eq('id', userId);
            profile.user_type = meta.user_type;
        }

        if (profile) {
            currentUser = { ...profile, ...session.user, user_type: profile.user_type || meta.user_type };

            // Acc√®s admin : soit is_admin en base, soit cl√© URL secr√®te
            if (profile.is_admin || adminKey === 'dc2024') {
                currentView = 'admin';
            } else if (currentUser.user_type === 'instructor') {
                const { data: instProfile } = await sb.from('instructors').select('approval_status').eq('id', userId).maybeSingle();
                const status = instProfile?.approval_status || 'pending_documents';
                if (status === 'approved') {
                    currentView = 'instructor-dashboard';
                } else if (status === 'pending_documents') {
                    currentView = 'instructor-upload-docs';
                } else if (status === 'rejected') {
                    currentView = 'instructor-rejected';
                } else {
                    currentView = 'instructor-pending';
                }
            } else {
                currentView = 'student-dashboard';
            }
        }
    } else if (roleParam === 'instructor') {
        currentView = 'instructor-login';
    } else if (roleParam === 'student') {
        currentView = 'student-login';
    }
    subscribeToPush();
    checkReferralInUrl();

    await loadData();
    render();

    // Charger les donn√©es de parrainage APR√àS render (les √©l√©ments DOM doivent exister)
    setTimeout(() => loadReferralData(), 300);

    // Refresh donn√©es sans re-render complet si sur carte
    setInterval(async () => {
        if (!document.hidden && currentView !== 'admin') {
            // Ne JAMAIS re-render les pages d'upload docs (d√©truit les inputs file)
            if (currentView === 'instructor-upload-docs' || currentView === 'instructor-rejected' || currentView === 'instructor-pending') return;

            await loadData();
            if (currentUser) {
                // Si sur le dashboard √©tudiant avec carte visible, juste mettre √† jour les markers
                if (currentView === 'student-dashboard' && map && iMarkers.length > 0) {
                    updateMapMarkers();
                } else {
                    render();
                }
            }
        }
    }, 10000); // 10s pour plus de r√©activit√©
}


window.submitRating = async function(bookingId, instructorId) {
    const rating = window._selectedRating || 0;
    if (!rating) { notif('‚ùå Choisissez une note', '', 'red'); return; }

    const { data: instructor } = await sb.from('instructors').select('rating,total_reviews').eq('id', instructorId).single();
    if (!instructor) { notif('‚ùå Erreur', '', 'red'); return; }

    const newTotal = (instructor.total_reviews || 0) + 1;
    const newRating = (((instructor.rating || 0) * (instructor.total_reviews || 0)) + rating) / newTotal;

    await sb.from('instructors').update({
        rating: Math.round(newRating * 10) / 10,
        total_reviews: newTotal
    }).eq('id', instructorId);

    await sb.from('bookings').update({ rated: true, rating_given: rating }).eq('id', bookingId);

    const modal = document.getElementById('rating-modal');
    if (modal) modal.remove();
    notif('‚≠ê Merci pour votre avis !', `Vous avez donn√© ${rating}/5 √©toiles`, 'green');
    await loadData();
    render();
}

window.hoverStar = function(val) {
    document.querySelectorAll('.star').forEach((s,i) => { s.textContent = i < val ? '\u2b50' : '\u2606'; });
}

window.resetStars = function() {
    const selected = window._selectedRating || 0;
    document.querySelectorAll('.star').forEach((s,i) => { s.textContent = i < selected ? '\u2b50' : '\u2606'; });
}

window.selectStar = function(val) {
    window._selectedRating = val;
    document.querySelectorAll('.star').forEach((s,i) => { s.textContent = i < val ? '\u2b50' : '\u2606'; });
}



// ========== MODE SOMBRE ==========
let isDark = localStorage.getItem('darkMode') === 'true';
function applyDark() {
    if (isDark) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
}
function toggleDark() {
    isDark = !isDark;
    localStorage.setItem('darkMode', isDark);
    applyDark();
    document.querySelectorAll('#dark-btn').forEach(b => b.textContent = isDark ? '‚òÄÔ∏è' : 'üåô');
}
applyDark();

window.showRating = function(bookingId, instructorId, instructorName) {
    window._selectedRating = 0;
    const stars = [1,2,3,4,5].map(i =>
        '<span style="font-size:2.8rem;cursor:pointer;transition:transform 0.15s;display:inline-block" data-val="' + i + '" ' +
        'onclick="window.selectStar(' + i + ')" ' +
        'onmouseover="window.hoverStar(' + i + ');this.style.transform=\'scale(1.2)\'" ' +
        'onmouseout="window.resetStars();this.style.transform=\'scale(1)\'">‚òÜ</span>'
    ).join('');
    const modal = document.createElement('div');
    modal.id = 'rating-modal';
    modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-[9999] p-4';
    modal.style.animation = 'fadeUp 0.3s ease-out';
    modal.innerHTML =
        '<div style="background:#fff;border-radius:28px;padding:32px;max-width:360px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,0.25);text-align:center;animation:scaleIn 0.3s ease-out">' +
        '<div style="width:64px;height:64px;background:#FFF7ED;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 16px">‚≠ê</div>' +
        '<h3 style="font-size:20px;font-weight:900;margin-bottom:6px;color:#111">Noter ' + instructorName + '</h3>' +
        '<p style="color:#999;font-size:14px;margin-bottom:24px">Comment s&#39;est pass&#233; votre cours ?</p>' +
        '<div style="display:flex;justify-content:center;gap:6px;margin-bottom:28px" id="star-container">' + stars + '</div>' +
        '<div style="display:flex;gap:10px">' +
        '<button onclick="document.getElementById(\'rating-modal\').remove()" style="flex:1;padding:14px;border:1.5px solid #E5E7EB;background:#fff;border-radius:14px;font-weight:700;font-size:15px;cursor:pointer;color:#6B7280;transition:all 0.15s">Annuler</button>' +
        '<button onclick="window.submitRating(\''+bookingId+'\',\''+instructorId+'\')" style="flex:1;padding:14px;background:linear-gradient(135deg,#FF5A1F,#FF7340);color:#fff;border:none;border-radius:14px;font-weight:700;font-size:15px;cursor:pointer;transition:all 0.15s">Envoyer</button>' +
        '</div></div>';
    document.body.appendChild(modal);
}


// ========== CHAT ==========
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT ‚Äî Messages + Photos + Appel t√©l√©phonique
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chatSubscription = null;
let _chatBookingId = null;

window.openChat = async function(bookingId, otherUserId, otherName) {
    bookingId   = String(bookingId   || '').trim();
    otherUserId = String(otherUserId || '').trim();
    otherName   = (otherName && otherName !== 'null' && otherName !== 'undefined')
                  ? String(otherName).trim() : 'Votre contact';
    _chatBookingId = bookingId;

    if (chatSubscription) { try { chatSubscription.unsubscribe(); } catch(e){} chatSubscription = null; }
    document.getElementById('chat-modal')?.remove();

    // ‚îÄ‚îÄ R√©cup√©rer le num√©ro de t√©l√©phone ‚îÄ‚îÄ
    let otherPhone = null;
    if (otherUserId) {
        try {
            const { data: inst } = await sb.from('instructors').select('phone_number').eq('id', otherUserId).maybeSingle();
            if (inst && inst.phone_number) otherPhone = String(inst.phone_number).trim();
        } catch(e) {}
        if (!otherPhone) {
            try {
                const { data: usr } = await sb.from('users').select('phone_number').eq('id', otherUserId).maybeSingle();
                if (usr && usr.phone_number) otherPhone = String(usr.phone_number).trim();
            } catch(e) {}
        }
    }

    // ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ
    const overlay = document.createElement('div');
    overlay.id = 'chat-modal';
    Object.assign(overlay.style, {
        position:'fixed', inset:'0', background:'rgba(0,0,0,0.7)',
        zIndex:'99999', display:'flex', alignItems:'flex-end', justifyContent:'center'
    });

    // ‚îÄ‚îÄ Panel principal ‚îÄ‚îÄ
    const panel = document.createElement('div');
    Object.assign(panel.style, {
        width:'100%', maxWidth:'520px', background:'#fff',
        borderRadius:'24px 24px 0 0', display:'flex', flexDirection:'column',
        height:'88vh', maxHeight:'680px',
        boxShadow:'0 -8px 40px rgba(0,0,0,0.35)', overflow:'hidden'
    });

    // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ
    const header = document.createElement('div');
    Object.assign(header.style, {
        background:'#0D0D0D', padding:'14px 16px',
        display:'flex', alignItems:'center', gap:'12px', flexShrink:'0'
    });

    const avatar = document.createElement('div');
    Object.assign(avatar.style, {
        width:'40px', height:'40px', borderRadius:'50%', background:'#FF5A1F',
        display:'flex', alignItems:'center', justifyContent:'center',
        fontWeight:'900', color:'white', fontSize:'17px', flexShrink:'0'
    });
    avatar.textContent = otherName[0].toUpperCase();

    const nameBlock = document.createElement('div');
    nameBlock.style.cssText = 'flex:1;min-width:0';
    nameBlock.innerHTML =
        '<p style="color:#fff;font-weight:800;font-size:15px;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'
        + _esc(otherName) + '</p>'
        + '<p style="color:#555;font-size:11px;margin:2px 0 0">‚óè Temps r√©el</p>';

    // Bouton t√©l√©phone
    const callBtn = document.createElement(otherPhone ? 'a' : 'button');
    if (otherPhone) {
        callBtn.href = 'tel:' + otherPhone;
        callBtn.style.cssText =
            'display:inline-flex;align-items:center;gap:6px;background:#00C853;color:#fff;'
            +'text-decoration:none;border-radius:20px;padding:7px 13px;font-weight:700;'
            +'font-size:12px;flex-shrink:0;white-space:nowrap;border:none;cursor:pointer';
        callBtn.innerHTML = _phoneSVG() + ' ' + _esc(otherPhone);
    } else {
        callBtn.style.cssText =
            'display:inline-flex;align-items:center;gap:6px;background:#1C1C1C;color:#666;'
            +'border:1px solid #333;border-radius:20px;padding:7px 13px;font-weight:600;'
            +'font-size:12px;flex-shrink:0;cursor:pointer';
        callBtn.innerHTML = _phoneSVG() + ' Appeler';
        callBtn.addEventListener('click', () =>
            notif('üìû Num√©ro non renseign√©', 'Le moniteur doit ajouter son num√©ro dans ses Param√®tres', 'orange'));
    }

    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    Object.assign(closeBtn.style, {
        width:'32px', height:'32px', borderRadius:'50%', background:'#1C1C1C',
        border:'1px solid #333', color:'#888', cursor:'pointer', fontSize:'20px',
        display:'flex', alignItems:'center', justifyContent:'center', flexShrink:'0'
    });
    closeBtn.addEventListener('click', window.closeChat);
    header.append(avatar, nameBlock, callBtn, closeBtn);

    // ‚îÄ‚îÄ PREVIEW IMAGE ‚îÄ‚îÄ
    const previewZone = document.createElement('div');
    previewZone.id = 'chat-img-preview';
    Object.assign(previewZone.style, {
        display:'none', padding:'10px 16px', background:'#FFF7ED',
        borderBottom:'1px solid #FED7AA', flexShrink:'0'
    });
    previewZone.innerHTML =
        '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">'
        +'<img id="chat-img-preview-img" src="" style="height:60px;width:60px;border-radius:10px;object-fit:cover;border:2px solid #FED7AA">'
        +'<div style="flex:1"><p style="font-size:13px;font-weight:700;color:#92400E;margin:0 0 3px">Photo pr√™te √† envoyer</p>'
        +'<p id="chat-img-preview-name" style="font-size:11px;color:#B45309;margin:0"></p></div>'
        +'<button id="chat-preview-cancel" style="background:none;border:none;color:#DC2626;font-size:24px;cursor:pointer;line-height:1">&times;</button>'
        +'</div>'
        +'<button id="chat-preview-send" style="width:100%;background:#FF5A1F;color:#fff;border:none;'
        +'border-radius:12px;padding:10px 0;font-weight:800;cursor:pointer;font-size:14px">üì§ Envoyer la photo</button>';

    // ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
    const msgsZone = document.createElement('div');
    msgsZone.id = 'chat-messages';
    Object.assign(msgsZone.style, {
        flex:'1', overflowY:'auto', padding:'16px', background:'#F9FAFB',
        display:'flex', flexDirection:'column', gap:'10px'
    });

    // ‚îÄ‚îÄ BARRE D'ENVOI ‚îÄ‚îÄ
    const inputBar = document.createElement('div');
    Object.assign(inputBar.style, {
        padding:'10px 12px', borderTop:'1px solid #E5E7EB',
        background:'#fff', display:'flex', alignItems:'center',
        gap:'8px', flexShrink:'0'
    });

    const photoLabel = document.createElement('label');
    photoLabel.title = 'Envoyer une photo';
    Object.assign(photoLabel.style, {
        width:'42px', height:'42px', borderRadius:'12px', background:'#F3F4F6',
        border:'1.5px solid #E5E7EB', display:'flex', alignItems:'center',
        justifyContent:'center', cursor:'pointer', flexShrink:'0', fontSize:'19px'
    });
    photoLabel.textContent = 'üì∑';

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'chat-img-input';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    photoLabel.appendChild(fileInput);

    const textInput = document.createElement('input');
    textInput.type = 'text';
    textInput.id = 'chat-input';
    textInput.placeholder = '√âcrire un message...';
    Object.assign(textInput.style, {
        flex:'1', border:'1.5px solid #E5E7EB', borderRadius:'14px',
        padding:'11px 15px', fontSize:'14px', outline:'none',
        background:'#fff', color:'#111'
    });
    textInput.addEventListener('focus', () => textInput.style.borderColor = '#3B82F6');
    textInput.addEventListener('blur',  () => textInput.style.borderColor = '#E5E7EB');

    const sendBtn = document.createElement('button');
    sendBtn.id = 'chat-send-btn';
    Object.assign(sendBtn.style, {
        width:'42px', height:'42px', borderRadius:'12px', background:'#3B82F6',
        border:'none', color:'white', cursor:'pointer', display:'flex',
        alignItems:'center', justifyContent:'center', flexShrink:'0'
    });
    sendBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>';

    inputBar.append(photoLabel, textInput, sendBtn);
    panel.append(header, previewZone, msgsZone, inputBar);
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    // ‚îÄ‚îÄ Event listeners (tous en addEventListener) ‚îÄ‚îÄ
    overlay.addEventListener('click', e => { if (e.target === overlay) window.closeChat(); });
    sendBtn.addEventListener('click', () => _chatSendText(bookingId));
    textInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) _chatSendText(bookingId); });
    fileInput.addEventListener('change', () => _chatPreviewImg(fileInput));
    document.getElementById('chat-preview-cancel').addEventListener('click', _chatCancelPreview);
    document.getElementById('chat-preview-send').addEventListener('click', () => _chatSendImg(bookingId, fileInput));

    await _chatLoadMessages(bookingId);

    chatSubscription = sb.channel('chat-' + bookingId)
        .on('broadcast', { event: 'new_message' }, payload => {
            if (payload.payload && payload.payload.sender_id !== currentUser.id)
                _chatAppend(payload.payload);
        })
        .on('postgres_changes', {
            event: 'INSERT', schema: 'public', table: 'messages',
            filter: 'booking_id=eq.' + bookingId
        }, payload => {
            if (!document.querySelector('[data-msg-id="' + payload.new.id + '"]'))
                _chatAppend(payload.new);
        })
        .subscribe();
};

window.closeChat = function() {
    if (chatSubscription) { try { chatSubscription.unsubscribe(); } catch(e){} chatSubscription = null; }
    document.getElementById('chat-modal')?.remove();
    _chatBookingId = null;
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function _esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function _phoneSVG() {
    return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02L6.6 10.8z"/></svg>';
}

async function _chatSendText(bookingId) {
    const input = document.getElementById('chat-input');
    const text = input?.value?.trim();
    if (!text) return;
    input.value = '';
    const msg = {
        booking_id: bookingId, sender_id: currentUser.id,
        sender_name: currentUser.name || 'Moi',
        content: sanitize(text), created_at: new Date().toISOString()
    };
    _chatAppend(msg);
    try { sb.channel('chat-' + bookingId).send({ type:'broadcast', event:'new_message', payload: msg }); } catch(e){}
    const { error } = await sb.from('messages').insert({
        booking_id: bookingId, sender_id: currentUser.id,
        sender_name: currentUser.name || 'Moi', content: sanitize(text)
    });
    if (error) notif('‚ùå Erreur envoi', error.message, 'red');
}

function _chatPreviewImg(fileInput) {
    const file = fileInput?.files?.[0];
    if (!file) return;
    if (file.size > 20 * 1024 * 1024) { notif('‚ùå Image trop lourde', 'Max 20 Mo', 'red'); fileInput.value=''; return; }
    const reader = new FileReader();
    reader.onload = e => {
        const pz = document.getElementById('chat-img-preview');
        const pi = document.getElementById('chat-img-preview-img');
        const pn = document.getElementById('chat-img-preview-name');
        if (pz) pz.style.display = 'block';
        if (pi) pi.src = e.target.result;
        if (pn) pn.textContent = file.name + ' ¬∑ ' + (file.size/1024).toFixed(0) + ' Ko';
        const inp = document.getElementById('chat-input');
        if (inp) inp.placeholder = 'L√©gende (optionnel)...';
    };
    reader.readAsDataURL(file);
}

function _chatCancelPreview() {
    const fi = document.getElementById('chat-img-input');
    if (fi) fi.value = '';
    const pz = document.getElementById('chat-img-preview');
    if (pz) pz.style.display = 'none';
    const inp = document.getElementById('chat-input');
    if (inp) inp.placeholder = '√âcrire un message...';
}

async function _chatSendImg(bookingId, fileInput) {
    const file = fileInput?.files?.[0];
    if (!file) { notif('‚ùå Aucune image', '', 'red'); return; }
    const btn = document.getElementById('chat-preview-send');
    if (btn) { btn.textContent = '‚è≥ Envoi...'; btn.disabled = true; }

    const caption = (document.getElementById('chat-input')?.value || '').trim();
    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase().replace(/[^a-z0-9]/g,'');
    const path = bookingId + '/' + Date.now() + '_' + Math.random().toString(36).substr(2,6) + '.' + ext;

    const { error: upErr } = await sb.storage.from('chat-images').upload(path, file, { upsert:false, contentType:file.type });
    if (upErr) {
        notif('‚ùå Erreur upload', upErr.message, 'red');
        if (btn) { btn.textContent = 'üì§ Envoyer la photo'; btn.disabled = false; }
        return;
    }
    const { data: urlData } = sb.storage.from('chat-images').getPublicUrl(path);
    const imageUrl = urlData?.publicUrl;
    if (!imageUrl) { notif('‚ùå URL introuvable', '', 'red'); return; }

    const content = caption || 'üì∑ Photo';
    const msg = {
        booking_id: bookingId, sender_id: currentUser.id,
        sender_name: currentUser.name || 'Moi',
        content, image_url: imageUrl, created_at: new Date().toISOString()
    };
    _chatAppend(msg);
    try { sb.channel('chat-' + bookingId).send({ type:'broadcast', event:'new_message', payload: msg }); } catch(e){}
    await sb.from('messages').insert({
        booking_id: bookingId, sender_id: currentUser.id,
        sender_name: currentUser.name || 'Moi', content, image_url: imageUrl
    });
    _chatCancelPreview();
    if (document.getElementById('chat-input')) document.getElementById('chat-input').value = '';
    notif('‚úÖ Photo envoy√©e !', '', 'green');
}

async function _chatLoadMessages(bookingId) {
    const { data } = await sb.from('messages').select('*').eq('booking_id', bookingId).order('created_at', { ascending:true });
    const container = document.getElementById('chat-messages');
    if (!container) return;
    container.innerHTML = '';
    if (!data || data.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'chat-empty';
        Object.assign(empty.style, { textAlign:'center', color:'#9CA3AF', fontSize:'14px', padding:'40px 20px', margin:'auto', lineHeight:'1.7' });
        empty.innerHTML = 'üí¨ Aucun message<br><span style="font-size:12px;color:#D1D5DB">Commencez la conversation !</span>';
        container.appendChild(empty);
        return;
    }
    data.forEach(m => _chatAppend(m));
}

function _chatAppend(msg) {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    container.querySelector('.chat-empty')?.remove();

    const isMe = msg.sender_id === currentUser.id;
    const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });

    const wrapper = document.createElement('div');
    wrapper.dataset.msgId = msg.id || '';
    wrapper.style.cssText = 'display:flex;' + (isMe ? 'justify-content:flex-end' : 'justify-content:flex-start');

    const bubbleWrap = document.createElement('div');
    bubbleWrap.style.maxWidth = '75%';

    const radMe = '18px 18px 4px 18px';
    const radOther = '18px 18px 18px 4px';
    const bgMe = 'linear-gradient(135deg,#3B82F6,#2563EB)';

    if (msg.image_url) {
        const imgWrap = document.createElement('div');
        Object.assign(imgWrap.style, {
            borderRadius: isMe ? radMe : radOther,
            overflow:'hidden',
            background: isMe ? bgMe : '#fff',
            boxShadow: isMe ? '0 3px 14px rgba(59,130,246,0.35)' : '0 2px 8px rgba(0,0,0,0.1)',
            padding:'5px'
        });
        const img = document.createElement('img');
        img.src = msg.image_url;
        img.alt = 'Photo';
        Object.assign(img.style, {
            display:'block', width:'100%', maxWidth:'220px', maxHeight:'220px',
            objectFit:'cover', borderRadius:'12px', cursor:'pointer'
        });
        img.addEventListener('click', () => _chatFullImg(msg.image_url));
        img.addEventListener('error', () => img.style.display = 'none');
        imgWrap.appendChild(img);
        if (msg.content && msg.content !== 'üì∑ Photo') {
            const cap = document.createElement('p');
            cap.textContent = msg.content;
            Object.assign(cap.style, { margin:'5px 6px 2px', fontSize:'13px', color: isMe ? '#fff' : '#111' });
            imgWrap.appendChild(cap);
        }
        bubbleWrap.appendChild(imgWrap);
    } else {
        const bubble = document.createElement('div');
        Object.assign(bubble.style, {
            background: isMe ? bgMe : '#fff',
            color: isMe ? '#fff' : '#111',
            borderRadius: isMe ? radMe : radOther,
            padding:'10px 14px',
            boxShadow: isMe ? '0 3px 14px rgba(59,130,246,0.35)' : '0 2px 8px rgba(0,0,0,0.1)',
            wordBreak:'break-word', lineHeight:'1.5', fontSize:'14px'
        });
        bubble.textContent = msg.content || '';
        bubbleWrap.appendChild(bubble);
    }

    const meta = document.createElement('p');
    meta.textContent = (isMe ? 'Vous' : (msg.sender_name || 'Contact')) + ' ¬∑ ' + time;
    Object.assign(meta.style, { fontSize:'10px', color:'#9CA3AF', margin:'3px 2px 0', textAlign: isMe ? 'right' : 'left' });
    bubbleWrap.appendChild(meta);
    wrapper.appendChild(bubbleWrap);
    container.appendChild(wrapper);
    container.scrollTop = container.scrollHeight;
}

function _chatFullImg(src) {
    const lb = document.createElement('div');
    lb.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.93);z-index:999999;display:flex;align-items:center;justify-content:center;cursor:pointer';
    lb.addEventListener('click', e => { if (e.target === lb) lb.remove(); });
    const img = document.createElement('img');
    img.src = src;
    img.style.cssText = 'max-width:95vw;max-height:88vh;border-radius:12px;object-fit:contain;cursor:default';
    img.addEventListener('click', e => e.stopPropagation());
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.cssText = 'position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.15);border:none;border-radius:50%;width:42px;height:42px;color:#fff;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center';
    closeBtn.addEventListener('click', () => lb.remove());
    const dl = document.createElement('a');
    dl.href = src; dl.download = 'photo.jpg'; dl.target = '_blank';
    dl.textContent = '‚¨á T√©l√©charger';
    dl.style.cssText = 'position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;color:#111;text-decoration:none;padding:10px 24px;border-radius:20px;font-weight:700;font-size:13px';
    lb.append(closeBtn, img, dl);
    document.body.appendChild(lb);
}

// Alias pour compatibilit√©
function appendMessage(msg) { _chatAppend(msg); }
function loadMessages(bookingId) { return _chatLoadMessages(bookingId); }
window.sendMessage = async function(bookingId) { await _chatSendText(bookingId || _chatBookingId); };


// ========== AVATAR ==========
window.previewAvatar = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { notif('‚ùå Fichier trop lourd', 'Maximum 5MB', 'red'); return; }

    const reader = new FileReader();
    reader.onload = (e) => {
        const preview = document.getElementById('avatar-preview');
        if (preview) preview.innerHTML = '<img src="'+e.target.result+'" class="w-full h-full object-cover" alt="Preview">';
    };
    reader.readAsDataURL(file);

    // Upload imm√©diat
    uploadAvatar(file);
}

async function uploadAvatar(file) {
    const ext = file.name.split('.').pop();
    const path = currentUser.id + '/avatar.' + ext;

    notif('‚è≥ Upload en cours...', '', 'orange');

    const { data, error } = await sb.storage.from('avatars').upload(path, file, {
        upsert: true,
        contentType: file.type
    });

    if (error) { notif('‚ùå Erreur upload', error.message, 'red'); return; }

    const { data: urlData } = sb.storage.from('avatars').getPublicUrl(path);
    const avatarUrl = urlData.publicUrl + '?t=' + Date.now();

    await sb.from('instructors').update({ avatar_url: avatarUrl }).eq('id', currentUser.id);
    await sb.from('users').update({ avatar_url: avatarUrl }).eq('id', currentUser.id);

    currentUser.avatar_url = avatarUrl;
    notif('‚úÖ Photo mise √† jour !', 'Visible par tous les √©l√®ves', 'green');
    await loadData();
    render();
}



// ========== PROFIL PUBLIC MONITEUR ==========
window.focusInstructor = function(id) { window.showInstructorProfile(id); };

window.showInstructorProfile = function(instructorId) {
    const inst = DB.instructors.find(x => x.id === instructorId);
    if (!inst) return;
    const slots = DB.slots.filter(s => s.instructor_id === instructorId && s.available);
    const initials = (inst.name || '?').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    const stars = inst.rating ? Math.round(inst.rating) : 0;

    // Supprimer modal existant
    document.getElementById('profile-modal')?.remove();

    // Cr√©er overlay
    const overlay = document.createElement('div');
    overlay.id = 'profile-modal';
    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center';
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });

    // Cr√©er panel
    const panel = document.createElement('div');
    panel.style.cssText = 'width:100%;max-width:480px;border-radius:24px 24px 0 0;overflow:hidden;max-height:90vh;overflow-y:auto;background:var(--surface)';

    // Header sombre
    const header = document.createElement('div');
    header.style.cssText = 'background:linear-gradient(135deg,#1A1A1A,#2D2D2D);padding:24px;position:relative';

    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&#x2715;';
    closeBtn.style.cssText = 'position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:16px';
    closeBtn.onclick = () => overlay.remove();

    const avatarDiv = document.createElement('div');
    avatarDiv.style.cssText = 'width:72px;height:72px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:white;background:var(--primary);flex-shrink:0';
    if (inst.avatar_url) {
        const img = document.createElement('img');
        img.src = inst.avatar_url;
        img.style.cssText = 'width:100%;height:100%;object-fit:cover';
        img.alt = inst.name;
        avatarDiv.appendChild(img);
    } else {
        avatarDiv.textContent = initials;
    }

    const infoDiv = document.createElement('div');
    infoDiv.innerHTML = '<h2 style="font-size:20px;font-weight:700;color:white;margin-bottom:4px">' + inst.name + (inst.verified ? ' <span style="background:#DCFCE7;color:#16A34A;font-size:11px;padding:2px 8px;border-radius:20px;font-weight:600">‚úì V√©rifi√©</span>' : '') + '</h2>' +
        '<p style="color:rgba(255,255,255,0.5);font-size:13px">üìç ' + (inst.location || 'Noum√©a') + '</p>' +
        '<p style="color:#F59E0B;font-size:14px;margin-top:4px">' + '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5 - stars) + (inst.rating ? ' <span style="color:rgba(255,255,255,0.7)">' + inst.rating.toFixed(1) + '</span>' : '') + ' <span style="color:rgba(255,255,255,0.3);font-size:12px">(' + (inst.total_reviews || 0) + ' avis)</span></p>';

    const flexRow = document.createElement('div');
    flexRow.style.cssText = 'display:flex;align-items:center;gap:16px';
    flexRow.appendChild(avatarDiv);
    flexRow.appendChild(infoDiv);
    header.appendChild(closeBtn);
    header.appendChild(flexRow);

    // Stats bar
    const statsBar = document.createElement('div');
    statsBar.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr;padding:20px;border-bottom:1px solid var(--border)';
    const statsData = [
        { val: (inst.hourly_rate || 0).toLocaleString(), label: 'XPF/heure' },
        { val: inst.experience || '‚Äî', label: 'ans exp.' },
        { val: slots.length, label: 'cr√©neaux' }
    ];
    statsData.forEach((s, i) => {
        const cell = document.createElement('div');
        cell.style.cssText = 'text-align:center' + (i > 0 ? ';border-left:1px solid var(--border)' : '');
        cell.innerHTML = '<p style="font-size:22px;font-weight:700;color:' + (i === 0 ? 'var(--primary)' : 'var(--text)') + '">' + s.val + '</p><p style="font-size:12px;color:var(--text-muted);margin-top:4px">' + s.label + '</p>';
        statsBar.appendChild(cell);
    });

    // Statut en ligne
    const statusBar = document.createElement('div');
    statusBar.style.cssText = 'padding:12px 20px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)';
    statusBar.innerHTML = '<div style="width:10px;height:10px;border-radius:50%;background:' + (inst.is_online ? '#22C55E' : '#9CA3AF') + '"></div><p style="font-size:14px;font-weight:500;color:var(--text)">' + (inst.is_online ? 'En ligne maintenant' : 'Hors ligne') + '</p>';

    // Cr√©neaux
    const slotsSection = document.createElement('div');
    slotsSection.style.cssText = 'padding:20px';
    const slotsTitle = document.createElement('h3');
    slotsTitle.style.cssText = 'font-weight:700;font-size:16px;color:var(--text);margin-bottom:16px';
    slotsTitle.textContent = 'Cr√©neaux disponibles';
    slotsSection.appendChild(slotsTitle);

    if (slots.length === 0) {
        const empty = document.createElement('p');
        empty.style.cssText = 'text-align:center;color:var(--text-muted);font-size:14px;padding:32px 0';
        empty.textContent = 'Aucun cr√©neau disponible pour le moment';
        slotsSection.appendChild(empty);
    } else {
        slots.forEach(s => {
            const slotCard = document.createElement('div');
            slotCard.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:16px;margin-bottom:8px;background:var(--bg);border:1px solid var(--border)';
            const slotInfo = document.createElement('div');
            slotInfo.innerHTML = '<p style="font-weight:600;font-size:14px;color:var(--text)">' + s.date + ' √† ' + s.time + '</p><p style="font-size:12px;color:var(--text-muted);margin-top:2px">Dur√©e : ' + s.duration + 'h</p>';
            const slotRight = document.createElement('div');
            slotRight.style.cssText = 'display:flex;align-items:center;gap:12px';
            const price = document.createElement('p');
            price.style.cssText = 'font-weight:700;color:var(--primary)';
            price.textContent = s.price.toLocaleString() + ' XPF';
            const bookBtn = document.createElement('button');
            bookBtn.className = 'btn-primary';
            bookBtn.style.cssText = 'padding:8px 16px;font-size:13px';
            bookBtn.textContent = 'R√©server';
            bookBtn.onclick = () => {
                overlay.remove();
                window.bookSlot(s.id, instructorId);
            };
            slotRight.appendChild(price);
            slotRight.appendChild(bookBtn);
            slotCard.appendChild(slotInfo);
            slotCard.appendChild(slotRight);
            slotsSection.appendChild(slotCard);
        });
    }

    panel.appendChild(header);
    panel.appendChild(statsBar);
    panel.appendChild(statusBar);
    panel.appendChild(slotsSection);
    overlay.appendChild(panel);
    document.body.appendChild(overlay);
}


boot();
</script>
</body>
</html>
